<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xertica.ai - Intelligence Dashboard</title>
  <link rel="icon" type="image/png" href="https://storage.googleapis.com/etp-bucket/Logos%20Xertica.ai%20(.png)/X%20-%20simbolo/Copy%20of%20X_symbol_variation3_Blue_white.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="loader.css">
  <style>
    .icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }
    .icon-lg {
      width: 28px;
      height: 28px;
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .xertica-logo-x {
      width: 100px;
      height: 100px;
      margin: 0 auto 25px;
      position: relative;
      animation: logoPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    .xertica-logo-x img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 25px rgba(74, 158, 255, 0.6));
    }
    @keyframes logoPulse {
      0%, 100% {
        opacity: 0.7;
        transform: scale(0.95);
      }
      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }
    .xertica-loading-text {
      color: #4A9EFF;
      font-size: 17px;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      letter-spacing: 1.2px;
      animation: textPulse 2s ease-in-out infinite;
    }
    @keyframes textPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }
    .xertica-loading-dots {
      display: inline-block;
      margin-left: 3px;
    }
    .xertica-loading-dots span {
      animation: dots 1.5s infinite;
      opacity: 0;
    }
    .xertica-loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .xertica-loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dots {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>
  <style>
    :root {
      /* Xertica.ai Brand Palette v.2 */
      --primary: #00BEFF;
      --primary-dark: #047EA9;
      --accent-pink: #FF89FF;
      --accent-green: #C0FF7D;
      --primary-purple: #8b5cf6;
      --bg-deep: #050a10;
      --bg-dark: #0f172a;
      --bg-card: #1a1d29;
      --glass-surface: rgba(18, 28, 41, 0.65);
      --glass-border: rgba(0, 190, 255, 0.15);
      --text-main: #e2e8f0;
      --text-muted: #94a3b8;
      --text-white: #ffffff;
      --text-gray: #b0b8c4;
      --primary-cyan: #00BEFF;
      --success: #C0FF7D;
      --danger: #E14849;
      --warning: #FFA500;
    }
    
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Roboto', sans-serif; 
      background-color: var(--bg-deep);
      /* Retro-Futurist Grid Background */
      background-image: 
        linear-gradient(rgba(0, 190, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 190, 255, 0.03) 1px, transparent 1px),
        radial-gradient(circle at 50% 0%, rgba(0, 190, 255, 0.15) 0%, transparent 60%);
      background-size: 40px 40px, 40px 40px, 100% 100%;
      color: var(--text-main); 
      display: flex; 
      height: 100vh; 
      overflow: hidden;
      overflow-x: hidden;
    }
    
    /* Sidebar */
    .sidebar { 
      width: 250px; 
      background: rgba(8, 14, 23, 0.8); 
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-right: 1px solid rgba(255,255,255,0.05); 
      padding: 20px; 
      display: flex; 
      flex-direction: column;
      box-shadow: 4px 0 30px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease, width 0.3s ease;
      position: relative;
      z-index: 1000;
    }
    .sidebar.collapsed {
      transform: translateX(-250px);
      width: 0;
      padding: 0;
      overflow: hidden;
    }
    .sidebar-toggle {
      position: fixed;
      left: 125px;
      bottom: 20px;
      top: auto;
      z-index: 1001;
      background: var(--glass-surface);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transform: translateX(-50%);
    }
    body.sidebar-collapsed .sidebar-toggle {
      left: 12px;
      transform: none;
    }
    .sidebar-toggle:hover {
      background: rgba(0,190,255,0.1);
      border-color: var(--primary-cyan);
      transform: scale(1.05);
    }
    .sidebar-toggle svg {
      width: 24px;
      height: 24px;
      stroke: var(--primary-cyan);
    }
    .main.sidebar-collapsed {
      margin-left: 0;
    }
    .logo { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 24px; color: var(--text-white); margin-bottom: 40px; letter-spacing: 1px; }
    .logo span { color: var(--primary-cyan); }
    .logo img { transition: opacity 0.3s ease; }
    .logo:hover img { opacity: 0.8; }
    .nav-item { 
      padding: 12px 15px; 
      margin: 5px 0; 
      border-radius: 12px; 
      cursor: pointer; 
      transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
      font-weight: 500; 
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    .nav-item::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0; width: 3px;
      background: var(--primary-cyan);
      border-radius: 0 4px 4px 0;
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }
    .nav-item.active::before { transform: scaleY(1); }
    .nav-item:hover, .nav-item.active { 
      background: linear-gradient(90deg, rgba(0,190,255,0.15) 0%, transparent 100%); 
      color: var(--primary-cyan); 
      box-shadow: 0 0 15px rgba(0,190,255,0.2);
      transform: translateX(2px);
    }

    /* Main Content */
    .main { flex: 1; padding: 30px; overflow-y: auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    h1, h2, h3, h4 { font-family: 'Poppins', sans-serif; margin: 0; }
    h3 { 
      margin-bottom: 20px; 
      color: var(--text-main);
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 20px;
      letter-spacing: -0.5px;
    }
    h4 { 
      color: var(--primary-cyan); 
      margin: 30px 0 20px 0; 
      padding: 16px 20px; 
      font-size: 16px;
      font-weight: 600;
      background: var(--glass-surface);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      border-left: 4px solid var(--primary-cyan);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    /* Section Headers com Glassmorphism */
    .metric-section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 30px 0 20px 0;
      padding: 18px 24px;
      font-size: 16px;
      font-weight: 600;
      background: var(--glass-surface);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .metric-section-header:hover {
      transform: translateX(3px);
      box-shadow: 0 6px 30px rgba(0,190,255,0.15);
    }
    .metric-section-header.pipeline { border-left: 4px solid var(--primary-cyan); color: var(--primary-cyan); }
    .metric-section-header.sales-specialist { border-left: 4px solid var(--accent-green); color: var(--accent-green); }
    .metric-section-header.won { border-left: 4px solid var(--accent-green); color: var(--accent-green); }
    .metric-section-header.lost { border-left: 4px solid var(--danger); color: var(--danger); }
    .metric-section-header.mvp { border-left: 4px solid var(--primary-purple); color: var(--primary-purple); }
    .metric-section-header.sellers { border-left: 4px solid var(--primary-purple); color: var(--primary-purple); }
    
    /* Small Labels (Forecast Health) */
    .forecast-health-label {
      font-size: 13px;
      margin-bottom: 10px;
      border: none;
      padding: 0;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      box-shadow:none;
    }
    .timestamp { font-size: 12px; color: var(--text-gray); }

    /* AI Analysis Card */
    .ai-card { 
      background: var(--glass-surface);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border); 
      padding: 25px; 
      border-radius: 20px; 
      margin-bottom: 30px; 
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1), 0 0 30px rgba(0,190,255,0.1);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, border-color 0.3s ease;
    }
    .ai-card:hover {
      border-color: rgba(0, 190, 255, 0.4);
      box-shadow: 0 10px 40px -10px rgba(0, 190, 255, 0.25);
      transform: translateY(-2px);
    }
    .ai-card h2 { color: var(--primary-cyan); font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .ai-content { font-size: 15px; line-height: 1.8; color: #e0e6ed; }
    
    /* Insight Item (War Room AI) */
    .insight-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .insight-item:last-child {
      border-bottom: none;
    }
    .insight-item .icon {
      flex-shrink: 0;
      margin-top: 2px;
    }
    .insight-item span {
      flex: 1;
      font-size: 12px;
      line-height: 1.6;
      color: var(--text-main);
    }

    /* KPI Grid */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; margin-bottom: 30px; }
    .kpi-card { 
      background: var(--glass-surface);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 20px; 
      border-radius: 20px; 
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, border-color 0.3s ease;
      position: relative; 
      overflow: hidden;
    }
    .kpi-card:hover { 
      transform: translateY(-4px);
      border-color: rgba(0, 190, 255, 0.4);
      box-shadow: 0 10px 40px -10px rgba(0, 190, 255, 0.2);
    }
    .kpi-card .icon-lg { position: absolute; top: 15px; right: 15px; opacity: 0.2; }
    .kpi-title { font-size: 11px; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .kpi-value { 
      font-size: 28px; 
      font-weight: 700; 
      font-family: 'Poppins', sans-serif; 
      margin-top: 8px;
      background: linear-gradient(180deg, #fff 0%, #cbd5e1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .kpi-subtitle { font-size: 12px; color: var(--text-gray); margin-top: 5px; }
    .val-green { color: var(--success); }
    .val-red { color: var(--danger); }
    .val-cyan { color: var(--primary-cyan); }
    .val-warning { color: var(--warning); }

    /* Tables */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px; 
      background: var(--glass-surface);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: 12px; 
      overflow: hidden;
      border: 1px solid var(--glass-border);
    }
    th { text-align: left; color: var(--text-gray); font-size: 11px; text-transform: uppercase; padding: 12px 15px; border-bottom: 2px solid rgba(255,255,255,0.1); font-weight: 600; letter-spacing: 0.5px; }
    td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 13px; }
    tr:hover { 
      background: rgba(0,190,255,0.05);
      transition: background 0.2s ease;
    }
    tr:last-child td { border-bottom: none; }
    .badge { 
      padding: 4px 12px; 
      border-radius: 99px; 
      font-size: 11px; 
      font-weight: 600; 
      display: inline-flex;
      align-items: center;
      gap: 6px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .badge-success { background: rgba(192, 255, 125, 0.1); color: var(--accent-green); border: 1px solid rgba(192, 255, 125, 0.2); }
    .badge-danger { background: rgba(225, 72, 73, 0.15); color: var(--danger); }
    .badge-warning { background: rgba(255, 137, 255, 0.1); color: var(--accent-pink); border: 1px solid rgba(255, 137, 255, 0.2); }

    /* Deal Cards (Pauta) */
    .deal-card { 
      background: var(--glass-surface);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 18px; 
      margin-bottom: 12px; 
      border-radius: 16px; 
      border-left: 4px solid var(--primary-cyan); 
      border: 1px solid var(--glass-border);
      border-left-width: 4px;
      border-left-color: var(--primary-cyan);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .deal-card:hover { 
      background: rgba(0, 190, 255, 0.08); 
      transform: translateX(5px);
      border-color: rgba(0, 190, 255, 0.4);
      box-shadow: 0 4px 20px rgba(0,190,255,0.15);
    }
    .deal-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
    .deal-name { font-weight: 600; font-size: 14px; color: var(--text-white); }
    .deal-value { font-weight: 700; color: var(--primary-cyan); font-size: 15px; }
    .deal-meta { font-size: 12px; color: var(--text-gray); line-height: 1.6; }
    .deal-audit { font-size: 12px; color: #cbd5e0; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); font-style: italic; }

    /* Margin Category Grid */
    .margin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 15px; }
    .margin-card { 
      background: rgba(0,190,255,0.05);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      padding: 15px; 
      border-radius: 12px; 
      border: 1px solid rgba(0,190,255,0.15); 
      text-align: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .margin-card:hover {
      transform: translateY(-3px);
      border-color: rgba(0,190,255,0.4);
      box-shadow: 0 4px 15px rgba(0,190,255,0.15);
    }
    .margin-card-title { font-size: 11px; color: var(--text-gray); text-transform: uppercase; }
    .margin-card-value { font-size: 22px; font-weight: 700; color: var(--primary-cyan); margin: 5px 0; }
    .margin-card-sub { font-size: 11px; color: var(--text-gray); }

    /* Sections Control */
    .section { display: none; animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 5px var(--primary-cyan), 0 0 10px var(--primary-cyan); }
      50% { box-shadow: 0 0 2px var(--primary-cyan), 0 0 5px var(--primary-cyan); }
    }
    
    /* Loading State */
    .loading { text-align: center; padding: 40px; color: var(--text-gray); }
    
    /* Executive Tabs */
    .exec-tab.active {
      color: var(--primary-cyan) !important;
      border-bottom: 3px solid var(--primary-cyan) !important;
      background: linear-gradient(180deg, transparent, rgba(0,190,255,0.08));
    }
    .exec-tab:hover {
      color: var(--text-main);
      background: rgba(255,255,255,0.02);
    }
    .exec-tab-content {
      animation: fadeIn 0.3s ease;
    }

    /* ML Tabs */
    .ml-tab.active {
      color: var(--primary-cyan) !important;
      border-bottom: 3px solid var(--primary-cyan) !important;
      background: linear-gradient(180deg, transparent, rgba(0,190,255,0.08));
    }
    .ml-tab:hover {
      color: var(--text-main);
      background: rgba(255,255,255,0.02);
    }
    .ml-tab-content {
      animation: fadeIn 0.3s ease;
      display: none;
    }
    .ml-tab-content.active {
      display: block;
    }

    /* Refresh Button */
    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: linear-gradient(135deg, var(--primary-cyan) 0%, var(--primary-dark) 100%);
      color: var(--bg-deep);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 190, 255, 0.4), 0 0 40px rgba(0, 190, 255, 0.2);
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .refresh-btn:hover {
      transform: scale(1.1) rotate(180deg);
      box-shadow: 0 6px 30px rgba(0, 190, 255, 0.6), 0 0 60px rgba(0, 190, 255, 0.3);
    }
    .refresh-btn:active {
      transform: scale(0.95);
    }
    .refresh-btn.loading {
      animation: spin 1s linear infinite;
      background: var(--text-gray);
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Multi-Select Dropdown */
    .multi-select-container {
      position: relative;
      min-width: 220px;
    }
    .multi-select-trigger {
      padding: 8px 34px 8px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.08);
      color: #ffffff;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
    }
    .multi-select-trigger:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.25);
    }
    .multi-select-trigger::after {
      content: 'â–¾';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      transition: transform 0.3s;
    }
    .multi-select-trigger.open::after {
      transform: translateY(-50%) rotate(180deg);
    }
    .multi-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 5px;
      background: #1a1d29;
      border: 1px solid rgba(0,190,255,0.3);
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      max-height: 350px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    .multi-select-dropdown.open {
      display: block;
    }
    .multi-select-group {
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .multi-select-group:last-child {
      border-bottom: none;
    }
    .multi-select-group-title {
      padding: 8px 16px;
      font-size: 11px;
      font-weight: 600;
      color: var(--primary-cyan);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }
    .multi-select-option {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
    }
    .multi-select-option:hover {
      background: rgba(0,190,255,0.1);
    }
    .multi-select-option input[type="checkbox"] {
      accent-color: var(--primary-cyan);
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    .multi-select-option label {
      cursor: pointer;
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .multi-select-option-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0,190,255,0.2);
      color: var(--primary-cyan);
      font-weight: 600;
    }
    .multi-select-actions {
      padding: 10px 16px;
      border-top: 1px solid rgba(255,255,255,0.05);
      display: flex;
      gap: 8px;
    }
    .multi-select-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.08);
      color: #ffffff;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s;
      flex: 1;
    }
    .multi-select-btn:hover {
      background: rgba(0,190,255,0.2);
      border-color: var(--primary-cyan);
      color: var(--primary-cyan);
    }
  </style>
</head>
<body>
  <!-- ========== SVG ICON SPRITES ========== -->
  <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <!-- Target/Goal Icon -->
      <symbol id="icon-target" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></symbol>
      
      <!-- Chart/Analytics Icon -->
      <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></symbol>
      
      <!-- Trophy/Win Icon -->
      <symbol id="icon-trophy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></symbol>
      
      <!-- Alert/Warning Icon -->
      <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></symbol>
      
      <!-- Lightbulb/Idea Icon -->
      <symbol id="icon-idea" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></symbol>
      
      <!-- User/Person Icon -->
      <symbol id="icon-user" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></symbol>
      
      <!-- Calendar Icon -->
      <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></symbol>
      
      <!-- Briefcase/Business Icon -->
      <symbol id="icon-briefcase" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></symbol>
      
      <!-- Location/Pin Icon -->
      <symbol id="icon-location" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></symbol>
      
      <!-- Star Icon -->
      <symbol id="icon-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></symbol>
      
      <!-- Money/Dollar Icon -->
      <symbol id="icon-money" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></symbol>
      
      <!-- Robot/AI Icon -->
      <symbol id="icon-robot" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/><path d="M9 20l-2 2"/><path d="M15 20l2 2"/></symbol>
      
      <!-- Check/Success Icon -->
      <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/></symbol>
      
      <!-- X/Close Icon -->
      <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
      
      <!-- Refresh/Reload Icon -->
      <symbol id="icon-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></symbol>
      
      <!-- Search/Magnify Icon -->
      <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></symbol>
      
      <!-- Clock/Time Icon -->
      <symbol id="icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></symbol>
      
      <!-- Sparkles/Magic Icon -->
      <symbol id="icon-sparkles" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 3l1.912 5.813 6.088.912-4.5 3.87 1.286 5.955L12 16.25l-4.786 3.3 1.286-5.955-4.5-3.87 6.088-.912L12 3z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></symbol>
      
      <!-- Trending Up Icon -->
      <symbol id="icon-trending-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></symbol>
      
      <!-- Trending Down Icon -->
      <symbol id="icon-trending-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></symbol>
      
      <!-- Bell/Notification Icon -->
      <symbol id="icon-bell" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></symbol>
      
      <!-- Activity/Pulse Icon -->
      <symbol id="icon-activity" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></symbol>
    </defs>
  </svg>

  <!-- ========== LOADING OVERLAY (inicial) ========== -->
  <div id="loading-overlay">
    <div class="loader-shell">
      <div class="loader-card">
        <div class="loader-brand">
          <img class="loader-logo" src="https://storage.googleapis.com/etp-bucket/Logos%20Xertica.ai%20(.png)/X%20-%20simbolo/Copy%20of%20X_symbol_variation3_Blue_white.png" alt="Xertica">
          <div class="loader-wordmark">Xertica</div>
        </div>
        <div class="loader-title">Carregando dados<span class="xertica-loading-dots"><span>.</span><span>.</span><span>.</span></span></div>
        <div class="loader-subtitle">Preparando indicadores, tabelas e visualizacoes para o dashboard.</div>
        <div class="loader-progress">
          <div class="loader-progress-bar"></div>
        </div>
      </div>
      <div class="loader-context">Conectando fontes e validando metricas</div>
    </div>
  </div>

  <!-- ========== FILTER LOADER (ao trocar filtros - MELHORADO) ========== -->
  <div id="filter-loading" class="filter-loading">
    <div class="loader-card loader-card--compact">
      <div class="loader-brand loader-brand--compact">
        <img class="loader-logo loader-logo--compact" src="https://storage.googleapis.com/etp-bucket/Logos%20Xertica.ai%20(.png)/X%20-%20simbolo/Copy%20of%20X_symbol_variation3_Blue_white.png" alt="Xertica">
        <div class="loader-wordmark">Xertica</div>
      </div>
      <div class="loader-title loader-title--compact">Atualizando dados</div>
      <div class="loader-progress loader-progress--compact">
        <div class="loader-progress-bar"></div>
      </div>
    </div>
  </div>

  <div class="sidebar">
    <div class="logo" style="display: flex; align-items: center; gap: 10px;">
      <img src="https://storage.googleapis.com/etp-bucket/Logos%20Xertica.ai%20(.png)/X%20-%20simbolo/Copy%20of%20X_symbol_variation3_Blue_white.png" alt="Xertica" style="height: 32px; width: auto;">
      <img src="https://storage.googleapis.com/etp-bucket/Logos%20Xertica.ai%20(.png)/xertica.ai/Copy%20of%20Logo_XERTICA_white.png" alt="Xertica.ai" style="height: 24px; width: auto; margin-top: 4px;">
    </div>
    <div class="nav-item active" onclick="showSection(this, 'executive')">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
      VisÃ£o Executiva
    </div>
    <div class="nav-item" onclick="showSection(this, 'dashboard')">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <path d="M9 9h6M9 15h6"/>
      </svg>
      Indicadores L10
    </div>
      <div class="nav-item" onclick="showSection(this, 'aprendizados')">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4M12 8h.01"/>
      </svg>
      Aprendizados
    </div>
    <div class="nav-item" onclick="showSection(this, 'fsr')">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      Performance FSR
    </div>
    <div class="nav-item" onclick="showSection(this, 'individual')">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      Por Vendedor
    </div>
    <div class="nav-item" onclick="showSection(this, 'agenda')">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      Pauta Semanal
    </div>
    <div class="nav-item" onclick="showSection(this, 'ml')">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="2"/>
        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
      </svg>
      InteligÃªncia ML
    </div>
  </div>

  <!-- BotÃ£o Toggle Sidebar -->
  <button class="sidebar-toggle" onclick="toggleSidebar()" title="Expandir/Recolher Menu">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>

  <div class="main">
    <div class="header">
      <div class="timestamp" style="width: 100%; text-align: center;">
        <span id="quarter-label">-</span> | 
        Atualizado: <span id="last-update">-</span>
      </div>
    </div>
    
    <!-- BotÃ£o de Atualizar -->
    <button class="refresh-btn" onclick="refreshDashboard()" title="Atualizar Dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 28px; height: 28px;">
        <polyline points="23 4 23 10 17 10"/>
        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
      </svg>
    </button>

    <!-- ========== FILTROS GLOBAIS (TOPO) ========== -->
    <div id="filters-container" style="
      position: sticky; 
      top: 0; 
      z-index: 999;
      background: var(--glass-surface);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 20px 24px; 
      margin: 0 0 30px 0; 
      border-radius: 16px; 
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2), 0 0 40px rgba(0,190,255,0.1);
    ">
      
      <!-- Filtros RÃ¡pidos - FY26 Quarters -->
      <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;">
        <span style="font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; min-width: 80px;">FY26 Quick:</span>
        <button onclick="applyQuickFilter('2026', 'Q1')" style="padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(0,190,255,0.3); background: rgba(0,190,255,0.1); color: var(--primary-cyan); cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s; white-space: nowrap;" onmouseover="this.style.background='rgba(0,190,255,0.2)'; this.style.borderColor='var(--primary-cyan)'" onmouseout="this.style.background='rgba(0,190,255,0.1)'; this.style.borderColor='rgba(0,190,255,0.3)'">Q1 2026</button>
        <button onclick="applyQuickFilter('2026', 'Q2')" style="padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(0,190,255,0.3); background: rgba(0,190,255,0.1); color: var(--primary-cyan); cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s; white-space: nowrap;" onmouseover="this.style.background='rgba(0,190,255,0.2)'; this.style.borderColor='var(--primary-cyan)'" onmouseout="this.style.background='rgba(0,190,255,0.1)'; this.style.borderColor='rgba(0,190,255,0.3)'">Q2 2026</button>
        <button onclick="applyQuickFilter('2026', 'Q3')" style="padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(0,190,255,0.3); background: rgba(0,190,255,0.1); color: var(--primary-cyan); cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s; white-space: nowrap;" onmouseover="this.style.background='rgba(0,190,255,0.2)'; this.style.borderColor='var(--primary-cyan)'" onmouseout="this.style.background='rgba(0,190,255,0.1)'; this.style.borderColor='rgba(0,190,255,0.3)'">Q3 2026</button>
        <button onclick="applyQuickFilter('2026', 'Q4')" style="padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(0,190,255,0.3); background: rgba(0,190,255,0.1); color: var(--primary-cyan); cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s; white-space: nowrap;" onmouseover="this.style.background='rgba(0,190,255,0.2)'; this.style.borderColor='var(--primary-cyan)'" onmouseout="this.style.background='rgba(0,190,255,0.1)'; this.style.borderColor='rgba(0,190,255,0.3)'">Q4 2026</button>
        <button onclick="applyQuickFilter('2026', '')" style="padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(192,255,125,0.3); background: rgba(192,255,125,0.1); color: var(--accent-green); cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s; white-space: nowrap;" onmouseover="this.style.background='rgba(192,255,125,0.2)'; this.style.borderColor='var(--accent-green)'" onmouseout="this.style.background='rgba(192,255,125,0.1)'; this.style.borderColor='rgba(192,255,125,0.3)'">FY26 Full</button>
        <button onclick="clearAllFilters()" style="padding: 8px 16px; border-radius: 12px; border: 1px solid rgba(225,72,73,0.3); background: rgba(225,72,73,0.1); color: var(--danger); cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s; white-space: nowrap; margin-left: 8px;" onmouseover="this.style.background='rgba(225,72,73,0.2)'; this.style.borderColor='var(--danger)'" onmouseout="this.style.background='rgba(225,72,73,0.1)'; this.style.borderColor='rgba(225,72,73,0.3)'">âœ• Limpar</button>
      </div>
      
      <!-- Filtros Detalhados -->
      <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 16px;">
      
      <!-- Filtro por Quarter -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Quarter:
        </span>
        <select id="quarter-filter" onchange="syncQuarterMonth('quarter')" style="padding: 8px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #ffffff; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.12)'; this.style.borderColor='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(255,255,255,0.15)'">
          <option value="" selected style="background: #1a1d29; color: #ffffff;">Todos</option>
          <option value="Q1" style="background: #1a1d29; color: #ffffff;">Q1 (Jan-Mar)</option>
          <option value="Q2" style="background: #1a1d29; color: #ffffff;">Q2 (Abr-Jun)</option>
          <option value="Q3" style="background: #1a1d29; color: #ffffff;">Q3 (Jul-Set)</option>
          <option value="Q4" style="background: #1a1d29; color: #ffffff;">Q4 (Out-Dez)</option>
        </select>
      </div>
      
      <!-- Filtro por Vendedor (MULTI-SELECT) -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          Vendedor:
        </span>
        <div class="multi-select-container" id="seller-multi-select">
          <div class="multi-select-trigger" onclick="toggleSellerDropdown()">
            <span id="seller-selected-text">Todos os Vendedores</span>
          </div>
          <div class="multi-select-dropdown" id="seller-dropdown">
            <div class="multi-select-group" id="active-sellers-group">
              <div class="multi-select-group-title">ðŸŸ¢ Vendedores Ativos</div>
              <!-- Active sellers populated by JS -->
            </div>
            <div class="multi-select-group" id="historical-sellers-group">
              <div class="multi-select-group-title">ðŸ“œ Vendedores HistÃ³ricos</div>
              <!-- Historical sellers populated by JS -->
            </div>
            <div class="multi-select-actions">
              <button class="multi-select-btn" onclick="selectAllSellers()">Todos</button>
              <button class="multi-select-btn" onclick="selectActiveSellers()">Somente Ativos</button>
              <button class="multi-select-btn" onclick="clearAllSellers()">Limpar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtro por Ano -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Ano:
        </span>
        <select id="year-filter" onchange="reloadDashboard()" style="padding: 8px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #ffffff; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.12)'; this.style.borderColor='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(255,255,255,0.15)'">
          <option value="" selected style="background: #1a1d29; color: #ffffff;">Todos</option>
          <option value="2024" style="background: #1a1d29; color: #ffffff;">2024</option>
          <option value="2025" style="background: #1a1d29; color: #ffffff;">2025</option>
          <option value="2026" style="background: #1a1d29; color: #ffffff;">2026</option>
          <option value="2027" style="background: #1a1d29; color: #ffffff;">2027</option>
        </select>
      </div>
      
      <!-- Filtro por MÃªs -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line></svg>
          MÃªs:
        </span>
        <select id="month-filter" onchange="syncQuarterMonth('month')" style="padding: 8px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #ffffff; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.12)'; this.style.borderColor='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(255,255,255,0.15)'">
          <option value="" selected style="background: #1a1d29; color: #ffffff;">Todos</option>
          <option value="1" style="background: #1a1d29; color: #ffffff;">Janeiro</option>
          <option value="2" style="background: #1a1d29; color: #ffffff;">Fevereiro</option>
          <option value="3" style="background: #1a1d29; color: #ffffff;">MarÃ§o</option>
          <option value="4" style="background: #1a1d29; color: #ffffff;">Abril</option>
          <option value="5" style="background: #1a1d29; color: #ffffff;">Maio</option>
          <option value="6" style="background: #1a1d29; color: #ffffff;">Junho</option>
          <option value="7" style="background: #1a1d29; color: #ffffff;">Julho</option>
          <option value="8" style="background: #1a1d29; color: #ffffff;">Agosto</option>
          <option value="9" style="background: #1a1d29; color: #ffffff;">Setembro</option>
          <option value="10" style="background: #1a1d29; color: #ffffff;">Outubro</option>
          <option value="11" style="background: #1a1d29; color: #ffffff;">Novembro</option>
          <option value="12" style="background: #1a1d29; color: #ffffff;">Dezembro</option>
        </select>
      </div>

      <!-- Filtro por PerÃ­odo (Atividades na Pauta Semanal) -->
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          PerÃ­odo:
        </span>
        <input id="date-start-filter" type="date" onchange="reloadDashboard()" style="padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #ffffff; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;" />
        <span style="font-size: 12px; color: var(--text-muted);">atÃ©</span>
        <input id="date-end-filter" type="date" onchange="reloadDashboard()" style="padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #ffffff; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s;" />
      </div>
    </div>
    </div>

    <!-- SEÃ‡ÃƒO 0: VISÃƒO EXECUTIVA (NOVA) -->
    <div id="executive" class="section active">
      <!-- TABS DA VISÃƒO EXECUTIVA -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 0;">
        <button class="exec-tab active" data-tab="resumo" onclick="switchExecTab('resumo')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 12px 20px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 14px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;">
            <line x1="18" y1="20" x2="18" y2="10"/>
            <line x1="12" y1="20" x2="12" y2="4"/>
            <line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
          Resumo do Quarter
        </button>
        <button class="exec-tab" data-tab="mapas" onclick="switchExecTab('mapas')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 12px 20px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 14px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;">
            <circle cx="12" cy="12" r="3"/>
            <circle cx="19" cy="5" r="2"/>
            <circle cx="5" cy="5" r="2"/>
            <circle cx="19" cy="19" r="2"/>
            <circle cx="5" cy="19" r="2"/>
            <path d="M12 9v6m0-6l7-4M12 9L5 5m7 10l7 4m-7-4l-7 4"/>
          </svg>
          Mapa de Palavras
        </button>
        <button class="exec-tab" data-tab="oportunidades" onclick="switchExecTab('oportunidades')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 12px 20px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 14px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="6"/>
            <circle cx="12" cy="12" r="2"/>
          </svg>
          Principais Oportunidades
        </button>
        <button class="exec-tab" data-tab="guia" onclick="switchExecTab('guia')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 12px 20px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 14px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
          Como Interpretar
        </button>
      </div>

      <!-- TAB CONTENT: RESUMO -->
      <div class="exec-tab-content active" data-content="resumo">
      <!-- SEÃ‡ÃƒO 1: MÃ‰TRICAS DO QUARTER -->
      <h3>
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"/>
          <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        MÃ©tricas Principais
      </h3>
      <p style="color: var(--text-muted); font-size: 12px; margin: -5px 0 15px 0;">Onde estamos vs. onde queremos chegar</p>
      
      <!-- ========================================================================== -->
      <!-- SEÃ‡ÃƒO 1: PIPELINE ABERTO (Oportunidades em Andamento) -->
      <!-- ========================================================================== -->
      <h4 class="metric-section-header pipeline">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
          <polyline points="17 6 23 6 23 12"/>
        </svg>
        PIPELINE ABERTO
      </h4>
      <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div class="kpi-card" style="border-left: 4px solid var(--primary-cyan);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
            <line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
          <div class="kpi-title" style="color: var(--primary-cyan);">Pipeline Total</div>
          <div class="kpi-value" style="color: var(--primary-cyan); font-size: 28px;" id="exec-pipeline-year-total">-</div>
          <div class="kpi-subtitle" id="exec-pipeline-year-deals" style="font-size: 11px; line-height: 1.3;">- deals abertos</div>
          <div class="kpi-subtitle" id="exec-pipeline-year-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(16,185,129,0.12); color: var(--success); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--warning);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
            <polyline points="17 6 23 6 23 12"/>
          </svg>
          <div class="kpi-title" style="color: var(--warning);">Pipeline (PerÃ­odo Filtrado)</div>
          <div class="kpi-value" style="color: var(--warning); font-size: 28px;" id="exec-pipeline-total">-</div>
          <div class="kpi-subtitle" id="exec-pipeline-deals" style="font-size: 11px; line-height: 1.3;">- deals no perÃ­odo</div>
          <div class="kpi-subtitle" id="exec-pipeline-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(16,185,129,0.12); color: var(--success); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
          </svg>
          <div class="kpi-title">PrevisÃ£o Ponderada IA</div>
          <div class="kpi-value val-warning" id="exec-forecast-weighted">-</div>
          <div class="kpi-subtitle" id="exec-forecast-percent" style="font-size: 11px; line-height: 1.3;">-% confianÃ§a mÃ©dia</div>
          <div class="kpi-subtitle" id="exec-forecast-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(16,185,129,0.12); color: var(--success); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          <div class="kpi-title">Deals â‰¥50% ConfianÃ§a IA</div>
          <div class="kpi-value val-cyan" id="exec-above50-value">-</div>
          <div class="kpi-subtitle" id="exec-above50-count" style="font-size: 11px; line-height: 1.3;">- deals</div>
          <div class="kpi-subtitle" id="exec-above50-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(16,185,129,0.12); color: var(--success); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--warning);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <div class="kpi-title" style="color: var(--warning);">Dias Idle MÃ©dio</div>
          <div class="kpi-value val-warning" id="exec-idle-days-avg">-</div>
          <div class="kpi-subtitle" id="exec-idle-days-detail">dias sem atividade</div>
          <div class="kpi-subtitle" id="exec-idle-days-risk" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(251,191,36,0.12); color: var(--warning); border-radius: 4px; display: inline-block; font-weight: 600;">-</div>
        </div>
      </div>

      <!-- SaÃºde do Forecast (Barra Visual) - DENTRO DA SEÃ‡ÃƒO PIPELINE -->
      <div style="margin: 25px 0;">
        <h4 class="forecast-health-label">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
          SaÃºde do Forecast - AnÃ¡lise IA (Por Categoria Forecast SF)
        </h4>
        <div style="display: flex; gap: 8px; height: 40px; border-radius: 8px; overflow: hidden; background: var(--bg-card); box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
          <div id="forecast-commit-bar" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">-</div>
          <div id="forecast-upside-bar" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">-</div>
          <div id="forecast-pipeline-bar" style="background: linear-gradient(135deg, #00BEFF 0%, #0080AA 100%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">-</div>
          <div id="forecast-potencial-bar" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">-</div>
          <div id="forecast-omitido-bar" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">-</div>
        </div>
        <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 11px; flex-wrap: wrap;">
          <div style="display: flex; flex-direction: column; gap: 3px;">
            <span style="color: var(--success); font-weight: 600;">â— COMMIT: <span id="forecast-commit-value">-</span></span>
            <span id="forecast-commit-net" style="color: var(--success); font-size: 10px; margin-left: 18px; opacity: 0.8;">Net: -</span>
          </div>
          <div style="display: flex; flex-direction: column; gap: 3px;">
            <span style="color: var(--warning); font-weight: 600;">â— UPSIDE: <span id="forecast-upside-value">-</span></span>
            <span id="forecast-upside-net" style="color: var(--warning); font-size: 10px; margin-left: 18px; opacity: 0.8;">Net: -</span>
          </div>
          <div style="display: flex; flex-direction: column; gap: 3px;">
            <span style="color: var(--primary-cyan); font-weight: 600;">â— PIPELINE: <span id="forecast-pipeline-value">-</span></span>
            <span id="forecast-pipeline-net" style="color: var(--primary-cyan); font-size: 10px; margin-left: 18px; opacity: 0.8;">Net: -</span>
          </div>
          <div style="display: flex; flex-direction: column; gap: 3px;">
            <span style="color: var(--primary-purple); font-weight: 600;">â— POTENCIAL: <span id="forecast-potencial-value">-</span></span>
            <span id="forecast-potencial-net" style="color: var(--primary-purple); font-size: 10px; margin-left: 18px; opacity: 0.8;">Net: -</span>
          </div>
          <div style="display: flex; flex-direction: column; gap: 3px;">
            <span style="color: var(--danger); font-weight: 600;">â— OMITIDO: <span id="forecast-omitido-value">-</span></span>
            <span id="forecast-omitido-net" style="color: var(--danger); font-size: 10px; margin-left: 18px; opacity: 0.8;">Net: -</span>
          </div>
        </div>
      </div>

      <!-- ========================================================================== -->
      <!-- SEÃ‡ÃƒO 2: SALES SPECIALIST (Curadoria Manual) -->
      <!-- ========================================================================== -->
      <h4 class="metric-section-header sales-specialist">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        <svg class="icon"><use href="#icon-user"/></svg> SALES SPECIALIST (Curadoria Manual)
      </h4>
      <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div class="kpi-card" style="border-left: 4px solid var(--success);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <div class="kpi-title" style="color: var(--success);">Total Curado</div>
          <div class="kpi-value" style="color: var(--success); font-size: 28px;" id="exec-ss-total">-</div>
          <div class="kpi-subtitle" id="exec-ss-deals" style="font-size: 11px; line-height: 1.3;">- deals curados</div>
          <div class="kpi-subtitle" id="exec-ss-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(16,185,129,0.12); color: var(--success); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--warning);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <div class="kpi-title" style="color: var(--warning);">Taxa de Curadoria</div>
          <div class="kpi-value" style="color: var(--warning); font-size: 28px;" id="exec-ss-coverage">-</div>
          <div class="kpi-subtitle" id="exec-ss-coverage-deals" style="font-size: 11px; line-height: 1.3;">do pipeline total</div>
          <div class="kpi-subtitle" id="exec-ss-coverage-value" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(245,158,11,0.12); color: var(--warning); border-radius: 4px; display: inline-block; font-weight: 600;">-% do valor</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--primary-cyan);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"/>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
          <div class="kpi-title" style="color: var(--primary-cyan);">Ticket MÃ©dio</div>
          <div class="kpi-value" style="color: var(--primary-cyan); font-size: 28px;" id="exec-ss-ticket">-</div>
          <div class="kpi-subtitle" id="exec-ss-ticket-detail" style="font-size: 11px; line-height: 1.3;">mÃ©dia por deal</div>
          <div class="kpi-subtitle" id="exec-ss-ticket-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(0,190,255,0.12); color: var(--primary-cyan); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--primary-purple);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="8.5" cy="7" r="4"/>
            <polyline points="17 11 19 13 23 9"/>
          </svg>
          <div class="kpi-title" style="color: var(--primary-purple);">Top Vendedor</div>
          <div class="kpi-value" style="color: var(--primary-purple); font-size: 22px;" id="exec-ss-top-seller">-</div>
          <div class="kpi-subtitle" id="exec-ss-top-value" style="font-size: 11px; line-height: 1.3;">- curado</div>
          <div class="kpi-subtitle" id="exec-ss-top-deals" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(139,92,246,0.12); color: var(--primary-purple); border-radius: 4px; display: inline-block; font-weight: 600;">- deals</div>
        </div>
      </div>

      <!-- SaÃºde do Forecast - Sales Specialist -->
      <div style="margin: 25px 0;">
        <h4 class="forecast-health-label">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
          SaÃºde do Forecast - Por Categoria
        </h4>
        <div style="display: flex; gap: 8px; height: 40px; border-radius: 8px; overflow: hidden; background: var(--bg-card); box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
          <div id="forecast-ss-commit-bar" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">-</div>
          <div id="forecast-ss-upside-bar" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: white; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">-</div>
        </div>
        <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 11px; flex-wrap: wrap;">
          <div style="display: flex; flex-direction: column; gap: 3px;">
            <span style="color: var(--success); font-weight: 600;">â— COMMIT: <span id="forecast-ss-commit-value">-</span></span>
            <span id="forecast-ss-commit-net" style="color: var(--success); font-size: 10px; margin-left: 18px; opacity: 0.8;">Net: -</span>
          </div>
          <div style="display: flex; flex-direction: column; gap: 3px;">
            <span style="color: var(--warning); font-weight: 600;">â— UPSIDE: <span id="forecast-ss-upside-value">-</span></span>
            <span id="forecast-ss-upside-net" style="color: var(--warning); font-size: 10px; margin-left: 18px; opacity: 0.8;">Net: -</span>
          </div>
        </div>
      </div>

      <!-- ========================================================================== -->
      <!-- SEÃ‡ÃƒO 3: DEALS FECHADOS - GANHOS (Deals Ganhos) -->
      <!-- ========================================================================== -->
      <h4 class="metric-section-header won">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        <svg class="icon"><use href="#icon-check"/></svg> DEALS FECHADOS (GANHOS)
      </h4>
      <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div class="kpi-card" style="border-left: 4px solid var(--success);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          <div class="kpi-title" style="color: var(--success);">Deals Fechados</div>
          <div class="kpi-value val-green" id="exec-closed-total">-</div>
          <div class="kpi-subtitle" id="exec-closed-deals" style="font-size: 11px; line-height: 1.3;">- deals ganhos</div>
          <div class="kpi-subtitle" id="exec-closed-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(16,185,129,0.12); color: var(--success); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M16 12l-4-4-4 4M12 16V8"/>
          </svg>
          <div class="kpi-title">Taxa de Win</div>
          <div class="kpi-value val-cyan" id="exec-conversion-rate">-</div>
          <div class="kpi-subtitle" id="exec-conversion-detail">-</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--success);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <div class="kpi-title" style="color: var(--success);">Ciclo MÃ©dio (Ganhos)</div>
          <div class="kpi-value val-green" id="exec-won-cycle-days">-</div>
          <div class="kpi-subtitle">dias para fechar</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
          </svg>
          <div class="kpi-title">Atividades MÃ©dias</div>
          <div class="kpi-value val-cyan" id="exec-won-activities">-</div>
          <div class="kpi-subtitle" id="exec-won-activities-detail">atividades por deal ganho</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--primary-purple);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 11l3 3L22 4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          <div class="kpi-title" style="color: var(--primary-purple);">MEDDIC MÃ©dio</div>
          <div class="kpi-value" style="color: var(--primary-purple);" id="exec-won-meddic">-</div>
          <div class="kpi-subtitle" id="exec-won-meddic-detail">score de qualificaÃ§Ã£o</div>
        </div>
      </div>

      <!-- ========================================================================== -->
      <!-- SEÃ‡ÃƒO 4: DEALS PERDIDOS (Deals Perdidos) -->
      <!-- ========================================================================== -->
      <h4 class="metric-section-header lost">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        DEALS PERDIDOS
      </h4>
      <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div class="kpi-card" style="border-left: 4px solid var(--danger);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          <div class="kpi-title" style="color: var(--danger);">Deals Perdidos</div>
          <div class="kpi-value val-red" id="exec-lost-total">-</div>
          <div class="kpi-subtitle" id="exec-lost-deals" style="font-size: 11px; line-height: 1.3;">- deals perdidos</div>
          <div class="kpi-subtitle" id="exec-lost-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(225,72,73,0.12); color: var(--danger); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 12l4 4 4-4M12 8v8"/>
          </svg>
          <div class="kpi-title">Taxa de Perda</div>
          <div class="kpi-value val-red" id="exec-loss-rate">-</div>
          <div class="kpi-subtitle" id="exec-loss-detail">-</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--danger);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <div class="kpi-title" style="color: var(--danger);">Ciclo MÃ©dio (Perdas)</div>
          <div class="kpi-value val-red" id="exec-lost-cycle-days">-</div>
          <div class="kpi-subtitle">dias atÃ© perder</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--warning);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          <div class="kpi-title" style="color: var(--warning);">Perdas EvitÃ¡veis</div>
          <div class="kpi-value val-warning" id="exec-lost-evitavel-pct">-</div>
          <div class="kpi-subtitle" id="exec-lost-evitavel-count">- deals evitÃ¡veis</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          <div class="kpi-title">EficiÃªncia de Ciclo</div>
          <div class="kpi-value val-cyan" id="exec-cycle-efficiency">-</div>
          <div class="kpi-subtitle" id="exec-cycle-efficiency-detail">ganhos vs perdas</div>
        </div>
      </div>

      <!-- ========================================================================== -->
      <!-- ðŸ‘¥ SEÃ‡ÃƒO 5: PERFORMANCE DOS VENDEDORES -->
      <!-- ========================================================================== -->
      <h4 class="metric-section-header sellers">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        ðŸ‘¥ PERFORMANCE DOS VENDEDORES
      </h4>
      <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
        <div class="kpi-card" style="border-left: 4px solid var(--primary-purple);">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <div class="kpi-title" style="color: var(--primary-purple);">Vendedores Ativos</div>
          <div class="kpi-value" style="color: var(--primary-purple); font-size: 28px;" id="exec-sellers-active">-</div>
          <div class="kpi-subtitle" id="exec-sellers-total" style="font-size: 11px; line-height: 1.3;">de - vendedores</div>
          <div class="kpi-subtitle" id="exec-sellers-winrate" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(139,92,246,0.12); color: var(--primary-purple); border-radius: 4px; display: inline-block; font-weight: 600;">Win Rate: -</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
          <div class="kpi-title">Ticket MÃ©dio (Ganhos)</div>
          <div class="kpi-value val-cyan" id="exec-ticket-won">-</div>
          <div class="kpi-subtitle" id="exec-ticket-won-detail" style="font-size: 11px; line-height: 1.3;">por deal ganho</div>
          <div class="kpi-subtitle" id="exec-ticket-won-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(16,185,129,0.12); color: var(--success); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
          <div class="kpi-title">Ticket MÃ©dio (Perdidos)</div>
          <div class="kpi-value val-red" id="exec-ticket-lost">-</div>
          <div class="kpi-subtitle" id="exec-ticket-lost-detail" style="font-size: 11px; line-height: 1.3;">por deal perdido</div>
          <div class="kpi-subtitle" id="exec-ticket-lost-net" style="font-size: 11px; margin-top: 5px; padding: 3px 8px; background: rgba(225,72,73,0.12); color: var(--danger); border-radius: 4px; display: inline-block; font-weight: 600;">Net: -</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <div class="kpi-title">Ciclo MÃ©dio (Ganhos)</div>
          <div class="kpi-value val-cyan" id="exec-cycle-won">-</div>
          <div class="kpi-subtitle" id="exec-cycle-won-detail" style="font-size: 11px; line-height: 1.3;">dias para fechar</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <div class="kpi-title">Ciclo MÃ©dio (Perdidos)</div>
          <div class="kpi-value val-red" id="exec-cycle-lost">-</div>
          <div class="kpi-subtitle" id="exec-cycle-lost-detail" style="font-size: 11px; line-height: 1.3;">dias atÃ© perder</div>
        </div>
      </div>

      <!-- SEÃ‡ÃƒO 2: ANÃLISE ESTRATÃ‰GICA DA IA -->
      <div class="ai-card" style="margin-top: 30px;">
        <h2 style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
          </svg>
          <span style="flex: 1;">AnÃ¡lise EstratÃ©gica (IA)</span>
          <button id="executive-toggle" onclick="toggleExecutiveAnalysis()" style="background: none; border: 1px solid var(--glass-border); color: var(--text-gray); padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; gap: 6px;">
            <span id="executive-toggle-label">Ocultar</span>
            <span id="executive-toggle-caret" style="display: inline-block; transition: transform 0.2s ease;">v</span>
          </button>
        </h2>
        <div id="executive-content" class="ai-content">
          <div class="loading">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
              <polyline points="23 4 23 10 17 10"/>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
            </svg>
            Carregando anÃ¡lise executiva...
          </div>
        </div>
      </div>

      <!-- SEÃ‡ÃƒO 3: DESTAQUES OPERACIONAIS DO QUARTER -->
      <h3 style="margin-top: 40px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 16v-4M12 8h.01"/>
        </svg>
        Destaques Operacionais do Quarter
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">Onde focar a energia agora</p>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px;">
        <!-- Card 1: Oportunidade-Chave -->
        <div class="deal-card" style="border-left-color: var(--warning);">
          <div style="font-size: 10px; color: var(--warning); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">Oportunidade-Chave #1</div>
          <div class="deal-header">
            <div class="deal-name" id="exec-key-opp-name">-</div>
            <div class="deal-value" id="exec-key-opp-value">-</div>
          </div>
          <div class="deal-meta">
            <strong>Conta:</strong> <span id="exec-key-opp-account">-</span><br>
            <strong>Vendedor:</strong> <span id="exec-key-opp-owner">-</span><br>
            <strong>Por que Ã© principal:</strong> <span id="exec-key-opp-why">-</span><br>
            <strong>Principal Risco:</strong> <span id="exec-key-opp-risk" style="color: var(--danger);">-</span><br>
            <strong>AnÃ¡lise IA:</strong> <span id="exec-key-opp-ai" style="color: var(--text-gray); font-size: 11px;">-</span>
          </div>
        </div>

        <!-- Card 2: VitÃ³ria Destaque -->
        <div class="deal-card" style="border-left-color: var(--success);">
          <div style="font-size: 10px; color: var(--success); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
              <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
            </svg>
            VitÃ³ria Destaque
          </div>
          <div class="deal-header">
            <div class="deal-name" id="exec-top-win-name">-</div>
            <div class="deal-value" style="color: var(--success);" id="exec-top-win-value">-</div>
          </div>
          <div class="deal-meta">
            <strong>Conta:</strong> <span id="exec-top-win-account">-</span><br>
            <strong>Vendedor:</strong> <span id="exec-top-win-owner">-</span><br>
            <strong>Por que ganhamos:</strong> <span id="exec-top-win-why" style="color: var(--success);">-</span><br>
            <strong>AnÃ¡lise IA:</strong> <span id="exec-top-win-ai" style="color: var(--text-gray); font-size: 11px;">-</span>
          </div>
        </div>

        <!-- Card 3: Perda Destaque -->
        <div class="deal-card" style="border-left-color: var(--danger);">
          <div style="font-size: 10px; color: var(--danger); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-weight: 600;">Perda Destaque</div>
          <div class="deal-header">
            <div class="deal-name" id="exec-top-loss-name">-</div>
            <div class="deal-value" style="color: var(--danger);" id="exec-top-loss-value">-</div>
          </div>
          <div class="deal-meta">
            <strong>Conta:</strong> <span id="exec-top-loss-account">-</span><br>
            <strong>Vendedor:</strong> <span id="exec-top-loss-owner">-</span><br>
            <strong>Por que perdemos:</strong> <span id="exec-top-loss-why" style="color: var(--danger);">-</span><br>
            <strong>AnÃ¡lise IA:</strong> <span id="exec-top-loss-ai" style="color: var(--text-gray); font-size: 11px;">-</span>
          </div>
        </div>
      </div>

      <!-- SEÃ‡ÃƒO 4: DESTAQUES DA EQUIPE NO QUARTER -->
      <h3 style="margin-top: 40px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        Destaques da Equipe no Quarter
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">Quem estÃ¡ brilhando e quem precisa de ajuda</p>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
        <!-- Card: MVP do Quarter -->
        <div class="ai-card" style="background: linear-gradient(135deg, rgba(192,255,125,0.1) 0%, rgba(28,43,62,1) 100%); border-color: var(--success);">
          <h2 style="color: var(--success); font-size: 16px;">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            MVP do Quarter
          </h2>
          <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--success), var(--primary-cyan)); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; color: var(--bg-dark);" id="exec-mvp-initial">-</div>
            <div style="flex: 1;">
              <div style="font-size: 18px; font-weight: 700; color: var(--text-white); margin-bottom: 5px;" id="exec-mvp-name">-</div>
              <div style="font-size: 13px; color: var(--text-gray); line-height: 1.6;" id="exec-mvp-reason">-</div>
            </div>
          </div>
        </div>

        <!-- Card: Ponto de AtenÃ§Ã£o -->
        <div class="ai-card" style="background: linear-gradient(135deg, rgba(225,72,73,0.1) 0%, rgba(28,43,62,1) 100%); border-color: var(--danger);">
          <h2 style="color: var(--danger); font-size: 16px;">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Ponto de AtenÃ§Ã£o
          </h2>
          <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--danger), var(--warning)); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; color: var(--bg-dark);" id="exec-attention-initial">-</div>
            <div style="flex: 1;">
              <div style="font-size: 18px; font-weight: 700; color: var(--text-white); margin-bottom: 5px;" id="exec-attention-name">-</div>
              <div style="font-size: 13px; color: var(--text-gray); line-height: 1.6;" id="exec-attention-reason">-</div>
            </div>
          </div>
        </div>
      </div>

      </div><!-- FIM TAB RESUMO -->

      <!-- TAB CONTENT: MAPA DE PALAVRAS -->
      <div class="exec-tab-content" data-content="mapas" style="display: none;">
      
      <!-- SEÃ‡ÃƒO 6: MAPA DE FLAGS DE RISCO -->
      <h3 style="margin-top: 0;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        Flags de Risco do Pipeline
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">Principais alertas e padrÃµes de risco identificados</p>
      
      <div id="exec-risk-flags-container" class="ai-card" style="padding: 20px;">
        <div class="loading">Processando flags de risco...</div>
      </div>

      <!-- SEÃ‡ÃƒO 7: LABELS DE AÃ‡ÃƒO DO PIPELINE -->
      <h3 style="margin-top: 30px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          <path d="M9 12h6m-6 4h6"/>
        </svg>
        Labels de AÃ§Ã£o do Pipeline
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">AÃ§Ãµes prioritÃ¡rias recomendadas pela IA para acelerar fechamento</p>
      
      <div id="exec-action-labels-container" class="ai-card" style="padding: 20px;">
        <div class="loading">Processando labels de aÃ§Ã£o...</div>
      </div>

      <!-- SEÃ‡ÃƒO 8: PERFIL DE VITÃ“RIAS -->
      <h3 style="margin-top: 30px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        Perfil de VitÃ³rias
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">CategorizaÃ§Ã£o dos tipos de deals ganhos</p>
      
      <div id="exec-win-types-container" class="ai-card" style="padding: 20px;">
        <div class="loading">Processando perfil de vitÃ³rias...</div>
      </div>

      <!-- SEÃ‡ÃƒO 9: PERFIL DE PERDAS -->
      <h3 style="margin-top: 30px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        Perfil de Perdas
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">CategorizaÃ§Ã£o dos tipos de deals perdidos</p>
      
      <div id="exec-loss-types-container" class="ai-card" style="padding: 20px;">
        <div class="loading">Processando perfil de perdas...</div>
      </div>

      <!-- SEÃ‡ÃƒO 10: PADRÃ•ES DE SUCESSO -->
      <h3 style="margin-top: 30px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        PadrÃµes de Sucesso
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">Tags e caracterÃ­sticas comuns em vitÃ³rias</p>
      
      <div id="exec-win-labels-container" class="ai-card" style="padding: 20px;">
        <div class="loading">Processando padrÃµes de sucesso...</div>
      </div>

      <!-- SEÃ‡ÃƒO 11: PADRÃ•ES DE PERDA -->
      <h3 style="margin-top: 30px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        PadrÃµes de Perda
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">Tags e caracterÃ­sticas comuns em perdas</p>
      
      <div id="exec-loss-labels-container" class="ai-card" style="padding: 20px;">
        <div class="loading">Processando padrÃµes de perda...</div>
      </div>

      <!-- SEÃ‡ÃƒO 12: AI INSIGHTS -->
      <h3 style="margin-top: 30px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
        </svg>
        AI Insights
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">AnÃ¡lise avanÃ§ada de padrÃµes com Machine Learning</p>
      
      <div id="ai-insights-container" class="ai-card" style="padding: 20px;">
        <div class="loading">Processando insights...</div>
      </div>

      </div><!-- FIM TAB MAPA DE PALAVRAS -->

      <!-- TAB CONTENT: PRINCIPAIS OPORTUNIDADES -->
      <div class="exec-tab-content" data-content="oportunidades" style="display: none;">
        <h3>
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          Principais Oportunidades
        </h3>
        <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">Top 5 por status (Abertas, Ganhas, Perdidas) com insights e recomendacoes</p>

        <div class="exec-top-opps-tabs" style="display: flex; gap: 10px; margin: 10px 0 18px 0; flex-wrap: wrap;">
          <button class="top-opps-tab active" data-top-opps-tab="open" onclick="switchTopOppsTab('open')" style="padding: 8px 14px; border-radius: 999px; border: 1px solid rgba(0,190,255,0.35); background: rgba(0,190,255,0.22); color: #00BEFF; font-weight: 700; cursor: pointer;">Abertas</button>
          <button class="top-opps-tab" data-top-opps-tab="won" onclick="switchTopOppsTab('won')" style="padding: 8px 14px; border-radius: 999px; border: 1px solid rgba(16,185,129,0.35); background: rgba(16,185,129,0.16); color: #10b981; font-weight: 700; cursor: pointer;">Ganhas</button>
          <button class="top-opps-tab" data-top-opps-tab="lost" onclick="switchTopOppsTab('lost')" style="padding: 8px 14px; border-radius: 999px; border: 1px solid rgba(239,68,68,0.35); background: rgba(239,68,68,0.16); color: #ef4444; font-weight: 700; cursor: pointer;">Perdidas</button>
        </div>
        
        <!-- AnÃ¡lise de IA das Principais Oportunidades -->
        <div class="ai-card" style="margin-bottom: 25px;">
          <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleAIAnalysis()">
            <h2 style="font-size: 16px; margin: 0;">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
              </svg>
              VisÃ£o EstratÃ©gica das Principais Oportunidades (IA)
            </h2>
            <svg id="ai-analysis-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; transition: transform 0.3s;">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div id="exec-top-opps-ai-analysis" class="ai-content" style="margin-top: 15px;">
            <div class="loading">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                <polyline points="23 4 23 10 17 10"/>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
              </svg>
              Analisando principais oportunidades...
            </div>
          </div>
        </div>

        <div id="exec-top5-note" style="display: none; color: var(--text-muted); font-size: 12px; margin: -5px 0 12px 0;"></div>

        <!-- Card Indicador: Total das Principais Oportunidades -->
        <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 25px;">
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <div class="kpi-title">Valor Total Top 5</div>
            <div class="kpi-value val-warning" id="exec-top5-total">-</div>
            <div class="kpi-subtitle" id="exec-top5-percent">-% do pipeline total</div>
          </div>
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="16"/>
              <line x1="8" y1="12" x2="16" y2="12"/>
            </svg>
            <div class="kpi-title">ConfianÃ§a MÃ©dia Top 5</div>
            <div class="kpi-value val-cyan" id="exec-top5-confidence">-</div>
            <div class="kpi-subtitle" id="exec-top5-deals">5 deals</div>
          </div>
        </div>

        <div id="exec-top5-summary" class="ai-card" style="margin-bottom: 20px; padding: 16px;">
          <div class="loading">Gerando resumo executivo...</div>
        </div>

        <div id="exec-top-opps-container"></div>
      </div><!-- FIM TAB OPORTUNIDADES -->

      <!-- TAB CONTENT: GUIA DE INTERPRETAÃ‡ÃƒO -->
      <div class="exec-tab-content" data-content="guia" style="display: none;">
        <h3>
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          Como Interpretar as MÃ©tricas da VisÃ£o Executiva
        </h3>
        <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 20px 0;">Guia completo para entender cada indicador</p>
        
        <div style="display: grid; gap: 20px;">
          <div class="ai-card">
            <h4 style="color: var(--primary-cyan); margin: 0 0 8px 0; font-size: 14px;">Pipeline Total</h4>
            <p style="margin: 0; color: var(--text-gray); font-size: 13px; line-height: 1.6;">
              Soma de todos os deals <strong>abertos</strong> no quarter atual. Representa o potencial mÃ¡ximo de revenue se todos fecharem.
            </p>
          </div>
          <div class="ai-card">
            <h4 style="color: var(--primary-cyan); margin: 0 0 8px 0; font-size: 14px;">âš¡ PrevisÃ£o Ponderada IA</h4>
            <p style="margin: 0; color: var(--text-gray); font-size: 13px; line-height: 1.6;">
              Valor mÃ©dio esperado de fechamento baseado na <strong>mÃ©dia de confianÃ§a IA</strong> de todos os deals. Calculado como: <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">Pipeline Total Ã— (ConfianÃ§a MÃ©dia %)</code>. 
              <br><br><strong>Exemplo:</strong> Se o pipeline Ã© $1M e a confianÃ§a mÃ©dia Ã© 60%, a previsÃ£o ponderada Ã© $600k.
            </p>
          </div>
          <div class="ai-card">
            <h4 style="color: var(--primary-cyan); margin: 0 0 8px 0; font-size: 14px;">Deals â‰¥50% ConfianÃ§a IA</h4>
            <p style="margin: 0; color: var(--text-gray); font-size: 13px; line-height: 1.6;">
              Valor total e quantidade de oportunidades com <strong>50% ou mais de confianÃ§a IA</strong> de fechar. Representa o pipeline com maior chance real de conversÃ£o. <strong>Adaptativo ao filtro:</strong> recalcula com base no perÃ­odo selecionado (all, FY26, Q1-Q4).
            </p>
          </div>
          <div class="ai-card">
            <h4 style="color: var(--success); margin: 0 0 8px 0; font-size: 14px;">COMMIT (â‰¥90% confianÃ§a)</h4>
            <p style="margin: 0; color: var(--text-gray); font-size: 13px; line-height: 1.6;">
              Deals com altÃ­ssima probabilidade de fechar. Normalmente prÃ³ximos de assinatura, com obstÃ¡culos jÃ¡ resolvidos.
            </p>
          </div>
          <div class="ai-card">
            <h4 style="color: var(--warning); margin: 0 0 8px 0; font-size: 14px;">UPSIDE (70-89% confianÃ§a)</h4>
            <p style="margin: 0; color: var(--text-gray); font-size: 13px; line-height: 1.6;">
              Oportunidades bem qualificadas e avanÃ§adas, mas com algum risco. Requerem acompanhamento ativo.
            </p>
          </div>
          <div class="ai-card">
            <h4 style="color: var(--primary-cyan); margin: 0 0 8px 0; font-size: 14px;">PIPELINE (<70% confianÃ§a)</h4>
            <p style="margin: 0; color: var(--text-gray); font-size: 13px; line-height: 1.6;">
              Deals em estÃ¡gio inicial ou com incertezas significativas. Precisam de trabalho para avanÃ§ar.
            </p>
          </div>
          <div class="ai-card">
            <h4 style="color: var(--primary-cyan); margin: 0 0 8px 0; font-size: 14px;">Taxa de ConversÃ£o</h4>
            <p style="margin: 0; color: var(--text-gray); font-size: 13px; line-height: 1.6;">
              Percentual de deals <strong>ganhos</strong> vs. total de deals <strong>fechados</strong> (ganhos + perdidos). Indica efetividade do time em converter oportunidades.
            </p>
          </div>
        </div>
      </div><!-- FIM TAB GUIA -->
    </div><!-- FIM EXECUTIVE SECTION -->

    <!-- SEÃ‡ÃƒO: INDICADORES L10 -->
    <div id="dashboard" class="section">
      <div class="ai-card">
        <h2>
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
          </svg>
          AnÃ¡lise do CRO (IA)
        </h2>
        <div id="ai-content" class="ai-content">
          <div class="loading">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
              <polyline points="23 4 23 10 17 10"/>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
            </svg>
            Carregando inteligÃªncia...
          </div>
        </div>
      </div>

      <h3>
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M9 9h6M9 15h6"/>
        </svg>
        Indicadores L10 (Semana Anterior)
      </h3>
      <p style="color: var(--text-gray); font-size: 12px; margin: -5px 0 15px 0;">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
        PerÃ­odo: Segunda a Sexta da semana anterior | Base: Oportunidades fechadas (Ganhas)
      </p>
      <div class="kpi-grid">
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"/>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
          <div class="kpi-title">Net Revenue Incr.</div>
          <div class="kpi-value val-green" id="kpi-net">-</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
          <div class="kpi-title">Bookings Incr.</div>
          <div class="kpi-value val-cyan" id="kpi-bookings-gross">-</div>
          <div class="kpi-subtitle" id="kpi-bookings-count">- deals</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          <div class="kpi-title">Pipeline PrÃ³x. Semana</div>
          <div class="kpi-value val-cyan" id="kpi-next-week">-</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
            <polyline points="17 6 23 6 23 12"/>
          </svg>
          <div class="kpi-title">Pipeline Quarter Atual</div>
          <div class="kpi-value val-cyan" id="kpi-quarter">-</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <div class="kpi-title">Aging Pipeline (>90d)</div>
          <div class="kpi-value val-red" id="kpi-aging">-</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M16 12l-4-4-4 4M12 16V8"/>
          </svg>
          <div class="kpi-title">Previsibilidade (Weighted)</div>
          <div class="kpi-value val-cyan" id="kpi-predictable">-</div>
        </div>
      </div>

      <h3>Margem MÃ©dia por Categoria (Bookings)</h3>
      <div class="margin-grid" id="margin-container"></div>
    </div>

    <!-- SEÃ‡ÃƒO: APRENDIZADOS -->
    <div id="aprendizados" class="section">
      <h3>
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <use href="#icon-sparkles"/>
        </svg>
        Aprendizados das VitÃ³rias
      </h3>
      <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom: 20px;">
        <div class="kpi-card" style="border-left: 4px solid var(--success);">
          <div class="kpi-title">VitÃ³rias</div>
          <div class="kpi-value val-green" id="insights-wins-count">-</div>
          <div class="kpi-subtitle" id="insights-wins-avg">-</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--danger);">
          <div class="kpi-title">Perdas</div>
          <div class="kpi-value val-red" id="insights-losses-count">-</div>
          <div class="kpi-subtitle" id="insights-losses-avg">-</div>
        </div>
        <div class="kpi-card" style="border-left: 4px solid var(--primary-cyan);">
          <div class="kpi-title">Pipeline</div>
          <div class="kpi-value val-cyan" id="insights-pipeline-count">-</div>
          <div class="kpi-subtitle" id="insights-total-count">-</div>
        </div>
      </div>
      <div class="ai-card">
        <div id="wins-insights-content" class="ai-content">
          <div class="loading">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
              <use href="#icon-refresh"/>
            </svg>
            Analisando padrÃµes de sucesso...
          </div>
        </div>
      </div>

      <h3 style="margin-top: 40px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <use href="#icon-alert"/>
        </svg>
        Insights de Melhorias (Perdas)
      </h3>
      <div class="ai-card">
        <div id="loss-insights-content" class="ai-content">
          <div class="loading">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
              <use href="#icon-refresh"/>
            </svg>
            Analisando causas de perda...
          </div>
        </div>
      </div>

      <h4 style="margin-top: 30px;">RecomendaÃ§Ãµes</h4>
      <div id="insights-recommendations"></div>
    </div>

    <!-- SEÃ‡ÃƒO 2: PERFORMANCE FSR -->
    <div id="fsr" class="section">
      <!-- Como Interpretar o IPV (ColapsÃ¡vel) -->
      <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 8px; margin-bottom: 32px; border: 1px solid rgba(148, 163, 184, 0.2); overflow: hidden;">
        <!-- Header ClicÃ¡vel -->
        <div onclick="document.getElementById('ipv-guide-content').classList.toggle('collapsed'); this.querySelector('.chevron-icon').classList.toggle('rotated');" 
             style="padding: 16px 20px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; user-select: none; transition: background 0.2s;"
             onmouseover="this.style.background='rgba(148, 163, 184, 0.1)'" 
             onmouseout="this.style.background='transparent'">
          <div style="display: flex; align-items: center; gap: 12px;">
            <svg style="width: 20px; height: 20px; flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <span style="color: #e2e8f0; font-weight: 600; font-size: 15px;">Como Interpretar o IPV (Ãndice de Performance do Vendedor)</span>
          </div>
          <svg class="chevron-icon" style="width: 20px; height: 20px; transition: transform 0.3s; flex-shrink: 0;" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </div>
        
        <!-- ConteÃºdo (Colapsado por PadrÃ£o) -->
        <div id="ipv-guide-content" class="collapsed" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
          <div style="padding: 0 20px 20px 20px;">
            <p style="color: #cbd5e1; margin: 0 0 16px 0; line-height: 1.6; font-size: 14px;">
              O IPV Ã© uma mÃ©trica <strong style="color: #f1f5f9;">balanceada</strong> que avalia performance sob 3 pilares complementares:
            </p>
            
            <!-- Grid de Pilares -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-bottom: 16px;">
              <!-- Resultado -->
              <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 16px; border-radius: 6px; border-left: 3px solid #fbbf24;">
                <div style="color: #fbbf24; font-weight: 700; margin-bottom: 8px; font-size: 13px; letter-spacing: 0.5px;">RESULTADO (40%)</div>
                <div style="color: #e2e8f0; font-size: 13px; line-height: 1.5;">
                  <strong>75% NET + 25% Deals.</strong> Prioriza valor NET financeiro gerado sobre quantidade.
                </div>
              </div>
              
              <!-- EficiÃªncia -->
              <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 16px; border-radius: 6px; border-left: 3px solid #10b981;">
                <div style="color: #10b981; font-weight: 700; margin-bottom: 8px; font-size: 13px; letter-spacing: 0.5px;">EFICIÃŠNCIA (35%)</div>
                <div style="color: #e2e8f0; font-size: 13px; line-height: 1.5;">
                  Win rate, ciclo de vendas e produtividade (deals/perÃ­odo). Premia eficÃ¡cia.
                </div>
              </div>
              
              <!-- Comportamento -->
              <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 16px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                <div style="color: #3b82f6; font-weight: 700; margin-bottom: 8px; font-size: 13px; letter-spacing: 0.5px;">COMPORTAMENTO (25%)</div>
                <div style="color: #e2e8f0; font-size: 13px; line-height: 1.5;">
                  Qualidade da execuÃ§Ã£o: atividades, qualificaÃ§Ã£o, causas de perda. Penaliza mÃ¡ qualificaÃ§Ã£o.
                </div>
              </div>
            </div>
            
            <!-- Nota Importante -->
            <div style="background: rgba(251, 191, 36, 0.1); padding: 14px; border-radius: 6px; border-left: 3px solid #fbbf24;">
              <div style="color: #fbbf24; font-weight: 700; margin-bottom: 8px; font-size: 13px; letter-spacing: 0.5px;">IMPORTANTE</div>
              <div style="color: #e2e8f0; font-size: 13px; line-height: 1.6;">
                O IPV <strong style="color: #f1f5f9;">prioriza NET</strong> (75% do pilar Resultado), mas tambÃ©m considera eficiÃªncia e processo. 
                Um vendedor pode ter IPV alto mesmo com menos NET se compensar com: (1) win rate muito superior, (2) ciclo mais curto, ou (3) zero abandono/mÃ¡ qualificaÃ§Ã£o.
              </div>
              <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(251, 191, 36, 0.2);">
                <div style="color: #cbd5e1; font-size: 12px;">
                  <strong style="color: #fbbf24;">FÃ³rmula Resultado:</strong> (NET Ã— 0.75) + (Deals Ã— 0.25) â€” NET pesa 3x mais que quantidade.
                </div>
                <div style="color: #94a3b8; font-size: 12px; margin-top: 4px;">
                  Para anÃ¡lise completa de Gross/Net, consulte o <strong style="color: #cbd5e1;">Scorecard abaixo</strong>.
                </div>
                <div style="color: #ef4444; font-size: 12px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(239, 68, 68, 0.2);">
                  <strong style="color: #ef4444;">âš ï¸ Regra de NegÃ³cio:</strong> Vendedor com NET â‰¤ 0 tem IPV limitado a 20 (nÃ£o pode rankear acima de quem gera resultado positivo).
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <style>
        #ipv-guide-content.collapsed {
          max-height: 0 !important;
        }
        #ipv-guide-content:not(.collapsed) {
          max-height: 800px !important;
        }
        .chevron-icon.rotated {
          transform: rotate(180deg);
        }
      </style>

      <!-- Ranking Geral de Performance (IPV) -->
      <h3>
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        Ranking Geral de Performance (IPV)
      </h3>
      <p style="color: var(--text-gray); margin-bottom: 20px;">
        Ãndice de Performance do Vendedor (0-100) baseado em Resultado (40%), EficiÃªncia (35%) e Comportamento (25%)
      </p>
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Vendedor</th>
            <th>IPV (0-100)</th>
            <th>Resultado</th>
            <th>EficiÃªncia</th>
            <th>Comportamento</th>
            <th>Win Rate</th>
            <th>Net Gerado</th>
          </tr>
        </thead>
        <tbody id="fsr-ipv-table">
          <tr><td colspan="8" style="text-align:center;color:var(--text-gray);padding:40px;">Carregando dados...</td></tr>
        </tbody>
      </table>

      <!-- Scorecard de Performance -->
      <h3 style="margin-top: 40px;">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M9 9h6M9 15h6"/>
        </svg>
        Scorecard de Performance - Vendedores Ativos
      </h3>
      <table>
        <thead>
          <tr>
            <th>Vendedor</th>
            <th>Win Rate</th>
            <th>Total Ganhos</th>
            <th>Total Perdas</th>
            <th>Ciclo MÃ©dio (Win)</th>
            <th>Ciclo MÃ©dio (Loss)</th>
            <th>Ticket MÃ©dio (Gross)</th>
            <th>Gross Gerado</th>
            <th>Net Gerado</th>
          </tr>
        </thead>
        <tbody id="fsr-performance-active-body">
          <tr><td colspan="9" style="text-align:center;color:var(--text-gray);padding:40px;">Carregando dados...</td></tr>
        </tbody>
      </table>

      <!-- DiagnÃ³stico de Comportamento -->
      <h3 style="margin-top: 40px;">DiagnÃ³stico de Comportamento - Vendedores Ativos</h3>
      <table>
        <thead>
          <tr>
            <th>Vendedor</th>
            <th>Ativ. MÃ©dias (Win)</th>
            <th>Ativ. MÃ©dias (Loss)</th>
            <th>Principal Causa de Perda</th>
            <th>Principal Fator de Sucesso</th>
          </tr>
        </thead>
        <tbody id="fsr-behavior-active-body">
          <tr><td colspan="5" style="text-align:center;color:var(--text-gray);padding:40px;">Carregando dados...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- SEÃ‡ÃƒO 4: POR VENDEDOR (NOVA - DRILL-DOWN) -->
    <div id="individual" class="section">
      <h3><svg class="icon"><use href="#icon-user"/></svg> Performance Individual por Vendedor</h3>
      <p style="color: var(--text-gray); margin-bottom: 20px;">AnÃ¡lise detalhada de mÃ©tricas, tendÃªncias e comparaÃ§Ãµes entre vendedores</p>
      
      <!-- Seletor de Vendedor -->
      <div style="margin-bottom: 24px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
        <select id="rep-selector" onchange="showRepDetails()" style="
          padding: 12px 16px; 
          background: var(--glass-surface); 
          color: var(--text-white); 
          border: 1px solid var(--glass-border); 
          border-radius: 12px; 
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          flex: 1;
          min-width: 300px;
          max-width: 500px;
          backdrop-filter: blur(16px);
          -webkit-backdrop-filter: blur(16px);
        ">
          <option value="">-- Selecione um vendedor --</option>
        </select>
        
        <button onclick="loadSellersComparison()" style="
          padding: 12px 20px; 
          background: var(--glass-surface); 
          color: var(--primary-cyan); 
          border: 1px solid var(--glass-border); 
          border-radius: 12px; 
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          backdrop-filter: blur(16px);
          -webkit-backdrop-filter: blur(16px);
        " onmouseover="this.style.background='rgba(0,190,255,0.1)'" onmouseout="this.style.background='var(--glass-surface)'">
          <svg class="icon"><use href="#icon-chart"/></svg> Comparar Todos
        </button>
      </div>

      <!-- Container de ComparaÃ§Ã£o (todos vendedores) -->
      <div id="sellers-comparison" style="display: none;">
        <h4 class="metric-section-header sellers">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          ComparaÃ§Ã£o entre Vendedores
        </h4>
        
        <!-- Grid de Cards de Vendedores -->
        <div id="sellers-grid" class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));"></div>
        
        <!-- Ranking e GrÃ¡ficos -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 24px;">
          <div class="ai-card">
            <h4 style="margin: 0 0 16px 0; color: var(--primary-cyan);"><svg class="icon"><use href="#icon-trophy"/></svg> Ranking por Win Rate</h4>
            <div id="ranking-winrate" style="font-size: 13px; line-height: 1.8;"></div>
          </div>
          <div class="ai-card">
            <h4 style="margin: 0 0 16px 0; color: var(--success);"><svg class="icon"><use href="#icon-money"/></svg> Ranking por Revenue</h4>
            <div id="ranking-revenue" style="font-size: 13px; line-height: 1.8;"></div>
          </div>
        </div>
      </div>

      <!-- Detalhes do Vendedor Selecionado -->
      <div id="rep-details" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4 id="rep-name-title" style="margin: 0; font-size: 24px; color: var(--primary-cyan);"></h4>
          <div id="rep-period-badge" style="padding: 8px 16px; background: rgba(0,190,255,0.1); border: 1px solid var(--primary-cyan); border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--primary-cyan);">
            <!-- PerÃ­odo serÃ¡ preenchido por JS -->
          </div>
        </div>
        
        <!-- IPV Card Destacado -->
        <div class="ai-card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(0,190,255,0.1) 0%, rgba(0,255,200,0.1) 100%); border: 2px solid var(--primary-cyan);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h4 style="margin: 0; color: var(--primary-cyan); font-size: 18px;">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
              </svg>
              Ãndice de Performance do Vendedor (IPV)
            </h4>
            <div id="rep-rank-badge" style="padding: 6px 16px; background: rgba(0,190,255,0.2); border-radius: 20px; font-size: 13px; font-weight: 700; color: var(--primary-cyan);">
              -
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items: center;">
            <!-- IPV Score Grande -->
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 56px; font-weight: 900; color: var(--primary-cyan); line-height: 1;" id="rep-ipv-score">-</div>
              <div style="font-size: 13px; color: var(--text-gray); margin-top: 8px; font-weight: 600;">SCORE IPV</div>
            </div>
            
            <!-- Breakdown por Pilar -->
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid var(--warning);">
                <div>
                  <div style="font-size: 12px; color: var(--text-gray);">Resultado (40%)</div>
                  <div style="font-size: 11px; color: var(--text-gray); opacity: 0.7;">NET + Deals</div>
                </div>
                <div style="font-size: 20px; font-weight: 700; color: var(--warning);" id="rep-ipv-resultado">-</div>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid var(--success);">
                <div>
                  <div style="font-size: 12px; color: var(--text-gray);">EficiÃªncia (35%)</div>
                  <div style="font-size: 11px; color: var(--text-gray); opacity: 0.7;">Win Rate + Ciclo</div>
                </div>
                <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="rep-ipv-eficiencia">-</div>
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid var(--primary-cyan);">
                <div>
                  <div style="font-size: 12px; color: var(--text-gray);">Comportamento (25%)</div>
                  <div style="font-size: 11px; color: var(--text-gray); opacity: 0.7;">Atividades + Qualidade</div>
                </div>
                <div style="font-size: 20px; font-weight: 700; color: var(--primary-cyan);" id="rep-ipv-comportamento">-</div>
              </div>
            </div>
          </div>
          
          <!-- NET Gate Warning (condicional) -->
          <div id="rep-net-gate-warning" style="display: none; margin-top: 16px; padding: 12px 16px; background: rgba(255,80,80,0.1); border-left: 4px solid var(--danger); border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <svg class="icon" style="color: var(--danger);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
              <div>
                <div style="font-size: 13px; font-weight: 700; color: var(--danger);">NET Gate Ativado</div>
                <div style="font-size: 12px; color: var(--text-gray); margin-top: 2px;">
                  NET â‰¤ 0 limita o IPV ao mÃ¡ximo de 20. Priorize deals com rentabilidade positiva.
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- KPI Cards -->
        <h4 class="metric-section-header sellers">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          Indicadores de Performance
        </h4>
        <div class="kpi-grid">
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M16 12l-4-4-4 4M12 16V8"/>
            </svg>
            <div class="kpi-title">Win Rate</div>
            <div class="kpi-value" id="rep-winrate">-</div>
            <div class="kpi-subtitle" id="rep-winrate-detail">-</div>
          </div>
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            <div class="kpi-title">Deals Ganhos</div>
            <div class="kpi-value val-green" id="rep-wins">-</div>
            <div class="kpi-subtitle" id="rep-wins-detail">-</div>
          </div>
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            <div class="kpi-title">Deals Perdidos</div>
            <div class="kpi-value val-red" id="rep-losses">-</div>
            <div class="kpi-subtitle" id="rep-losses-detail">-</div>
          </div>
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"/>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
            <div class="kpi-title">Revenue Gerado</div>
            <div class="kpi-value val-cyan" id="rep-revenue">-</div>
            <div class="kpi-subtitle" id="rep-revenue-detail">-</div>
          </div>
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            <div class="kpi-title">Ciclo MÃ©dio (Win)</div>
            <div class="kpi-value val-green" id="rep-cycle-win">-</div>
            <div class="kpi-subtitle">deals fechados</div>
          </div>
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
              <polyline points="17 18 23 18 23 12"/>
            </svg>
            <div class="kpi-title">Ciclo MÃ©dio (Loss)</div>
            <div class="kpi-value val-red" id="rep-cycle-loss">-</div>
            <div class="kpi-subtitle">deals perdidos</div>
          </div>
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <path d="M9 9h6M9 15h6"/>
            </svg>
            <div class="kpi-title">Ticket MÃ©dio</div>
            <div class="kpi-value val-cyan" id="rep-avg-ticket">-</div>
            <div class="kpi-subtitle" id="rep-ticket-detail">por deal ganho</div>
          </div>
          <div class="kpi-card">
            <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 20V10M12 20V4M6 20v-6"/>
            </svg>
            <div class="kpi-title">Pipeline Ativo</div>
            <div class="kpi-value val-cyan" id="rep-pipeline">-</div>
            <div class="kpi-subtitle" id="rep-pipeline-detail">-</div>
          </div>
        </div>

        <!-- Performance Temporal -->
        <h4 class="metric-section-header sellers" style="margin-top: 32px;">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <polyline points="5 12 12 5 19 12"/>
          </svg>
          EvoluÃ§Ã£o Temporal (por Quarter)
        </h4>
        <div id="rep-timeline" class="ai-card">
          <div class="loading" style="text-align: center; padding: 20px;"><svg class="icon"><use href="#icon-chart"/></svg> Carregando dados temporais...</div>
        </div>

        <!-- DiagnÃ³stico e Insights -->
        <h4 class="metric-section-header sellers" style="margin-top: 32px;">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          DiagnÃ³stico Comportamental & Insights
        </h4>
        <div class="ai-card">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px;">
            <div>
              <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px; font-weight: 600;"><svg class="icon"><use href="#icon-sparkles"/></svg> Principal Fator de Sucesso</div>
              <div style="font-size: 15px; color: var(--success); font-weight: 600;" id="rep-win-factor">-</div>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px; font-weight: 600;"><svg class="icon"><use href="#icon-alert"/></svg> Principal Causa de Perda</div>
              <div style="font-size: 15px; color: var(--danger); font-weight: 600;" id="rep-loss-cause">-</div>
            </div>
          </div>
          
          <!-- RecomendaÃ§Ãµes IA -->
          <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 12px; font-weight: 600;"><svg class="icon"><use href="#icon-robot"/></svg> RecomendaÃ§Ãµes de Melhoria</div>
            <div id="rep-recommendations" style="font-size: 13px; line-height: 1.8; color: var(--text-main);">
              <!-- SerÃ¡ populado por JavaScript -->
            </div>
          </div>
        </div>
        
        <!-- Top Deals do Vendedor -->
        <h4 class="metric-section-header sellers" style="margin-top: 32px;">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
          Top Deals (Ganhos + Pipeline Ativo)
        </h4>
        <div id="rep-top-deals" class="ai-card">
          <div class="loading" style="text-align: center; padding: 20px;"><svg class="icon"><use href="#icon-briefcase"/></svg> Carregando deals...</div>
        </div>
      </div>
    </div>

    <!-- SEÃ‡ÃƒO 5: PAUTA SEMANAL ENHANCED - 1-ON-1 MEETINGS -->
    <div id="agenda" class="section">
      <h3><svg class="icon"><use href="#icon-calendar"/></svg> Pauta Semanal - ReuniÃµes 1-on-1</h3>
      <p style="color: var(--text-gray); margin-bottom: 16px;">
        <strong>Quarter Atual:</strong> <span id="agenda-quarter" style="color: var(--primary-cyan); font-weight: 700;">FY26-Q1</span> | 
        RevisÃ£o de oportunidades com feedback de performance e coaching por vendedor
      </p>
      
      <!-- Resumo Geral do Quarter -->
      <div class="kpi-grid" style="margin-bottom: 24px;">
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <div class="kpi-title">Vendedores</div>
          <div class="kpi-value val-cyan" id="agenda-sellers-count">-</div>
          <div class="kpi-subtitle">no quarter atual</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          <div class="kpi-title">Total Deals</div>
          <div class="kpi-value val-cyan" id="agenda-total-deals">-</div>
          <div class="kpi-subtitle" id="agenda-total-value">-</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="16 12 12 8 8 12"/>
            <line x1="12" y1="16" x2="12" y2="8"/>
          </svg>
          <div class="kpi-title">Deals CrÃ­ticos</div>
          <div class="kpi-value val-warning" id="agenda-criticos-count">-</div>
          <div class="kpi-subtitle">â‰¥70% confianÃ§a</div>
        </div>
        <div class="kpi-card">
          <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <div class="kpi-title">Deals Zumbis</div>
          <div class="kpi-value val-red" id="agenda-zumbis-count">-</div>
          <div class="kpi-subtitle">>90 dias sem atividade</div>
        </div>
      </div>
      
      <!-- Lista de Vendedores com Deals -->
      <div id="agenda-sellers-container">
        <div class="loading" style="text-align: center; padding: 40px;">
          <svg class="icon"><use href="#icon-calendar"/></svg> Carregando pauta do quarter...
        </div>
      </div>
    </div>

    <!-- SEÃ‡ÃƒO 6: INTELIGÃŠNCIA ML -->
    <div id="ml" class="section">
      <h3><svg class="icon"><use href="#icon-robot"/></svg> InteligÃªncia Artificial: 9 Modelos/Views Preditivos BigQuery ML</h3>
      <p style="color: var(--text-gray); margin-bottom: 24px;">PrediÃ§Ãµes baseadas em modelos de Machine Learning treinados com histÃ³rico de vendas</p>
      
      <!-- Card de IntroduÃ§Ã£o -->
      <div class="ai-card" style="margin-bottom: 24px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; font-size: 13px;">
          <div>
            <div style="font-weight: 700; color: var(--primary-cyan); margin-bottom: 6px;">âš™ï¸ Tecnologia</div>
            <div style="color: var(--text-gray);">BigQuery ML (BQML)</div>
          </div>
          <div>
            <div style="font-weight: 700; color: var(--primary-cyan); margin-bottom: 6px;"><svg class="icon"><use href="#icon-chart"/></svg> Dataset</div>
            <div style="color: var(--text-gray);">Deals histÃ³ricos + pipeline</div>
          </div>
          <div>
            <div style="font-weight: 700; color: var(--primary-cyan); margin-bottom: 6px;"><svg class="icon"><use href="#icon-target"/></svg> Objetivo</div>
            <div style="color: var(--text-gray);">Otimizar vendas e reduzir perdas</div>
          </div>
        </div>
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px; color: var(--text-gray); line-height: 1.8;">
          <strong style="color: var(--text-main);">Como usar:</strong> Navegue pelas tabs para ver prediÃ§Ãµes especÃ­ficas. Cada modelo fornece insights acionÃ¡veis baseados em padrÃµes identificados no histÃ³rico. Use as prediÃ§Ãµes para priorizar aÃ§Ãµes, alocar recursos e antecipar riscos.
        </div>
      </div>
      
      <!-- TABS ML -->
      <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 0; flex-wrap: wrap;">
        <button class="ml-tab active" data-tab="previsao-ciclo" onclick="switchMLTab('previsao-ciclo')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 10px 16px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 13px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          â±ï¸ PrevisÃ£o de Ciclo
        </button>
        <button class="ml-tab" data-tab="previsibilidade" onclick="switchMLTab('previsibilidade')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 10px 16px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 13px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg class="icon"><use href="#icon-target"/></svg> Previsibilidade
        </button>
        <button class="ml-tab" data-tab="classificador-perda" onclick="switchMLTab('classificador-perda')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 10px 16px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 13px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg class="icon"><use href="#icon-x"/></svg> Classificador de Perda
        </button>
        <button class="ml-tab" data-tab="risco-abandono" onclick="switchMLTab('risco-abandono')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 10px 16px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 13px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg class="icon" style="color:var(--error)"><use href="#icon-alert"/></svg> Risco de Abandono
        </button>
        <button class="ml-tab" data-tab="performance-vendedor" onclick="switchMLTab('performance-vendedor')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 10px 16px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 13px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg class="icon"><use href="#icon-user"/></svg> Performance Vendedor
        </button>
        <button class="ml-tab" data-tab="prioridade-deals" onclick="switchMLTab('prioridade-deals')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 10px 16px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 13px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg class="icon"><use href="#icon-star"/></svg> Prioridade de Deals
        </button>
        <button class="ml-tab" data-tab="proxima-acao" onclick="switchMLTab('proxima-acao')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 10px 16px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 13px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg class="icon"><use href="#icon-idea"/></svg> PrÃ³xima AÃ§Ã£o
        </button>
        <button class="ml-tab" data-tab="recomendacao-produtos" onclick="switchMLTab('recomendacao-produtos')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 10px 16px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 13px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg class="icon"><use href="#icon-idea"/></svg> RecomendaÃ§Ã£o Produtos
        </button>
        <button class="ml-tab" data-tab="deteccao-anomalias" onclick="switchMLTab('deteccao-anomalias')" style="
          background: none; 
          border: none; 
          color: var(--text-gray); 
          padding: 10px 16px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 13px;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
        ">
          <svg class="icon"><use href="#icon-alert"/></svg> DetecÃ§Ã£o Anomalias
        </button>
      </div>

      <!-- CONTEÃšDO DAS TABS -->
      <div id="ml-content-area">
        <div class="loading"><svg class="icon"><use href="#icon-robot"/></svg> Carregando prediÃ§Ãµes de Machine Learning...</div>
      </div>
    </div>
  </div>

  <script>
    // FunÃ§Ã£o de log (wrapper para console.log)
    const log = (...args) => console.log(...args);
    
    // Helper function para Ã­cones SVG
    const icon = (name, size = '') => {
      const sizeClass = size === 'lg' ? 'icon-lg' : '';
      return `<svg class="icon ${sizeClass}" aria-hidden="true"><use href="#icon-${name}"/></svg>`;
    };

    // Endpoints (Firebase Hosting -> Cloud Functions / Cloud Run)
    const API_BASE_URL = (() => {
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:8080';
      }
      // In production (Firebase Hosting), use empty string for relative URLs
      // Firebase will proxy /api/** to Cloud Run automatically
      if (window.location.hostname.includes('web.app')) {
        return ''; // Relative URLs will use Firebase proxy
      }
      // Fallback to Cloud Run URL directly
      return 'https://sales-intelligence-api-j7loux7yta-uc.a.run.app';
    })();
    const DASHBOARD_API_URL = API_BASE_URL;
    const ML_API_URL = API_BASE_URL;
    window.API_BASE_URL = API_BASE_URL;
    
    // Recupera dados do servidor (nÃ£o mais injetados pelo template)
    let DATA = {
      l10: {},
      executive: {},
      fsrScorecard: [],
      fsrMetrics: {},
      insights: { topWinFactors: [], topLossCauses: [] },
      insightsRag: {},
      aiAnalysis: {},
      weeklyAgenda: {},
      updatedAt: new Date().toISOString(),
      quarterLabel: 'N/A'
    };
    
    // Multi-select seller state
    let availableSellers = {
      active: [],
      historical: []
    };
    let selectedSellers = [];
    
    /* ========================
       MULTI-SELECT SELLERS
       ======================== */
    
    async function loadSellers() {
      try {
        const data = await fetchJsonNoCache(`${API_BASE_URL}/api/sellers`);
        availableSellers = data;
        
        log('[SELLERS] Loaded:', {
          active: data.active.length,
          historical: data.historical.length
        });
        
        renderSellerOptions();
      } catch (e) {
        console.error('[SELLERS] Error loading:', e);
      }
    }
    
    function renderSellerOptions() {
      const activeGroup = document.getElementById('active-sellers-group');
      const historicalGroup = document.getElementById('historical-sellers-group');
      
      if (!activeGroup || !historicalGroup) return;
      
      // Clear existing options (except title)
      activeGroup.innerHTML = '<div class="multi-select-group-title">ðŸŸ¢ Vendedores Ativos</div>';
      historicalGroup.innerHTML = '<div class="multi-select-group-title">ðŸ“œ Vendedores HistÃ³ricos</div>';
      
      // Render active sellers
      availableSellers.active.forEach(seller => {
        const option = createSellerOption(seller.Vendedor, seller.deals_pipeline, true);
        activeGroup.appendChild(option);
      });
      
      // Render historical sellers
      availableSellers.historical.forEach(seller => {
        const option = createSellerOption(seller.Vendedor, seller.deals_won + seller.deals_lost, false);
        historicalGroup.appendChild(option);
      });
    }
    
    function createSellerOption(name, dealsCount, isActive) {
      const div = document.createElement('div');
      div.className = 'multi-select-option';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `seller-${name.replace(/\s/g, '-')}`;
      checkbox.value = name;
      checkbox.onchange = () => onSellerChange();
      
      const label = document.createElement('label');
      label.setAttribute('for', checkbox.id);
      
      const nameSpan = document.createElement('span');
      nameSpan.textContent = name;
      
      const badge = document.createElement('span');
      badge.className = 'multi-select-option-badge';
      badge.textContent = dealsCount;
      
      label.appendChild(nameSpan);
      label.appendChild(badge);
      
      div.appendChild(checkbox);
      div.appendChild(label);
      
      return div;
    }
    
    function toggleSellerDropdown() {
      const trigger = document.querySelector('.multi-select-trigger');
      const dropdown = document.getElementById('seller-dropdown');
      
      trigger.classList.toggle('open');
      dropdown.classList.toggle('open');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const container = document.getElementById('seller-multi-select');
      if (container && !container.contains(e.target)) {
        const trigger = document.querySelector('.multi-select-trigger');
        const dropdown = document.getElementById('seller-dropdown');
        trigger?.classList.remove('open');
        dropdown?.classList.remove('open');
      }
    });
    
    function onSellerChange() {
      const checkboxes = document.querySelectorAll('#seller-dropdown input[type="checkbox"]');
      selectedSellers = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
      
      updateSellerTriggerText();
      
      // Reload dashboard with selected sellers
      reloadDashboard();
    }
    
    function updateSellerTriggerText() {
      const triggerText = document.getElementById('seller-selected-text');
      
      if (selectedSellers.length === 0) {
        triggerText.textContent = 'Todos os Vendedores';
        triggerText.style.color = '#ffffff';
      } else if (selectedSellers.length === 1) {
        triggerText.textContent = selectedSellers[0];
        triggerText.style.color = 'var(--primary-cyan)';
      } else {
        triggerText.textContent = `${selectedSellers.length} vendedores`;
        triggerText.style.color = 'var(--primary-cyan)';
      }
    }
    
    function selectAllSellers() {
      const checkboxes = document.querySelectorAll('#seller-dropdown input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = true);
      onSellerChange();
    }
    
    function selectActiveSellers() {
      const checkboxes = document.querySelectorAll('#seller-dropdown input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const sellerName = cb.value;
        const isActive = availableSellers.active.some(s => s.Vendedor === sellerName);
        cb.checked = isActive;
      });
      onSellerChange();
    }
    
    function clearAllSellers() {
      const checkboxes = document.querySelectorAll('#seller-dropdown input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);
      onSellerChange();
    }
    
    /* ========================
       END MULTI-SELECT SELLERS
       ======================== */
    
    // InicializaÃ§Ã£o
    document.addEventListener('DOMContentLoaded', () => {
      // Default do filtro global de perÃ­odo: semana vigente (segunda atÃ© hoje)
      // (aplica-se principalmente Ã s Atividades da Pauta Semanal)
      try {
        const dateStartFilter = document.getElementById('date-start-filter');
        const dateEndFilter = document.getElementById('date-end-filter');
        const hasStart = !!(dateStartFilter && dateStartFilter.value);
        const hasEnd = !!(dateEndFilter && dateEndFilter.value);

        if (dateStartFilter && dateEndFilter && !hasStart && !hasEnd) {
          const today = new Date();
          const end = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const start = new Date(end);
          const day = start.getDay();
          // JS: 0=Domingo..6=SÃ¡bado. Queremos segunda.
          const diffToMonday = (day + 6) % 7;
          start.setDate(start.getDate() - diffToMonday);

          const toIso = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${dd}`;
          };

          dateStartFilter.value = toIso(start);
          dateEndFilter.value = toIso(end);
          log('[FILTERS] PerÃ­odo default (semana vigente):', dateStartFilter.value, 'â†’', dateEndFilter.value);
        }
      } catch (e) {
        // NÃ£o bloquear inicializaÃ§Ã£o
        console.warn('Falha ao aplicar perÃ­odo default:', e);
      }

      loadSellers(); // Load available sellers for multi-select
      loadDashboardData();
    });
    
    // FunÃ§Ã£o para recarregar dashboard quando filtros mudam (COM DEBOUNCE)
    function reloadDashboard() {
      log('[RELOAD] <svg class="icon"><use href="#icon-refresh"/></svg> Recarregando dashboard com novos filtros...');
      showFilterLoader();
      
      // Debounce: aguarda 400ms antes de executar
      clearTimeout(window.reloadDebounceTimer);
      window.reloadDebounceTimer = setTimeout(() => {
        loadDashboardData();
        if (document.getElementById('aprendizados')?.classList.contains('active')) {
          loadAprendizados();
        }
        // Atualiza Pauta Semanal se estiver ativa
        if (document.getElementById('agenda')?.classList.contains('active') && typeof window.loadWeeklyAgenda === 'function') {
          window.loadWeeklyAgenda();
        }
      }, 400);
    }
    
    // Toggle Sidebar
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const main = document.querySelector('.main');
      const toggle = document.querySelector('.sidebar-toggle');
      
      sidebar.classList.toggle('collapsed');
      main.classList.toggle('sidebar-collapsed');
      document.body.classList.toggle('sidebar-collapsed');
      
      // Rotaciona Ã­cone
      const icon = toggle.querySelector('svg');
      if (sidebar.classList.contains('collapsed')) {
        icon.style.transform = 'rotate(180deg)';
      } else {
        icon.style.transform = 'rotate(0deg)';
      }
    }
    
    // FunÃ§Ã£o para aplicar filtros rÃ¡pidos de FY26
    function applyQuickFilter(year, quarter) {
      const yearFilter = document.getElementById('year-filter');
      const quarterFilter = document.getElementById('quarter-filter');
      const monthFilter = document.getElementById('month-filter');
      
      // Define valores
      if (yearFilter) yearFilter.value = year;
      if (quarterFilter) quarterFilter.value = quarter;
      if (monthFilter) monthFilter.value = '';
      
      log(`[QUICK FILTER] Aplicando: Year=${year}, Quarter=${quarter}`);
      reloadDashboard();
    }
    
    // FunÃ§Ã£o para limpar todos os filtros
    function clearAllFilters() {
      const yearFilter = document.getElementById('year-filter');
      const quarterFilter = document.getElementById('quarter-filter');
      const monthFilter = document.getElementById('month-filter');
      const repFilter = document.getElementById('rep-filter');
      const dateStartFilter = document.getElementById('date-start-filter');
      const dateEndFilter = document.getElementById('date-end-filter');
      
      if (yearFilter) yearFilter.value = '';
      if (quarterFilter) quarterFilter.value = '';
      if (monthFilter) monthFilter.value = '';
      if (repFilter) repFilter.value = 'all';
      if (dateStartFilter) dateStartFilter.value = '';
      if (dateEndFilter) dateEndFilter.value = '';
      
      log('[CLEAR] Todos os filtros limpos');
      reloadDashboard();
    }
    
    // FunÃ§Ã£o para sincronizar filtros de quarter e month
    function syncQuarterMonth(changedFilter) {
      const quarterFilter = document.getElementById('quarter-filter');
      const monthFilter = document.getElementById('month-filter');
      
      if (changedFilter === 'quarter' && quarterFilter?.value) {
        // Se quarter foi selecionado, limpar month
        if (monthFilter) monthFilter.value = '';
      } else if (changedFilter === 'month' && monthFilter?.value) {
        // Se month foi selecionado, limpar quarter
        if (quarterFilter) quarterFilter.value = '';
      }
      
      reloadDashboard();
    }
    
    // ========== CACHE HELPER ==========
    async function fetchJsonNoCache(url) {
      const cacheBust = url + (url.includes('?') ? '&' : '?') + `_ts=${Date.now()}`;
      const response = await fetch(cacheBust, {
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache'
        }
      });
      const text = await response.text();
      let data;
      try {
        data = text ? JSON.parse(text) : null;
      } catch (e) {
        throw new Error(`Resposta nao-JSON de ${url}: ${text.slice(0, 160)}`);
      }
      if (!response.ok) {
        throw new Error(`HTTP ${response.status} de ${url}: ${text.slice(0, 160)}`);
      }
      return data;
    }

    async function fetchWithCache(url, cacheKey, cacheMinutes = 5) {
      // Tenta buscar do cache
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          const age = Date.now() - parsed.timestamp;
          if (age < cacheMinutes * 60 * 1000) {
            log(`[CACHE] <svg class="icon"><use href="#icon-check"/></svg> ${cacheKey} (idade: ${Math.round(age/1000)}s)`);
            return parsed.data;
          }
        } catch (e) {
          log(`[CACHE] <svg class="icon"><use href="#icon-alert"/></svg> Erro ao ler: ${e.message}`);
        }
      }
      
      // Busca da API
      log(`[CACHE] ðŸŒ Fetch: ${url.substring(0, 80)}...`);
      const data = await fetchJsonNoCache(url);
      
      // Salva no cache
      try {
        localStorage.setItem(cacheKey, JSON.stringify({
          timestamp: Date.now(),
          data: data
        }));
      } catch (e) {
        log(`[CACHE] <svg class="icon"><use href="#icon-alert"/></svg> Erro ao salvar: ${e.message}`);
      }
      
      return data;
    }
    
    // Limpar cache ao mudar filtros
    function clearDataCache() {
      const keys = Object.keys(localStorage).filter(k => k.startsWith('cache_'));
      keys.forEach(k => localStorage.removeItem(k));
      log('[CACHE] ðŸ—‘ï¸ Cache limpo (' + keys.length + ' itens)');
    }

    async function loadDashboardData() {
      try {
        log('[DASHBOARD] ========== INÃCIO DO CARREGAMENTO ==========');
        showLoading('Carregando dashboard');
        
        // Pega filtros atuais
        const yearFilter = document.getElementById('year-filter')?.value || '';
        const monthFilter = document.getElementById('month-filter')?.value || '';
        const quarterFilter = document.getElementById('quarter-filter')?.value || '';
        const dateStart = document.getElementById('date-start-filter')?.value || '';
        const dateEnd = document.getElementById('date-end-filter')?.value || '';
        
        // Multi-select seller filter
        const sellerFilter = selectedSellers.length > 0 ? selectedSellers.join(',') : '';
        
        // Monta query string com suporte a quarter
        const params = new URLSearchParams();
        if (yearFilter) params.append('year', yearFilter);
        
        // Quarter tem prioridade sobre month
        if (quarterFilter) {
          // Converter Q1, Q2, Q3, Q4 para 1, 2, 3, 4
          const quarterNum = quarterFilter.replace('Q', '');
          params.append('quarter', quarterNum);
        } else if (monthFilter) {
          params.append('month', monthFilter);
        }
        
        if (sellerFilter) params.append('seller', sellerFilter);
        const queryString = params.toString() ? '?' + params.toString() : '';
        
        // Armazenar filtros ativos globalmente para uso em renderDashboard
        window.currentFilters = {
          year: yearFilter,
          quarter: quarterFilter,
          month: monthFilter,
          seller: sellerFilter,
          date_start: dateStart,
          date_end: dateEnd
        };
        
        log('[FILTERS]', { year: yearFilter, quarter: quarterFilter, month: monthFilter, sellers: selectedSellers });
        log('[API QUERY]', queryString);
        
        // Chamada Ãºnica para a API (backend agora suporta quarter nativo)
        const wonUrl = `${API_BASE_URL}/api/closed/won?limit=5000${queryString ? '&' + params.toString() : ''}`;
        const lostUrl = `${API_BASE_URL}/api/closed/lost?limit=5000${queryString ? '&' + params.toString() : ''}`;
        const cacheKey = params.toString() || 'all';
        
        const needsTopOppsFallback = !!queryString;
        const insightsRagPromise = Promise.resolve({ aiInsights: { status: 'disabled', wins: '', losses: '', recommendations: [] }, deals: [] });

        const [metrics, pipelineData, prioritiesData, actionsData, wonDataCached, lostDataCached, patternsData, salesSpecialistData, insightsRagData, fallbackPipelineData, fallbackWonData, fallbackLostData] = await Promise.all([
          fetchJsonNoCache(`${API_BASE_URL}/api/metrics${queryString}`),
          fetchJsonNoCache(`${API_BASE_URL}/api/pipeline?limit=500${queryString ? '&' + params.toString() : ''}`),
          fetchJsonNoCache(`${API_BASE_URL}/api/priorities?limit=100${queryString ? '&' + params.toString() : ''}`),
          fetchJsonNoCache(`${API_BASE_URL}/api/actions?urgencia=ALTA&limit=50${queryString ? '&' + params.toString() : ''}`),
          fetchWithCache(wonUrl, `cache_won_${cacheKey}`, queryString ? 3 : 10),
          fetchWithCache(lostUrl, `cache_lost_${cacheKey}`, queryString ? 3 : 10),
          fetchJsonNoCache(`${API_BASE_URL}/api/analyze-patterns${queryString}`),
          fetchJsonNoCache(`${API_BASE_URL}/api/sales-specialist${queryString}`),
          insightsRagPromise,
          needsTopOppsFallback ? fetchJsonNoCache(`${API_BASE_URL}/api/pipeline?limit=500`) : Promise.resolve([]),
          needsTopOppsFallback ? fetchWithCache(`${API_BASE_URL}/api/closed/won?limit=5000`, 'cache_won_all', 10) : Promise.resolve([]),
          needsTopOppsFallback ? fetchWithCache(`${API_BASE_URL}/api/closed/lost?limit=5000`, 'cache_lost_all', 10) : Promise.resolve([])
        ]);

        const wonData = wonDataCached;
        const lostData = lostDataCached;
        
        log('[API DATA] Metrics:', metrics);
        log('[DEBUG] ===== ANTES updateExecutiveMetricsFromAPI =====');
        log('[DEBUG] pipeline_filtered da API:', metrics.pipeline_filtered);
        
        // CORREÃ‡ÃƒO: Armazena metrics globalmente para uso em renderDashboard()
        window.currentApiMetrics = metrics;
        
        // Atualizar KPIs do Dashboard Executivo com dados da API
        updateExecutiveMetricsFromAPI(metrics);
        log('[DEBUG] ===== DEPOIS updateExecutiveMetricsFromAPI =====');
        
        log('[API DATA] Pipeline deals:', Array.isArray(pipelineData) ? pipelineData.length : 0);
        log('[API DATA] Priorities:', Array.isArray(prioritiesData) ? prioritiesData.length : 0);
        log('[API DATA] Actions:', Array.isArray(actionsData) ? actionsData.length : 0);
        log('[API DATA] Won deals:', Array.isArray(wonData) ? wonData.length : 0);
        log('[API DATA] Lost deals:', Array.isArray(lostData) ? lostData.length : 0);
        log('[API DATA] Sales Specialist:', Array.isArray(salesSpecialistData) ? salesSpecialistData.length : 0);
        log('[API DATA] AI Patterns:', patternsData);
        log('[API DATA] Insights RAG:', insightsRagData);
        if (needsTopOppsFallback) {
          log('[API DATA] Top opps fallback:', {
            pipeline: Array.isArray(fallbackPipelineData) ? fallbackPipelineData.length : 0,
            won: Array.isArray(fallbackWonData) ? fallbackWonData.length : 0,
            lost: Array.isArray(fallbackLostData) ? fallbackLostData.length : 0
          });
        }
        
        // IMPORTANTE: Separar dados para mÃ©tricas (reais/filtrados) vs. word clouds (fallback se necessÃ¡rio)
        // MÃ©tricas SEMPRE usam dados filtrados (mesmo que vazios)
        // Word clouds podem usar fallback quando filtro resulta em zero
        let wonDataForWordClouds = wonData;
        let lostDataForWordClouds = lostData;
        
        // Fallback APENAS para word clouds (nÃ£o afeta mÃ©tricas)
        if ((!wonData || wonData.length === 0) && (!lostData || lostData.length === 0)) {
          log('[FALLBACK] Buscando dados sem filtro APENAS para word clouds (nÃ£o afeta mÃ©tricas)...');
          try {
            const [fallbackWonRes, fallbackLostRes] = await Promise.all([
              fetch(`${API_BASE_URL}/api/closed/won?limit=5000`),
              fetch(`${API_BASE_URL}/api/closed/lost?limit=5000`)
            ]);
            wonDataForWordClouds = await fallbackWonRes.json();
            lostDataForWordClouds = await fallbackLostRes.json();
            log('[FALLBACK] Won fallback:', wonDataForWordClouds.length);
            log('[FALLBACK] Lost fallback:', lostDataForWordClouds.length);
          } catch (e) {
            log('[FALLBACK] Erro ao buscar dados fallback:', e);
          }
        }
        
        // Converter para formato esperado pelo dashboard
        // CRÃTICO: MÃ©tricas usam dados REAIS filtrados, word clouds podem ter fallback
        const raw = {
          status: 'success',
          metrics: metrics,
          pipeline: Array.isArray(pipelineData) ? pipelineData : [],
          priorities: Array.isArray(prioritiesData) ? prioritiesData : [],
          actions: Array.isArray(actionsData) ? actionsData : [],
          // MÃ‰TRICAS: Usar dados REAIS filtrados (mesmo que vazios)
          won: Array.isArray(wonData) ? wonData : [],
          lost: Array.isArray(lostData) ? lostData : [],
          // WORD CLOUDS: Dados separados para nÃ£o afetar mÃ©tricas
          wonWordCloud: Array.isArray(wonDataForWordClouds) ? wonDataForWordClouds : [],
          lostWordCloud: Array.isArray(lostDataForWordClouds) ? lostDataForWordClouds : [],
          patterns: patternsData || {},
          salesSpecialist: Array.isArray(salesSpecialistData) ? salesSpecialistData : [],
          insightsRag: insightsRagData || {}
        };
        
        DATA = normalizeCloudResponse(raw);
        
        // Armazenar pipeline raw para uso em filtros
        window.DATA = DATA;
        window.pipelineDataRaw = raw.pipeline || [];
        window.topOppsFallback = {
          pipeline: Array.isArray(fallbackPipelineData) ? fallbackPipelineData : [],
          won: Array.isArray(fallbackWonData) ? fallbackWonData : [],
          lost: Array.isArray(fallbackLostData) ? fallbackLostData : []
        };

        log('[DATA] Estrutura de dados carregada:', {
          'weeklyAgenda quarters': Object.keys(DATA.weeklyAgenda || {}).length,
          'fsrScorecard vendedores': (DATA.fsrScorecard || []).length,
          'l10 keys': Object.keys(DATA.l10 || {}).length,
          'aiAnalysis keys': Object.keys(DATA.aiAnalysis || {}).length,
          'wordClouds': DATA.wordClouds ? Object.keys(DATA.wordClouds).map(k => `${k}:${DATA.wordClouds[k].length}`).join(', ') : 'N/A',
          'quarterLabel': DATA.quarterLabel,
          'updatedAt': DATA.updatedAt
        });

        log('[DATA] Dados completos:', DATA);
        renderDashboard();
        
        // Atualiza Performance FSR se estiver ativa
        applyFiltersToPerformance();
        
        // Esconde loader inicial
        hideInitialLoader();
        hideFilterLoader();
        hideLoading();
      } catch (e) {
        hideLoading();
        console.error('[ERROR] Erro ao carregar dados:', e);
        showError('Erro ao carregar dados: ' + e.message);
        hideInitialLoader();
        hideFilterLoader();
      }
    }

    function normalizeCloudResponse(raw) {
      const nowIso = new Date().toISOString();
      const cloud = raw && raw.status === 'success' ? raw : null;
      
      // Dados da API
      const metrics = cloud?.metrics || {};
      const pipelineDeals = cloud?.pipeline || [];
      // CRÃTICO: Separar dados para mÃ©tricas (filtrados) vs. word clouds (com fallback)
      const wonDeals = cloud?.won || [];
      const lostDeals = cloud?.lost || [];
      const wonDealsWordCloud = cloud?.wonWordCloud || cloud?.won || [];
      const lostDealsWordCloud = cloud?.lostWordCloud || cloud?.lost || [];
      
      log('[NORMALIZE] Pipeline deals:', pipelineDeals.length);
      log('[NORMALIZE] Won deals (mÃ©tricas):', wonDeals.length);
      log('[NORMALIZE] Lost deals (mÃ©tricas):', lostDeals.length);
      log('[NORMALIZE] Won deals (word cloud):', wonDealsWordCloud.length);
      log('[NORMALIZE] Lost deals (word cloud):', lostDealsWordCloud.length);
      
      // Agrupar pipeline por Fiscal Quarter
      const weeklyAgenda = {};
      const sellerStats = {};
      const quarterBreakdown = {};
      
      const deriveFiscalQuarter = (dateStr) => {
        if (!dateStr) return '';
        let parsed = new Date(dateStr);
        if (Number.isNaN(parsed.getTime())) {
          const match = String(dateStr).match(/^(\d{2})-(\d{2})-(\d{4})$/);
          if (match) {
            const [, dd, mm, yyyy] = match;
            parsed = new Date(`${yyyy}-${mm}-${dd}`);
          }
        }
        if (Number.isNaN(parsed.getTime())) return '';
        const month = parsed.getMonth() + 1;
        const quarterNum = Math.floor((month - 1) / 3) + 1;
        const year = parsed.getFullYear();
        const fy = String(year).slice(-2);
        return `FY${fy}-Q${quarterNum}`;
      };

      // Processar pipeline deals
      pipelineDeals.forEach(deal => {
        const derivedQuarter = deriveFiscalQuarter(deal.Data_Prevista);
        const quarter = deal.Fiscal_Q || derivedQuarter || 'FY26-Q1';
        const seller = deal.Vendedor || 'Unknown';
        
        // Usar Forecast_IA (se disponÃ­vel) ou Forecast_SF como fallback
        const forecastCategory = deal.Forecast_IA || deal.Forecast_SF || 'PIPELINE';
        
        // <svg class="icon"><use href="#icon-check"/></svg> USAR CONFIANÃ‡A REAL DO BIGQUERY (campo Confianca)
        let confidence = parseFloat(deal.Confianca) || 0;
        // Se vier como decimal (ex: 0.30), converter para percentual (30)
        if (confidence > 0 && confidence <= 1) confidence = confidence * 100;
        // Log para debug (remover apÃ³s validaÃ§Ã£o)
        if (deal.Oportunidade && Math.random() < 0.05) {
          log('[CONF DEBUG]', deal.Oportunidade, '- Real:', confidence + '%', 'Forecast:', forecastCategory);
        }
        
        const dealObj = {
          id: deal.Oportunidade,
          name: deal.Oportunidade,
          opportunity: deal.Oportunidade,
          account: deal.Conta || deal.Conta_Nome || deal.Account || deal.Cliente || deal.Empresa,
          seller: seller,
          stage: deal.Fase_Atual,
          val: deal.Gross || 0,
          gross: deal.Gross || 0,
          net: deal.Net || 0,
          confidence: confidence,
          forecastCategory: forecastCategory, // â† NOVO: Guarda categoria original
          closeDate: deal.Data_Prevista,
          closed: deal.Data_Prevista,
          fiscalQ: quarter,
          fiscal_q: quarter,
          quarter: quarter,
          activities: deal.Atividades || 0,
          daysIdle: parseInt(deal.Idle_Dias || deal.Dias_Idle) || 0,
          profile: deal.Perfil,
          products: deal.Produtos
        };
        
        // Debug opcional: manter silencioso em producao
        
        // Adicionar ao weeklyAgenda
        if (!weeklyAgenda[quarter]) {
          weeklyAgenda[quarter] = [];
        }
        weeklyAgenda[quarter].push(dealObj);
        
        // Quarter breakdown
        if (!quarterBreakdown[quarter]) {
          quarterBreakdown[quarter] = { gross: 0, net: 0, count: 0 };
        }
        quarterBreakdown[quarter].gross += deal.Gross || 0;
        quarterBreakdown[quarter].net += deal.Net || 0;
        quarterBreakdown[quarter].count++;
        
        // Seller stats
        if (!sellerStats[seller]) {
          sellerStats[seller] = {
            name: seller,
            total_deals: 0,
            total_gross: 0,
            total_net: 0,
            avg_deal_size: 0
          };
        }
        sellerStats[seller].total_deals++;
        sellerStats[seller].total_gross += deal.Gross || 0;
        sellerStats[seller].total_net += deal.Net || 0;
      });
      
      // Calcular avg_deal_size
      Object.values(sellerStats).forEach(s => {
        s.avg_deal_size = s.total_deals > 0 ? s.total_gross / s.total_deals : 0;
      });
      
      log('[NORMALIZE] Quarters:', Object.keys(weeklyAgenda));
      log('[NORMALIZE] Sellers:', Object.keys(sellerStats).length);
      
      // fsrScorecard
      const fsrScorecard = Object.values(sellerStats).map(seller => ({
        name: seller.name,
        isActive: true,
        ipv: 0,
        ipvBreakdown: { result: 0, efficiency: 0, behavior: 0 },
        totalDeals: seller.total_deals,
        totalWon: 0,
        totalLost: 0,
        winRate: 0,
        revenueGross: seller.total_gross,
        revenue: seller.total_net,
        avgGross: seller.avg_deal_size,
        avgWinCycle: 0,
        avgLossCycle: 0,
        avgActivitiesWin: 0,
        topWinFactor: 'N/A',
        topLossCause: 'N/A',
        totalWonQuarter: 0,
        totalLostQuarter: 0
      }));
      
      // Won/Lost aggregations por quarter
      const wonAgg = [];
      const lostAgg = [];
      
      wonDeals.forEach(deal => {
        const quarter = deal.Fiscal_Q || deriveFiscalQuarter(deal.Data_Fechamento) || 'FY26-Q1';
        wonAgg.push({
          fiscalQ: quarter,
          Gross: deal.Gross || 0,
          gross: deal.Gross || 0,
          Net: deal.Net || 0,
          net: deal.Net || 0,
          Vendedor: deal.Vendedor || 'N/A',
          seller: deal.Vendedor || 'N/A',
          owner: deal.Vendedor || 'N/A',
          Opportunity_Name: deal.Oportunidade || 'Deal Ganho',
          opportunityName: deal.Oportunidade || 'Deal Ganho',
          Conta: deal.Conta || deal.Conta_Nome || deal.Account || deal.Cliente || deal.Empresa || 'Conta nÃ£o especificada',
          account: deal.Conta || deal.Conta_Nome || deal.Account || deal.Cliente || deal.Empresa || 'Conta nÃ£o especificada',
          Data_Fechamento: deal.Data_Fechamento,
          closeDate: deal.Data_Fechamento,
          Ciclo_dias: parseFloat(deal.Ciclo_dias) || 0,
          ciclo_dias: parseFloat(deal.Ciclo_dias) || 0,
          Tipo_Resultado: deal.Tipo_Resultado || '',
          Fatores_Sucesso: deal.Fatores_Sucesso || '',
          Win_Reason: deal.Win_Reason || deal.Fatores_Sucesso || deal.Causa_Raiz || 'Motivo nÃ£o especificado',
          winReason: deal.Win_Reason || deal.Fatores_Sucesso || deal.Causa_Raiz || 'Motivo nÃ£o especificado'
        });
      });
      
      lostDeals.forEach(deal => {
        const quarter = deal.Fiscal_Q || deriveFiscalQuarter(deal.Data_Fechamento) || 'FY26-Q1';
        lostAgg.push({
          fiscalQ: quarter,
          Gross: deal.Gross || 0,
          gross: deal.Gross || 0,
          Net: deal.Net || 0,
          net: deal.Net || 0,
          Vendedor: deal.Vendedor || 'N/A',
          seller: deal.Vendedor || 'N/A',
          owner: deal.Vendedor || 'N/A',
          Opportunity_Name: deal.Oportunidade || 'Deal Perdido',
          opportunityName: deal.Oportunidade || 'Deal Perdido',
          Conta: deal.Conta || deal.Conta_Nome || deal.Account || deal.Cliente || deal.Empresa || 'Conta nÃ£o especificada',
          account: deal.Conta || deal.Conta_Nome || deal.Account || deal.Cliente || deal.Empresa || 'Conta nÃ£o especificada',
          Data_Fechamento: deal.Data_Fechamento,
          closeDate: deal.Data_Fechamento,
          Tipo_Resultado: deal.Tipo_Resultado || '',
          Causa_Raiz: deal.Causa_Raiz || '',
          Loss_Reason: deal.Causa_Raiz || deal.Loss_Reason || 'Motivo nÃ£o especificado',
          lossReason: deal.Causa_Raiz || deal.Loss_Reason || 'Motivo nÃ£o especificado',
          cause: deal.Causa_Raiz || 'OUTRO',
          Ciclo_dias: parseFloat(deal.Ciclo_dias) || 0,
          ciclo_dias: parseFloat(deal.Ciclo_dias) || 0
        });
      });
      
      // Forecast categories
      let commitGross = 0, upsideGross = 0, pipelineGross2 = 0;
      let commitCount = 0, upsideCount = 0, pipelineCount = 0;
      
      pipelineDeals.forEach(d => {
        if (d.Forecast_SF === 'Commit') {
          commitGross += d.Gross || 0;
          commitCount++;
        } else if (d.Forecast_SF === 'Upside') {
          upsideGross += d.Gross || 0;
          upsideCount++;
        } else {
          pipelineGross2 += d.Gross || 0;
          pipelineCount++;
        }
      });
      
      const totalGross = metrics.pipeline_total?.gross || 0;
      const totalNet = metrics.pipeline_total?.net || 0;
      const totalOpps = metrics.pipeline_total?.deals_count || 0;
      const netRatio = totalGross > 0 ? (totalNet / totalGross) : 0;
      const above50Gross = commitGross + upsideGross;
      const above50Count = commitCount + upsideCount;
      const above50Net = above50Gross * netRatio;
      
      // Extrair FY26 breakdown
      const fy26Breakdown = {};
      ['FY26-Q1', 'FY26-Q2', 'FY26-Q3', 'FY26-Q4'].forEach(q => {
        fy26Breakdown[q] = quarterBreakdown[q] || { gross: 0, net: 0, count: 0 };
      });
      
      const fy26Total = Object.values(fy26Breakdown).reduce((acc, q) => ({
        gross: acc.gross + q.gross,
        net: acc.net + q.net,
        count: acc.count + q.count
      }), { gross: 0, net: 0, count: 0 });
      
      // CloudAnalysis structure completa
      const cloudAnalysis = {
        status: 'success',
        timestamp: nowIso,
        pipeline_analysis: {
          executive: {
            pipeline_all: {
              deals_count: totalOpps,
              gross: totalGross,
              net: totalNet
            },
            pipeline_filtered: {
              deals_count: metrics.pipeline_filtered?.deals_count || 0,
              gross: metrics.pipeline_filtered?.gross || 0,
              net: metrics.pipeline_filtered?.net || 0,
              avg_confidence: metrics.pipeline_filtered?.avg_confidence || 0,
              avg_idle_days: metrics.pipeline_filtered?.avg_idle_days || 0,
              high_risk_idle: metrics.pipeline_filtered?.high_risk_idle || 0,
              avg_meddic: metrics.pipeline_filtered?.avg_meddic || 0,
              avg_bant: metrics.pipeline_filtered?.avg_bant || 0
            },
            pipeline_fy26: {
              deals_count: fy26Total.count,
              gross: fy26Total.gross,
              net: fy26Total.net
            },
            high_confidence: {
              deals_count: metrics.high_confidence?.deals_count || 0,
              gross: metrics.high_confidence?.gross || 0,
              net: metrics.high_confidence?.net || 0,
              avg_confidence: metrics.high_confidence?.avg_confidence || 0
            },
            pipeline_by_quarter: fy26Breakdown
          },
          sellers: Object.values(sellerStats)
        },
        closed_analysis: {
          win_rate_by_seller: {},
          loss_reasons: {},
          avg_cycle_won_days: metrics.closed_won?.avg_cycle_days || 0,
          avg_cycle_lost_days: metrics.closed_lost?.avg_cycle_days || 0,
          closed_quarter: {
            quarter: 'FY26-Q1',
            won: {
              deals_count: metrics.closed_won?.deals_count || 0,
              gross: metrics.closed_won?.gross || 0,
              net: metrics.closed_won?.net || 0,
              avg_cycle_days: metrics.closed_won?.avg_cycle_days || 0
            },
            lost: {
              deals_count: metrics.closed_lost?.deals_count || 0,
              gross: metrics.closed_lost?.gross || 0,
              net: metrics.closed_lost?.net || 0,
              avg_cycle_days: metrics.closed_lost?.avg_cycle_days || 0
            },
            win_rate: metrics.win_rate || 0,
            total_closed: (metrics.closed_won?.deals_count || 0) + (metrics.closed_lost?.deals_count || 0),
            forecast_specialist: {
              gross: 0,
              net: 0,
              deals_count: 0,
              commit_gross: 0,
              commit_net: 0,
              commit_deals: 0,
              upside_gross: 0,
              upside_net: 0,
              upside_deals: 0,
              by_fiscal_q: {}
            }
          }
        },
        aggregations: {
          by_forecast_category: [
            { category: 'COMMIT', count: commitCount, total_gross: commitGross, avg_confidence: 0.95 },
            { category: 'UPSIDE', count: upsideCount, total_gross: upsideGross, avg_confidence: 0.70 },
            { category: 'PIPELINE', count: pipelineCount, total_gross: pipelineGross2, avg_confidence: 0.30 }
          ],
          by_quarter: Object.entries(fy26Breakdown).map(([q, data]) => ({
            quarter: q,
            total_gross: data.gross || 0,
            total_net: data.net || 0,
            count: data.count || 0
          })),
          by_seller_quarter: []
        }
      };

      const result = {
        l10: {},
        executive: {
          pipeline_total: totalOpps,
          pipeline_gross: totalGross,
          won_total: metrics.closed_won?.deals_count || 0,
          won_gross: metrics.closed_won?.gross || 0,
          lost_total: metrics.closed_lost?.deals_count || 0,
          lost_gross: metrics.closed_lost?.gross || 0
        },
        fsrScorecard: fsrScorecard,
        fsrMetrics: {},
        insights: { 
          topWinFactors: [], 
          topLossCauses: [] 
        },
        aiAnalysis: {},
        weeklyAgenda: weeklyAgenda,
        wordClouds: { 
          winTypes: [], winLabels: [], 
          lossTypes: [], lossLabels: [], 
          riskFlags: [], actionLabels: [] 
        },
        wonWordCloudDeals: wonDealsWordCloud,
        lostWordCloudDeals: lostDealsWordCloud,
        wonAgg: wonAgg,
        lostAgg: lostAgg,
        cloudMetrics: {
          avgConfidence: 0.5,
          above50Gross: above50Gross,
          above50Net: above50Net,
          above50Count: above50Count,
          commitGross: commitGross,
          upsideGross: upsideGross,
          pipelineGross: pipelineGross2
        },
        cloudAnalysis: cloudAnalysis,
        updatedAt: nowIso,
        quarterLabel: 'FY26-Q1'
      };

      // Insights do backend (nao misturar com wordcloud)
      result.insights = cloud?.insights || { topWinFactors: [], topLossCauses: [] };
      
      // Processar word clouds dos deals
      // Process Sales Specialist data
      const salesSpecialistDeals = cloud?.salesSpecialist || [];
      const salesSpecialistByStatus = { COMMIT: [], UPSIDE: [] };
      const salesSpecialistByVendor = {};
      let ssCommitGross = 0, ssCommitNet = 0, ssCommitCount = 0;
      let ssUpsideGross = 0, ssUpsideNet = 0, ssUpsideCount = 0;
      
      salesSpecialistDeals.forEach(deal => {
        // Usa forecast_status (segunda coluna Status da planilha: UPSIDE/COMMIT)
        const status = (deal.forecast_status || deal.Status || 'UPSIDE').toUpperCase();
        const gross = parseFloat(deal.booking_total_gross) || 0;
        const net = parseFloat(deal.booking_total_net) || 0;
        const vendedor = deal.vendedor || 'Unknown';
        
        if (status.includes('COMMIT')) {
          ssCommitGross += gross;
          ssCommitNet += net;
          ssCommitCount++;
          salesSpecialistByStatus.COMMIT.push(deal);
        } else if (status.includes('UPSIDE')) {
          ssUpsideGross += gross;
          ssUpsideNet += net;
          ssUpsideCount++;
          salesSpecialistByStatus.UPSIDE.push(deal);
        }
        
        // Aggregate by vendor
        if (!salesSpecialistByVendor[vendedor]) {
          salesSpecialistByVendor[vendedor] = { deals: 0, gross: 0, net: 0 };
        }
        salesSpecialistByVendor[vendedor].deals++;
        salesSpecialistByVendor[vendedor].gross += gross;
        salesSpecialistByVendor[vendedor].net += net;
      });
      
      // Add to result
      result.salesSpecialist = {
        total: {
          deals: salesSpecialistDeals.length,
          gross: ssCommitGross + ssUpsideGross,
          net: ssCommitNet + ssUpsideNet
        },
        byStatus: {
          COMMIT: { deals: ssCommitCount, gross: ssCommitGross, net: ssCommitNet },
          UPSIDE: { deals: ssUpsideCount, gross: ssUpsideGross, net: ssUpsideNet }
        },
        byVendor: salesSpecialistByVendor,
        deals: salesSpecialistDeals
      };
      
      log('[WORDCLOUD] Processing word clouds from deals...');
      log('[WORDCLOUD] Won deals (word cloud):', wonDealsWordCloud.length);
      log('[WORDCLOUD] Lost deals (word cloud):', lostDealsWordCloud.length);
      log('[WORDCLOUD] Pipeline deals:', pipelineDeals.length);
      log('[DEBUG] CloudAnalysis metrics:', {
        pipeline_total: cloudAnalysis?.pipeline_analysis?.metrics?.pipeline_total,
        pipeline_filtered: cloudAnalysis?.pipeline_analysis?.metrics?.pipeline_filtered,
        closed_won: cloudAnalysis?.pipeline_analysis?.metrics?.closed_won,
        closed_lost: cloudAnalysis?.pipeline_analysis?.metrics?.closed_lost
      });
      const wordClouds = processWordClouds(wonDealsWordCloud, lostDealsWordCloud, pipelineDeals);
      log('[WORDCLOUD] Generated word clouds:', {
        winTypes: wordClouds.winTypes.length,
        winLabels: wordClouds.winLabels.length,
        lossTypes: wordClouds.lossTypes.length,
        lossLabels: wordClouds.lossLabels.length,
        riskFlags: wordClouds.riskFlags.length,
        actionLabels: wordClouds.actionLabels.length
      });
      result.wordClouds = wordClouds;
      
      // AI Insights from patterns endpoint
      result.aiInsights = cloud?.patterns || {
        win_insights: '',
        loss_insights: '',
        recommendations: [],
        status: 'unavailable'
      };
      
      // TODO: IntegraÃ§Ã£o futura com Gemini para anÃ¡lise avanÃ§ada
      // Enviar para API: POST /api/analyze-patterns com {wonDeals, lostDeals}
      // Retorno esperado: { winInsights: "...", lossInsights: "...", recommendations: [...] }
      
      return result;
    }
    
    function processWordClouds(wonDeals, lostDeals, pipelineDeals) {
      // Contadores de frequÃªncia
      const winTypeCount = {};
      const winLabelCount = {};
      const lossTypeCount = {};
      const lossLabelCount = {};
      const riskFlagCount = {};
      const actionLabelCount = {};
      
      // Palavras-chave para extrair insights (stopwords invertidas - o que queremos)
      const keyPhrases = [
        'base instalada', 'relacionamento', 'confianÃ§a', 'champion', 'sponsor',
        'orÃ§amento', 'budget', 'timing', 'mandato', 'urgÃªncia', 'necessidade',
        'competidor', 'concorrÃªncia', 'preÃ§o', 'valor', 'roi',
        'qualificaÃ§Ã£o', 'discovery', 'meddic', 'bant', 'engajamento',
        'decisor', 'economic buyer', 'stakeholder', 'processo',
        'ata', 'pregÃ£o', 'licitaÃ§Ã£o', 'edital', 'setor pÃºblico'
      ];
      
      // FunÃ§Ã£o para extrair keywords de texto longo
      const extractKeywords = (text, maxKeywords = 3) => {
        if (!text) return [];
        const textLower = text.toLowerCase();
        const found = [];
        
        keyPhrases.forEach(phrase => {
          if (textLower.includes(phrase)) {
            found.push(phrase);
          }
        });
        
        return found.slice(0, maxKeywords);
      };
      
      // Processar deals ganhos
      wonDeals.forEach(deal => {
        // Tipo_Resultado
        if (deal.Tipo_Resultado) {
          winTypeCount[deal.Tipo_Resultado] = (winTypeCount[deal.Tipo_Resultado] || 0) + 1;
        }
        // Extrair keywords dos Fatores_Sucesso
        if (deal.Fatores_Sucesso) {
          const keywords = extractKeywords(deal.Fatores_Sucesso, 5);
          keywords.forEach(keyword => {
            winLabelCount[keyword] = (winLabelCount[keyword] || 0) + 1;
          });
        }
      });
      
      // Processar deals perdidos
      lostDeals.forEach(deal => {
        // Tipo_Resultado
        if (deal.Tipo_Resultado) {
          lossTypeCount[deal.Tipo_Resultado] = (lossTypeCount[deal.Tipo_Resultado] || 0) + 1;
        }
        // Extrair keywords da Causa_Raiz
        if (deal.Causa_Raiz) {
          const keywords = extractKeywords(deal.Causa_Raiz, 5);
          keywords.forEach(keyword => {
            lossLabelCount[keyword] = (lossLabelCount[keyword] || 0) + 1;
          });
        }
      });
      
      const normalizeConfidence = (value) => {
        let conf = parseFloat(value);
        if (!Number.isFinite(conf)) return 0;
        if (conf > 0 && conf <= 1) conf = conf * 100;
        return conf;
      };

      // Processar pipeline para flags de risco
      pipelineDeals.forEach(deal => {
        // Analisar confianÃ§a baixa
        const confidence = normalizeConfidence(deal.Confianca ?? deal.confidence ?? deal.Confidence);
        if (confidence < 30 && confidence > 0) {
          riskFlagCount['ConfianÃ§a Baixa (<30%)'] = (riskFlagCount['ConfianÃ§a Baixa (<30%)'] || 0) + 1;
        }
        
        // Data prevista atrasada
        if (deal.Data_Prevista) {
          const closeDate = new Date(deal.Data_Prevista);
          const today = new Date();
          if (closeDate < today) {
            riskFlagCount['Data Prevista Vencida'] = (riskFlagCount['Data Prevista Vencida'] || 0) + 1;
          }
        }
        
        // Deal high value sem movimento
        if (deal.Gross > 100000 && confidence > 0 && confidence < 50) {
          riskFlagCount['High Value + Baixa ConfianÃ§a'] = (riskFlagCount['High Value + Baixa ConfianÃ§a'] || 0) + 1;
        }
      });
      
      // Gerar aÃ§Ãµes recomendadas baseadas no pipeline
      pipelineDeals.forEach(deal => {
        const confidence = normalizeConfidence(deal.Confianca ?? deal.confidence ?? deal.Confidence);
        
        if (confidence > 0 && confidence < 30) {
          actionLabelCount['Qualificar Melhor (MEDDIC)'] = (actionLabelCount['Qualificar Melhor (MEDDIC)'] || 0) + 1;
        }
        if (confidence >= 30 && confidence < 50) {
          actionLabelCount['Engajar Champion'] = (actionLabelCount['Engajar Champion'] || 0) + 1;
        }
        if (confidence >= 50 && confidence < 80) {
          actionLabelCount['AvanÃ§ar para Fechamento'] = (actionLabelCount['AvanÃ§ar para Fechamento'] || 0) + 1;
        }
        if (deal.Fase_Atual === 'Propuesta' || deal.Fase_Atual === 'Proposta') {
          actionLabelCount['Enviar Proposta/Follow-up'] = (actionLabelCount['Enviar Proposta/Follow-up'] || 0) + 1;
        }
      });
      
      // Converter para arrays ordenados por frequÃªncia
      const toArray = (obj) => Object.entries(obj)
        .map(([text, value]) => ({ text, value }))
        .sort((a, b) => b.value - a.value);
      
      return {
        winTypes: toArray(winTypeCount),
        winLabels: toArray(winLabelCount),
        lossTypes: toArray(lossTypeCount),
        lossLabels: toArray(lossLabelCount),
        riskFlags: toArray(riskFlagCount),
        actionLabels: toArray(actionLabelCount)
      };
    }
    
    function showError(message) {
      document.body.innerHTML = `
        <div style="padding: 40px; text-align: center; color: #fff; background: #1c2b3e; min-height: 100vh;">
          <h2 style="color: #E14849;"><svg class="icon"><use href="#icon-alert"/></svg> Erro ao carregar dashboard</h2>
          <p style="color: #b0b8c4; margin: 20px 0;">${message}</p>
          <button onclick="location.reload()" style="
            background: #00BEFF; 
            color: #1c2b3e; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer;
            font-size: 14px;
          ">Tentar Novamente</button>
        </div>
      `;
    }
    
    // NÃ£o hÃ¡ cache no frontend Firebase; apenas recarrega a pÃ¡gina.
    function clearDashboardCache() {
      refreshDashboard();
    }

    // FunÃ§Ã£o para mostrar tempo desde Ãºltima atualizaÃ§Ã£o
    function updateTimeSinceUpdate() {
      if (!DATA || !DATA.updatedAt) return;
      
      const updateTime = new Date(DATA.updatedAt);
      const now = new Date();
      const diffMs = now - updateTime;
      const diffMins = Math.floor(diffMs / 60000);
      
      const updateElement = document.getElementById('last-update');
      if (updateElement) {
        let timeText = '';
        let color = '#10b981'; // green
        
        if (diffMins < 1) {
          timeText = 'agora mesmo';
        } else if (diffMins === 1) {
          timeText = 'hÃ¡ 1 minuto';
        } else if (diffMins < 5) {
          timeText = `hÃ¡ ${diffMins} minutos`;
        } else {
          timeText = `hÃ¡ ${diffMins} minutos`;
          color = '#f59e0b'; // orange - cache pode estar desatualizado
        }
        
        updateElement.textContent = timeText;
        updateElement.style.color = color;
        updateElement.style.fontWeight = '600';
      }
    }
    
    // Atualiza o tempo a cada 30 segundos
    setInterval(updateTimeSinceUpdate, 30000);

    // ========== LOADER FUNCTIONS ==========
    const USE_MINIMAL_LOADER = false;
    const loaderOverlay = document.getElementById('loading-overlay');
    if (loaderOverlay && USE_MINIMAL_LOADER) {
      loaderOverlay.classList.add('loader-minimal');
    }

    let initialLoaderHidden = false;
    function hideInitialLoader() {
      const loader = document.getElementById('loading-overlay');
      if (loader && !initialLoaderHidden) {
        initialLoaderHidden = true;
        loader.classList.add('hidden');
        setTimeout(() => {
          loader.style.display = 'none';
        }, 500); // Aguarda animacao de fade out
      }
    }
    
    function showFilterLoader() {
      const filterLoader = document.getElementById('filter-loading');
      if (filterLoader) {
        filterLoader.style.display = 'flex';
        filterLoader.style.visibility = 'visible';
        filterLoader.style.transition = 'opacity 0.3s ease';
        setTimeout(() => { filterLoader.style.opacity = '1'; }, 10);
      }
    }

    function hideFilterLoader() {
      const filterLoader = document.getElementById('filter-loading');
      if (filterLoader) {
        filterLoader.style.opacity = '0';
        setTimeout(() => { 
          filterLoader.style.display = 'none';
          filterLoader.style.visibility = 'hidden';
        }, 300);
      }
    }

    // Debounce para filtros (evita mÃºltiplas chamadas rÃ¡pidas)
    let filterDebounceTimer;
    function debounceFilter(func, delay = 300) {
      clearTimeout(filterDebounceTimer);
      showFilterLoader();
      filterDebounceTimer = setTimeout(() => {
        func();
        hideFilterLoader();
      }, delay);
    }

    // Helper para formataÃ§Ã£o de dinheiro (movido para antes de renderDashboard)
    function formatMoney(val) {
      if (!val && val !== 0) return '$0';
      return '$' + Math.round(val).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }

    // Helper para formatar data e hora (movido para escopo global)
    const formatDateTime = (isoString) => {
      if (!isoString || isoString === '-') return '-';
      try {
        const date = new Date(isoString);
        const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        return `${dateStr} Ã s ${timeStr}`;
      } catch (e) {
        return isoString;
      }
    };

    // Helper functions para manipulaÃ§Ã£o segura do DOM (movido para escopo global)
    const setTextSafe = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.innerText = value;
      else console.warn(`Elemento nÃ£o encontrado: ${id}`);
    };

    const setHtmlSafe = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = value;
      else console.warn(`Elemento nÃ£o encontrado: ${id}`);
    };

    const escapeHtml = (value) => {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };

    const showToast = (message, type = 'info') => {
      const id = 'toast-container';
      let container = document.getElementById(id);
      if (!container) {
        container = document.createElement('div');
        container.id = id;
        container.style.position = 'fixed';
        container.style.right = '16px';
        container.style.bottom = '16px';
        container.style.zIndex = '9999';
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.gap = '8px';
        document.body.appendChild(container);
      }

      const toast = document.createElement('div');
      const colors = {
        info: '#00BEFF',
        success: '#C0FF7D',
        warning: '#FFA500',
        error: '#E14849'
      };
      const color = colors[type] || colors.info;
      toast.style.background = 'rgba(15, 23, 42, 0.95)';
      toast.style.border = `1px solid ${color}`;
      toast.style.color = '#fff';
      toast.style.padding = '10px 14px';
      toast.style.borderRadius = '10px';
      toast.style.fontSize = '12px';
      toast.style.boxShadow = '0 8px 20px rgba(0,0,0,0.35)';
      toast.innerText = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    };

    const setBarSafe = (id, width, text) => {
      const el = document.getElementById(id);
      if (el) {
        el.style.width = width + '%';
        el.innerText = text;
      } else {
        console.warn(`Elemento de barra nÃ£o encontrado: ${id}`);
      }
    };

    // Helper para valores seguros (movido para escopo global)
    const safe = (obj, path, defaultVal = 0) => {
      const keys = path.split('.');
      let current = obj;
      for (const key of keys) {
        if (current && current[key] !== undefined) {
          current = current[key];
        } else {
          return defaultVal;
        }
      }
      return current;
    };

    // Helper para limpar possÃ­veis JSONs da IA
    const cleanAIResponse = (text) => {
      if (!text || typeof text !== 'string') return text;
      
      let cleaned = text.trim();
      
      // Se comeÃ§a com { e termina com }, tenta extrair JSON
      if (cleaned.startsWith('{') && cleaned.endsWith('}')) {
        try {
          // Tenta fazer parse do JSON
          const parsed = JSON.parse(cleaned);
          
          // Se Ã© um objeto simples com 1 campo, pega o valor
          const keys = Object.keys(parsed);
          if (keys.length === 1) {
            cleaned = parsed[keys[0]];
            log(`âœ‚ï¸ Frontend: JSON extraÃ­do da chave "${keys[0]}"`);
          } else {
            // Se tem mÃºltiplas chaves, tenta pegar campos comuns
            cleaned = parsed.resumo_executivo || 
                      parsed.paragrafo_executivo || 
                      parsed.summary_html || 
                      parsed.resumo_semanal_html ||
                      parsed.resumo_semanal_cro ||
                      parsed.html || 
                      parsed.content || 
                      parsed.texto ||
                      cleaned;
            log(`âœ‚ï¸ Frontend: JSON extraÃ­do de objeto com ${keys.length} campos`);
          }
        } catch (e) {
          log(`<svg class="icon"><use href="#icon-alert"/></svg> Frontend: JSON malformado, usando regex: ${e.message}`);
        }
      }
      
      // Aplica limpeza mÃºltiplas vezes para garantir remoÃ§Ã£o completa (fallback)
      for (let i = 0; i < 3; i++) {
        // { "campo": "valor" } -> valor (padrÃ£o completo)
        cleaned = cleaned.replace(/^\s*\{\s*"[^"]+"\s*:\s*"([^"]*)"\s*\}\s*$/s, '$1');
        
        // { "campo": "valor... -> valor...
        cleaned = cleaned.replace(/^\s*\{\s*"[^"]+"\s*:\s*"/, '');
        
        // ..." } -> ...
        cleaned = cleaned.replace(/"\s*\}\s*$/, '');
        
        // { "campo": (sem aspas no valor)
        cleaned = cleaned.replace(/^\s*\{\s*"[^"]+"\s*:\s*/, '');
        
        // } no final
        cleaned = cleaned.replace(/\s*\}\s*$/, '');
      }
      
      // Remove escapes e converte quebras
      cleaned = cleaned.replace(/\\n/g, '\n');
      cleaned = cleaned.replace(/\\"/g, '"');
      cleaned = cleaned.replace(/\\'/g, "'");
      cleaned = cleaned.replace(/\n/g, '<br>');
      
      return cleaned.trim();
    };

    function renderDashboard() {
      try {
        log('[RENDER] ========== INÃCIO DA RENDERIZAÃ‡ÃƒO ==========');
        log('[RENDER] Timestamp:', new Date().toISOString());
        
        // Declare hasActiveFilters logo no inÃ­cio para uso em toda a funÃ§Ã£o
        const hasActiveFilters = window.currentFilters && (window.currentFilters.year || window.currentFilters.quarter || window.currentFilters.month || window.currentFilters.seller);
        
        // CORREÃ‡ÃƒO: Usa metrics da API (window.currentApiMetrics) se disponÃ­vel, senÃ£o fallback para DATA.cloudAnalysis
        const apiFilteredData = (window.currentApiMetrics && window.currentApiMetrics.pipeline_filtered) 
          ? window.currentApiMetrics.pipeline_filtered
          : safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.pipeline_filtered', {});
        
        // Adicionar high_confidence ao apiFilteredData para uso posterior
        if (window.currentApiMetrics && window.currentApiMetrics.high_confidence) {
          apiFilteredData.high_confidence = window.currentApiMetrics.high_confidence;
        } else {
          apiFilteredData.high_confidence = safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.high_confidence', {});
        }
        
        // ============================================================================
        // MÃ‰TRICAS ESTÃTICAS DESATIVADAS (sem fallback)
        // ============================================================================
        log('[RENDER] === MÃ‰TRICAS ESTÃTICAS DESATIVADAS ===');
        window.STATIC_METRICS_LOADED = false;
        window.STATIC_METRICS = null;

        // Header
        log('[RENDER] === HEADER ===');
        log('[DATA] updatedAt:', safe(DATA, 'updatedAt', '-'));
        log('[DATA] quarterLabel:', safe(DATA, 'quarterLabel', 'FY26'));
        setTextSafe('last-update', formatDateTime(safe(DATA, 'updatedAt', '-')));
        setTextSafe('quarter-label', safe(DATA, 'quarterLabel', 'FY26'));
        // Removido: quarter-label-exec (elemento foi removido do HTML)
        
        // Atualiza indicador de tempo desde Ãºltima atualizaÃ§Ã£o
        updateTimeSinceUpdate();

        // 0. VISÃƒO EXECUTIVA - NOVA ESTRUTURA
        log('[RENDER] ========== VISÃƒO EXECUTIVA ==========');
        
        // SEÃ‡ÃƒO 1: MÃ‰TRICAS PRINCIPAIS
        log('[RENDER] === SEÃ‡ÃƒO 1: MÃ‰TRICAS PRINCIPAIS ===');
        // Calcula mÃ©tricas do quarter a partir dos dados jÃ¡ carregados
        const scorecard = DATA.fsrScorecard || [];
        log('[DATA] fsrScorecard:', scorecard.length, 'vendedores');
        const activeReps = scorecard.filter(r => r.isActive);
        log('[CALC] Vendedores ativos:', activeReps.length, '/', scorecard.length);
        
        // Pipeline do quarter - USA DADOS DA VISÃƒO EXECUTIVA (L10)
        const l10 = DATA.executive || DATA.l10 || {};
        const quarters = DATA.weeklyAgenda || {};
        log('[DATA] weeklyAgenda quarters:', Object.keys(quarters));
        log('[DATA] l10 disponÃ­vel:', !!DATA.l10);
        
        // IMPORTANTE: pipelineTotal usa TODOS os anos (allPipelineGross), nÃ£o apenas FY26
        // VISÃƒO EXECUTIVA: LÃª de cloudAnalysis (Python/BigQuery) ou metrics diretamente
        let pipelineTotal = safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.pipeline_all.gross', null);
        let pipelineTotalNet = safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.pipeline_all.net', null);
        let pipelineDeals = safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.pipeline_all.deals_count', null);
        
        // Se cloudAnalysis nÃ£o tiver os dados, usar metrics diretamente da API
        if (pipelineTotal === null || pipelineTotal === 0) {
          log('[FALLBACK] Usando metrics da API para KPIs principais');
          pipelineTotal = safe(DATA, 'cloudAnalysis.pipeline_analysis.metrics.pipeline_total.gross', 0);
          pipelineTotalNet = safe(DATA, 'cloudAnalysis.pipeline_analysis.metrics.pipeline_total.net', 0);
          pipelineDeals = safe(DATA, 'cloudAnalysis.pipeline_analysis.metrics.pipeline_total.deals_count', 0);
        }
        
        log('[KPI] Pipeline Total:', formatMoney(pipelineTotal), 'deals:', pipelineDeals);
        
        let commitValue = 0;
        let upsideValue = 0;
        let pipelineValue = 0;
        let totalConfidence = 0; // Para calcular mÃ©dia ponderada
        let totalDealsProcessed = 0; // Contador correto de deals para mÃ©dia
        let totalNetSum = 0; // Soma de Net de TODOS os deals
        // Esses valores vÃªm DA API, nÃ£o calculamos mais localmente
        let above50Value = 0; // Soma de Gross >= 50% (DA API)
        let above50Net = 0; // Soma de Net >= 50% (DA API)
        let above50Count = 0; // Contagem de deals >= 50% (DA API)
        const allDeals = []; // Para principais oportunidades
        
        // Armazena todos os deals com seus dados para recalcular por perÃ­odo
        window.allDealsWithConfidence = [];
        
        // Recalcula forecast categories usando GROSS (nÃ£o weighted) e allDeals
        Object.values(quarters).forEach(deals => {
          if (deals && Array.isArray(deals)) {
            deals.forEach(d => {
              let conf = d.confidence || 0;
              // Se confianÃ§a vem como nÃºmero inteiro (ex: 50 ao invÃ©s de 0.5), divide por 100
              if (conf > 1) conf = conf / 100;
              const grossValue = d.val || 0; // Usa GROSS direto
              const netValue = d.net || 0; // NET do deal
              totalConfidence += conf;
              totalDealsProcessed++; // Incrementa contador de deals processados
              totalNetSum += netValue; // Acumula Net de TODOS os deals
              
              // NÃƒO calcula deals >= 50% aqui - serÃ¡ pego da API
              
              // Armazena deal completo para recalcular por filtro
              window.allDealsWithConfidence.push({
                gross: grossValue,
                net: netValue,
                confidence: conf,
                closeDate: d.closeDate || d.closed,
                stage: d.stage,
                fiscalQ: d.fiscalQ || d.fiscal_q || '',  // Armazena Fiscal Q para filtro
                forecastCategory: d.forecastCategory || 'PIPELINE'  // â† Categoria de forecast para barras
              });
              
              // Classifica por categoria de forecast (AnÃ¡lise IA)
              // COMMIT: â‰¥90%, UPSIDE: 50-89%, PIPELINE: <50%
              // ConfianÃ§a jÃ¡ estÃ¡ em decimal (0.0 a 1.0)
              if (conf >= 0.90) commitValue += grossValue;
              else if (conf >= 0.50) upsideValue += grossValue;
              else pipelineValue += grossValue;
              
              // Guarda deal para lista de principais
              allDeals.push(d);
            });
          }
        });
        
        // Fallback para mÃ©tricas agregadas quando nÃ£o hÃ¡ deals detalhados
        const cloudMetrics = DATA.cloudMetrics || {};
        if (totalDealsProcessed === 0) {
          if (cloudMetrics.commitGross || cloudMetrics.upsideGross || cloudMetrics.pipelineGross) {
            commitValue = cloudMetrics.commitGross || 0;
            upsideValue = cloudMetrics.upsideGross || 0;
            pipelineValue = cloudMetrics.pipelineGross || 0;
          }
        }
        
        // <svg class="icon"><use href="#icon-check"/></svg> SEMPRE pega high_confidence da API (com ou sem filtros)
        const highConfFromAPI = hasActiveFilters 
          ? apiFilteredData.high_confidence 
          : safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.high_confidence', {});
        
        if (highConfFromAPI && (highConfFromAPI.gross || highConfFromAPI.deals_count)) {
          above50Value = highConfFromAPI.gross || 0;
          above50Net = highConfFromAPI.net || 0;
          above50Count = highConfFromAPI.deals_count || 0;
          log('[HIGH-CONF] <svg class="icon"><use href="#icon-check"/></svg> Usando valores DA API:', {
            filtered: hasActiveFilters,
            gross: formatMoney(above50Value),
            net: formatMoney(above50Net),
            count: above50Count
          });
        } else {
          log('[HIGH-CONF] <svg class="icon"><use href="#icon-alert"/></svg> Dados nÃ£o disponÃ­veis na API');
        }

        // FunÃ§Ã£o global para recalcular saÃºde do forecast por perÃ­odo (usando forecast_ia do BigQuery)
        window.updateForecastHealth = function(period) {
          log('[FORECAST HEALTH] Iniciando atualizaÃ§Ã£o para perÃ­odo:', period);
          log('[FORECAST HEALTH] Total de deals armazenados:', window.allDealsWithConfidence ? window.allDealsWithConfidence.length : 0);
          
          let filteredCommit = 0, filteredCommitNet = 0;
          let filteredUpside = 0, filteredUpsideNet = 0;
          let filteredPipeline = 0, filteredPipelineNet = 0;
          let filteredPotencial = 0, filteredPotencialNet = 0;
          let filteredOmitido = 0, filteredOmitidoNet = 0;
          
          if (period === 'all' || period === 'total') {
            // Usa todos os deals
            window.allDealsWithConfidence.forEach(d => {
              const category = (d.forecastCategory || '').toUpperCase();
              const gross = d.gross || 0;
              const net = d.net || 0;
              
              if (category.includes('COMMIT')) { filteredCommit += gross; filteredCommitNet += net; }
              else if (category === 'UPSIDE') { filteredUpside += gross; filteredUpsideNet += net; }
              else if (category === 'POTENCIAL') { filteredPotencial += gross; filteredPotencialNet += net; }
              else if (category.includes('OMIT')) { filteredOmitido += gross; filteredOmitidoNet += net; }
              else { filteredPipeline += gross; filteredPipelineNet += net; }
            });
          } else {
            // Filtra por quarter usando Fiscal Q (ex: "FY26-Q1")
            const targetQuarter = 'FY26-' + period.toUpperCase(); // Ex: "q1" -> "FY26-Q1"
            
            log('[FORECAST HEALTH] Filtrando para:', targetQuarter);
            
            window.allDealsWithConfidence.forEach(d => {
              // Usa fiscalQ se disponÃ­vel, senÃ£o tenta pela data
              if (d.fiscalQ === targetQuarter) {
                const category = (d.forecastCategory || '').toUpperCase();
                const gross = d.gross || 0;
                const net = d.net || 0;
                
                if (category.includes('COMMIT')) { filteredCommit += gross; filteredCommitNet += net; }
                else if (category === 'UPSIDE') { filteredUpside += gross; filteredUpsideNet += net; }
                else if (category === 'POTENCIAL') { filteredPotencial += gross; filteredPotencialNet += net; }
                else if (category.includes('OMIT')) { filteredOmitido += gross; filteredOmitidoNet += net; }
                else { filteredPipeline += gross; filteredPipelineNet += net; }
              }
            });
          }
          
          const totalForecast = filteredCommit + filteredUpside + filteredPipeline + filteredPotencial + filteredOmitido;
          const commitPercent = totalForecast > 0 ? (filteredCommit / totalForecast) * 100 : 0;
          const upsidePercent = totalForecast > 0 ? (filteredUpside / totalForecast) * 100 : 0;
          const pipelinePercent = totalForecast > 0 ? (filteredPipeline / totalForecast) * 100 : 0;
          const potencialPercent = totalForecast > 0 ? (filteredPotencial / totalForecast) * 100 : 0;
          const omitidoPercent = totalForecast > 0 ? (filteredOmitido / totalForecast) * 100 : 0;
          
          log('[FORECAST HEALTH] Valores calculados:', {
            'totalForecast': formatMoney(totalForecast),
            'commit': formatMoney(filteredCommit) + ' (' + Math.round(commitPercent) + '%)',
            'upside': formatMoney(filteredUpside) + ' (' + Math.round(upsidePercent) + '%)',
            'pipeline': formatMoney(filteredPipeline) + ' (' + Math.round(pipelinePercent) + '%)',
            'potencial': formatMoney(filteredPotencial) + ' (' + Math.round(potencialPercent) + '%)',
            'omitido': formatMoney(filteredOmitido) + ' (' + Math.round(omitidoPercent) + '%)'
          });
          
          setBarSafe('forecast-commit-bar', commitPercent, commitPercent >= 10 ? 'COMMIT' : '');
          setBarSafe('forecast-upside-bar', upsidePercent, upsidePercent >= 10 ? 'UPSIDE' : '');
          setBarSafe('forecast-pipeline-bar', pipelinePercent, pipelinePercent >= 10 ? 'PIPELINE' : '');
          setBarSafe('forecast-potencial-bar', potencialPercent, potencialPercent >= 10 ? 'POTENCIAL' : '');
          setBarSafe('forecast-omitido-bar', omitidoPercent, omitidoPercent >= 10 ? 'OMITIDO' : '');
          
          setTextSafe('forecast-commit-value', formatMoney(filteredCommit) + ' (' + Math.round(commitPercent) + '%)');
          setTextSafe('forecast-upside-value', formatMoney(filteredUpside) + ' (' + Math.round(upsidePercent) + '%)');
          setTextSafe('forecast-pipeline-value', formatMoney(filteredPipeline) + ' (' + Math.round(pipelinePercent) + '%)');
          setTextSafe('forecast-potencial-value', formatMoney(filteredPotencial) + ' (' + Math.round(potencialPercent) + '%)');
          setTextSafe('forecast-omitido-value', formatMoney(filteredOmitido) + ' (' + Math.round(omitidoPercent) + '%)');
          
          // Atualizar spans de Net
          setTextSafe('forecast-commit-net', 'Net: ' + formatMoney(filteredCommitNet));
          setTextSafe('forecast-upside-net', 'Net: ' + formatMoney(filteredUpsideNet));
          setTextSafe('forecast-pipeline-net', 'Net: ' + formatMoney(filteredPipelineNet));
          setTextSafe('forecast-potencial-net', 'Net: ' + formatMoney(filteredPotencialNet));
          setTextSafe('forecast-omitido-net', 'Net: ' + formatMoney(filteredOmitidoNet));
        };
        
        // Inicializar barras com todos os deals (load inicial)
        if (window.allDealsWithConfidence.length > 0) {
          window.updateForecastHealth('all');
        }
        
        log('[CALC] Pipeline calculado:', {
          'total': formatMoney(pipelineTotal),
          'deals': pipelineDeals,
          'above50Value': formatMoney(above50Value),
          'above50Count': above50Count,
          'commitValue': formatMoney(commitValue),
          'upsideValue': formatMoney(upsideValue),
          'pipelineValue': formatMoney(pipelineValue),
          'allDeals': allDeals.length
        });
        
        // PrevisÃ£o ponderada MÃ‰DIA (busca da anÃ¡lise de IA ou calcula como fallback)
        let confidenceFromAI = 0;
        if (DATA.aiAnalysis && DATA.aiAnalysis.forecastAnalysis) {
          // Tenta extrair a confianÃ§a da anÃ¡lise de IA
          const forecastMatch = DATA.aiAnalysis.forecastAnalysis.match(/ConfianÃ§a[^\d]*(\d+)%/i);
          if (forecastMatch) {
            confidenceFromAI = parseInt(forecastMatch[1]);
            log('[DATA] ConfianÃ§a extraÃ­da da anÃ¡lise de IA:', confidenceFromAI + '%');
          }
        }
        
        // CRÃTICO: Se hÃ¡ filtros ativos, usar avg_confidence da API filtrada
        let avgConfidence = 0;
        if (hasActiveFilters && apiFilteredData.avg_confidence !== undefined) {
          avgConfidence = apiFilteredData.avg_confidence;
          log('[CALC] ConfianÃ§a FILTRADA da API:', avgConfidence + '%', '(' + apiFilteredData.deals_count + ' deals)');
        } else {
          // avgConfidence: calcula mÃ©dia REAL dos deals processados (nÃ£o usar estÃ¡ticos)
          const avgConfidenceCalc = totalDealsProcessed > 0 ? (totalConfidence / totalDealsProcessed) * 100 : 0;
          avgConfidence = avgConfidenceCalc;
          
          // Fallback apenas se nÃ£o conseguiu calcular dos deals
          if (avgConfidence === 0 && cloudMetrics.avgConfidence) {
            avgConfidence = cloudMetrics.avgConfidence;
            log('[FALLBACK] Usando confianÃ§a do cloudMetrics:', avgConfidence + '%');
          } else if (avgConfidence === 0) {
            avgConfidence = confidenceFromAI;
            log('[FALLBACK] Usando confianÃ§a extraÃ­da da IA:', avgConfidence + '%');
          }
          
          log('[CALC] ConfianÃ§a mÃ©dia TOTAL calculada:', Math.round(avgConfidence) + '%', '(' + totalDealsProcessed + ' deals processados)');
        }
        
        // CORREÃ‡ÃƒO: PrevisÃ£o Ponderada deve usar pipeline FILTRADO quando hÃ¡ filtros ativos
        const pipelineForForecast = (hasActiveFilters && apiFilteredData.gross) 
          ? apiFilteredData.gross 
          : pipelineTotal;
        const forecastAvgWeighted = pipelineForForecast * (avgConfidence / 100);
        log('[CALC] Forecast ponderado:', formatMoney(forecastAvgWeighted), 'usando pipeline', formatMoney(pipelineForForecast), 'x', Math.round(avgConfidence) + '%');
        
        // Armazena globalmente para evitar reset ao filtrar
        window.avgConfidence = avgConfidence;
        
        // Quarter atual para cÃ¡lculos dependentes
        const currentQuarterLabel = DATA.quarterLabel || safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.quarter', 'FY26-Q1');

        // Total fechado no quarter (soma dos ganhos dos vendedores ativos - APENAS QUARTER ATUAL)
        let closedGross = activeReps.reduce((sum, r) => sum + (r.revenueGross || 0), 0);
        let closedNet = activeReps.reduce((sum, r) => sum + (r.revenue || 0), 0);
        let closedDeals = activeReps.reduce((sum, r) => sum + (r.totalWonQuarter || 0), 0);
        const closedQuarter = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.closed', null);
        if (closedDeals === 0 && closedQuarter) {
          closedGross = closedQuarter.gross || 0;
          closedNet = closedQuarter.net || 0;
          closedDeals = closedQuarter.deals_count || 0;
        }
        log('[CALC] Fechados no Quarter:', formatMoney(closedGross), '(Gross) |', formatMoney(closedNet), '(Net) | (', closedDeals, 'deals )');
        
        // CORREÃ‡ÃƒO: Declara wonAgg e lostAgg ANTES de usar
        const wonAgg = DATA.wonAgg || [];
        const lostAgg = DATA.lostAgg || [];
        log('[DATA] wonAgg disponÃ­vel:', wonAgg.length, 'deals');
        log('[DATA] lostAgg disponÃ­vel:', lostAgg.length, 'deals');
        
        // Armazena globalmente para outras funÃ§Ãµes (ex: updateConversionMetricsForPeriod)
        window.wonAgg = wonAgg;
        window.lostAgg = lostAgg;
        
        // Taxa de conversÃ£o do quarter (APENAS QUARTER ATUAL)
        // CORREÃ‡ÃƒO: Usar wonAgg.length diretamente em vez de soma dos vendedores (pode estar zerada)
        let totalWins = wonAgg.length;
        let totalLosses = lostAgg.length;
        let totalDeals = totalWins + totalLosses;
        let conversionRate = totalDeals > 0 ? Math.round((totalWins / totalDeals) * 100) : 0;
        
        // Se ainda zerado, tentar do cloudAnalysis como fallback final
        if (totalDeals === 0) {
          const closedStats = safe(DATA, 'cloudAnalysis.closed_analysis', {});
          const convStats = safe(DATA, 'cloudAnalysis.conversion_rate', {});
          const winRate = convStats.win_rate || closedStats.win_rate || 0;
          conversionRate = Math.round(winRate);
          totalWins = closedStats.won || wonAgg.length || 0;
          totalLosses = closedStats.lost || lostAgg.length || 0;
          totalDeals = totalWins + totalLosses;
        }
        
        // GROSS e NET de Ganhas e Perdidas (quarter atual)
        let winsGross = 0;
        let winsNet = 0;
        let lossesGross = 0;
        let lossesNet = 0;
        
        // Soma GROSS/NET das ganhas do quarter atual
        wonAgg.forEach(item => {
          if (item.fiscalQ === currentQuarterLabel) {
            winsGross += item.gross || 0;
            winsNet += item.net || 0;
          }
        });
        
        // Soma GROSS/NET das perdidas do quarter atual
        lostAgg.forEach(item => {
          if (item.fiscalQ === currentQuarterLabel) {
            lossesGross += item.gross || 0;
            lossesNet += item.net || 0;
          }
        });
        
        log('[CALC] ConversÃ£o do Quarter:', conversionRate + '%', '(', totalWins, '/', totalDeals, 'deals )');
        log('[CALC] Ganhas - Gross:', formatMoney(winsGross), '| Net:', formatMoney(winsNet), '(', totalWins, 'deals)');
        log('[CALC] Perdidas - Gross:', formatMoney(lossesGross), '| Net:', formatMoney(lossesNet), '(', totalLosses, 'deals)');
        
        // Popula KPIs do Placar
        log('[RENDER] Populando KPIs do Placar...');
        
        // ============================================================================
        // ARQUITETURA HÃBRIDA: Usa mÃ©tricas estÃ¡ticas SE disponÃ­veis, senÃ£o fallback
        // ============================================================================
        
        let pipelineTotalAnoGross, pipelineTotalAnoNet, pipelineTotalAnoDeals;
        let pipelineSalesSpecGross, pipelineSalesSpecNet, pipelineSalesSpecDeals;
        let allPipelineGross, allPipelineNet, allPipelineDeals;
        
        // <svg class="icon"><use href="#icon-check"/></svg> SEMPRE usar mÃ©tricas da API (nunca STATIC_METRICS)
        log('[METRICS] <svg class="icon"><use href="#icon-check"/></svg> Usando mÃ©tricas da API CloudAnalysis');
          
        // VISÃƒO EXECUTIVA: CloudAnalysis
        pipelineTotalAnoGross = safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.pipeline_fy26.gross', 0);
        pipelineTotalAnoNet = safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.pipeline_fy26.net', 0);
        pipelineTotalAnoDeals = safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.pipeline_fy26.deals_count', 0);
        
        pipelineSalesSpecGross = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.gross', 0);
        pipelineSalesSpecNet = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.net', 0);
        pipelineSalesSpecDeals = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.deals_count', 0);
        
        // CORREÃ‡ÃƒO: Inicializa allPipeline com pipelineTotalAno (total sem filtro)
        // Nunca deve ser zerado por filtros, apenas atualizado se houver valor maior
        allPipelineGross = pipelineTotalAnoGross || pipelineTotal;
        allPipelineNet = pipelineTotalAnoNet || (pipelineTotal * window.pipelineNetRatio);
        allPipelineDeals = pipelineTotalAnoDeals || totalDealsProcessed;
        
        // Se houver pipeline_all do cloudAnalysis e for MAIOR, usar esse
        const cloudPipelineAll = safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.pipeline_all', {});
        if (cloudPipelineAll.gross > allPipelineGross) {
          allPipelineGross = cloudPipelineAll.gross;
          allPipelineNet = cloudPipelineAll.net || allPipelineNet;
          allPipelineDeals = cloudPipelineAll.deals_count || allPipelineDeals;
        }
        
        // Detecta FY atual baseado na data (extrai FY26 de "FY26-Q1")
        const currentFY = safe(DATA, 'quarterLabel', 'FY26-Q1').split('-')[0]; // Extrai "FY26" de "FY26-Q1"
        window.currentFY = currentFY;

        // Detalhamento por quarter (sempre do payload JSON - usado para filtros)
        // VISÃƒO EXECUTIVA: Quarters de cloudAnalysis
        const qDetailsRaw = safe(DATA, 'cloudAnalysis.pipeline_analysis.executive.pipeline_by_quarter', {});
        
        // NOVOS KPIS: Pipeline Total Ano e Sales Specialist (usa valores hÃ­bridos)
        
        log('[CALC] Pipeline FY26:', formatMoney(pipelineTotalAnoGross), '(', pipelineTotalAnoDeals, 'deals )');
        log('[CALC] PrevisÃ£o Sales Specialist:', formatMoney(pipelineSalesSpecGross), '(', pipelineSalesSpecDeals, 'deals )');
        log('[CALC] Pipeline Total (Todos Anos):', formatMoney(allPipelineGross), '(', allPipelineDeals, 'deals )');
        
        // Atualiza labels dos filtros com formato completo FY26-Q1
        setTextSafe('filter-total-label', 'Todo Pipeline (' + currentFY + ')');
        setTextSafe('filter-q1-label', currentFY + '-Q1');
        setTextSafe('filter-q2-label', currentFY + '-Q2');
        setTextSafe('filter-q3-label', currentFY + '-Q3');
        setTextSafe('filter-q4-label', currentFY + '-Q4');
        
        // Normaliza quarters (suporta FY26-Q1 e Q1)
        const qDetails = {
          Q1: qDetailsRaw[currentFY + '-Q1'] || qDetailsRaw.Q1 || { gross: 0, net: 0, count: 0 },
          Q2: qDetailsRaw[currentFY + '-Q2'] || qDetailsRaw.Q2 || { gross: 0, net: 0, count: 0 },
          Q3: qDetailsRaw[currentFY + '-Q3'] || qDetailsRaw.Q3 || { gross: 0, net: 0, count: 0 },
          Q4: qDetailsRaw[currentFY + '-Q4'] || qDetailsRaw.Q4 || { gross: 0, net: 0, count: 0 }
        };

        // Inicializa com view total
        // IMPORTANTE: Se hÃ¡ filtros ativos, usar dados REAIS da API (metrics.pipeline_filtered)
        // Caso contrÃ¡rio, usar dados estÃ¡ticos do JSON
        // (hasActiveFilters e apiFilteredData jÃ¡ declarados no inÃ­cio da funÃ§Ã£o)
        
        if (hasActiveFilters && apiFilteredData.deals_count > 0) {
          // Usar dados filtrados da API - TODOS OS CAMPOS
          log('[PIPELINE DATA] <svg class="icon"><use href="#icon-check"/></svg> Usando dados FILTRADOS da API para TODOS os quarters');
          log('[PIPELINE DATA] Filtered:', apiFilteredData.deals_count, 'deals', formatMoney(apiFilteredData.gross));
          
          // Quando hÃ¡ filtro, todos os campos usam dados filtrados (nÃ£o hÃ¡ breakdown por quarter)
          const filteredData = { gross: apiFilteredData.gross || 0, net: apiFilteredData.net || 0, count: apiFilteredData.deals_count || 0 };
          window.pipelineData = {
            all: filteredData,
            total: filteredData,
            q1: filteredData,  // Usar dados filtrados, nÃ£o qDetails
            q2: filteredData,
            q3: filteredData,
            q4: filteredData
          };
        } else {
          // Usar dados estÃ¡ticos do JSON (sem filtro) - COM BREAKDOWN
          log('[PIPELINE DATA] Usando dados ESTÃTICOS do JSON com breakdown por quarter');
          window.pipelineData = {
            all: { gross: allPipelineGross, net: allPipelineNet, count: allPipelineDeals },
            total: { gross: pipelineTotalAnoGross, net: pipelineTotalAnoNet, count: pipelineTotalAnoDeals },
            q1: qDetails.Q1 || { gross: 0, net: 0, count: 0 },
            q2: qDetails.Q2 || { gross: 0, net: 0, count: 0 },
            q3: qDetails.Q3 || { gross: 0, net: 0, count: 0 },
            q4: qDetails.Q4 || { gross: 0, net: 0, count: 0 }
          };
        }

        window.pipelineAggByQuarter = safe(DATA, 'cloudAnalysis.aggregations.by_quarter', []);
        window.pipelineAggBySellerQuarter = safe(DATA, 'cloudAnalysis.aggregations.by_seller_quarter', []);
        window.pipelineNetRatio = allPipelineGross > 0 ? (allPipelineNet / allPipelineGross) : 0;

        // Dados Sales Specialist por Fiscal Q (baseado em Closed Date)
        // VISÃƒO EXECUTIVA: Sales Specialist breakdown  
        const salesSpecCommitGross = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.commit_gross', 0);
        const salesSpecCommitNet = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.commit_net', 0);
        const salesSpecCommitDeals = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.commit_deals', 0);
        const salesSpecUpsideGross = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.upside_gross', 0);
        const salesSpecUpsideNet = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.upside_net', 0);
        const salesSpecUpsideDeals = safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.upside_deals', 0);
        
        window.salesSpecData = {
          all: { gross: pipelineSalesSpecGross, net: pipelineSalesSpecNet, count: pipelineSalesSpecDeals },
          byFiscalQ: safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.forecast_specialist.by_fiscal_q', {}),
          commitGross: salesSpecCommitGross,
          commitNet: salesSpecCommitNet,
          upsideGross: salesSpecUpsideGross,
          upsideNet: salesSpecUpsideNet
        };
        
        // ============================================================================
        // POPULA KPIs (usa mÃ©tricas estÃ¡ticas se disponÃ­veis, senÃ£o usa valores locais)
        // ============================================================================
        
        // SE mÃ©tricas estÃ¡ticas NÃƒO foram carregadas ainda, popula com valores locais
        if (!window.STATIC_METRICS_LOADED) {
          log('[HYBRID] Populando KPIs com valores locais (mÃ©tricas estÃ¡ticas ainda carregando...)');
          log('[DEBUG] hasActiveFilters:', hasActiveFilters);
          log('[DEBUG] window.currentFilters:', window.currentFilters);
          
          // Pipeline Total (TODOS OS ANOS) - ESTÃTICO
          setTextSafe('exec-pipeline-year-total', formatMoney(allPipelineGross));
          setTextSafe('exec-pipeline-year-deals', allPipelineDeals + ' deals abertos');
          setTextSafe('exec-pipeline-year-net', 'Net: ' + formatMoney(allPipelineNet));

          // Pipeline (PerÃ­odo Filtrado) - DINÃ‚MICO
          // CORREÃ‡ÃƒO: NÃƒO sobrescrever se updateExecutiveMetricsFromAPI() jÃ¡ atualizou
          // Somente atualizar se NÃƒO hÃ¡ filtros ativos (load inicial sem filtros)
          if (!hasActiveFilters) {
            const initialPipelineGross = allPipelineGross;
            const initialPipelineNet = allPipelineNet;
            const initialPipelineDeals = allPipelineDeals;
            
            setTextSafe('exec-pipeline-total', formatMoney(initialPipelineGross));
            setTextSafe('exec-pipeline-deals', initialPipelineDeals + ' deals no perÃ­odo');
            setTextSafe('exec-pipeline-net', 'Net: ' + formatMoney(initialPipelineNet));
            log('[PIPELINE FILTERED] <svg class="icon"><use href="#icon-x"/></svg> Sobrescrito com valores totais (sem filtro):', formatMoney(initialPipelineGross));
          } else {
            log('[PIPELINE FILTERED] â­ï¸ MANTENDO valores da API (jÃ¡ atualizados por updateExecutiveMetricsFromAPI)');
            log('[DEBUG] Filtros ativos detectados - NÃƒO sobrescrevendo card');
          }
          
          // Sales Specialist
          setTextSafe('exec-pipeline-specialist-total', formatMoney(pipelineSalesSpecGross));
          setTextSafe('exec-pipeline-specialist-deals', pipelineSalesSpecDeals + ' deals curados');
          setTextSafe('exec-pipeline-specialist-net', 'Net: ' + formatMoney(pipelineSalesSpecNet));
        } else {
          log('[HYBRID] <svg class="icon"><use href="#icon-alert"/></svg> STATIC_METRICS_LOADED = true, pulando populaÃ§Ã£o de KPIs');
        }
        
        // Vendedores Ativos e Win Rate
        // CRÃTICO: Se hÃ¡ filtros ativos, usar dados filtrados da API
        let totalVendedores = scorecard.length;
        let displayConversionRate = conversionRate;
        
        if (hasActiveFilters && apiFilteredData.deals_count > 0) {
          // Contar vendedores Ãºnicos com deals no perÃ­odo filtrado
          const uniqueSellers = new Set();
          const pipelineDealsFiltered = window.pipelineDataRaw || [];
          pipelineDealsFiltered.forEach(d => {
            if (d.Vendedor) uniqueSellers.add(d.Vendedor);
          });
          totalVendedores = uniqueSellers.size;
          
          // Usar win_rate da API filtrada (jÃ¡ vem do metrics)
          const apiWinRate = safe(DATA, 'cloudAnalysis.pipeline_analysis.metrics.win_rate', null);
          if (apiWinRate !== null) {
            displayConversionRate = Math.round(apiWinRate);
          }
          log('[VENDEDORES] <svg class="icon"><use href="#icon-check"/></svg> Usando dados FILTRADOS:', totalVendedores, 'vendedores, Win Rate:', displayConversionRate + '%');
        }
        
        window.totalVendedores = totalVendedores;
        setTextSafe('exec-active-reps', totalVendedores);
        setTextSafe('exec-winrate', 'Win Rate: ' + displayConversionRate + '%');
        
        // Popula Net em outros cards
        // CORREÃ‡ÃƒO: Net Forecast deve usar pipeline FILTRADO quando hÃ¡ filtros ativos
        const pipelineNetForForecast = (hasActiveFilters && apiFilteredData.net) 
          ? apiFilteredData.net 
          : (totalNetSum > 0 ? totalNetSum : (allPipelineNet || pipelineTotalNet || 0));
        const forecastNetWeighted = pipelineNetForForecast * (avgConfidence / 100);
        log('[CALC] Net Forecast:', { totalNetSum, pipelineNetForForecast, avgConfidence, forecastNetWeighted, hasActiveFilters });
        setTextSafe('exec-forecast-net', 'Net: ' + formatMoney(forecastNetWeighted));
        setTextSafe('exec-above50-net', 'Net: ' + formatMoney(above50Net));
        
        // CORREÃ‡ÃƒO: SÃ³ chamar filterPipeline('all') se NÃƒO hÃ¡ filtros ativos
        // Caso contrÃ¡rio, mantÃ©m valores filtrados da API
        if (!hasActiveFilters) {
          log('[RENDER] <svg class="icon"><use href="#icon-chart"/></svg> Inicializando com filtro ALL (sem filtros ativos)');
          filterPipeline('all'); // Renderiza view inicial - jÃ¡ popula Deals Fechados e Taxa ConversÃ£o
        } else {
          log('[RENDER] <svg class="icon"><use href="#icon-check"/></svg> Filtros ativos detectados - MANTENDO valores da API filtrada');
          // Atualiza apenas conversÃ£o e forecast health sem tocar no card Pipeline Filtrado
          updateConversionMetricsForPeriod('all');
          if (window.updateForecastHealth) window.updateForecastHealth('all');
        }
        
        // CRÃTICO: Usar avgConfidence filtrado da API quando hasActiveFilters
        const displayAvgConfidence = (hasActiveFilters && apiFilteredData.avg_confidence !== undefined) 
          ? apiFilteredData.avg_confidence 
          : avgConfidence;
        
        setTextSafe('exec-forecast-weighted', formatMoney(forecastAvgWeighted));
        setTextSafe('exec-forecast-percent', Math.round(displayAvgConfidence) + '% confianÃ§a mÃ©dia');
        setTextSafe('exec-above50-value', formatMoney(above50Value));
        setTextSafe('exec-above50-count', above50Count + ' deals');
        setTextSafe('exec-above50-net', 'Net: ' + formatMoney(above50Net));
        
        // MÃ©tricas de Idle Days agora vÃªm do endpoint /api/metrics via updateExecutiveMetricsFromAPI
        // (chamada jÃ¡ feita em loadData apÃ³s receber metrics do backend)
        
        // Armazena mÃ©tricas de ganhas/perdidas para uso global
        window.conversionMetrics = {
          winsGross,
          winsNet,
          lossesGross,
          lossesNet,
          totalWins,
          totalLosses,
          totalDeals,
          conversionRate
        };
        
        // SaÃºde do Forecast (barra visual)
        // AnÃ¡lise IA: COMMIT â‰¥90%, UPSIDE 50-89%, PIPELINE <50%
        const totalForecast = commitValue + upsideValue + pipelineValue;
        const commitPercent = totalForecast > 0 ? (commitValue / totalForecast) * 100 : 0;
        const upsidePercent = totalForecast > 0 ? (upsideValue / totalForecast) * 100 : 0;
        const pipelinePercent = totalForecast > 0 ? (pipelineValue / totalForecast) * 100 : 0;
        log('[CALC] Forecast saÃºde:', {
          'commit': Math.round(commitPercent) + '% (' + formatMoney(commitValue) + ')',
          'upside': Math.round(upsidePercent) + '% (' + formatMoney(upsideValue) + ')',
          'pipeline': Math.round(pipelinePercent) + '% (' + formatMoney(pipelineValue) + ')'
        });
        
        setBarSafe('forecast-commit-bar', commitPercent, commitPercent >= 15 ? 'COMMIT' : '');
        setBarSafe('forecast-upside-bar', upsidePercent, upsidePercent >= 15 ? 'UPSIDE' : '');
        setBarSafe('forecast-pipeline-bar', pipelinePercent, pipelinePercent >= 15 ? 'PIPELINE' : '');
        
        setTextSafe('forecast-commit-value', formatMoney(commitValue) + ' (' + Math.round(commitPercent) + '%)');
        setTextSafe('forecast-upside-value', formatMoney(upsideValue) + ' (' + Math.round(upsidePercent) + '%)');
        setTextSafe('forecast-pipeline-value', formatMoney(pipelineValue) + ' (' + Math.round(pipelinePercent) + '%)');
        
        // SaÃºde do Forecast - Sales Specialist (usando dados do backend)
        const totalSalesSpec = salesSpecCommitGross + salesSpecUpsideGross;
        const ssCommitPercent = totalSalesSpec > 0 ? (salesSpecCommitGross / totalSalesSpec) * 100 : 0;
        const ssUpsidePercent = totalSalesSpec > 0 ? (salesSpecUpsideGross / totalSalesSpec) * 100 : 0;
        
        log('[CALC] Sales Specialist saÃºde:', {
          'commit': Math.round(ssCommitPercent) + '% (' + formatMoney(salesSpecCommitGross) + ')',
          'upside': Math.round(ssUpsidePercent) + '% (' + formatMoney(salesSpecUpsideGross) + ')'
        });
        
        setBarSafe('forecast-ss-commit-bar', ssCommitPercent, ssCommitPercent >= 15 ? 'COMMIT' : '');
        setBarSafe('forecast-ss-upside-bar', ssUpsidePercent, ssUpsidePercent >= 15 ? 'UPSIDE' : '');
        
        setTextSafe('forecast-ss-commit-value', formatMoney(salesSpecCommitGross) + ' (' + Math.round(ssCommitPercent) + '%)');
        setTextSafe('forecast-ss-upside-value', formatMoney(salesSpecUpsideGross) + ' (' + Math.round(ssUpsidePercent) + '%)');
        
        // SEÃ‡ÃƒO 2: AnÃ¡lise EstratÃ©gica da IA (REESCRITA - ANÃLISE INTELIGENTE DE VERDADE)
        const execContentEl = document.getElementById('executive-content');
        const execToggleLabel = document.getElementById('executive-toggle-label');
        const execToggleCaret = document.getElementById('executive-toggle-caret');
        if (execContentEl) {
          if (execToggleLabel && execToggleCaret) {
            execToggleLabel.textContent = 'Ocultar';
            execToggleCaret.style.transform = 'rotate(0deg)';
          }
          if (DATA.aiAnalysis && DATA.aiAnalysis.executive) {
            execContentEl.innerHTML = cleanAIResponse(DATA.aiAnalysis.executive);
          } else {
            // CORREÃ‡ÃƒO: Usa valores FILTRADOS quando hÃ¡ filtros ativos
            const displayPipelineGross = (hasActiveFilters && apiFilteredData.gross) ? apiFilteredData.gross : allPipelineGross;
            const displayPipelineDeals = (hasActiveFilters && apiFilteredData.deals_count) ? apiFilteredData.deals_count : allPipelineDeals;
            const displayAvgConfidence = (hasActiveFilters && apiFilteredData.avg_confidence) ? apiFilteredData.avg_confidence : avgConfidence;
            const displayForecastWeighted = displayPipelineGross * (displayAvgConfidence / 100);
            const displaySalesSpecDeals = pipelineSalesSpecDeals;
            const displaySalesSpecGross = pipelineSalesSpecGross;
            
            // Define variÃ¡veis de forecast categories para uso posterior
            const hasCommit = totalForecast > 0 && commitPercent >= 10;
            const hasUpside = totalForecast > 0 && upsidePercent >= 20;
            const hasPipeline = totalForecast > 0 && pipelinePercent >= 30;
            
            // Calcula ciclos mÃ©dios de won/lost para anÃ¡lise
            let avgWinCycle = 0;
            let avgLossCycle = 0;
            if (wonAgg && wonAgg.length > 0) {
              const totalCicloWin = wonAgg.reduce((sum, d) => sum + (d.ciclo_dias || d.Ciclo_dias || 0), 0);
              avgWinCycle = totalCicloWin / wonAgg.length;
            }
            if (lostAgg && lostAgg.length > 0) {
              const totalCicloLoss = lostAgg.reduce((sum, d) => sum + (d.ciclo_dias || d.Ciclo_dias || 0), 0);
              avgLossCycle = totalCicloLoss / lostAgg.length;
            }
            
            // MÃ‰TRICAS CALCULADAS PARA ANÃLISE INTELIGENTE
            const ticketMedio = displayPipelineDeals > 0 ? displayPipelineGross / displayPipelineDeals : 0;
            const ticketGanho = totalWins > 0 ? winsGross / totalWins : 0;
            const ticketPerda = totalLosses > 0 ? lossesGross / totalLosses : 0;
            const ratioPerdasVsGanhos = winsGross > 0 ? lossesGross / winsGross : 0;
            const coverage = winsGross > 0 ? (displayForecastWeighted / winsGross) : 0;
            const eficienciaCiclo = totalWins > 0 && totalLosses > 0 ? ((avgWinCycle || 0) / (avgLossCycle || 1)) : 0;
            
            // ====== ANÃLISE INTELIGENTE COMPLETA ======
            const analysis = [];
            
            // 1. DIAGNÃ“STICO CRÃTICO (identificar problemas reais)
            const diagnosticos = [];
            
            // Problema 1: Win Rate baixo com anÃ¡lise de causa
            if (displayConversionRate < 20 && totalDeals >= 10) {
              let problema = `<strong style="color: var(--danger);">ðŸš¨ ALERTA CRÃTICO: Win Rate de ${displayConversionRate}%</strong> indica desperdÃ­cio massivo de recursos. `;
              
              // AnÃ¡lise de causa-raiz
              if (ticketPerda > ticketGanho * 1.5) {
                problema += `<strong>Causa identificada:</strong> Foco em deals grandes sem fit adequado (perda mÃ©dia ${formatMoney(ticketPerda)} vs ganho ${formatMoney(ticketGanho)}). `;
                problema += `<strong>Impacto:</strong> ${formatMoney(lossesGross)} queimados perseguindo deals errados. `;
                problema += `<span style="color: var(--warning);">â†’ Implementar filtro MEDDIC >20 antes de investir em deals >${formatMoney(ticketPerda * 0.8)}</span>`;
              } else if (ratioPerdasVsGanhos > 10) {
                problema += `<strong>Causa identificada:</strong> QualificaÃ§Ã£o inexistente - ${Math.round(ratioPerdasVsGanhos)}x mais valor perdido que ganho. `;
                problema += `<span style="color: var(--warning);">â†’ Pausar novos deals atÃ© revisar ICP e processo de qualificaÃ§Ã£o</span>`;
              } else {
                problema += `<span style="color: var(--warning);">â†’ Revisar urgentemente processo de qualificaÃ§Ã£o e ICP</span>`;
              }
              
              diagnosticos.push(problema);
            } else if (displayConversionRate >= 20 && displayConversionRate < 30 && totalDeals >= 10) {
              diagnosticos.push(`<strong style="color: var(--warning);">âš ï¸ Win Rate de ${displayConversionRate}%</strong> estÃ¡ abaixo do benchmark (30%+). Com ${formatMoney(lossesGross)} perdidos, hÃ¡ margem para melhora significativa atravÃ©s de melhor qualificaÃ§Ã£o inicial.`);
            }
            
            // Problema 2: Pipeline desproporcional ao resultado
            if (coverage < 2 && winsGross > 0) {
              diagnosticos.push(`<strong style="color: var(--danger);">ðŸŽ¯ COBERTURA CRÃTICA:</strong> Pipeline de apenas ${coverage.toFixed(1)}x o resultado atual. Para manter ritmo, necessÃ¡rio <strong>${formatMoney(winsGross * 3 - displayForecastWeighted)}</strong> adicionais em pipeline qualificado.`);
            } else if (coverage > 5) {
              diagnosticos.push(`<strong style="color: var(--success);">ðŸ“Š PIPELINE SAUDÃVEL:</strong> Cobertura de ${coverage.toFixed(1)}x indica geraÃ§Ã£o forte. Foco deve ser <strong>aceleraÃ§Ã£o e conversÃ£o</strong>, nÃ£o geraÃ§Ã£o.`);
            }
            
            // Problema 3: ConfianÃ§a baixa generalizada
            if (displayAvgConfidence < 35 && displayPipelineDeals > 10) {
              diagnosticos.push(`<strong style="color: var(--danger);">ðŸ¤– SCORING QUEBRADO:</strong> ConfianÃ§a mÃ©dia de ${Math.round(displayAvgConfidence)}% sugere que IA nÃ£o confia no pipeline. PossÃ­veis causas: deals mal qualificados, falta de atividade, ou MEDDIC baixo. <span style="color: var(--warning);">â†’ Auditar ${Math.round(displayPipelineDeals * 0.3)} maiores deals</span>`);
            }
            
            // Problema 4: Falta de COMMIT
            if (!hasCommit && displayPipelineDeals > 5) {
              diagnosticos.push(`<strong style="color: var(--danger);">â° RISCO DE QUARTER:</strong> Zero deals em COMMIT significa nenhum fechamento garantido curto prazo. <span style="color: var(--warning);">â†’ AÃ§Ã£o imediata: identificar 3-5 deals para fechar em 30 dias</span>`);
            }
            
            // Problema 5: Ciclo muito longo em perdas
            if (avgLossCycle > avgWinCycle * 2 && totalLosses >= 5) {
              const diasDesperdicio = avgLossCycle - avgWinCycle;
              diagnosticos.push(`<strong style="color: var(--warning);">â±ï¸ INEFICIÃŠNCIA DE CICLO:</strong> Deals perdidos levam ${Math.round(diasDesperdicio)} dias a mais que vitÃ³rias para falhar (${Math.round(avgLossCycle)}d vs ${Math.round(avgWinCycle)}d). <strong>Custo oculto:</strong> Tempo de vendedor desperdiÃ§ado em deals sem fit. <span style="color: var(--warning);">â†’ Implementar early exit criteria</span>`);
            }
            
            if (diagnosticos.length > 0) {
              analysis.push(`<div style="background: rgba(225,72,73,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--danger); margin-bottom: 15px;">${diagnosticos.join('<br><br>')}</div>`);
            }
            
            // 2. OPORTUNIDADES IDENTIFICADAS (onde focar energia)
            const oportunidades = [];
            
            if (above50Count > 0 && above50Value > displayForecastWeighted * 0.3) {
              oportunidades.push(`<strong style="color: var(--success);">ðŸ’° QUICK WINS:</strong> ${above50Count} deals com confianÃ§a â‰¥50% representam ${formatMoney(above50Value)}. <span style="color: var(--primary-cyan);">Esses ${above50Count} deals devem ser prioridade #1</span> - potencial de fechar ${Math.round((above50Value / displayForecastWeighted) * 100)}% do forecast.`);
            }
            
            if (displaySalesSpecDeals > 0) {
              const specPercent = (displaySalesSpecGross / displayPipelineGross) * 100;
              const specTicket = displaySalesSpecGross / displaySalesSpecDeals;
              
              if (specTicket > ticketMedio * 1.3) {
                oportunidades.push(`<strong style="color: var(--success);">â­ CURADORIA FUNCIONANDO:</strong> Sales Specialist curando deals ${Math.round((specTicket / ticketMedio) * 100 - 100)}% maiores que mÃ©dia (${formatMoney(specTicket)} vs ${formatMoney(ticketMedio)}). <span style="color: var(--primary-cyan);">Expandir programa de curadoria</span>.`);
              }
            } else if (displayPipelineDeals > 15) {
              oportunidades.push(`<strong style="color: var(--warning);">ðŸ’¼ FALTA CURADORIA:</strong> ${displayPipelineDeals} deals sem curadoria manual. Sales Specialist poderia identificar os ${Math.round(displayPipelineDeals * 0.15)} deals mais estratÃ©gicos para atenÃ§Ã£o VIP.`);
            }
            
            if (totalWins > 0 && avgWinCycle < 60) {
              oportunidades.push(`<strong style="color: var(--success);">âš¡ VELOCIDADE COMPETITIVA:</strong> Ciclo mÃ©dio de ${Math.round(avgWinCycle)} dias em vitÃ³rias Ã© excelente. Replicar padrÃµes de sucesso: qual perfil/estÃ¡gio/vendedor fecha mais rÃ¡pido?`);
            }
            
            if (oportunidades.length > 0) {
              analysis.push(`<div style="background: rgba(192,255,125,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--success); margin-bottom: 15px;">${oportunidades.join('<br><br>')}</div>`);
            }
            
            // 3. PLANO DE AÃ‡ÃƒO ESPECÃFICO (nÃ£o genÃ©rico)
            const acoes = [];
            
            // AÃ§Ã£o baseada em diagnÃ³stico
            if (displayConversionRate < 20 && ticketPerda > ticketGanho * 1.5) {
              acoes.push(`<strong>1. FILTRO DE ENTRADA (urgente):</strong> Pausar pursuit em deals >${formatMoney(ticketPerda * 0.8)} com MEDDIC <20 ou sem champion identificado`);
              acoes.push(`<strong>2. ANÃLISE POST-MORTEM:</strong> Revisar top 10 perdas do perÃ­odo para identificar red flags comuns`);
            } else if (displayConversionRate < 25) {
              acoes.push(`<strong>1. QUALIFICAÃ‡ÃƒO:</strong> Implementar checklist BANT obrigatÃ³rio antes de avanÃ§ar para Proposta`);
            }
            
            if (!hasCommit && above50Count > 0) {
              acoes.push(`<strong>2. ACELERAÃ‡ÃƒO IMEDIATA:</strong> Daily standups nos ${above50Count} deals â‰¥50% confianÃ§a atÃ© mover ${Math.min(3, above50Count)} para COMMIT`);
            } else if (!hasCommit) {
              acoes.push(`<strong>2. PIPELINE REBUILD:</strong> Identificar 5 deals potenciais que possam fechar em 30-45 dias`);
            }
            
            if (displayAvgConfidence < 35) {
              acoes.push(`<strong>3. SCORING AUDIT:</strong> Revisar MEDDIC dos ${Math.round(displayPipelineDeals * 0.3)} maiores deals e atualizar prÃ³ximas aÃ§Ãµes`);
            }
            
            if (displaySalesSpecDeals === 0 && displayPipelineDeals > 10) {
              acoes.push(`<strong>4. CURADORIA ESTRATÃ‰GICA:</strong> Sales Specialist deve curar top ${Math.min(5, Math.round(displayPipelineDeals * 0.2))} deals por valor + fit para atenÃ§Ã£o executiva`);
            }
            
            if (avgLossCycle > 120 && totalLosses >= 5) {
              acoes.push(`<strong>5. EARLY EXIT:</strong> Definir critÃ©rios para exit (ex: 60 dias sem progresso de estÃ¡gio = kill deal)`);
            }
            
            if (acoes.length > 0) {
              analysis.push(`<div style="background: rgba(0,190,255,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid var(--primary-cyan); margin-bottom: 0;"><strong style="color: var(--primary-cyan); font-size: 15px;">ðŸ“‹ PLANO DE AÃ‡ÃƒO - PRÃ“XIMOS 30 DIAS:</strong><br><br>${acoes.join('<br><br>')}</div>`);
            }
            
            // Se nÃ£o hÃ¡ anÃ¡lise, mostrar mensagem
            if (analysis.length === 0) {
              analysis.push(`<div style="padding: 15px; text-align: center; color: var(--text-gray);"><strong>âœ… Performance dentro do esperado</strong><br>Continue monitorando mÃ©tricas principais e executando plano de vendas.</div>`);
            }
            
            // Gera HTML final
            execContentEl.innerHTML = analysis.join('');
          }
        }
        
        // SEÃ‡ÃƒO 3: DESTAQUES OPERACIONAIS DO QUARTER
        
        // Oportunidade-Chave #1 (maior valor aberto no quarter)
        let keyOpp = null;
        let maxValue = 0;
        Object.values(quarters).forEach(deals => {
          if (deals && Array.isArray(deals)) {
            deals.forEach(d => {
              if ((d.val || 0) > maxValue) {
                maxValue = d.val || 0;
                keyOpp = d;
              }
            });
          }
        });
        
        if (keyOpp) {
          setTextSafe('exec-key-opp-name', keyOpp.name || 'N/A');
          setTextSafe('exec-key-opp-value', formatMoney(keyOpp.val || 0));
          setTextSafe('exec-key-opp-account', keyOpp.account || 'Conta nÃ£o especificada');
          setTextSafe('exec-key-opp-owner', keyOpp.seller || keyOpp.owner || 'N/A');
          setTextSafe('exec-key-opp-why', 'Maior valor em aberto (' + formatMoney(keyOpp.val || 0) + ')');
          
          log('[KEY OPP] Deal selecionado:', { 
            name: keyOpp.name, 
            account: keyOpp.account, 
            seller: keyOpp.seller, 
            value: maxValue,
            allFields: Object.keys(keyOpp)
          });
          
          const riskFactors = [];
          const confidencePercent = Math.round(keyOpp.confidence || 0);
          if (confidencePercent < 50) riskFactors.push('Baixa confianÃ§a (' + confidencePercent + '%)');
          if ((keyOpp.daysToClose || 0) < 0) riskFactors.push('Atrasado');
          if (keyOpp.daysIdle > 30) riskFactors.push('Idle ' + keyOpp.daysIdle + ' dias');
          else if (keyOpp.daysIdle > 14) riskFactors.push('Idle ' + keyOpp.daysIdle + ' dias');
          
          setTextSafe('exec-key-opp-risk', riskFactors.length > 0 ? riskFactors.join(', ') : 'Nenhum risco crÃ­tico identificado');
          
          // NOVO: AnÃ¡lise IA completa do deal
          const aiAnalysis = [];
          aiAnalysis.push(`Deal no estÃ¡gio "${keyOpp.stage || 'N/A'}"`);
          if (keyOpp.confidence !== undefined && keyOpp.confidence !== null) {
            const confPercent = Math.round(keyOpp.confidence);
            if (confPercent >= 70) aiAnalysis.push(`Alta probabilidade de conversÃ£o (${confPercent}%)`);
            else if (confPercent >= 40) aiAnalysis.push(`Probabilidade moderada (${confPercent}%)`);
            else aiAnalysis.push(`Requer atenÃ§Ã£o urgente (confianÃ§a ${confPercent}%)`);
          }
          if (keyOpp.activities) {
            if (keyOpp.activities >= 5) aiAnalysis.push(`Bem engajado (${keyOpp.activities} atividades)`);
            else aiAnalysis.push(`Engajamento baixo (${keyOpp.activities} atividades)`);
          }
          if ((keyOpp.daysIdle || 0) > 0) aiAnalysis.push(`Idle ${keyOpp.daysIdle} dias`);
          if (keyOpp.forecastCategory) {
            aiAnalysis.push(`Categoria: ${keyOpp.forecastCategory}`);
          }
          if (keyOpp.profile) aiAnalysis.push(`Perfil: ${keyOpp.profile}`);
          
          setTextSafe('exec-key-opp-ai', aiAnalysis.join('. ') + '.');
          log('[KEY OPP] Deal exibido:', { name: keyOpp.name, account: keyOpp.account, seller: keyOpp.seller, value: maxValue });
        } else {
          setTextSafe('exec-key-opp-name', 'Nenhuma oportunidade aberta');
          setTextSafe('exec-key-opp-value', '$0');
          setTextSafe('exec-key-opp-account', '-');
          setTextSafe('exec-key-opp-owner', '-');
          setTextSafe('exec-key-opp-why', '-');
          setTextSafe('exec-key-opp-risk', '-');
          setTextSafe('exec-key-opp-ai', '-');
        }
        
        // VitÃ³ria Destaque (maior deal individual ganho no perÃ­odo - busca no wonAgg)
        let topWinDeal = null;
        let maxWinValue = 0;
        
        if (wonAgg && Array.isArray(wonAgg)) {
          wonAgg.forEach(deal => {
            const dealValue = deal.Gross || deal.gross || 0;
            if (dealValue > maxWinValue) {
              maxWinValue = dealValue;
              topWinDeal = deal;
            }
          });
        }
        
        if (topWinDeal && maxWinValue > 0) {
          const dealName = topWinDeal.Opportunity_Name || topWinDeal.opportunityName || 'Deal Ganho';
          const dealOwner = topWinDeal.Vendedor || topWinDeal.seller || topWinDeal.owner || 'Vendedor nÃ£o especificado';
          const dealAccount = topWinDeal.Conta || topWinDeal.account || 'Conta nÃ£o especificada';
          
          setTextSafe('exec-top-win-name', dealName);
          setTextSafe('exec-top-win-value', formatMoney(maxWinValue));
          setTextSafe('exec-top-win-account', dealAccount);
          setTextSafe('exec-top-win-owner', dealOwner);
          
          // Motivo de vitÃ³ria - prioriza Win_Reason do BigQuery
          const winReason = topWinDeal.Win_Reason || topWinDeal.winReason;
          const winReasons = [];
          
          if (winReason && winReason !== 'Motivo nÃ£o especificado') {
            winReasons.push(winReason);
          } else {
            // Fallback: anÃ¡lise baseada em dados
            if (maxWinValue > 500000) winReasons.push('Deal de alto valor');
            const ciclo = topWinDeal.ciclo_dias || topWinDeal.Ciclo_dias || 0;
            if (ciclo > 0 && ciclo < 90) winReasons.push('Ciclo rÃ¡pido (' + Math.round(ciclo) + ' dias)');
            if (!winReasons.length) winReasons.push('Maior deal ganho no perÃ­odo');
          }
          
          setTextSafe('exec-top-win-why', winReasons.join('. '));
          
          // NOVO: AnÃ¡lise IA da vitÃ³ria
          const winAiAnalysis = [];
          const ciclo = topWinDeal.ciclo_dias || topWinDeal.Ciclo_dias || 0;
          if (ciclo > 0) {
            if (ciclo < 60) winAiAnalysis.push(`Fechado rapidamente em ${Math.round(ciclo)} dias`);
            else if (ciclo < 120) winAiAnalysis.push(`Ciclo padrÃ£o de ${Math.round(ciclo)} dias`);
            else winAiAnalysis.push(`Ciclo longo de ${Math.round(ciclo)} dias`);
          }
          if (maxWinValue > 1000000) winAiAnalysis.push('Enterprise deal estratÃ©gico');
          else if (maxWinValue > 500000) winAiAnalysis.push('Deal de mÃ©dio-alto valor');
          if (topWinDeal.Net) {
            const margin = ((topWinDeal.Net / maxWinValue) * 100).toFixed(1);
            winAiAnalysis.push(`Margem: ${margin}%`);
          }
          
          setTextSafe('exec-top-win-ai', winAiAnalysis.length > 0 ? winAiAnalysis.join('. ') + '.' : 'VitÃ³ria importante para o quarter.');
          log('[WIN] Deal exibido:', { dealName, dealOwner, dealAccount, maxWinValue, winReasons });
        } else {
          setTextSafe('exec-top-win-name', 'Nenhuma vitÃ³ria registrada');
          setTextSafe('exec-top-win-value', '$0');
          setTextSafe('exec-top-win-account', '-');
          setTextSafe('exec-top-win-owner', '-');
          setTextSafe('exec-top-win-why', '-');
          setTextSafe('exec-top-win-ai', '-');
        }
        
        // Perda Destaque (maior deal individual perdido no perÃ­odo - busca no lostAgg)
        let topLossDeal = null;
        let maxLossValue = 0;
        
        if (lostAgg && Array.isArray(lostAgg)) {
          lostAgg.forEach(deal => {
            const dealValue = deal.Gross || deal.gross || 0;
            if (dealValue > maxLossValue) {
              maxLossValue = dealValue;
              topLossDeal = deal;
            }
          });
        }
        
        if (topLossDeal && maxLossValue > 0) {
          const dealName = topLossDeal.Opportunity_Name || topLossDeal.opportunityName || 'Deal Perdido';
          const dealOwner = topLossDeal.Vendedor || topLossDeal.seller || topLossDeal.owner || 'Vendedor nÃ£o especificado';
          const dealAccount = topLossDeal.Conta || topLossDeal.account || 'Conta nÃ£o especificada';
          
          setTextSafe('exec-top-loss-name', dealName);
          setTextSafe('exec-top-loss-value', formatMoney(maxLossValue));
          setTextSafe('exec-top-loss-account', dealAccount);
          setTextSafe('exec-top-loss-owner', dealOwner);
          
          // Motivo de perda - prioriza Loss_Reason do BigQuery
          const lossReason = topLossDeal.Loss_Reason || topLossDeal.lossReason || topLossDeal.cause || 'Motivo nÃ£o especificado';
          setTextSafe('exec-top-loss-why', lossReason);
          
          // NOVO: AnÃ¡lise IA da perda
          const lossAiAnalysis = [];
          const ciclo = topLossDeal.ciclo_dias || topLossDeal.Ciclo_dias || 0;
          if (ciclo > 0) {
            if (ciclo > 180) lossAiAnalysis.push(`Deal travado por ${Math.round(ciclo)} dias antes da perda`);
            else lossAiAnalysis.push(`Ciclo de ${Math.round(ciclo)} dias atÃ© perda`);
          }
          if (maxLossValue > 1000000) lossAiAnalysis.push('Perda de alto impacto (>$1M)');
          else if (maxLossValue > 500000) lossAiAnalysis.push('Perda significativa');
          
          // AnÃ¡lise da causa
          if (lossReason.toLowerCase().includes('preÃ§o') || lossReason.toLowerCase().includes('custo')) {
            lossAiAnalysis.push('Oportunidade de revisar estratÃ©gia de pricing');
          } else if (lossReason.toLowerCase().includes('concor') || lossReason.toLowerCase().includes('compet')) {
            lossAiAnalysis.push('AnÃ¡lise competitiva recomendada');
          } else if (lossReason.toLowerCase().includes('timing') || lossReason.toLowerCase().includes('budget')) {
            lossAiAnalysis.push('Oportunidade futura potencial');
          }
          
          setTextSafe('exec-top-loss-ai', lossAiAnalysis.length > 0 ? lossAiAnalysis.join('. ') + '.' : 'Requer anÃ¡lise post-mortem detalhada.');
          log('[LOSS] Deal exibido:', { dealName, dealOwner, dealAccount, maxLossValue, lossReason });
        } else {
          setTextSafe('exec-top-loss-name', 'Nenhuma perda significativa');
          setTextSafe('exec-top-loss-value', '$0');
          setTextSafe('exec-top-loss-account', '-');
          setTextSafe('exec-top-loss-owner', '-');
          setTextSafe('exec-top-loss-why', '-');
          setTextSafe('exec-top-loss-ai', '-');
        }
        
        // SEÃ‡ÃƒO 4: DESTAQUES DA EQUIPE NO QUARTER
        
        // Calcular performance real por vendedor usando wonAgg/lostAgg
        const sellerPerformance = {};
        
        if (wonAgg && Array.isArray(wonAgg)) {
          wonAgg.forEach(deal => {
            const seller = deal.Vendedor || deal.seller || 'Unknown';
            if (!sellerPerformance[seller]) {
              sellerPerformance[seller] = { 
                name: seller, 
                wins: 0, 
                losses: 0, 
                winRevenue: 0, 
                lossRevenue: 0,
                avgWinCycle: 0,
                totalWinCycle: 0
              };
            }
            sellerPerformance[seller].wins++;
            sellerPerformance[seller].winRevenue += (deal.Gross || deal.gross || 0);
            sellerPerformance[seller].totalWinCycle += (deal.ciclo_dias || deal.Ciclo_dias || 0);
          });
        }
        
        if (lostAgg && Array.isArray(lostAgg)) {
          lostAgg.forEach(deal => {
            const seller = deal.Vendedor || deal.seller || 'Unknown';
            if (!sellerPerformance[seller]) {
              sellerPerformance[seller] = { 
                name: seller, 
                wins: 0, 
                losses: 0, 
                winRevenue: 0, 
                lossRevenue: 0,
                avgWinCycle: 0,
                totalWinCycle: 0
              };
            }
            sellerPerformance[seller].losses++;
            sellerPerformance[seller].lossRevenue += (deal.Gross || deal.gross || 0);
          });
        }
        
        // Calcular mÃ©tricas derivadas
        Object.values(sellerPerformance).forEach(seller => {
          const totalDeals = seller.wins + seller.losses;
          seller.winRate = totalDeals > 0 ? Math.round((seller.wins / totalDeals) * 100) : 0;
          seller.avgWinCycle = seller.wins > 0 ? Math.round(seller.totalWinCycle / seller.wins) : 0;
          seller.totalRevenue = seller.winRevenue + seller.lossRevenue;
        });
        
        log('[TEAM] Vendedores no perÃ­odo:', Object.keys(sellerPerformance).length);
        
        // MVP do Quarter (melhor performance combinada: revenue + win rate + eficiÃªncia)
        let mvp = null;
        let mvpScore = 0;
        Object.values(sellerPerformance).forEach(seller => {
          // LÃ“GICA MELHORADA: Aceita vendedores com â‰¥1 ganho OU deals significativos
          const totalDeals = seller.wins + seller.losses;
          if (seller.wins >= 1 || totalDeals >= 3) {
            // Score composto: (revenue * 0.6) + (winRate * 0.3) + (eficiÃªncia ciclo * 0.1)
            const revenueScore = seller.winRevenue / 1000000; // Normaliza para milhÃµes
            const winRateScore = (seller.winRate / 100) * 2; // 0-2
            const cycleScore = seller.avgWinCycle > 0 ? Math.max(0, 2 - (seller.avgWinCycle / 60)) : 0; // Melhor se ciclo <60d
            const score = (revenueScore * 0.6) + (winRateScore * 0.3) + (cycleScore * 0.1);
            
            if (score > mvpScore) {
              mvpScore = score;
              mvp = seller;
            }
          }
        });
        
        if (mvp) {
          const initial = mvp.name ? mvp.name.charAt(0).toUpperCase() : '?';
          setTextSafe('exec-mvp-initial', initial);
          setTextSafe('exec-mvp-name', mvp.name);
          
          const highlights = [];
          highlights.push(`${mvp.winRate}% de Win Rate`);
          highlights.push(`${formatMoney(mvp.winRevenue)} conquistado`);
          if (mvp.avgWinCycle > 0) highlights.push(`Ciclo mÃ©dio de ${mvp.avgWinCycle} dias`);
          highlights.push(`${mvp.wins} ${mvp.wins === 1 ? 'vitÃ³ria' : 'vitÃ³rias'}`);
          if (mvp.losses > 0) highlights.push(`${mvp.losses} ${mvp.losses === 1 ? 'perda' : 'perdas'}`);
          
          const mvpReason = `ðŸ† Liderando o perÃ­odo: ${highlights.join(' â€¢ ')}${mvp.avgWinCycle > 0 && mvp.avgWinCycle < 60 ? ` â€¢ âš¡ Destaque em velocidade de fechamento` : ''}`;
          setTextSafe('exec-mvp-reason', mvpReason);
          log('[MVP] Vendedor destaque:', mvp);
        } else {
          setTextSafe('exec-mvp-initial', '-');
          setTextSafe('exec-mvp-name', 'PerÃ­odo sem deals');
          setTextSafe('exec-mvp-reason', 'Nenhuma atividade de vendas registrada no perÃ­odo filtrado');
        }
        
        // Ponto de AtenÃ§Ã£o (anÃ¡lise inteligente de performance)
        let attention = null;
        let attentionScore = 100;
        let attentionReasons = [];
        
        Object.values(sellerPerformance).forEach(seller => {
          const totalDeals = seller.wins + seller.losses;
          // LÃ“GICA MELHORADA: Considera vendedores com atividade (â‰¥2 deals OU perdas significativas)
          if (totalDeals >= 2 || seller.lossRevenue > 500000) {
            const issues = [];
            let score = 100; // ComeÃ§a perfeito, deduz pontos por problemas
            
            // CritÃ©rio 1: Win Rate baixo (mais crÃ­tico)
            if (seller.winRate < 30 && totalDeals >= 3) {
              issues.push(`Win rate crÃ­tico (${seller.winRate}%)`);
              score -= 40;
            } else if (seller.winRate < 50 && totalDeals >= 5) {
              issues.push(`Win rate abaixo da mÃ©dia (${seller.winRate}%)`);
              score -= 25;
            }
            
            // CritÃ©rio 2: Muitas perdas recentes
            if (seller.losses > seller.wins * 3 && seller.losses >= 3) {
              issues.push(`${seller.losses} perdas vs ${seller.wins} vitÃ³ria${seller.wins !== 1 ? 's' : ''}`);
              score -= 30;
            } else if (seller.losses > seller.wins * 2 && seller.losses >= 2) {
              issues.push(`Mais perdas (${seller.losses}) que vitÃ³rias (${seller.wins})`);
              score -= 20;
            }
            
            // CritÃ©rio 3: Valor perdido >> Valor ganho
            if (seller.lossRevenue > seller.winRevenue * 5 && seller.lossRevenue > 1000000) {
              issues.push(`Alto valor em perdas (${formatMoney(seller.lossRevenue)})`);
              score -= 25;
            } else if (seller.lossRevenue > seller.winRevenue * 2) {
              issues.push(`Valor perdido > valor ganho`);
              score -= 15;
            }
            
            // CritÃ©rio 4: Ciclo muito longo (ineficiÃªncia)
            if (seller.avgWinCycle > 180) {
              issues.push(`Ciclo longo (${seller.avgWinCycle} dias)`);
              score -= 10;
            }
            
            // Se tem problemas E score Ã© o pior atÃ© agora
            if (issues.length > 0 && score < attentionScore) {
              attentionScore = score;
              attention = seller;
              attentionReasons = issues;
            }
          }
        });
        
        if (attention && attentionScore < 70) {
          const initial = attention.name ? attention.name.charAt(0).toUpperCase() : '!';
          setTextSafe('exec-attention-initial', initial);
          setTextSafe('exec-attention-name', attention.name);
          
          const actionable = [];
          actionable.push(...attentionReasons);
          
          // Adiciona recomendaÃ§Ãµes
          if (attention.winRate < 30) actionable.push('ðŸ“Š Revisar qualificaÃ§Ã£o de leads');
          if (attention.losses > attention.wins * 2) actionable.push('ðŸŽ¯ Focar em deals de maior probabilidade');
          if (attention.avgWinCycle > 150) actionable.push('â±ï¸ Acelerar follow-ups');
          
          const attentionReason = actionable.join(' â€¢ ');
          setTextSafe('exec-attention-reason', attentionReason);
          log('[ATTENTION] Vendedor requer atenÃ§Ã£o:', attention);
        } else {
          setTextSafe('exec-attention-initial', 'âœ“');
          setTextSafe('exec-attention-name', 'Equipe performando bem');
          setTextSafe('exec-attention-reason', 'Nenhum ponto crÃ­tico identificado no perÃ­odo filtrado');
        }

        // SEÃ‡ÃƒO 5: TOP 5 OPORTUNIDADES (ABERTAS / GANHAS / PERDIDAS)
        log('[RENDER] === SEÃ‡ÃƒO 5: TOP 5 OPORTUNIDADES ===');
        const topOppsAIEl = document.getElementById('exec-top-opps-ai-analysis');
        if (topOppsAIEl) {
          if (DATA.aiAnalysis && DATA.aiAnalysis.topOpportunitiesAnalysis) {
            topOppsAIEl.innerHTML = DATA.aiAnalysis.topOpportunitiesAnalysis;
          } else {
            topOppsAIEl.innerHTML = '<p style="color: var(--text-gray);">Resumo executivo por regras: use os destaques e recomendacoes abaixo para decisao rapida.</p>';
          }
        }

        const topOppsContainer = document.getElementById('exec-top-opps-container');
        const topOppsNote = document.getElementById('exec-top5-note');
        const topOppsTabs = Array.from(document.querySelectorAll('.top-opps-tab'));

        const normalizeConfidencePercent = (value) => {
          if (value == null || value === '') return 0;
          const numeric = Number(value);
          if (Number.isNaN(numeric)) return 0;
          return numeric <= 1 ? Math.round(numeric * 100) : Math.round(numeric);
        };

        const deriveQuarterLabel = (dateStr) => {
          if (!dateStr) return '';
          let parsed = new Date(dateStr);
          if (Number.isNaN(parsed.getTime())) {
            const match = String(dateStr).match(/^(\d{2})-(\d{2})-(\d{4})$/);
            if (match) {
              const [, dd, mm, yyyy] = match;
              parsed = new Date(`${yyyy}-${mm}-${dd}`);
            }
          }
          if (Number.isNaN(parsed.getTime())) return '';
          const month = parsed.getMonth() + 1;
          const quarterNum = Math.floor((month - 1) / 3) + 1;
          const year = parsed.getFullYear();
          const fy = String(year).slice(-2);
          return `FY${fy}-Q${quarterNum}`;
        };

        const truncateText = (text, maxLen) => {
          if (!text) return '';
          const trimmed = String(text).trim();
          if (trimmed.length <= maxLen) return trimmed;
          return trimmed.slice(0, maxLen - 1) + 'â€¦';
        };

        const normalizeOpenDeal = (deal) => {
          const quarter = deal.fiscalQ || deal.quarter || deal.Fiscal_Q || deriveQuarterLabel(deal.closeDate || deal.Data_Prevista);
          const rawIdle = deal.daysIdle ?? deal.Idle_Dias;
          const rawActivities = deal.activities ?? deal.Atividades;
          const idleDays = (rawIdle === '' || rawIdle == null) ? null : Number(rawIdle);
          const activities = (rawActivities === '' || rawActivities == null) ? null : Number(rawActivities);
          return {
            name: deal.name || deal.Oportunidade || 'Deal sem nome',
            account: deal.account || deal.accountName || deal.Conta || 'Conta nao informada',
            owner: deal.seller || deal.owner || deal.Vendedor || 'N/A',
            value: deal.val || deal.Gross || 0,
            confidence: normalizeConfidencePercent(deal.confidence ?? deal.Confianca),
            stage: deal.stage || deal.Fase_Atual || '',
            idleDays: Number.isNaN(idleDays) ? null : idleDays,
            activities: Number.isNaN(activities) ? null : activities,
            insight: deal.pipelineAnalysis || deal.insight || '',
            auditQuestions: deal.auditQuestions || '',
            quarter: quarter || 'Quarter N/A'
          };
        };

        const normalizeClosedDeal = (deal, kind) => {
          const quarter = deal.fiscalQ || deal.Fiscal_Q || deriveQuarterLabel(deal.Data_Fechamento || deal.closeDate);
          return {
            name: deal.Oportunidade || deal.Opportunity_Name || deal.opportunityName || deal.name || 'Deal sem nome',
            account: deal.Conta || deal.account || 'Conta nao informada',
            owner: deal.Vendedor || deal.owner || 'N/A',
            value: deal.Gross || deal.val || 0,
            closeDate: deal.Data_Fechamento || deal.closeDate || '',
            cycle: deal.Ciclo_dias || deal.ciclo_dias || deal.Ciclo || deal.cycle || null,
            resultType: deal.Tipo_Resultado || '',
            reason: kind === 'won'
              ? (deal.Fatores_Sucesso || deal.Win_Reason || deal.winReason || '')
              : (deal.Causa_Raiz || deal.Loss_Reason || deal.lossReason || ''),
            quarter: quarter || 'Quarter N/A'
          };
        };

        const buildInsight = (kind, deal) => {
          if (kind === 'open') {
            const conf = deal.confidence || 0;
            const idle = deal.idleDays != null ? Number(deal.idleDays) : null;
            const activityCount = deal.activities != null ? Number(deal.activities) : null;
            const summaryParts = [];
            if (deal.stage) summaryParts.push(`Stage ${deal.stage}`);
            summaryParts.push(`Confianca ${conf}%`);
            if (idle != null && !Number.isNaN(idle) && idle > 0) summaryParts.push(`Idle ${idle}d`);
            if (activityCount != null && !Number.isNaN(activityCount) && activityCount > 0) summaryParts.push(`${activityCount} atividades`);
            const summary = summaryParts.join(' Â· ');

            let action = 'Revisar proximo passo e reforcar champion';
            if (conf >= 80) action = 'Acelerar fechamento e remover bloqueios finais';
            else if (conf >= 50) action = 'Garantir proposta clara e timeline de decisao';
            else if (conf < 30) action = 'Requalificar oportunidade e validar fit';
            if (idle != null && idle >= 30) action = 'Reativar contato e redefinir proximo passo';
            return { summary, action };
          }

          if (kind === 'won') {
            const summary = [deal.resultType, deal.reason].filter(Boolean).join(' Â· ') || 'Fechamento bem-sucedido';
            let action = 'Replicar padroes em deals similares e documentar aprendizados';
            if (deal.cycle && Number(deal.cycle) > 120) action = 'Reduzir ciclo em deals similares e acelerar etapas criticas';
            else if (deal.reason && /arp|ata/i.test(deal.reason)) action = 'Padronizar play de ARP e acelerar aprovacoes';
            else if (deal.reason && /base instalada|incumb/i.test(deal.reason)) action = 'Escalar upsell na base instalada com playbook claro';
            else if (deal.reason && /agilidade|timing|rapido|veloc/i.test(deal.reason)) action = 'Codificar playbook de velocidade e reduzir atrito';
            else if (deal.reason && /champion|sponsor|decisor/i.test(deal.reason)) action = 'Mapear champions cedo e formalizar patrocinios';
            else if (deal.reason && /preco|valor|orcamento|roi/i.test(deal.reason)) action = 'Reforcar ROI e business case nas propostas';
            return { summary, action };
          }

          const summary = [deal.resultType, deal.reason].filter(Boolean).join(' Â· ') || 'Perda com causa a investigar';
          let action = 'Aplicar gate de qualificacao e ajustar abordagem cedo';
          if (deal.reason && /abandono|engajamento/i.test(deal.reason)) action = 'Criar SLA de follow-up e playbook de reengajamento';
          else if (deal.reason && /qualificacao|bant|meddic/i.test(deal.reason)) action = 'Fortalecer criterios de qualificacao e corte rapido';
          else if (deal.reason && /concorr|compet/i.test(deal.reason)) action = 'Diferenciar proposta e usar battlecards cedo';
          else if (deal.reason && /preco|valor|orcamento|roi/i.test(deal.reason)) action = 'Trabalhar ROI cedo e alinhar expectativas financeiras';
          else if (deal.reason && /prazo|tempo|ciclo/i.test(deal.reason)) action = 'Definir timeline com decisores e reduzir ciclo';
          return { summary, action };
        };

        const detectTheme = (text, themes) => {
          const content = (text || '').toLowerCase();
          for (const theme of themes) {
            if (theme.match.some(pattern => content.includes(pattern))) return theme.label;
          }
          return 'Outros';
        };

        const summarizeThemes = (deals, selector, themes) => {
          const counts = {};
          deals.forEach(deal => {
            const value = selector(deal);
            if (!value) return;
            const label = detectTheme(value, themes);
            counts[label] = (counts[label] || 0) + 1;
          });
          const ranked = Object.entries(counts).sort((a, b) => b[1] - a[1]);
          return ranked.slice(0, 2).map(([label, count]) => `${label} (${count})`).join(' Â· ');
        };

        const renderTopOppsSummary = (tab, top5Deals, normalized, totalBase, top5Total, top5AvgConf, targetQuarter, baseLabel) => {
          const summaryEl = document.getElementById('exec-top5-summary');
          if (!summaryEl) return;

          const topDeal = top5Deals[0];
          const topDealShare = totalBase > 0 && topDeal ? ((topDeal.value || 0) / totalBase * 100).toFixed(1) : '0.0';
          const periodLabel = targetQuarter ? ` (${targetQuarter})` : '';

          let highlight = 'Sem dados suficientes para resumir.';
          let action = 'Defina filtros para detalhar o periodo.';
          let extra = '';

          if (tab === 'open') {
            const highRisk = top5Deals.find(deal => (deal.confidence || 0) < 30 || (deal.idleDays != null && Number(deal.idleDays) >= 30));
            highlight = topDeal
              ? `Concentracao: ${topDeal.account} representa ${topDealShare}% do ${baseLabel}${periodLabel}.`
              : 'Concentracao indisponivel.';
            action = highRisk
              ? `Prioridade de risco: ${highRisk.account} com ${highRisk.confidence || 0}% de confianca e ${highRisk.idleDays || 0} dias idle.`
              : 'Sem riscos criticos detectados no Top 5.';
            extra = top5AvgConf != null ? `Confianca media: ${top5AvgConf}% em ${top5Deals.length} deals.` : '';
          } else if (tab === 'won') {
            const themes = [
              { label: 'Relacionamento/Base instalada', match: ['relacionamento', 'base instalada', 'incumb'] },
              { label: 'ARP/Compras publicas', match: ['arp', 'ata'] },
              { label: 'Velocidade/Timing', match: ['agilidade', 'timing', 'rapido', 'ciclo'] },
              { label: 'Preco/ROI', match: ['preco', 'valor', 'orcamento', 'roi'] },
              { label: 'Champion/Decisor', match: ['champion', 'sponsor', 'decisor'] }
            ];
            const themeSummary = summarizeThemes(top5Deals, deal => deal.reason || '', themes);
            highlight = topDeal
              ? `Maior vitoria: ${topDeal.account} (${formatMoney(topDeal.value || 0)}).`
              : 'Maior vitoria indisponivel.';
            action = themeSummary ? `Fatores dominantes: ${themeSummary}.` : 'Sem fator dominante claro.';
            extra = `Total Top 5: ${formatMoney(top5Total)} (${top5Deals.length} deals).`;
          } else {
            const themes = [
              { label: 'Qualificacao fraca', match: ['qualificacao', 'bant', 'meddic'] },
              { label: 'Abandono/Engajamento', match: ['abandono', 'engajamento'] },
              { label: 'Concorrencia', match: ['concorr', 'compet'] },
              { label: 'Preco/Orcamento', match: ['preco', 'valor', 'orcamento'] },
              { label: 'Ciclo longo', match: ['ciclo', 'prazo', 'tempo'] }
            ];
            const themeSummary = summarizeThemes(top5Deals, deal => deal.reason || '', themes);
            highlight = topDeal
              ? `Maior perda: ${topDeal.account} (${formatMoney(topDeal.value || 0)}).`
              : 'Maior perda indisponivel.';
            action = themeSummary ? `Causas dominantes: ${themeSummary}.` : 'Sem causa dominante clara.';
            extra = `Total Top 5: ${formatMoney(top5Total)} (${top5Deals.length} deals).`;
          }

          summaryEl.innerHTML = `
            <div style="font-weight: 700; margin-bottom: 8px;">Resumo Executivo</div>
            <div style="font-size: 12px; color: var(--text-gray); line-height: 1.6;">${highlight}</div>
            <div style="font-size: 12px; color: var(--primary-cyan); line-height: 1.6; margin-top: 6px;">${action}</div>
            ${extra ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 6px;">${extra}</div>` : ''}
          `;
        };

        const setActiveTopOppsTab = (tab) => {
          const tabColors = {
            open: '#00BEFF',
            won: '#10b981',
            lost: '#ef4444'
          };
          topOppsTabs.forEach(button => {
            const isActive = button.dataset.topOppsTab === tab;
            const baseColor = tabColors[button.dataset.topOppsTab] || '#00BEFF';
            button.classList.toggle('active', isActive);
            button.style.background = isActive ? `${baseColor}33` : `${baseColor}14`;
            button.style.color = isActive ? baseColor : 'var(--text-gray)';
            button.style.borderColor = isActive ? `${baseColor}77` : `${baseColor}33`;
          });
        };

        const getFilteredDealsByPeriod = (deals) => {
          const period = window.currentTopOppsPeriod || 'all';
          const fy = window.currentFY || 'FY26';
          if (period === 'q1' || period === 'q2' || period === 'q3' || period === 'q4') {
            const targetQuarter = `${fy}-${period.toUpperCase()}`;
            return deals.filter(d => (d.fiscalQ || d.quarter) === targetQuarter);
          }
          return deals;
        };

        const renderTopOppsTab = (tab) => {
          if (!topOppsContainer) return;
          topOppsContainer.innerHTML = '';

          const period = window.currentTopOppsPeriod || 'all';
          const fy = window.currentFY || 'FY26';
          const isQuarterPeriod = period === 'q1' || period === 'q2' || period === 'q3' || period === 'q4';
          const targetQuarter = isQuarterPeriod ? `${fy}-${period.toUpperCase()}` : '';
          const filterClosedByQuarter = (deals) => {
            if (!isQuarterPeriod) return deals;
            return deals.filter(deal => {
              const quarter = deal.Fiscal_Q || deriveQuarterLabel(deal.Data_Fechamento);
              return quarter === targetQuarter;
            });
          };

          let baseDeals = [];
          let fallbackDeals = [];
          let normalized = [];
          let fallbackUsed = false;
          let baseLabel = 'pipeline';

          if (tab === 'open') {
            baseLabel = 'pipeline';
            const openDeals = getFilteredDealsByPeriod(allDeals || []);
            baseDeals = openDeals;
            fallbackDeals = (window.topOppsFallback && window.topOppsFallback.pipeline) ? window.topOppsFallback.pipeline : [];
            const source = baseDeals.length > 0 ? baseDeals : fallbackDeals;
            fallbackUsed = baseDeals.length === 0 && fallbackDeals.length > 0;
            normalized = source.map(normalizeOpenDeal);
          } else if (tab === 'won') {
            baseLabel = 'ganhos';
            baseDeals = filterClosedByQuarter(Array.isArray(DATA.wonAgg) ? DATA.wonAgg : []);
            fallbackDeals = filterClosedByQuarter((window.topOppsFallback && window.topOppsFallback.won) ? window.topOppsFallback.won : []);
            const source = baseDeals.length > 0 ? baseDeals : fallbackDeals;
            fallbackUsed = baseDeals.length === 0 && fallbackDeals.length > 0;
            normalized = source.map(deal => normalizeClosedDeal(deal, 'won'));
          } else {
            baseLabel = 'perdas';
            baseDeals = filterClosedByQuarter(Array.isArray(DATA.lostAgg) ? DATA.lostAgg : []);
            fallbackDeals = filterClosedByQuarter((window.topOppsFallback && window.topOppsFallback.lost) ? window.topOppsFallback.lost : []);
            const source = baseDeals.length > 0 ? baseDeals : fallbackDeals;
            fallbackUsed = baseDeals.length === 0 && fallbackDeals.length > 0;
            normalized = source.map(deal => normalizeClosedDeal(deal, 'lost'));
          }

          const top5Deals = normalized
            .sort((a, b) => (b.value || 0) - (a.value || 0))
            .slice(0, 5);

          const totalBase = normalized.reduce((sum, d) => sum + (d.value || 0), 0);
          const top5Total = top5Deals.reduce((sum, d) => sum + (d.value || 0), 0);
          const top5Percent = totalBase > 0 ? ((top5Total / totalBase) * 100).toFixed(1) : 0;
          const top5AvgConf = tab === 'open' && top5Deals.length > 0
            ? Math.round(top5Deals.reduce((sum, d) => sum + (d.confidence || 0), 0) / top5Deals.length)
            : null;

          setTextSafe('exec-top5-total', formatMoney(top5Total));
          const periodSuffix = isQuarterPeriod ? ` (${targetQuarter})` : '';
          setTextSafe('exec-top5-percent', `${top5Percent}% do ${baseLabel} do periodo${periodSuffix}`);
          setTextSafe('exec-top5-confidence', top5AvgConf == null ? 'N/A' : `${top5AvgConf}%`);
          setTextSafe('exec-top5-deals', `${top5Deals.length} deals`);

          renderTopOppsSummary(tab, top5Deals, normalized, totalBase, top5Total, top5AvgConf, targetQuarter, baseLabel);

          if (topOppsNote) {
            if (fallbackUsed) {
              topOppsNote.style.display = 'block';
              topOppsNote.textContent = 'Mostrando base historica sem filtro (nao ha deals no periodo selecionado).';
            } else {
              topOppsNote.style.display = 'none';
              topOppsNote.textContent = '';
            }
          }

          if (top5Deals.length === 0) {
            topOppsContainer.innerHTML = '<div style="color: var(--text-gray); padding: 20px; text-align: center;">Nenhuma oportunidade encontrada</div>';
            return;
          }

          top5Deals.forEach((deal, idx) => {
            const conf = deal.confidence || 0;
            let confBadge = 'badge-warning';
            if (conf >= 90) confBadge = 'badge-success';
            else if (conf > 0 && conf < 50) confBadge = 'badge-danger';

            const insight = buildInsight(tab, deal);
            const auditQuestions = deal.auditQuestions || '';
            const questionsArray = auditQuestions.split('|').map(q => q.trim()).filter(q => q.length > 0);

            const card = document.createElement('div');
            card.className = 'deal-card';
            card.style.marginBottom = '10px';

            card.innerHTML = `
              <div style="font-size: 10px; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">#${idx + 1} Â· ${deal.quarter || 'Quarter N/A'}</div>
              <div class="deal-header">
                <div>
                  <div class="deal-name">${deal.name}</div>
                  <div style="font-size: 12px; color: var(--text-gray); margin-top: 4px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; vertical-align: middle; margin-right: 4px;">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Conta: <strong style="color: var(--text-white);">${deal.account}</strong>
                  </div>
                </div>
                <div class="deal-value">${formatMoney(deal.value || 0)}</div>
              </div>
              <div class="deal-meta" style="margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span><strong>Responsavel:</strong> ${deal.owner}</span>
                  ${tab === 'open' ? `<span class="badge ${confBadge}">${conf}% confianca</span>` : '<span class="badge badge-warning">Fechado</span>'}
                </div>
                ${deal.stage ? `<div style="margin-top: 8px; font-size: 12px; color: var(--text-gray);"><strong>Stage:</strong> ${deal.stage}</div>` : ''}
                ${deal.resultType ? `<div style="margin-top: 8px; font-size: 12px; color: var(--text-gray);"><strong>Resultado:</strong> ${deal.resultType}</div>` : ''}
                ${deal.cycle ? `<div style="margin-top: 6px; font-size: 12px; color: var(--text-gray);"><strong>Ciclo:</strong> ${deal.cycle} dias</div>` : ''}
                ${deal.reason ? `<div style="margin-top: 6px; font-size: 12px; color: var(--text-gray);"><strong>Motivo:</strong> ${deal.reason}</div>` : ''}
                ${questionsArray.length > 0 ? `
                  <details style="margin-top: 12px; padding: 12px; background: rgba(225,72,73,0.1); border-left: 3px solid var(--danger); border-radius: 4px;">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--danger); font-size: 13px; user-select: none;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                      </svg>
                      Perguntas de Auditoria IA
                    </summary>
                    <ul style="margin: 12px 0 0 0; padding-left: 20px; font-size: 12px; line-height: 1.7; color: var(--text-gray);">
                      ${questionsArray.map(q => `<li style="margin-bottom: 8px;">${q}</li>`).join('')}
                    </ul>
                  </details>
                ` : ''}
                ${deal.insight ? `
                  <details style="margin-top: 12px; padding: 10px; background: rgba(0,190,255,0.05); border-left: 3px solid var(--primary-cyan); border-radius: 4px;">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--primary-cyan); font-size: 12px; user-select: none;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                      </svg>
                      Insights da Analise de Pipeline
                    </summary>
                    <div style="margin-top: 10px; font-size: 12px; line-height: 1.6; color: var(--text-gray);">
                      ${deal.insight}
                    </div>
                  </details>
                ` : ''}
                <div style="margin-top: 10px; font-size: 12px; color: var(--text-gray);"><strong>Resumo:</strong> ${insight.summary}</div>
                <div style="margin-top: 6px; font-size: 12px; color: var(--primary-cyan);"><strong>Recomendacao:</strong> ${insight.action}</div>
              </div>
            `;
            topOppsContainer.appendChild(card);
          });
        };

        window.switchTopOppsTab = function(tab) {
          window.topOppsState = window.topOppsState || { tab: 'open' };
          window.topOppsState.tab = tab;
          setActiveTopOppsTab(tab);
          renderTopOppsTab(tab);
        };

        window.updateTop5Opps = function(period) {
          log('[TOP 5] ========== ATUALIZANDO TOP 5 PARA PERIODO:', period, '==========');
          window.currentTopOppsPeriod = period;
          const activeTab = (window.topOppsState && window.topOppsState.tab) ? window.topOppsState.tab : 'open';
          setActiveTopOppsTab(activeTab);
          renderTopOppsTab(activeTab);
          log('[TOP 5] ========== TOP 5 ATUALIZADO COM SUCESSO ==========');
        };

        window.allDealsWithQuarter = allDeals;
        window.currentTopOppsPeriod = window.currentTopOppsPeriod || 'all';

        const initialTab = (window.topOppsState && window.topOppsState.tab) ? window.topOppsState.tab : 'open';
        setActiveTopOppsTab(initialTab);
        renderTopOppsTab(initialTab);
        
        // Armazena todos os deals com quarter para uso global
        window.allDealsWithQuarter = allDeals;

        // Helper function global para criar word cloud
        window.createWordCloud = function(dataArray, containerId, colorScheme = 'default') {
          const container = document.getElementById(containerId);
          if (!container || dataArray.length === 0) {
            if (container) {
              container.innerHTML = '<p style="color: var(--text-gray); text-align: center;">Nenhum dado disponÃ­vel</p>';
            }
            return;
          }
          
          const maxCount = dataArray[0][1];
          const getColor = (count, scheme) => {
            if (scheme === 'success') {
              return count >= maxCount * 0.7 ? 'var(--success)' : 
                     count >= maxCount * 0.4 ? '#10b981' : 
                     'rgba(16,185,129,0.6)';
            } else if (scheme === 'danger') {
              return count >= maxCount * 0.7 ? 'var(--danger)' : 
                     count >= maxCount * 0.4 ? '#f87171' : 
                     'rgba(239,68,68,0.6)';
            } else if (scheme === 'info') {
              return count >= maxCount * 0.7 ? 'var(--primary-cyan)' : 
                     count >= maxCount * 0.4 ? '#00BEFF' : 
                     'rgba(0,190,255,0.6)';
            } else {
              return count >= maxCount * 0.7 ? 'var(--danger)' : 
                     count >= maxCount * 0.4 ? 'var(--warning)' : 
                     'var(--text-gray)';
            }
          };
          
          container.innerHTML = `
            <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center;">
              ${dataArray.map(([label, count]) => {
                const size = 10 + (count / maxCount) * 10;
                const opacity = 0.5 + (count / maxCount) * 0.5;
                const color = getColor(count, colorScheme);
                return `
                  <span style="
                    font-size: ${size}px;
                    color: ${color};
                    opacity: ${opacity};
                    font-weight: 600;
                    padding: 4px 8px;
                    background: rgba(255,255,255,0.05);
                    border-radius: 4px;
                    white-space: nowrap;
                    transition: all 0.3s;
                    cursor: help;
                  " title="${count} ocorrÃªncia${count > 1 ? 's' : ''}">
                    ${label} <span style="font-size: 9px; opacity: 0.7;">(${count})</span>
                  </span>
                `;
              }).join('')}
            </div>
          `;
        };

        // SEÃ‡ÃƒO 6: MAPA DE FLAGS DE RISCO
        log('[RENDER] === SEÃ‡ÃƒO 6: MAPA DE FLAGS DE RISCO ===');
        const riskFlagsContainer = document.getElementById('exec-risk-flags-container');
        if (riskFlagsContainer && DATA.wordClouds && DATA.wordClouds.riskFlags) {
          const flagsArray = DATA.wordClouds.riskFlags.slice(0, 20); // Top 20 flags
          
          log('[DATA] Flags de risco:', flagsArray.length, 'tipos');
          
          if (flagsArray.length > 0) {
            const maxCount = flagsArray[0].value;
            riskFlagsContainer.innerHTML = `
              <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center;">
                ${flagsArray.map(item => {
                  const size = 10 + (item.value / maxCount) * 10; // Tamanho de 10px a 20px
                  const opacity = 0.5 + (item.value / maxCount) * 0.5; // Opacidade de 0.5 a 1
                  const color = item.value >= maxCount * 0.7 ? 'var(--danger)' : 
                               item.value >= maxCount * 0.4 ? 'var(--warning)' : 
                               'var(--text-gray)';
                  return `
                    <span style="
                      font-size: ${size}px;
                      color: ${color};
                      opacity: ${opacity};
                      font-weight: 600;
                      padding: 4px 8px;
                      background: rgba(255,255,255,0.05);
                      border-radius: 4px;
                      white-space: nowrap;
                      transition: all 0.3s;
                      cursor: help;
                    " title="${item.value} ocorrÃªncia(s)">
                      ${item.text} <span style="font-size: 10px; color: var(--text-gray);">(${item.value})</span>
                    </span>
                  `;
                }).join('')}
              </div>
            `;
          } else {
            riskFlagsContainer.innerHTML = '<p style="color: var(--text-gray); text-align: center;">Nenhuma flag de risco identificada no pipeline</p>';
          }
        } else if (riskFlagsContainer) {
          riskFlagsContainer.innerHTML = '<p style="color: var(--text-gray); text-align: center;">Nenhuma flag de risco identificada no pipeline</p>';
        }
        
        // SEÃ‡ÃƒO 7: LABELS DE AÃ‡ÃƒO DO PIPELINE
        log('[RENDER] === SEÃ‡ÃƒO 7: LABELS DE AÃ‡ÃƒO DO PIPELINE ===');
        const actionLabelsContainer = document.getElementById('exec-action-labels-container');
        if (actionLabelsContainer && DATA.wordClouds && DATA.wordClouds.actionLabels) {
          const actionLabelsArray = DATA.wordClouds.actionLabels.slice(0, 20);
          log('[DATA] Labels de aÃ§Ã£o:', actionLabelsArray.length, 'tipos');
          
          if (actionLabelsArray.length > 0) {
            window.createWordCloud(actionLabelsArray.map(item => [item.text, item.value]), 'exec-action-labels-container', 'info');
          } else {
            actionLabelsContainer.innerHTML = '<p style="color: var(--text-gray); text-align: center;">Nenhum dado disponÃ­vel</p>';
          }
        } else if (actionLabelsContainer) {
          actionLabelsContainer.innerHTML = '<p style="color: var(--text-gray); text-align: center;">Nenhum dado disponÃ­vel</p>';
        }
        
        // SEÃ‡ÃƒO 8 & 9: PERFIL DE VITÃ“RIAS E PERDAS (Tipo Resultado)
        log('[RENDER] === SEÃ‡ÃƒO 8 & 9: PERFIL DE VITÃ“RIAS E PERDAS ===');
        if (DATA.wordClouds) {
          const allWinTypes = {};
          const allLossTypes = {};
          
          // Conta frequÃªncias de Tipo Resultado
          (DATA.wordClouds.winTypes || []).forEach(item => {
            if (item && item.text && item.text.trim()) {
              const type = item.text.trim();
              allWinTypes[type] = (allWinTypes[type] || 0) + (item.value || 1);
            }
          });
          
          (DATA.wordClouds.lossTypes || []).forEach(item => {
            if (item && item.text && item.text.trim()) {
              const type = item.text.trim();
              allLossTypes[type] = (allLossTypes[type] || 0) + (item.value || 1);
            }
          });
          
          const winTypesArray = Object.entries(allWinTypes).sort((a, b) => b[1] - a[1]).slice(0, 15);
          const lossTypesArray = Object.entries(allLossTypes).sort((a, b) => b[1] - a[1]).slice(0, 15);
          
          log('[DATA] Perfil vitÃ³rias:', winTypesArray.length, 'tipos');
          log('[DATA] Perfil perdas:', lossTypesArray.length, 'tipos');
          
          window.createWordCloud(winTypesArray, 'exec-win-types-container', 'success');
          window.createWordCloud(lossTypesArray, 'exec-loss-types-container', 'danger');
        }
        
        // SEÃ‡ÃƒO 10 & 11: PADRÃ•ES DE SUCESSO E PERDA (Labels)
        log('[RENDER] === SEÃ‡ÃƒO 10 & 11: PADRÃ•ES DE SUCESSO E PERDA ===');
        if (DATA.wordClouds) {
          const allWinLabels = {};
          const allLossLabels = {};
          
          // Conta frequÃªncias
          (DATA.wordClouds.winLabels || []).forEach(item => {
            if (item && item.text && item.text.trim()) {
              const label = item.text.trim();
              allWinLabels[label] = (allWinLabels[label] || 0) + (item.value || 1);
            }
          });
          
          (DATA.wordClouds.lossLabels || []).forEach(item => {
            if (item && item.text && item.text.trim()) {
              const label = item.text.trim();
              allLossLabels[label] = (allLossLabels[label] || 0) + (item.value || 1);
            }
          });
          
          const winLabelsArray = Object.entries(allWinLabels).sort((a, b) => b[1] - a[1]).slice(0, 20);
          const lossLabelsArray = Object.entries(allLossLabels).sort((a, b) => b[1] - a[1]).slice(0, 20);
          
          log('[DATA] PadrÃµes sucesso:', winLabelsArray.length, 'labels');
          log('[DATA] PadrÃµes perda:', lossLabelsArray.length, 'labels');
          
          window.createWordCloud(winLabelsArray, 'exec-win-labels-container', 'success');
          window.createWordCloud(lossLabelsArray, 'exec-loss-labels-container', 'danger');
        }

        // AI Insights
        log('[RENDER] === AI INSIGHTS ===');
        const aiInsightsContainer = document.getElementById('ai-insights-container');
        if (aiInsightsContainer && DATA.aiInsights) {
          const ai = DATA.aiInsights;
          
          // FunÃ§Ã£o para quebrar insights em bullets
          const parseToBullets = (text) => {
            if (!text) return [];
            // Quebrar por frases usando pontos, limitando tamanho
            const sentences = text
              .split(/\.\s+/)
              .map(s => s.trim())
              .filter(s => s.length > 20);
            return sentences.map(s => s.endsWith('.') ? s : s + '.');
          };
          
          const winBullets = parseToBullets(ai.win_insights);
          const lossBullets = parseToBullets(ai.loss_insights);
          
          aiInsightsContainer.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 20px;">
              <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--success); padding: 20px; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: var(--success); font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                  <svg class="icon"><use href="#icon-trophy"/></svg> PadrÃµes de VitÃ³ria
                </h4>
                ${winBullets.length > 0 ? `
                  <ul style="margin: 0; padding-left: 20px; color: var(--text-gray); font-size: 13px; line-height: 1.9; list-style: disc;">
                    ${winBullets.map(bullet => `<li style="margin-bottom: 8px;">${bullet}</li>`).join('')}
                  </ul>
                ` : `<p style="margin: 0; color: var(--text-gray); font-size: 13px;">Nenhum insight disponÃ­vel</p>`}
              </div>
              
              <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--danger); padding: 20px; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: var(--danger); font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                  <svg class="icon"><use href="#icon-alert"/></svg> PadrÃµes de Perda
                </h4>
                ${lossBullets.length > 0 ? `
                  <ul style="margin: 0; padding-left: 20px; color: var(--text-gray); font-size: 13px; line-height: 1.9; list-style: disc;">
                    ${lossBullets.map(bullet => `<li style="margin-bottom: 8px;">${bullet}</li>`).join('')}
                  </ul>
                ` : `<p style="margin: 0; color: var(--text-gray); font-size: 13px;">Nenhum insight disponÃ­vel</p>`}
              </div>
              
              ${ai.recommendations && ai.recommendations.length > 0 ? `
                <div style="background: rgba(0, 190, 255, 0.1); border-left: 4px solid var(--primary-cyan); padding: 20px; border-radius: 8px;">
                  <h4 style="margin: 0 0 15px 0; color: var(--primary-cyan); font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <svg class="icon"><use href="#icon-idea"/></svg> RecomendaÃ§Ãµes
                  </h4>
                  <ul style="margin: 0; padding-left: 20px; color: var(--text-gray); font-size: 13px; line-height: 1.9; list-style: decimal;">
                    ${ai.recommendations.map(rec => `<li style="margin-bottom: 10px;"><strong>${rec}</strong></li>`).join('')}
                  </ul>
                </div>
              ` : ''}
              
              ${ai.status === 'gemini' ? `
                <div style="text-align: center; padding: 12px; background: rgba(0, 190, 255, 0.05); border-radius: 6px; border: 1px solid rgba(0, 190, 255, 0.2);">
                  <p style="margin: 0; color: var(--primary-cyan); font-size: 11px; font-weight: 500;">
                    <svg class="icon"><use href="#icon-sparkles"/></svg> AnÃ¡lise gerada por Gemini 2.5 Flash
                    ${ai.deals_analyzed ? ` â€¢ ${ai.deals_analyzed.won} vitÃ³rias + ${ai.deals_analyzed.lost} perdas analisadas` : ''}
                  </p>
                </div>
              ` : ai.status === 'placeholder' ? `
                <p style="text-align: center; color: var(--text-gray); font-size: 11px; margin: 10px 0 0 0; opacity: 0.7;">
                  âš™ï¸ AnÃ¡lise bÃ¡sica ativa. IntegraÃ§Ã£o com Gemini em desenvolvimento.
                </p>
              ` : ''}
            </div>
          `;
        }

        // 1. L10 (mantÃ©m o cÃ³digo existente com validaÃ§Ãµes)
        log('[RENDER] === SEÃ‡ÃƒO L10 ===');
        // Reutiliza l10 jÃ¡ declarado anteriormente
        log('[DATA] L10 dados:', {
          'netRevenue': formatMoney(safe(l10, 'netRevenue')),
          'bookingsGross': formatMoney(safe(l10, 'bookingsGross')),
          'bookingsCount': safe(l10, 'bookingsCount', 0),
          'pipelineNextWeek': formatMoney(safe(l10, 'pipelineNextWeek')),
          'pipelineQuarter': formatMoney(safe(l10, 'pipelineQuarter')),
          'agingPipeline': safe(l10, 'agingPipeline', 0),
          'predictableRevenue': formatMoney(safe(l10, 'predictableRevenue'))
        });
        setTextSafe('kpi-net', formatMoney(safe(l10, 'netRevenue')));
        setTextSafe('kpi-bookings-gross', formatMoney(safe(l10, 'bookingsGross')));
        setTextSafe('kpi-bookings-count', safe(l10, 'bookingsCount', 0) + ' deals');
        setTextSafe('kpi-next-week', formatMoney(safe(l10, 'pipelineNextWeek')));
        setTextSafe('kpi-quarter', formatMoney(safe(l10, 'pipelineQuarter')));
        setTextSafe('kpi-aging', safe(l10, 'agingPipeline', 0));
        setTextSafe('kpi-predictable', formatMoney(safe(l10, 'predictableRevenue')));

        // Margem por categoria
        log('[RENDER] Processando margens por categoria...');
        const marginContainer = document.getElementById('margin-container');
        if (marginContainer) {
          marginContainer.innerHTML = '';
        const margins = safe(l10, 'marginByCategory', []);
        log('[DATA] Margens:', margins.length, 'categorias');
        if (margins.length > 0) {
          margins.forEach(cat => {
            const card = document.createElement('div');
            card.className = 'margin-card';
            card.innerHTML = `
              <div class="margin-card-title">${cat.category || 'N/A'}</div>
              <div class="margin-card-value">${cat.margin || 0}%</div>
              <div class="margin-card-sub">${cat.count || 0} deals â€¢ ${formatMoney(cat.revenue || 0)}</div>
            `;
            marginContainer.appendChild(card);
          });
        } else {
          marginContainer.innerHTML = '<div style="color: var(--text-gray); padding: 20px; text-align: center;">Sem dados de margem disponÃ­veis</div>';
        }
        } // fim do if marginContainer

        // 2. FSR Performance Table - Separa ativos e inativos
        log('[RENDER] === SEÃ‡ÃƒO FSR PERFORMANCE ===');
        const scorecardTable = DATA.fsrScorecard || [];
        const activeRepsTable = scorecardTable.filter(r => r.isActive);
        const inactiveReps = scorecardTable.filter(r => !r.isActive);
        log('[DATA] FSR Scorecard:', activeRepsTable.length, 'ativos,', inactiveReps.length, 'inativos');
        
        // Popula tabela de IPV (Ranking Geral)
        const ipvTableBody = document.getElementById('fsr-ipv-table');
        if (ipvTableBody) {
          ipvTableBody.innerHTML = '';
          if (activeRepsTable.length > 0) {
            activeRepsTable.forEach((fsr, idx) => {
              const tr = document.createElement('tr');
              
              // Determina cor do IPV
              let ipvClass = 'badge-warning';
              const ipv = fsr.ipv || 0;
              if (ipv >= 80) ipvClass = 'badge-success';
              else if (ipv < 50) ipvClass = 'badge-danger';
              
              // Badges coloridos para os pilares (com proteÃ§Ã£o contra undefined)
              const breakdown = fsr.ipvBreakdown || { result: 0, efficiency: 0, behavior: 0 };
              const resultClass = (breakdown.result || 0) >= 70 ? 'badge-success' : 
                                  (breakdown.result || 0) >= 50 ? 'badge-warning' : 'badge-danger';
              const effClass = (breakdown.efficiency || 0) >= 70 ? 'badge-success' : 
                               (breakdown.efficiency || 0) >= 50 ? 'badge-warning' : 'badge-danger';
              const behavClass = (breakdown.behavior || 0) >= 70 ? 'badge-success' : 
                                 (breakdown.behavior || 0) >= 50 ? 'badge-warning' : 'badge-danger';
              
              tr.innerHTML = `
                <td style="font-weight: 700; color: var(--primary-cyan); font-size: 1.2em;">#${idx + 1}</td>
                <td style="font-weight: 600; color: #fff;">${fsr.name || 'N/A'}</td>
                <td><span class="badge ${ipvClass}" style="font-size: 1.1em; padding: 8px 12px;">${ipv}</span></td>
                <td><span class="badge ${resultClass}">${breakdown.result || 0}</span></td>
                <td><span class="badge ${effClass}">${breakdown.efficiency || 0}</span></td>
                <td><span class="badge ${behavClass}">${breakdown.behavior || 0}</span></td>
                <td>${fsr.winRate || 0}%</td>
                <td style="font-weight: 600;">${formatMoney(fsr.totalGrossGenerated || 0)}</td>
              `;
              ipvTableBody.appendChild(tr);
            });
          } else {
            ipvTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-gray);">Sem dados de vendedores ativos</td></tr>';
          }
        }
        
        // Popula tabela de vendedores ATIVOS
        const perfActiveBody = document.getElementById('fsr-performance-active-body');
        if (perfActiveBody) {
          perfActiveBody.innerHTML = '';
        if (activeRepsTable.length > 0) {
          activeRepsTable.forEach(fsr => {
            const tr = document.createElement('tr');
            
            // Determina cor do Win Rate
            let winRateClass = 'badge-warning';
            const wr = fsr.winRate || 0;
            if (wr >= 80) winRateClass = 'badge-success';
            else if (wr < 40) winRateClass = 'badge-danger';
            
            tr.innerHTML = `
              <td style="font-weight: 600; color: #fff;">${fsr.name || 'N/A'}</td>
              <td><span class="badge ${winRateClass}">${wr}%</span></td>
              <td>${fsr.totalWon || 0}</td>
              <td>${fsr.totalLost || 0}</td>
              <td style="color: var(--success);">${fsr.avgWinCycle || 0}d</td>
              <td style="color: var(--danger);">${fsr.avgLossCycle || 0}d</td>
              <td>${formatMoney(fsr.avgGross || 0)}</td>
              <td style="font-weight: 600; color: var(--success);">${formatMoney(fsr.totalGrossGenerated || 0)}</td>
              <td style="font-weight: 600; color: var(--primary-cyan);">${formatMoney(fsr.totalNetGenerated || 0)}</td>
            `;
            perfActiveBody.appendChild(tr);
          });
        } else {
          perfActiveBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-gray);">Sem dados de vendedores ativos</td></tr>';
        }
        } // fim do if perfActiveBody
        
        // Popula tabela de vendedores INATIVOS
        const perfInactiveBody = document.getElementById('fsr-performance-inactive-body');
        if (perfInactiveBody) {
          perfInactiveBody.innerHTML = '';
        setTextSafe('inactive-count', inactiveReps.length);
        if (inactiveReps.length > 0) {
          inactiveReps.forEach(fsr => {
            const tr = document.createElement('tr');
            
            let winRateClass = 'badge-warning';
            const wr = fsr.winRate || 0;
            if (wr >= 80) winRateClass = 'badge-success';
            else if (wr < 40) winRateClass = 'badge-danger';
            
            tr.innerHTML = `
              <td style="font-weight: 600; color: var(--text-gray);">${fsr.name || 'N/A'}</td>
              <td><span class="badge ${winRateClass}">${wr}%</span></td>
              <td>${fsr.totalWon || 0}</td>
              <td>${fsr.totalLost || 0}</td>
              <td style="color: var(--text-gray);">${formatMoney(fsr.revenue || 0)}</td>
            `;
            perfInactiveBody.appendChild(tr);
          });
        } else {
          perfInactiveBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-gray);">Nenhum vendedor inativo</td></tr>';
        }
        } // fim do if perfInactiveBody

        // FSR Behavior Table - APENAS ATIVOS
        const behavActiveBody = document.getElementById('fsr-behavior-active-body');
        if (behavActiveBody) {
          behavActiveBody.innerHTML = '';
        if (activeRepsTable.length > 0) {
          activeRepsTable.forEach(fsr => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style="font-weight: 600; color: #fff;">${fsr.name || 'N/A'}</td>
              <td style="color: var(--success);">${fsr.avgActivitiesWin || 0}</td>
              <td style="color: var(--danger);">${fsr.avgActivitiesLoss || 0}</td>
              <td style="font-size: 12px; color: var(--text-gray);">${fsr.topLossCause || 'N/A'}</td>
              <td style="font-size: 12px; color: var(--text-gray);">${fsr.topWinFactor || 'N/A'}</td>
            `;
            behavActiveBody.appendChild(tr);
          });
        } else {
          behavActiveBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-gray);">Sem dados de vendedores ativos</td></tr>';
        }
        } // fim do if behavActiveBody

        // 4. POR VENDEDOR - Popula selector APENAS COM ATIVOS
        const repSelector = document.getElementById('rep-selector');
        if (repSelector) {
          repSelector.innerHTML = '<option value="">-- Selecione um vendedor --</option>';
          if (activeRepsTable.length > 0) {
            activeRepsTable.forEach((rep, idx) => {
              const option = document.createElement('option');
              option.value = idx;
              option.textContent = rep.name || `Vendedor ${idx + 1}`;
              option.dataset.isActive = 'true'; // Marca como ativo
              repSelector.appendChild(option);
            });
          }
        }

        // 5. Agenda (Pautas por Quarter) - cÃ³digo existente mantido
        const agendaContainer = document.getElementById('agenda-sellers-container');
        if (agendaContainer) {
          agendaContainer.innerHTML = '';
        
        const quartersAgenda = DATA.weeklyAgenda || {};
        if (Object.keys(quartersAgenda).length === 0) {
          agendaContainer.innerHTML = '<div class="loading">Nenhuma pauta crÃ­tica no momento</div>';
        } else {
          for (const [quarter, deals] of Object.entries(quartersAgenda)) {
            if (!deals || deals.length === 0) continue;
            
            const qDiv = document.createElement('div');
            qDiv.innerHTML = `<h4>${quarter}</h4>`;
            
            deals.forEach(d => {
              const card = document.createElement('div');
              card.className = 'deal-card';
              
              // Determina badge de confianÃ§a
              let confidenceBadge = 'badge-warning';
              const conf = d.confidence || 50;
              if (conf >= 70) confidenceBadge = 'badge-success';
              else if (conf < 50) confidenceBadge = 'badge-danger';
              
              card.innerHTML = `
                <div class="deal-header">
                  <div class="deal-name">${d.name || 'Deal sem nome'}</div>
                  <div class="deal-value">${formatMoney(d.val || 0)}</div>
                </div>
                <div class="deal-meta">
                  <svg class="icon"><use href="#icon-user"/></svg> ${d.owner || 'N/A'} | 
                  <strong>Stage:</strong> ${d.stage || 'N/A'} | 
                  <span class="badge ${confidenceBadge}">${conf}% confianÃ§a</span> | 
                  ${(d.daysToClose || 0) > 0 ? d.daysToClose + ' dias p/ close' : 'Atrasado'}
                </div>
                <div class="deal-audit">
                  ${d.auditQuestions || (d.nextActivity ? 'PrÃ³x: ' + d.nextActivity : 'Sem atividade agendada')}
                </div>
              `;
              qDiv.appendChild(card);
            });
            
            agendaContainer.appendChild(qDiv);
          }
        }
        } // fim do if agendaContainer
        
        // ============================================================================
        // POPULA FILTRO DE VENDEDORES
        // ============================================================================
        populateRepFilter();
        
        // Atualizar mÃ©tricas de Sales Specialist
        updateSalesSpecialistMetrics();
        
        log('[RENDER] ========== RENDERIZAÃ‡ÃƒO CONCLUÃDA ==========');
        log('[RENDER] Timestamp fim:', new Date().toISOString());
      } catch (error) {
        console.error('<svg class="icon"><use href="#icon-x"/></svg> Erro ao renderizar dashboard:', error);
        document.body.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #fff; background: #1c2b3e; min-height: 100vh;">
            <h2 style="color: #E14849;"><svg class="icon"><use href="#icon-alert"/></svg> Erro ao carregar dashboard</h2>
            <p style="color: #b0b8c4; margin: 20px 0;">${error.message}</p>
            <details style="margin-top: 30px; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto; background: #24344d; padding: 20px; border-radius: 8px;">
              <summary style="cursor: pointer; color: #00BEFF; font-weight: 600;"><svg class="icon"><use href="#icon-search"/></svg> Detalhes TÃ©cnicos</summary>
              <pre style="margin-top: 15px; color: #e0e6ed; font-size: 12px; overflow-x: auto;">${error.stack || 'Stack trace nÃ£o disponÃ­vel'}</pre>
            </details>
            <div style="margin-top: 30px;">
              <button onclick="location.reload()" style="
                background: #00BEFF; 
                color: #1c2b3e; 
                border: none; 
                padding: 12px 24px; 
                border-radius: 8px; 
                font-weight: 600; 
                cursor: pointer;
                font-size: 14px;
              "><svg class="icon"><use href="#icon-refresh"/></svg> Recarregar Dashboard</button>
            </div>
            <p style="color: #666; font-size: 12px; margin-top: 30px;">
              Se o erro persistir, limpe o cache via menu: <b>Xertica AI > Limpar Cache Web App</b>
            </p>
          </div>
        `;
      }
    }

    // FunÃ§Ã£o para mostrar detalhes de um vendedor especÃ­fico (REESCRITA - CONSOME API)
    async function showRepDetails() {
      const selector = document.getElementById('rep-selector');
      const idx = selector.value;
      const detailsDiv = document.getElementById('rep-details');
      const comparisonDiv = document.getElementById('sellers-comparison');
      
      // Esconde comparaÃ§Ã£o
      comparisonDiv.style.display = 'none';
      
      if (!idx || idx === '') {
        detailsDiv.style.display = 'none';
        return;
      }
      
      const sellerName = selector.options[selector.selectedIndex].text;
      
      // Mostra seÃ§Ã£o e loading
      detailsDiv.style.display = 'block';
      setHtmlSafe('rep-name-title', `<svg class="icon"><use href="#icon-user"/></svg> ${escapeHtml(sellerName)}`);
      showLoading('Carregando performance do vendedor...');
      
      try {
        // âœ… Usa filtros globais OU fallback para Q1 2026 (perÃ­odo padrÃ£o)
        const filters = window.currentFilters || {};
        const usingDefault = !filters.year && !filters.quarter;
        const year = filters.year || '2026';
        const quarter = filters.quarter || '1';
        
        // Monta query string
        let queryParams = [];
        if (year) queryParams.push(`year=${year}`);
        if (quarter) queryParams.push(`quarter=${quarter}`);
        const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
        
        // Define label do perÃ­odo (com indicador de padrÃ£o)
        let periodLabel = `ðŸ“… FY${year.slice(-2)}-Q${quarter}`;
        if (usingDefault) {
          periodLabel += ' <small style="opacity: 0.7; font-weight: 400;">(padrÃ£o)</small>';
        }
        setHtmlSafe('rep-period-badge', periodLabel);
        
        // âœ… CONSOME API /api/performance/seller/{name}
        const response = await fetch(
          `${window.API_BASE_URL}/api/performance/seller/${encodeURIComponent(sellerName)}${queryString}`
        );
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success || !data.performance) {
          throw new Error('Dados do vendedor nÃ£o encontrados');
        }
        
        const perf = data.performance;
        const scorecard = data.scorecard || {};
        const comportamento = data.comportamento || {};
        
        // ============================================================================
        // POPULA CARD IPV DESTACADO
        // ============================================================================
        setTextSafe('rep-ipv-score', perf.ipv || 0);
        setTextSafe('rep-ipv-resultado', perf.resultado || 0);
        setTextSafe('rep-ipv-eficiencia', perf.eficiencia || 0);
        setTextSafe('rep-ipv-comportamento', perf.comportamento || 0);
        setTextSafe('rep-rank-badge', `#${perf.rank || '?'} no ranking`);
        
        // Mostra NET gate warning se aplicÃ¡vel
        const netGateWarning = document.getElementById('rep-net-gate-warning');
        if (scorecard.netGerado <= 0 && perf.ipv <= 20) {
          netGateWarning.style.display = 'block';
        } else {
          netGateWarning.style.display = 'none';
        }
        
        // ============================================================================
        // POPULA KPIs
        // ============================================================================
        setTextSafe('rep-winrate', (perf.winRate || 0) + '%');
        setTextSafe('rep-winrate-detail', `${scorecard.totalGanhos || 0}/${(scorecard.totalGanhos || 0) + (scorecard.totalPerdas || 0)} deals ganhos`);
        setTextSafe('rep-wins', scorecard.totalGanhos || 0);
        setTextSafe('rep-wins-detail', formatMoney(scorecard.netGerado || 0)); // âœ… USA NET
        setTextSafe('rep-losses', scorecard.totalPerdas || 0);
        setTextSafe('rep-losses-detail', `${(scorecard.totalGanhos || 0) + (scorecard.totalPerdas || 0)} deals total`);
        setTextSafe('rep-revenue', formatMoney(scorecard.netGerado || 0)); // âœ… USA NET
        setTextSafe('rep-revenue-detail', `${scorecard.totalGanhos || 0} deals fechados`);
        setTextSafe('rep-cycle-win', (scorecard.cicloMedioWin || 0) + 'd');
        setTextSafe('rep-cycle-loss', (scorecard.cicloMedioLoss || 0) + 'd');
        setTextSafe('rep-avg-ticket', formatMoney(scorecard.ticketMedio || 0));
        setTextSafe('rep-ticket-detail', 'mÃ©dia por deal');
        
        // Pipeline - busca do window.DATA (nÃ£o tem no scorecard)
        const pipeline = window.DATA?.pipeline || [];
        const pipelineDeals = pipeline.filter(d => d.Vendedor === sellerName);
        const pipelineValue = pipelineDeals.reduce((sum, d) => sum + (parseFloat(d.Net) || 0), 0); // âœ… USA NET
        setTextSafe('rep-pipeline', formatMoney(pipelineValue));
        setTextSafe('rep-pipeline-detail', `${pipelineDeals.length} deals ativos`);
        
        // Aplica cores ao Win Rate
        const wrElement = document.getElementById('rep-winrate');
        const winRate = perf.winRate || 0;
        if (winRate >= 30) wrElement.className = 'kpi-value val-green';
        else if (winRate >= 15) wrElement.className = 'kpi-value val-warning';
        else wrElement.className = 'kpi-value val-red';
        
        // ============================================================================
        // DIAGNÃ“STICO COMPORTAMENTAL
        // ============================================================================
        setTextSafe('rep-win-factor', comportamento.principalFatorSucesso || 'Dados insuficientes');
        setTextSafe('rep-loss-cause', comportamento.principalCausaPerda || 'Dados insuficientes');
        
        // RecomendaÃ§Ãµes baseadas em IA
        const recommendations = generateSellerRecommendations(
          winRate, 
          scorecard.cicloMedioWin || 0, 
          scorecard.cicloMedioLoss || 0, 
          pipelineDeals.length,
          scorecard.netGerado || 0 // âœ… USA NET
        );
        document.getElementById('rep-recommendations').innerHTML = recommendations.map((r, i) => 
          `<div style="margin-bottom: 8px; padding-left: 16px; border-left: 3px solid ${i === 0 ? 'var(--primary-cyan)' : 'rgba(255,255,255,0.2)'};">
            ${r}
          </div>`
        ).join('');
        
        // ============================================================================
        // CARREGA EVOLUÃ‡ÃƒO TEMPORAL
        // ============================================================================
        loadSellerTimeline(sellerName);
        
        // ============================================================================
        // CARREGA TOP DEALS
        // ============================================================================
        loadSellerTopDeals(sellerName, year, quarter);
        
        hideLoading();
        
      } catch (error) {
        console.error('[SELLER] Erro ao carregar dados:', error);
        hideLoading();
        detailsDiv.innerHTML = `
          <div class="ai-card" style="text-align: center; padding: 40px;">
            <svg class="icon" style="color: var(--danger); font-size: 48px;"><use href="#icon-alert"/></svg>
            <h4 style="color: var(--danger); margin-top: 16px;">Erro ao carregar dados do vendedor</h4>
            <p style="color: var(--text-gray); margin-top: 8px;">${error.message}</p>
            <button onclick="showRepDetails()" style="
              margin-top: 20px;
              padding: 10px 20px;
              background: var(--primary-cyan);
              color: var(--bg-primary);
              border: none;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
            ">Tentar Novamente</button>
          </div>
        `;
      }
    }
    
    // ============================================================================
    // EVOLUÃ‡ÃƒO TEMPORAL DO VENDEDOR
    // ============================================================================
    async function loadSellerTimeline(sellerName) {
      const container = document.getElementById('rep-timeline');
      container.innerHTML = '<div class="loading" style="text-align: center; padding: 20px;"><svg class="icon"><use href="#icon-chart"/></svg> Carregando evoluÃ§Ã£o temporal...</div>';
      
      try {
        const response = await fetch(
          `${window.API_BASE_URL}/api/seller-timeline/${encodeURIComponent(sellerName)}?quarters=4`
        );
        
        if (!response.ok) {
          throw new Error('Erro ao buscar timeline');
        }
        
        const data = await response.json();
        
        if (!data.success || !data.timeline || data.timeline.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 20px;">HistÃ³rico insuficiente para anÃ¡lise temporal</p>';
          return;
        }
        
        const timeline = data.timeline;
        const mediaTime = data.media_time || {};
        
        // Encontra melhor e pior quarter
        const ipvs = timeline.map(t => t.ipv);
        const maxIPV = Math.max(...ipvs);
        const minIPV = Math.min(...ipvs);
        const bestQuarter = timeline.find(t => t.ipv === maxIPV);
        const worstQuarter = timeline.find(t => t.ipv === minIPV);
        
        // Renderiza timeline
        let html = '<div style="display: grid; gap: 16px;">';
        
        // Header com resumo
        html += `
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px;">
            <div>
              <div style="font-size: 11px; color: var(--text-gray); margin-bottom: 4px;">MÃ©dia do PerÃ­odo</div>
              <div style="font-size: 20px; font-weight: 700; color: var(--primary-cyan);">${mediaTime.ipv || 0}</div>
            </div>
            <div>
              <div style="font-size: 11px; color: var(--text-gray); margin-bottom: 4px;">Melhor Quarter</div>
              <div style="font-size: 16px; font-weight: 700; color: var(--success);">${bestQuarter.quarter}: ${bestQuarter.ipv}</div>
            </div>
            <div>
              <div style="font-size: 11px; color: var(--text-gray); margin-bottom: 4px;">Pior Quarter</div>
              <div style="font-size: 16px; font-weight: 700; color: var(--danger);">${worstQuarter.quarter}: ${worstQuarter.ipv}</div>
            </div>
          </div>
        `;
        
        // Timeline visual
        html += '<div style="display: grid; gap: 12px;">';
        timeline.reverse().forEach(t => {
          const ipvColor = t.ipv >= 50 ? 'var(--success)' : t.ipv >= 30 ? 'var(--warning)' : 'var(--danger)';
          const isBest = t.ipv === maxIPV;
          const isWorst = t.ipv === minIPV;
          
          html += `
            <div style="padding: 12px 16px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid ${ipvColor}; ${isBest ? 'box-shadow: 0 0 12px rgba(0,255,150,0.3);' : isWorst ? 'box-shadow: 0 0 12px rgba(255,80,80,0.3);' : ''}">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: 700; color: ${ipvColor};">
                    ${t.quarter} ${isBest ? 'ðŸ†' : isWorst ? 'âš ï¸' : ''}
                  </div>
                  <div style="font-size: 11px; color: var(--text-gray); margin-top: 4px;">
                    Resultado: ${t.resultado || 0} | EficiÃªncia: ${t.eficiencia || 0} | Comportamento: ${t.comportamento || 0}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 24px; font-weight: 900; color: ${ipvColor};">${t.ipv}</div>
                  <div style="font-size: 11px; color: var(--text-gray);">${formatMoney(t.netGerado || 0)}</div>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div></div>';
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('[TIMELINE] Erro:', error);
        container.innerHTML = `<p style="text-align: center; color: var(--danger); padding: 20px;"><svg class="icon"><use href="#icon-alert"/></svg> Erro ao carregar evoluÃ§Ã£o temporal</p>`;
      }
    }
    
    // ============================================================================
    // TOP DEALS DO VENDEDOR
    // ============================================================================
    async function loadSellerTopDeals(sellerName, year, quarter) {
      const container = document.getElementById('rep-top-deals');
      container.innerHTML = '<div class="loading" style="text-align: center; padding: 20px;"><svg class="icon"><use href="#icon-briefcase"/></svg> Carregando top deals...</div>';
      
      try {
        // Monta query string (year e quarter podem ser null)
        let queryParams = ['top_n=5'];
        if (year) queryParams.push(`year=${year}`);
        if (quarter) queryParams.push(`quarter=${quarter}`);
        const queryString = '?' + queryParams.join('&');
        
        const response = await fetch(
          `${window.API_BASE_URL}/api/seller-deals/${encodeURIComponent(sellerName)}${queryString}`
        );
        
        if (!response.ok) {
          throw new Error('Erro ao buscar deals');
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error('Resposta invÃ¡lida da API');
        }
        
        const topWins = data.top_wins || [];
        const topLosses = data.top_losses || [];
        const pipelineHot = data.pipeline_hot || [];
        
        let html = '<div style="display: grid; gap: 20px;">';
        
        // TOP WINS
        html += `
          <div>
            <h5 style="margin: 0 0 12px 0; color: var(--success); font-size: 14px;">
              <svg class="icon"><use href="#icon-check"/></svg> Top 5 Deals Ganhos (por NET)
            </h5>
            <div style="display: grid; gap: 8px;">
        `;
        
        if (topWins.length === 0) {
          html += '<p style="color: var(--text-gray); font-size: 13px;">Nenhum deal ganho no perÃ­odo</p>';
        } else {
          topWins.forEach((deal, i) => {
            html += `
              <div style="display: flex; justify-content: space-between; padding: 10px 16px; background: rgba(0,255,150,0.05); border-radius: 8px; border-left: 3px solid var(--success);">
                <div>
                  <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">${i + 1}. ${deal.nome || 'Deal sem nome'}</div>
                  <div style="font-size: 11px; color: var(--text-gray); margin-top: 2px;">
                    ${deal.ciclo_dias || 0} dias | ${deal.motivo || 'Sem motivo'}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 14px; font-weight: 700; color: var(--success);">${formatMoney(deal.net || 0)}</div>
                  <div style="font-size: 10px; color: var(--text-gray);">NET</div>
                </div>
              </div>
            `;
          });
        }
        
        html += '</div></div>';
        
        // TOP LOSSES
        html += `
          <div>
            <h5 style="margin: 0 0 12px 0; color: var(--danger); font-size: 14px;">
              <svg class="icon"><use href="#icon-x"/></svg> Top 5 Deals Perdidos (por valor potencial)
            </h5>
            <div style="display: grid; gap: 8px;">
        `;
        
        if (topLosses.length === 0) {
          html += '<p style="color: var(--text-gray); font-size: 13px;">Nenhum deal perdido no perÃ­odo</p>';
        } else {
          topLosses.forEach((deal, i) => {
            html += `
              <div style="display: flex; justify-content: space-between; padding: 10px 16px; background: rgba(255,80,80,0.05); border-radius: 8px; border-left: 3px solid var(--danger);">
                <div>
                  <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">
                    ${i + 1}. ${deal.nome || 'Deal sem nome'}
                    ${deal.evitavel === 'Sim' ? '<span style="margin-left: 6px; padding: 2px 6px; background: rgba(255,180,0,0.2); border-radius: 4px; font-size: 10px; color: var(--warning);">EVITÃVEL</span>' : ''}
                  </div>
                  <div style="font-size: 11px; color: var(--text-gray); margin-top: 2px;">
                    ${deal.ciclo_dias || 0} dias | ${deal.motivo || 'Sem motivo'}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 14px; font-weight: 700; color: var(--danger);">${formatMoney(deal.gross_potencial || 0)}</div>
                  <div style="font-size: 10px; color: var(--text-gray);">POTENCIAL</div>
                </div>
              </div>
            `;
          });
        }
        
        html += '</div></div>';
        
        // PIPELINE HOT
        html += `
          <div>
            <h5 style="margin: 0 0 12px 0; color: var(--primary-cyan); font-size: 14px;">
              <svg class="icon"><use href="#icon-fire"/></svg> Pipeline Hot (NET Ã— ConfianÃ§a)
            </h5>
            <div style="display: grid; gap: 8px;">
        `;
        
        if (pipelineHot.length === 0) {
          html += '<p style="color: var(--text-gray); font-size: 13px;">Nenhum deal quente no pipeline</p>';
        } else {
          pipelineHot.forEach((deal, i) => {
            html += `
              <div style="display: flex; justify-content: space-between; padding: 10px 16px; background: rgba(0,190,255,0.05); border-radius: 8px; border-left: 3px solid var(--primary-cyan);">
                <div>
                  <div style="font-size: 13px; font-weight: 600; color: var(--text-main);">${i + 1}. ${deal.nome || 'Deal sem nome'}</div>
                  <div style="font-size: 11px; color: var(--text-gray); margin-top: 2px;">
                    ${deal.stage || 'Stage?'} | ${deal.confianca || 0}% confianÃ§a
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 14px; font-weight: 700; color: var(--primary-cyan);">${formatMoney(deal.expected_value || 0)}</div>
                  <div style="font-size: 10px; color: var(--text-gray);">EXPECTED</div>
                </div>
              </div>
            `;
          });
        }
        
        html += '</div></div></div>';
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('[TOP DEALS] Erro:', error);
        container.innerHTML = `<p style="text-align: center; color: var(--danger); padding: 20px;"><svg class="icon"><use href="#icon-alert"/></svg> Erro ao carregar top deals</p>`;
      }
    }
    
    // Atualiza function generateSellerRecommendations para aceitar NET
    function generateSellerRecommendations(winRate, cycleWin, cycleLoss, pipelineCount, netGerado = 0) {
      const recommendations = [];
      
      // Alerta de NET negativo (NET gate)
      if (netGerado <= 0) {
        recommendations.push('<svg class="icon" style="color:var(--danger)"><use href="#icon-alert"/></svg> <strong>NET Negativo Detectado:</strong> Priorize deals com rentabilidade positiva. IPV limitado a 20 atÃ© reverter situaÃ§Ã£o.');
      }
      
      if (winRate < 15) {
        recommendations.push('<svg class="icon"><use href="#icon-target"/></svg> <strong>Win Rate CrÃ­tico:</strong> Revisar qualificaÃ§Ã£o de leads (MEDDIC) e focar em deals com maior fit');
      } else if (winRate < 30) {
        recommendations.push('<svg class="icon"><use href="#icon-alert"/></svg> <strong>Win Rate Abaixo da Meta:</strong> Implementar follow-ups estruturados e revisÃ£o de proposta com gestÃ£o');
      } else {
        recommendations.push('<svg class="icon"><use href="#icon-check"/></svg> <strong>Win Rate SaudÃ¡vel:</strong> Manter cadÃªncia atual e focar em aumentar ticket mÃ©dio');
      }
      
      if (cycleWin > 60) {
        recommendations.push('â±ï¸ <strong>Ciclo de Venda Longo:</strong> Acelerar negociaÃ§Ã£o com POC rÃ¡pido e envolvimento de champions');
      } else if (cycleWin > 30) {
        recommendations.push('<svg class="icon"><use href="#icon-trending-up"/></svg> <strong>Ciclo Moderado:</strong> Otimizar reuniÃµes de discovery e reduzir tempo de resposta');
      }
      
      if (pipelineCount < 5) {
        recommendations.push('<svg class="icon"><use href="#icon-chart"/></svg> <strong>Pipeline Baixo:</strong> Intensificar prospecÃ§Ã£o e qualificaÃ§Ã£o de novos leads');
      } else if (pipelineCount > 15) {
        recommendations.push('<svg class="icon"><use href="#icon-target"/></svg> <strong>Pipeline Saturado:</strong> Priorizar top deals e desqualificar oportunidades de baixa probabilidade');
      }
      
      if (cycleLoss > cycleWin * 3) {
        recommendations.push('<svg class="icon" style="color:var(--error)"><use href="#icon-alert"/></svg> <strong>DesqualificaÃ§Ã£o Tardia:</strong> Aplicar MEDDIC nas primeiras reuniÃµes para evitar desgaste em deals sem fit');
      }
      
      return recommendations;
    }
    
    // FunÃ§Ã£o auxiliar para encontrar o item mais frequente
    function getMostFrequent(arr) {
      if (!arr || arr.length === 0) return null;
      const frequency = {};
      arr.forEach(item => {
        frequency[item] = (frequency[item] || 0) + 1;
      });
      return Object.keys(frequency).reduce((a, b) => frequency[a] > frequency[b] ? a : b);
    }
    
    // Carrega comparaÃ§Ã£o entre todos os vendedores
    function loadSellersComparison() {
      log('[SELLERS] Carregando comparaÃ§Ã£o...');
      
      const detailsDiv = document.getElementById('rep-details');
      const comparisonDiv = document.getElementById('sellers-comparison');
      
      // Esconde detalhes individuais
      detailsDiv.style.display = 'none';
      comparisonDiv.style.display = 'block';
      
      // Reseta seletor
      document.getElementById('rep-selector').value = '';
      
      const closedWon = window.DATA?.closed_won || [];
      const closedLost = window.DATA?.closed_lost || [];
      
      // Agrupa por vendedor
      const sellersMap = {};
      
      [...closedWon, ...closedLost].forEach(deal => {
        const seller = deal.Vendedor;
        if (!seller) return;
        
        if (!sellersMap[seller]) {
          sellersMap[seller] = { wins: 0, losses: 0, revenue: 0, cycleWinSum: 0, cycleLossSum: 0 };
        }
        
        if (closedWon.includes(deal)) {
          sellersMap[seller].wins++;
          sellersMap[seller].revenue += parseFloat(deal.Net) || 0; // âœ… USA NET
          sellersMap[seller].cycleWinSum += parseInt(deal.Ciclo_dias) || 0;
        } else {
          sellersMap[seller].losses++;
          sellersMap[seller].cycleLossSum += parseInt(deal.Ciclo_dias) || 0;
        }
      });
      
      // Calcula mÃ©tricas finais
      const sellersArray = Object.keys(sellersMap).map(name => {
        const data = sellersMap[name];
        const total = data.wins + data.losses;
        const winRate = total > 0 ? Math.round((data.wins / total) * 100) : 0;
        const avgCycleWin = data.wins > 0 ? Math.round(data.cycleWinSum / data.wins) : 0;
        const avgTicket = data.wins > 0 ? data.revenue / data.wins : 0;
        
        return { name, ...data, total, winRate, avgCycleWin, avgTicket };
      });
      
      // Grid de cards
      const gridHtml = sellersArray.map(seller => {
        const wrClass = seller.winRate >= 30 ? 'val-green' : seller.winRate >= 15 ? 'val-warning' : 'val-red';
        
        return `<div class="kpi-card">
          <div style="font-size: 14px; font-weight: 700; color: var(--primary-cyan); margin-bottom: 12px;">${seller.name}</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
            <div><span style="color: var(--text-gray);">Win Rate:</span> <strong class="${wrClass}">${seller.winRate}%</strong></div>
            <div><span style="color: var(--text-gray);">Revenue:</span> <strong class="val-cyan">${formatMoney(seller.revenue)}</strong></div>
            <div><span style="color: var(--text-gray);">Ganhos:</span> <strong class="val-green">${seller.wins}</strong></div>
            <div><span style="color: var(--text-gray);">Ciclo:</span> <strong>${seller.avgCycleWin}d</strong></div>
          </div>
        </div>`;
      }).join('');
      
      document.getElementById('sellers-grid').innerHTML = gridHtml;
      
      // Rankings
      const byWinRate = [...sellersArray].sort((a, b) => b.winRate - a.winRate);
      const byRevenue = [...sellersArray].sort((a, b) => b.revenue - a.revenue);
      
      const rankingWRHtml = byWinRate.map((s, i) => {
        const wrClass = s.winRate >= 30 ? 'val-green' : s.winRate >= 15 ? 'val-warning' : 'val-red';
        return `<div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
          <span><strong style="color: var(--primary-cyan);">#${i + 1}</strong> ${s.name}</span>
          <span class="${wrClass}" style="font-weight: 700;">${s.winRate}%</span>
        </div>`;
      }).join('');
      
      const rankingRevHtml = byRevenue.map((s, i) => {
        return `<div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
          <span><strong style="color: var(--success);">#${i + 1}</strong> ${s.name}</span>
          <span class="val-cyan" style="font-weight: 700;">${formatMoney(s.revenue)}</span>
        </div>`;
      }).join('');
      
      document.getElementById('ranking-winrate').innerHTML = rankingWRHtml;
      document.getElementById('ranking-revenue').innerHTML = rankingRevHtml;
      
      log('[SELLERS] <svg class="icon"><use href="#icon-check"/></svg> ComparaÃ§Ã£o carregada:', sellersArray.length, 'vendedores');
    }
    
    // ============================================================================
    // PAUTA SEMANAL - FUNÃ‡Ã•ES (ATUALIZADO PARA USAR API COM RAG)
    // ============================================================================
    
    // Carrega agenda semanal usando nova API /api/weekly-agenda
    async function loadWeeklyAgenda(period = 'all') {
      log('[AGENDA INLINE] Carregando pauta semanal via API (fallback)...');
      showLoading('Carregando pauta semanal com IA');
      
      const container = document.getElementById('agenda-sellers-container');
      if (!container) {
        console.error('[AGENDA] Elemento agenda-sellers-container nÃ£o encontrado no DOM');
        hideLoading();
        return;
      }
      
      try {
        // Use NEW API format with quarter and dates
        const currentFilters = window.currentFilters || {};
        let year = currentFilters.year || new Date().getFullYear();
        let quarter = currentFilters.quarter || 'Q1';

        const params = new URLSearchParams();
        params.append('quarter', `FY${String(year).slice(-2)}-${quarter}`);

        if (currentFilters.seller) {
          params.append('seller', currentFilters.seller);
        }
        if (currentFilters.date_start) {
          params.append('start_date', currentFilters.date_start);
        }
        if (currentFilters.date_end) {
          params.append('end_date', currentFilters.date_end);
        }

        const url = `${window.API_BASE_URL}/api/weekly-agenda?${params.toString()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error('Erro ao buscar pauta semanal');
        }
        
        const data = await response.json();
        
        // NEW FORMAT: data.sellers instead of data.deals
        if (!data.success || !data.sellers || data.sellers.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">Nenhum deal encontrado para este quarter/vendedor</p>';
          hideLoading();
          return;
        }
        
        const sellers = data.sellers;
        const summary = data.summary || {};
        
        // Simple rendering for fallback
        let html = '<div style="color: var(--text-gray); font-size: 14px; margin-bottom: 20px;">';
        html += `<strong>Pauta Semanal:</strong> ${summary.total_sellers || 0} vendedores, ${summary.total_deals || 0} deals</div>`;
        
        sellers.forEach((seller, idx) => {
          const sellerSummary = seller.summary || {};
          html += `
            <div style="margin-bottom: 24px; padding: 20px; background: var(--glass-surface); border-radius: 16px; border: 1px solid var(--glass-border);">
              <h4 style="margin: 0 0 12px 0; color: var(--primary-cyan); font-size: 16px;">
                ${seller.vendedor || 'Vendedor'}
              </h4>
              <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 12px;">
                <strong>${sellerSummary.total_deals || 0}</strong> deals â€¢ 
                R$ ${Math.round(sellerSummary.total_gross_k || 0)}K
              </div>
            </div>
          `;
        });
        
        const finalContainer = document.getElementById('agenda-sellers-container');
        if (finalContainer) {
          finalContainer.innerHTML = html;
          log('[AGENDA INLINE] âœ“ Pauta carregada (fallback):', sellers.length, 'vendedores');
        }
        
        hideLoading();
        
      } catch (error) {
        console.error('[AGENDA] Erro:', error);
        const errorContainer = document.getElementById('agenda-sellers-container');
        if (errorContainer) {
          errorContainer.innerHTML = `<div class="ai-card" style="border-left: 3px solid var(--danger);"><strong>Erro ao carregar pauta:</strong> ${error.message}</div>`;
        }
        hideLoading();
      }
    }


    function renderSellerDeals(deals) {
      return deals.map(deal => {
        const confidence = parseFloat(deal.Confianca ?? deal.confidence ?? 0) || 0;
        const value = parseFloat(deal.Gross ?? deal.gross ?? 0) || 0;
        const stage = deal.Fase || deal.Stage || deal.Estagio || 'N/A';
        const forecast = deal.Forecast || deal.Previsao || deal.Forecast_Category || 'N/A';
        const quarter = deal.Fiscal_Q || deal.Quarter || 'N/A';

        // Define badge por confianÃ§a
        let badgeClass = 'badge-warning';
        let urgencyLabel = 'MÃ‰DIA';
        if (confidence >= 70) {
          badgeClass = 'badge-danger';
          urgencyLabel = 'CRÃTICA';
        } else if (confidence < 50) {
          badgeClass = 'badge-success';
          urgencyLabel = 'BAIXA';
        }

        // Calcula dias idle (se disponÃ­vel)
        const daysIdle = parseInt(deal.Dias_Idle) || 0;
        const idleBadge = daysIdle > 14 ? `<span class="badge badge-danger">${daysIdle}d idle <svg class="icon" style="color:var(--error)"><use href="#icon-alert"/></svg></span>` : '';

        return `
          <div style="padding: 12px; background: rgba(255,255,255,0.03); border-left: 3px solid ${confidence >= 70 ? 'var(--danger)' : confidence >= 50 ? 'var(--warning)' : 'var(--primary-cyan)'}; border-radius: 8px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 14px; color: var(--text-main); margin-bottom: 4px;">
                  ${deal.Oportunidade || 'Sem nome'}
                </div>
                <div style="font-size: 12px; color: var(--text-gray);">
                  <strong>Stage:</strong> ${stage} | <strong>Forecast:</strong> ${forecast} | ${quarter}
                </div>
              </div>
              <div style="text-align: right;">
                <div class="val-cyan" style="font-weight: 700; font-size: 14px;">${formatMoney(value)}</div>
                <div style="font-size: 11px; color: var(--text-gray); margin-top: 2px;">${confidence}% confianÃ§a</div>
              </div>
            </div>

            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <span class="badge ${badgeClass}">${urgencyLabel}</span>
              ${idleBadge}
              <span style="font-size: 11px; color: var(--text-gray);">
                ${deal.Conta || 'Conta nÃ£o informada'}
              </span>
            </div>

            ${daysIdle > 14 ? `<div style="margin-top: 8px; padding: 8px; background: rgba(225,72,73,0.1); border-radius: 6px; font-size: 11px; color: var(--danger);">
              <svg class="icon"><use href="#icon-alert"/></svg> <strong>AÃ§Ã£o requerida:</strong> Deal inativo hÃ¡ ${daysIdle} dias - agendar follow-up urgente
            </div>` : ''}
          </div>
        `;
      }).join('');
    }
    // Gera alertas e recomendaÃ§Ãµes (ATUALIZADO)
    function generateAgendaAlerts(criticalDeals, highPriorityDeals, zombieDeals) {
      const alerts = [];
      
      // Analisa deals crÃ­ticos
      if (criticalDeals.length > 0) {
        const criticalValue = criticalDeals.reduce((sum, d) => sum + (parseFloat(d.Gross) || 0), 0);
        alerts.push({
          type: 'danger',
          icon: '<svg class="icon" style="color:var(--error)"><use href="#icon-alert"/></svg>',
          title: 'Deals CrÃ­ticos Requerem AtenÃ§Ã£o',
          message: `${criticalDeals.length} deals com â‰¥70% confianÃ§a (${formatMoney(criticalValue)}) precisam de follow-up imediato para nÃ£o perder momentum.`
        });
      }
      
      // Deals idle
      const idleDeals = [...criticalDeals, ...highPriorityDeals].filter(d => parseInt(d.Dias_Idle) > 14);
      if (idleDeals.length > 0) {
        const idleValue = idleDeals.reduce((sum, d) => sum + (parseFloat(d.Gross) || 0), 0);
        alerts.push({
          type: 'warning',
          icon: '<svg class="icon"><use href="#icon-clock"/></svg>',
          title: 'Deals Inativos Identificados',
          message: `${idleDeals.length} deals parados hÃ¡ mais de 14 dias (${formatMoney(idleValue)}). Reativar com urgÃªncia.`
        });
      }
      
      // Analisa pipeline por vendedor
      const sellerPipeline = {};
      [...criticalDeals, ...highPriorityDeals].forEach(d => {
        const seller = d.Vendedor || 'Sem Vendedor';
        if (!sellerPipeline[seller]) sellerPipeline[seller] = { count: 0, value: 0 };
        sellerPipeline[seller].count++;
        sellerPipeline[seller].value += parseFloat(d.Gross) || 0;
      });
      
      // Identifica vendedor com mais oportunidades
      const topSeller = Object.keys(sellerPipeline).reduce((a, b) => 
        sellerPipeline[a].count > sellerPipeline[b].count ? a : b, ''
      );
      
      if (topSeller && sellerPipeline[topSeller].count >= 5) {
        alerts.push({
          type: 'info',
          icon: '<svg class="icon"><use href="#icon-user"/></svg>',
          title: 'Vendedor com Alta Carga',
          message: `${topSeller} possui ${sellerPipeline[topSeller].count} deals prioritÃ¡rios (${formatMoney(sellerPipeline[topSeller].value)}). Considerar redistribuiÃ§Ã£o ou suporte adicional.`
        });
      }
      
      // RecomendaÃ§Ãµes gerais
      alerts.push({
        type: 'success',
        icon: '<svg class="icon"><use href="#icon-idea"/></svg>',
        title: 'RecomendaÃ§Ã£o: CadÃªncia de Follow-ups',
        message: 'Estabelecer check-ins diÃ¡rios para deals â‰¥70% e semanais para 40-69%. Usar templates de email para agilizar comunicaÃ§Ã£o.'
      });
      
      // Renderiza alertas
      const html = alerts.map(alert => {
        const bgColor = {
          'danger': 'rgba(225,72,73,0.1)',
          'warning': 'rgba(255,165,0,0.1)',
          'info': 'rgba(0,190,255,0.1)',
          'success': 'rgba(192,255,125,0.1)'
        }[alert.type];
        
        const borderColor = {
          'danger': 'var(--danger)',
          'warning': 'var(--warning)',
          'info': 'var(--primary-cyan)',
          'success': 'var(--accent-green)'
        }[alert.type];
        
        return `
          <div style="padding: 16px; margin-bottom: 12px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px;">
            <div style="font-weight: 700; font-size: 14px; margin-bottom: 6px; color: var(--text-main);">
              ${alert.icon} ${alert.title}
            </div>
            <div style="font-size: 13px; color: var(--text-gray); line-height: 1.6;">
              ${alert.message}
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('agenda-alerts').innerHTML = html;
    }
    
    // ============================================================================
    // NOVA FUNÃ‡ÃƒO: Carrega War Room (ApresentaÃ§Ã£o Executiva)
    // ============================================================================
    async function loadWarRoom() {
      // War Room endpoint foi removido do backend (war_room.py excluÃ­do).
      // Mantemos a seÃ§Ã£o no front, mas sem chamar /api/war-room.
      log('[WAR-ROOM] War Room desativado (endpoint removido).');
      try {
        setTextSafe('war-forecast-total', 'â€”');
        setTextSafe('war-closed-total', 'â€”');
        setTextSafe('war-closed-perc', '');
        setTextSafe('war-zumbis-count', 'â€”');
        setTextSafe('war-zumbis-value', '');
        setTextSafe('war-confianca-avg', 'â€”');
        setHtmlSafe('war-ai-attention', '<p style="color: var(--text-gray);">War Room desativado</p>');
        setHtmlSafe('war-ai-wins', '<p style="color: var(--text-gray);">War Room desativado</p>');
        setHtmlSafe('war-ai-actions', '<p style="color: var(--text-gray);">War Room desativado</p>');
        document.querySelector('#warroom-sellers-table tbody').innerHTML =
          '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-gray);">War Room desativado</td></tr>';
        document.querySelector('#warroom-deals-table tbody').innerHTML =
          '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-gray);">War Room desativado</td></tr>';
      } catch (e) {
        // Non-blocking
      }
      showToast('War Room foi desativado. Use a aba Pauta Semanal.', 'info');
      return;
    }
    
    // ============================================================================
    // FUNÃ‡ÃƒO: Exporta War Room para CSV
    // ============================================================================
    function exportWarRoomCSV() {
      log('[WAR-ROOM] Export War Room desativado.');
      showToast('Export do War Room foi desativado.', 'info');
    }
    
    
    // ============================================================================
    // NOVA FUNÃ‡ÃƒO: Popula KPIs estÃ¡ticos da aba <svg class="icon"><use href="#icon-chart"/></svg> Dashboard_Metrics
    // ============================================================================
    function populateStaticKPIs(metrics) {
      if (!metrics) {
        log('[STATIC] <svg class="icon"><use href="#icon-alert"/></svg> Nenhuma mÃ©trica estÃ¡tica disponÃ­vel');
        return;
      }
      
      log('[STATIC] Populando KPIs estÃ¡ticos...');
      
      try {
        // Pipeline Total (TODOS OS ANOS) - NÃ£o muda com filtros
        setTextSafe('exec-pipeline-year-total', formatMoney(metrics.allPipelineGross));
        setTextSafe('exec-pipeline-year-deals', metrics.allPipelineDeals + ' deals abertos');
        setTextSafe('exec-pipeline-year-net', 'Net: ' + formatMoney(metrics.allPipelineNet));
        
        // Pipeline (PerÃ­odo Filtrado) - Inicia com todos os anos
        setTextSafe('exec-pipeline-total', formatMoney(metrics.allPipelineGross));
        setTextSafe('exec-pipeline-deals', metrics.allPipelineDeals + ' deals abertos');
        setTextSafe('exec-pipeline-net', 'Net: ' + formatMoney(metrics.allPipelineNet));
        
        // Sales Specialist
        setTextSafe('exec-pipeline-specialist-total', formatMoney(metrics.salesSpecGross));
        setTextSafe('exec-pipeline-specialist-deals', metrics.salesSpecDeals + ' deals curados');
        setTextSafe('exec-pipeline-specialist-net', 'Net: ' + formatMoney(metrics.salesSpecNet));
        
        // Vendedores Ativos
        setTextSafe('exec-active-reps', metrics.activeRepsCount);
        
        // Deals >= 50% ConfianÃ§a
        setTextSafe('exec-above50-value', formatMoney(metrics.highConfGross));
        setTextSafe('exec-above50-count', metrics.highConfDeals + ' deals');
        setTextSafe('exec-above50-net', 'Net: ' + formatMoney(metrics.highConfNet));
        
        // ConfianÃ§a MÃ©dia
        const avgConfPercent = Math.round(metrics.avgConfidence);
        setTextSafe('exec-forecast-percent', avgConfPercent + '% confianÃ§a mÃ©dia');
        
        // Calcula PrevisÃ£o Ponderada (Pipeline Total Ã— ConfianÃ§a MÃ©dia)
        const forecastWeighted = metrics.allPipelineGross * (metrics.avgConfidence / 100);
        setTextSafe('exec-forecast-weighted', formatMoney(forecastWeighted));
        const forecastNetWeighted = metrics.allPipelineNet * (metrics.avgConfidence / 100);
        setTextSafe('exec-forecast-net', 'Net: ' + formatMoney(forecastNetWeighted));
        
        log('[STATIC] <svg class="icon"><use href="#icon-check"/></svg> KPIs estÃ¡ticos populados com sucesso');
        
      } catch (e) {
        log('[STATIC] <svg class="icon"><use href="#icon-x"/></svg> Erro ao popular KPIs estÃ¡ticos:', e.message);
      }
    }

    // ==========================================================================
    // NavegaÃ§Ã£o corrigida com argumentos explÃ­citos
    function showSection(element, sectionId) {
      // Remove active de todas as seÃ§Ãµes e nav items
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      
      // Adiciona active ao elemento clicado e Ã  seÃ§Ã£o correspondente
      const target = document.getElementById(sectionId);
      if (target) target.classList.add('active');
      if (element) element.classList.add('active');
      
      // Atualiza tÃ­tulo
      const titles = { 
        'executive': 'VisÃ£o Executiva',
        'dashboard': 'Indicadores L10', 
        'aprendizados': 'Aprendizados',
        'fsr': 'Performance FSR',
        'individual': 'Por Vendedor', 
        'agenda': 'Pauta Semanal',
        'warroom': 'ðŸŽ¯ War Room - ApresentaÃ§Ã£o Executiva',
        'ml': '<svg class="icon"><use href="#icon-robot"/></svg> InteligÃªncia ML'
      };
      setTextSafe('page-title', titles[sectionId] || 'Dashboard');

      if (sectionId === 'aprendizados') {
        loadAprendizados();
      }
      
      // Se aba ML for ativada, carrega prediÃ§Ãµes automaticamente
      if (sectionId === 'ml' && !ML_DATA) {
        loadMLPredictions();
      }
      
      // Se aba Agenda for ativada, carrega pauta automaticamente
      if (sectionId === 'agenda') {
        // Usa nova funÃ§Ã£o do weekly-agenda-new.js se disponÃ­vel
        if (typeof window.loadWeeklyAgenda === 'function') {
          window.loadWeeklyAgenda();
        } else {
          loadWeeklyAgenda('all'); // Fallback para funÃ§Ã£o antiga
        }
      }

      // Se aba War Room for ativada, carrega automaticamente
      if (sectionId === 'warroom') {
        loadWarRoom();
      }

      // Se aba Performance FSR for ativada, carrega dados da API
      if (sectionId === 'fsr') {
        loadPerformanceData();
      }
    }

    // ==========================================================================
    // Aprendizados (inline)
    async function loadAprendizados() {
      const winsEl = document.getElementById('wins-insights-content');
      const lossesEl = document.getElementById('loss-insights-content');
      if (!winsEl || !lossesEl) return;

      winsEl.innerHTML = '<div class="loading"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><use href="#icon-refresh"/></svg>Carregando insights...</div>';
      lossesEl.innerHTML = '<div class="loading"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><use href="#icon-refresh"/></svg>Carregando insights...</div>';

      try {
        const year = document.getElementById('year-filter')?.value || '';
        const quarterRaw = document.getElementById('quarter-filter')?.value || '';
        const quarter = quarterRaw ? quarterRaw.replace('Q', '') : '';
        const month = document.getElementById('month-filter')?.value || '';
        const seller = selectedSellers.length > 0 ? selectedSellers.join(',') : '';

        const params = new URLSearchParams();
        if (year) params.set('year', year);
        if (quarter) params.set('quarter', quarter);
        if (!quarter && month) params.set('month', month);
        if (seller) params.set('seller', seller);

        const [metricsRes, patternsRes] = await Promise.all([
          fetch(`${API_BASE_URL}/api/metrics?${params.toString()}`),
          fetch(`${API_BASE_URL}/api/analyze-patterns?${params.toString()}`)
        ]);

        if (!metricsRes.ok) throw new Error('Erro ao carregar mÃ©tricas');
        if (!patternsRes.ok) throw new Error('Erro ao carregar padrÃµes');

        const metrics = await metricsRes.json();
        const patterns = await patternsRes.json();
        renderAprendizadosFromPatterns(metrics, patterns);
      } catch (error) {
        console.error('Erro ao carregar insights:', error);
        winsEl.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 20px;">Erro ao carregar dados. Por favor, tente novamente.</div>';
        lossesEl.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 20px;">Erro ao carregar dados. Por favor, tente novamente.</div>';
      }
    }

    function renderAprendizadosFromPatterns(metrics, patterns) {
      const wins = patterns?.win_insights || 'Sem insights de vitÃ³rias.';
      const losses = patterns?.loss_insights || 'Sem insights de perdas.';

      const winsEl = document.getElementById('wins-insights-content');
      const lossesEl = document.getElementById('loss-insights-content');
      const recsDiv = document.getElementById('insights-recommendations');

      if (winsEl) {
        winsEl.innerHTML = `<div style="padding: 16px; line-height: 1.8;">${wins.replace(/\n/g, '<br>')}</div>`;
      }
      if (lossesEl) {
        lossesEl.innerHTML = `<div style="padding: 16px; line-height: 1.8;">${losses.replace(/\n/g, '<br>')}</div>`;
      }

      const pipelineStats = metrics?.pipeline_filtered || {};
      const winsStats = metrics?.closed_won || {};
      const lossesStats = metrics?.closed_lost || {};

      setTextSafe('insights-wins-count', `${winsStats.deals_count || 0} deals`);
      setTextSafe('insights-wins-avg', `Ciclo medio ${Math.round(winsStats.avg_cycle_days || 0)}d`);
      setTextSafe('insights-losses-count', `${lossesStats.deals_count || 0} deals`);
      setTextSafe('insights-losses-avg', `Ciclo medio ${Math.round(lossesStats.avg_cycle_days || 0)}d`);
      setTextSafe('insights-pipeline-count', `${pipelineStats.deals_count || 0} deals`);
      setTextSafe('insights-total-count', `Idle medio ${Math.round(pipelineStats.avg_idle_days || 0)}d`);


      if (recsDiv) {
        const recs = patterns?.recommendations || [];
        if (Array.isArray(recs) && recs.length > 0) {
          recsDiv.innerHTML = '';
          recs.forEach((rec, idx) => {
            const item = document.createElement('div');
            item.className = 'deal-card';
            item.innerHTML = `
              <div style="display: flex; gap: 12px; align-items: flex-start;">
                <span class="badge badge-warning" style="font-size: 12px; font-weight: 700;">#${idx + 1}</span>
                <div style="line-height: 1.6;">${rec}</div>
              </div>
            `;
            recsDiv.appendChild(item);
          });
        } else {
          recsDiv.innerHTML = '<div style="color: var(--text-gray); padding: 20px; text-align: center;">Sem recomendaÃ§Ãµes no filtro atual</div>';
        }
      }
    }

    // FunÃ§Ã£o para trocar tabs dentro da VisÃ£o Executiva
    function switchExecTab(tabName) {
      console.log('[TAB] Trocando para tab:', tabName);
      
      // Remove active de todos os botÃµes
      document.querySelectorAll('.exec-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.color = 'var(--text-gray)';
        tab.style.borderBottom = '3px solid transparent';
      });
      
      // Remove active de todos os conteÃºdos
      document.querySelectorAll('.exec-tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
      });
      
      // Adiciona active ao botÃ£o clicado
      const activeTab = document.querySelector(`.exec-tab[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.color = 'var(--primary-cyan)';
        activeTab.style.borderBottom = '3px solid var(--primary-cyan)';
      }
      
      // Adiciona active ao conteÃºdo correspondente
      const activeContent = document.querySelector(`.exec-tab-content[data-content="${tabName}"]`);
      if (activeContent) {
        activeContent.classList.add('active');
        activeContent.style.display = 'block';
      }
    }

    // FunÃ§Ã£o para expandir/colapsar anÃ¡lise de IA
    function toggleAIAnalysis() {
      const analysisContent = document.getElementById('exec-top-opps-ai-analysis');
      const chevron = document.getElementById('ai-analysis-chevron');
      
      if (analysisContent && chevron) {
        if (analysisContent.style.display === 'none') {
          analysisContent.style.display = 'block';
          chevron.style.transform = 'rotate(0deg)';
        } else {
          analysisContent.style.display = 'none';
          chevron.style.transform = 'rotate(-90deg)';
        }
      }
    }

    // FunÃ§Ã£o para expandir/colapsar Analise Estrategica (IA)
    function toggleExecutiveAnalysis() {
      const content = document.getElementById('executive-content');
      const label = document.getElementById('executive-toggle-label');
      const caret = document.getElementById('executive-toggle-caret');

      if (!content || !label || !caret) return;

      const isHidden = content.style.display === 'none';
      content.style.display = isHidden ? 'block' : 'none';
      label.textContent = isHidden ? 'Ocultar' : 'Expandir';
      caret.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
    }
    
    // FunÃ§Ã£o para atualizar mÃ©tricas do Dashboard Executivo usando dados da API /api/metrics
    function updateExecutiveMetricsFromAPI(metrics) {
      if (!metrics) {
        log('[EXEC METRICS] <svg class="icon"><use href="#icon-alert"/></svg> Nenhum dado de metrics disponÃ­vel');
        return;
      }
      
      log('[EXEC METRICS] Atualizando KPIs com dados da API:', metrics);
      log('[DEBUG] ===== updateExecutiveMetricsFromAPI EXECUTANDO =====');
      
      // PIPELINE (PERÃODO FILTRADO)
      if (metrics.pipeline_filtered) {
        const pipelineGross = metrics.pipeline_filtered.gross;
        const pipelineNet = metrics.pipeline_filtered.net;
        const pipelineCount = metrics.pipeline_filtered.deals_count;
        
        log('[DEBUG] pipeline_filtered valores:', {
          gross: formatMoney(pipelineGross),
          net: formatMoney(pipelineNet),
          deals: pipelineCount
        });
        
        if (pipelineGross !== null && pipelineGross !== undefined) {
          setTextSafe('exec-pipeline-total', formatMoney(pipelineGross));
          setTextSafe('exec-pipeline-deals', pipelineCount + ' deals no perÃ­odo');
          setTextSafe('exec-pipeline-net', 'Net: ' + formatMoney(pipelineNet));
          log('[PIPELINE FILTERED] <svg class="icon"><use href="#icon-check"/></svg> Card ATUALIZADO da API:', formatMoney(pipelineGross), pipelineCount, 'deals');
        } else {
          log('[PIPELINE FILTERED] <svg class="icon"><use href="#icon-alert"/></svg> pipeline_filtered.gross Ã© null/undefined');
        }
      } else {
        log('[PIPELINE FILTERED] <svg class="icon"><use href="#icon-alert"/></svg> metrics.pipeline_filtered NÃƒO existe');
      }
      
      // PREVISÃƒO PONDERADA IA
      if (metrics.pipeline_filtered) {
        const pipelineGross = metrics.pipeline_filtered.gross || 0;
        const avgConf = metrics.pipeline_filtered.avg_meddic || 0; // Usar avg_meddic como proxy de confianÃ§a
        const forecastWeighted = pipelineGross * (avgConf / 100);
        const forecastNet = (metrics.pipeline_filtered.net || 0) * (avgConf / 100);
        
        setTextSafe('exec-forecast-total', formatMoney(forecastWeighted));
        setTextSafe('exec-forecast-avg', Math.round(avgConf) + '% confianÃ§a mÃ©dia');
        setTextSafe('exec-forecast-net', 'Net: ' + formatMoney(forecastNet));
        log('[FORECAST WEIGHTED] <svg class="icon"><use href="#icon-check"/></svg> Atualizado da API:', formatMoney(forecastWeighted));
      }
      
      // DEALS â‰¥50% CONFIANÃ‡A IA
      if (metrics.high_confidence) {
        const highConfGross = metrics.high_confidence.gross;
        const highConfNet = metrics.high_confidence.net;
        const highConfCount = metrics.high_confidence.deals_count;
        const highConfAvg = metrics.high_confidence.avg_confidence || 0;
        
        if (highConfGross !== null && highConfGross !== undefined) {
          setTextSafe('exec-above50-total', formatMoney(highConfGross));
          setTextSafe('exec-above50-deals', highConfCount + ' deals');
          setTextSafe('exec-above50-net', 'Net: ' + formatMoney(highConfNet));
          log('[HIGH CONFIDENCE] <svg class="icon"><use href="#icon-check"/></svg> Atualizado da API:', formatMoney(highConfGross), highConfCount, 'deals');
        }
      }
      
      // IDLE DAYS (do pipeline)
      if (metrics.pipeline_filtered) {
        const avgIdleDays = metrics.pipeline_filtered.avg_idle_days;
        const highRiskCount = metrics.pipeline_filtered.high_risk_idle || 0;
        const mediumRiskCount = metrics.pipeline_filtered.medium_risk_idle || 0;
        const dealsCount = metrics.pipeline_filtered.deals_count || 0;
        
        if (avgIdleDays !== null && avgIdleDays !== undefined) {
          setTextSafe('exec-idle-days-avg', Math.round(avgIdleDays));
          setTextSafe('exec-idle-days-detail', `${Math.round(avgIdleDays)} dias sem atividade`);
          
          // Montar label de risco
          let riskLabel = '';
          if (highRiskCount > 0) {
            riskLabel = `ðŸ”´ ${highRiskCount} em alto risco (>30d)`;
          } else if (mediumRiskCount > 0) {
            riskLabel = `ðŸŸ¡ ${mediumRiskCount} em mÃ©dio risco (15-30d)`;
          } else {
            riskLabel = `ðŸŸ¢ ${dealsCount} deals ativos`;
          }
          setTextSafe('exec-idle-days-risk', riskLabel);
          
          log('[IDLE DAYS] <svg class="icon"><use href="#icon-check"/></svg> Atualizado da API:', avgIdleDays);
        }
      }
      
      // ATIVIDADES e MEDDIC SCORE (GANHOS do pipeline)
      if (metrics.closed_won) {
        const avgActivitiesWon = metrics.closed_won.avg_activities;
        const avgCycleWon = metrics.closed_won.avg_cycle_days;
        
        if (avgActivitiesWon !== null && avgActivitiesWon !== undefined) {
          setTextSafe('exec-won-activities', Math.round(avgActivitiesWon));
          setTextSafe('exec-won-activities-detail', `${Math.round(avgActivitiesWon)} atividades por deal ganho`);
          log('[ATIVIDADES WON] <svg class="icon"><use href="#icon-check"/></svg> Atualizado da API:', avgActivitiesWon);
        }
        
        if (avgCycleWon !== null && avgCycleWon !== undefined) {
          setTextSafe('exec-won-cycle-days', Math.round(avgCycleWon));
          setTextSafe('exec-cycle-won', Math.round(avgCycleWon) + ' dias');
          setTextSafe('exec-cycle-won-detail', metrics.closed_won.deals_count + ' deals com ciclo');
          window.avgCycleWon = Math.round(avgCycleWon);
          log('[CICLO WON] <svg class="icon"><use href="#icon-check"/></svg> Atualizado da API:', avgCycleWon);
        }
        
        // NET VALUE
        if (metrics.closed_won.net) {
          // Atualizar onde o Net Ã© exibido (ex: exec-forecast-net)
          const netValue = metrics.closed_won.net;
          const wonDealsCount = metrics.closed_won.deals_count || 0;
          if (wonDealsCount > 0) {
            const ticketWonNet = netValue / wonDealsCount;
            setTextSafe('exec-ticket-won-net', 'Net: ' + formatMoney(ticketWonNet));
          }
          log('[NET WON] <svg class="icon"><use href="#icon-check"/></svg> Atualizado da API:', netValue);
        }
      }
      
      // MEDDIC SCORE - CORREÃ‡ÃƒO: Deve vir de closed_won (deals ganhos), nÃ£o de pipeline
      // Pipeline pode ter deals futuros que ainda nÃ£o aconteceram
      if (metrics.closed_won && metrics.closed_won.deals_count > 0) {
        // Tenta pegar avg_meddic de closed_won (se API adicionar no futuro)
        const avgMeddicWon = metrics.closed_won.avg_meddic;
        
        if (avgMeddicWon !== null && avgMeddicWon !== undefined) {
          setTextSafe('exec-won-meddic', Math.round(avgMeddicWon));
          setTextSafe('exec-won-meddic-detail', `${Math.round(avgMeddicWon)}/100 score de qualificaÃ§Ã£o`);
          log('[MEDDIC SCORE] <svg class="icon"><use href="#icon-check"/></svg> Atualizado da API (closed_won):', avgMeddicWon);
        } else {
          // Fallback: usa pipeline_filtered apenas se houver deals ganhos no perÃ­odo
          const avgMeddicPipeline = metrics.pipeline_filtered?.avg_meddic;
          if (avgMeddicPipeline !== null && avgMeddicPipeline !== undefined) {
            setTextSafe('exec-won-meddic', Math.round(avgMeddicPipeline));
            setTextSafe('exec-won-meddic-detail', `${Math.round(avgMeddicPipeline)}/100 score de qualificaÃ§Ã£o`);
            log('[MEDDIC SCORE] <svg class="icon"><use href="#icon-alert"/></svg> Usando pipeline (fallback):', avgMeddicPipeline);
          }
        }
      } else {
        // Se nÃ£o hÃ¡ deals ganhos, mostrar N/A ou 0
        setTextSafe('exec-won-meddic', '0');
        setTextSafe('exec-won-meddic-detail', 'Sem dados de MEDDIC');
        log('[MEDDIC SCORE] <svg class="icon"><use href="#icon-alert"/></svg> Nenhum deal ganho no perÃ­odo');
      }
      
      // ATIVIDADES PERDIDAS e EVITABILIDADE
      if (metrics.closed_lost) {
        const avgActivitiesLost = metrics.closed_lost.avg_activities;
        const avgCycleLost = metrics.closed_lost.avg_cycle_days;
        const evitavelPct = metrics.closed_lost.evitavel_pct || 0;
        const evitavelCount = metrics.closed_lost.evitavel_count || 0;
        const totalLosses = metrics.closed_lost.deals_count || 0;
        
        if (avgCycleLost !== null && avgCycleLost !== undefined) {
          setTextSafe('exec-lost-cycle-days', Math.round(avgCycleLost));
          setTextSafe('exec-cycle-lost', Math.round(avgCycleLost) + ' dias');
          setTextSafe('exec-cycle-lost-detail', totalLosses + ' deals com ciclo');
          window.avgCycleLost = Math.round(avgCycleLost);
          log('[CICLO LOST] <svg class="icon"><use href="#icon-check"/></svg> Atualizado da API:', avgCycleLost);
        }
        
        setTextSafe('exec-lost-evitavel-pct', Math.round(evitavelPct) + '%');
        setTextSafe('exec-lost-evitavel-count', `${evitavelCount} de ${totalLosses} deals evitÃ¡veis`);
        log('[EVITAVEL] <svg class="icon"><use href="#icon-check"/></svg> Atualizado da API:', evitavelPct + '%');
      }
      
      // EFICIÃŠNCIA DE CICLO
      // CRÃTICO: Usar cycle_efficiency_pct da API (jÃ¡ calculado com dados filtrados)
      const apiCycleEfficiency = metrics.cycle_efficiency_pct;
      if (apiCycleEfficiency !== null && apiCycleEfficiency !== undefined) {
        const efficiency = Math.round(apiCycleEfficiency);
        const efficiencyText = efficiency > 0 ? `+${efficiency}%` : `${efficiency}%`;
        const wonCycle = window.avgCycleWon || 0;
        const lostCycle = window.avgCycleLost || 0;
        setTextSafe('exec-cycle-efficiency', efficiencyText);
        setTextSafe('exec-cycle-efficiency-detail', `ganhos ${wonCycle}d vs perdas ${lostCycle}d`);
        log('[EFICIENCIA] <svg class="icon"><use href="#icon-check"/></svg> Ciclo da API:', efficiency + '%');
      } else if (window.avgCycleWon && window.avgCycleLost && window.avgCycleLost > 0) {
        // Fallback: calcular localmente se API nÃ£o retornar
        const efficiency = Math.round((1 - (window.avgCycleWon / window.avgCycleLost)) * 100);
        const efficiencyText = efficiency > 0 ? `+${efficiency}%` : `${efficiency}%`;
        setTextSafe('exec-cycle-efficiency', efficiencyText);
        setTextSafe('exec-cycle-efficiency-detail', `ganhos ${window.avgCycleWon}d vs perdas ${window.avgCycleLost}d`);
        log('[EFICIENCIA] <svg class="icon"><use href="#icon-check"/></svg> Ciclo calculated (fallback):', efficiency + '%');
      }
    }
    
    // FunÃ§Ã£o para calcular e atualizar mÃ©tricas de Idle Days (DEPRECATED - usar updateExecutiveMetricsFromAPI)
    function updateIdleDaysMetrics(pipelineData) {
      log('[IDLE DAYS] <svg class="icon"><use href="#icon-alert"/></svg> updateIdleDaysMetrics deprecated - usando dados da API');
      // Esta funÃ§Ã£o Ã© mantida para compatibilidade mas nÃ£o calcula mais nada
      // Os dados agora vÃªm do endpoint /api/metrics via updateExecutiveMetricsFromAPI
    }
    
    // FunÃ§Ã£o auxiliar para filtrar pipeline por perÃ­odo
    function filterPipelineByPeriod_(period) {
      const allPipeline = window.DATA?.pipeline || window.pipelineDataRaw || [];
      
      if (!Array.isArray(allPipeline) || allPipeline.length === 0) {
        log('[FILTER PIPELINE] <svg class="icon"><use href="#icon-alert"/></svg> Nenhum dado de pipeline disponÃ­vel');
        return [];
      }
      
      if (period === 'all') {
        return allPipeline;
      }
      
      const fy = window.currentFY || 'FY26';
      
      if (period === 'total') {
        return allPipeline.filter(d => 
          (d.Fiscal_Q || d.fiscal_q || '').startsWith(fy + '-')
        );
      }
      
      if (['q1', 'q2', 'q3', 'q4'].includes(period)) {
        const targetQuarter = fy + '-' + period.toUpperCase();
        return allPipeline.filter(d => 
          (d.Fiscal_Q || d.fiscal_q) === targetQuarter
        );
      }
      
      return allPipeline;
    }
    
    // FunÃ§Ã£o para atualizar mÃ©tricas de conversÃ£o ao filtrar por perÃ­odo
    function updateConversionMetricsForPeriod(period) {
      if (!window.wonAgg || !window.lostAgg) {
        log('[CONVERSION] <svg class="icon"><use href="#icon-alert"/></svg> wonAgg ou lostAgg nÃ£o disponÃ­veis');
        log('[CONVERSION] wonAgg:', window.wonAgg ? window.wonAgg.length : 'undefined');
        log('[CONVERSION] lostAgg:', window.lostAgg ? window.lostAgg.length : 'undefined');
        return;
      }
      
      let winsGross = 0, winsNet = 0, lossesGross = 0, lossesNet = 0;
      let totalWins = 0, totalLosses = 0;
      
      // Se perÃ­odo for um quarter especÃ­fico, filtra
      const fy = window.currentFY || 'FY26';
      let targetQuarter = null;
      
      if (period === 'q1' || period === 'q2' || period === 'q3' || period === 'q4') {
        targetQuarter = `${fy}-${period.toUpperCase()}`;
      }
      
      log('[CONVERSION] Filtrando por:', targetQuarter || 'TODOS');
      log('[CONVERSION] wonAgg total:', window.wonAgg.length);
      log('[CONVERSION] lostAgg total:', window.lostAgg.length);
      
      // Filtra ganhas pelo perÃ­odo
      if (window.wonAgg) {
        window.wonAgg.forEach(deal => {
          // Se targetQuarter Ã© null ("all"), inclui TODOS os deals
          // Se targetQuarter existe, filtra apenas matching fiscalQ
          if (targetQuarter === null || deal.fiscalQ === targetQuarter) {
            winsGross += deal.gross || 0;
            winsNet += deal.net || 0;
            totalWins++;
          }
        });
      }
      
      // Filtra perdidas pelo perÃ­odo
      if (window.lostAgg) {
        window.lostAgg.forEach(deal => {
          // Se targetQuarter Ã© null ("all"), inclui TODOS os deals
          if (targetQuarter === null || deal.fiscalQ === targetQuarter) {
            lossesGross += deal.gross || 0;
            lossesNet += deal.net || 0;
            totalLosses++;
          }
        });
      }
      
      const totalDeals = totalWins + totalLosses;
      const conversionRate = totalDeals > 0 ? Math.round((totalWins / totalDeals) * 100) : 0;
      
      log('[CONVERSION UPDATE] PerÃ­odo:', targetQuarter || 'TODOS');
      log('[CONVERSION] Ganhas: Gross', formatMoney(winsGross), '| Net', formatMoney(winsNet), '|', totalWins, 'deals');
      log('[CONVERSION] Perdidas: Gross', formatMoney(lossesGross), '| Net', formatMoney(lossesNet), '|', totalLosses, 'deals');
      log('[CONVERSION] Taxa:', conversionRate + '%', `(${totalWins}/${totalDeals})`);
      
      // Atualiza o card "Fechado no Quarter" (adaptativo ao filtro)
      setTextSafe('exec-closed-total', formatMoney(winsGross));
      setTextSafe('exec-closed-deals', totalWins + ' deals ganhos');
      setTextSafe('exec-closed-net', 'Net: ' + formatMoney(winsNet));
      
      // Atualiza o card "Taxa de ConversÃ£o" (adaptativo ao filtro)
      setTextSafe('exec-conversion-rate', conversionRate + '%');
      setTextSafe('exec-conversion-detail', totalWins + '/' + totalDeals + ' deals');
      
      // ========== NOVO: Atualiza os cards de DEALS PERDIDOS ==========
      const lossRate = totalDeals > 0 ? Math.round((totalLosses / totalDeals) * 100) : 0;
      setTextSafe('exec-lost-total', formatMoney(lossesGross));
      setTextSafe('exec-lost-deals', totalLosses + ' deals perdidos');
      setTextSafe('exec-lost-net', 'Net: ' + formatMoney(lossesNet));
      setTextSafe('exec-loss-rate', lossRate + '%');
      setTextSafe('exec-loss-detail', totalLosses + '/' + totalDeals + ' deals');
      
      // ========== NOVO: Atualiza PERFORMANCE DOS VENDEDORES ==========
      // Ticket MÃ©dio Ganhos
      const ticketWonGross = totalWins > 0 ? winsGross / totalWins : 0;
      const ticketWonNet = totalWins > 0 ? winsNet / totalWins : 0;
      setTextSafe('exec-ticket-won', formatMoney(ticketWonGross));
      setTextSafe('exec-ticket-won-detail', 'mÃ©dia por deal');
      setTextSafe('exec-ticket-won-net', 'Net: ' + formatMoney(ticketWonNet));
      
      // Ticket MÃ©dio Perdidos
      const ticketLostGross = totalLosses > 0 ? lossesGross / totalLosses : 0;
      const ticketLostNet = totalLosses > 0 ? lossesNet / totalLosses : 0;
      setTextSafe('exec-ticket-lost', formatMoney(ticketLostGross));
      setTextSafe('exec-ticket-lost-detail', 'mÃ©dia por deal');
      setTextSafe('exec-ticket-lost-net', 'Net: ' + formatMoney(ticketLostNet));
      
      // <svg class="icon"><use href="#icon-alert"/></svg> NOTA: MÃ©tricas de Ciclo, Atividades, MEDDIC e Evitabilidade sÃ£o atualizadas
      // pela funÃ§Ã£o updateExecutiveMetricsFromAPI() usando dados do endpoint /api/metrics
      // O cÃ¡lculo manual foi removido para evitar duplicaÃ§Ã£o e inconsistÃªncia
      
      // Vendedores: Win Rate total
      const sellersWinRate = totalDeals > 0 ? conversionRate : 0;
      setTextSafe('exec-sellers-active', window.totalVendedores || 10);
      setTextSafe('exec-sellers-total', 'de ' + (window.totalVendedores || 10) + ' vendedores');
      setTextSafe('exec-sellers-winrate', 'Win Rate: ' + sellersWinRate + '%');
      
      // Atualiza a display da Taxa de ConversÃ£o
      const conversionCard = document.querySelector('[data-card="conversion"]');
      if (conversionCard) {
        const detailEl = conversionCard.querySelector('[data-detail]');
        if (detailEl) {
          const html = `
            <div style="margin-top: 12px; font-size: 11px; opacity: 0.85; line-height: 1.6;">
              <div><strong>Ganhas:</strong> ${formatMoney(winsGross)} (Gross) | ${formatMoney(winsNet)} (Net)</div>
              <div><strong>Perdidas:</strong> ${formatMoney(lossesGross)} (Gross) | ${formatMoney(lossesNet)} (Net)</div>
              <div style="margin-top: 8px; border-top: 1px solid rgba(176,184,196,0.2); padding-top: 8px;">
                <strong>Resultado LÃ­quido (Net):</strong> ${formatMoney(winsNet - lossesNet)}
              </div>
            </div>
          `;
          detailEl.innerHTML += html;
        }
      }
    }
    
    // ============================================================================
    // FUNÃ‡ÃƒO PARA ATUALIZAR SALES SPECIALIST METRICS
    // ============================================================================
    function updateSalesSpecialistMetrics() {
      if (!DATA || !DATA.salesSpecialist) {
        log('[SALES SPECIALIST] Dados nÃ£o disponÃ­veis');
        return;
      }
      
      const ss = DATA.salesSpecialist;
      const pipelineTotal = DATA?.cloud_analysis?.pipeline_analysis?.metrics?.pipeline_total?.gross || 74523512;
      
      // Total Curado
      setTextSafe('exec-ss-total', formatMoney(ss.total.gross));
      setTextSafe('exec-ss-deals', `${ss.total.deals} deals curados`);
      setTextSafe('exec-ss-net', `Net: ${formatMoney(ss.total.net)}`);
      
      // Taxa de Curadoria
      const coveragePercent = pipelineTotal > 0 ? ((ss.total.gross / pipelineTotal) * 100).toFixed(1) : 0;
      const coverageDealsPercent = DATA.weeklyAgenda ? ((ss.total.deals / Object.values(DATA.weeklyAgenda).flat().length) * 100).toFixed(1) : 0;
      setTextSafe('exec-ss-coverage', `${coveragePercent}%`);
      setTextSafe('exec-ss-coverage-deals', `${coverageDealsPercent}% dos deals`);
      setTextSafe('exec-ss-coverage-value', `${coveragePercent}% do valor`);
      
      // Ticket MÃ©dio
      const avgTicketGross = ss.total.deals > 0 ? ss.total.gross / ss.total.deals : 0;
      const avgTicketNet = ss.total.deals > 0 ? ss.total.net / ss.total.deals : 0;
      setTextSafe('exec-ss-ticket', formatMoney(avgTicketGross));
      setTextSafe('exec-ss-ticket-detail', 'mÃ©dia por deal');
      setTextSafe('exec-ss-ticket-net', `Net: ${formatMoney(avgTicketNet)}`);
      
      // Top Vendedor
      const vendedores = Object.entries(ss.byVendor).sort((a, b) => b[1].gross - a[1].gross);
      if (vendedores.length > 0) {
        const [topName, topData] = vendedores[0];
        setTextSafe('exec-ss-top-seller', topName);
        setTextSafe('exec-ss-top-value', formatMoney(topData.gross) + ' curado');
        setTextSafe('exec-ss-top-deals', `${topData.deals} deals`);
      }
      
      // Atualizar barras de Forecast Health - Sales Specialist
      const commitPercent = ss.total.gross > 0 ? (ss.byStatus.COMMIT.gross / ss.total.gross) * 100 : 0;
      const upsidePercent = ss.total.gross > 0 ? (ss.byStatus.UPSIDE.gross / ss.total.gross) * 100 : 0;
      
      const commitBar = document.getElementById('forecast-ss-commit-bar');
      const upsideBar = document.getElementById('forecast-ss-upside-bar');
      
      if (commitBar) {
        commitBar.style.width = commitPercent + '%';
        commitBar.textContent = commitPercent > 5 ? `${commitPercent.toFixed(0)}%` : '';
      }
      if (upsideBar) {
        upsideBar.style.width = upsidePercent + '%';
        upsideBar.textContent = upsidePercent > 5 ? `${upsidePercent.toFixed(0)}%` : '';
      }
      
      setTextSafe('forecast-ss-commit-value', `${formatMoney(ss.byStatus.COMMIT.gross)} (${commitPercent.toFixed(0)}%)`);
      setTextSafe('forecast-ss-commit-net', 'Net: ' + formatMoney(ss.byStatus.COMMIT.net));
      
      setTextSafe('forecast-ss-upside-value', `${formatMoney(ss.byStatus.UPSIDE.gross)} (${upsidePercent.toFixed(0)}%)`);
      setTextSafe('forecast-ss-upside-net', 'Net: ' + formatMoney(ss.byStatus.UPSIDE.net));
      
      log('[SALES SPECIALIST] MÃ©tricas atualizadas:', ss);
    }
    
    // ============================================================================
    // FUNÃ‡ÃƒO PARA ATUALIZAR PREVISÃƒO PONDERADA IA (ADAPTATIVA AO FILTRO)
    // ============================================================================
    function updateForecastPrediction(period, pipelineData) {
      log('[FORECAST] Recalculando PrevisÃ£o Ponderada IA para perÃ­odo:', period);
      
      // SEMPRE calcula confianÃ§a mÃ©dia dos deals disponÃ­veis (nÃ£o USA STATIC_METRICS)
      let avgConfidence = 0;
      
      // Para todos os perÃ­odos, recalcula com deals disponÃ­veis
      if (!window.allDealsWithConfidence || window.allDealsWithConfidence.length === 0) {
        log('[FORECAST] <svg class="icon"><use href="#icon-alert"/></svg> allDealsWithConfidence nÃ£o disponÃ­vel, confianÃ§a = 0');
        avgConfidence = 0;
      } else {
        const fy = window.currentFY || 'FY26';
        let dealsToAnalyze = [];
        
        if (period === 'all' || period === 'total') {
          // Sem filtro: analisa TODOS os deals do ano fiscal atual
          dealsToAnalyze = window.allDealsWithConfidence.filter(d => 
            (d.fiscalQ || '').startsWith(fy + '-')
          );
          log('[FORECAST] Analisando TODOS os deals de', fy + ':', dealsToAnalyze.length);
        } else if (['q1', 'q2', 'q3', 'q4'].includes(period)) {
          const targetQuarter = fy + '-' + period.toUpperCase();
          dealsToAnalyze = window.allDealsWithConfidence.filter(d => 
            d.fiscalQ === targetQuarter
          );
          log('[FORECAST] Analisando deals de', targetQuarter + ':', dealsToAnalyze.length);
        }
        
        // Calcula confianÃ§a mÃ©dia dos deals do perÃ­odo
        let totalConfidence = 0;
        let dealsWithConfidence = 0;
        
        dealsToAnalyze.forEach(d => {
          let conf = parseFloat(d.confidence) || 0;
          if (conf > 1) conf = conf / 100;
          
          if (conf > 0) {
            totalConfidence += conf;
            dealsWithConfidence++;
          }
        });
        
        avgConfidence = dealsWithConfidence > 0 
          ? (totalConfidence / dealsWithConfidence) * 100 
          : 0;
        
        log('[FORECAST] ConfianÃ§a mÃ©dia calculada do perÃ­odo:', avgConfidence.toFixed(1) + '%', '(' + dealsWithConfidence + ' deals)');
      }
      
      // Calcula previsÃ£o ponderada
      const forecastGross = pipelineData.gross * (avgConfidence / 100);
      const forecastNet = pipelineData.net * (avgConfidence / 100);
      
      log('[FORECAST] PrevisÃ£o Ponderada IA:', {
        'pipeline': formatMoney(pipelineData.gross),
        'confianÃ§a': avgConfidence.toFixed(1) + '%',
        'previsÃ£o': formatMoney(forecastGross)
      });
      
      // Atualiza cards
      setTextSafe('exec-forecast-weighted', formatMoney(forecastGross));
      setTextSafe('exec-forecast-percent', Math.round(avgConfidence) + '% confianÃ§a mÃ©dia');
      setTextSafe('exec-forecast-net', 'Net: ' + formatMoney(forecastNet));
    }
    
    // ============================================================================
    // FUNÃ‡ÃƒO PARA ATUALIZAR DEALS â‰¥50% CONFIANÃ‡A IA (ADAPTATIVA AO FILTRO)
    // ============================================================================
    function updateHighConfidenceDeals(period) {
      log('[HIGH-CONF] Recalculando Deals â‰¥50% para perÃ­odo:', period);
      
      // <svg class="icon"><use href="#icon-check"/></svg> SEMPRE pega da API filtrada (nunca recalcula localmente)
      // Os valores corretos vÃªm do backend que faz: WHERE Confianca >= 50
      const hasFilters = period !== 'all';
      let highConfGross = 0;
      let highConfNet = 0;
      let highConfCount = 0;
      
      if (hasFilters && window.lastApiFilteredResponse) {
        // Usa valores filtrados da Ãºltima resposta da API
        const apiHighConf = window.lastApiFilteredResponse.executive?.high_confidence || {};
        highConfGross = apiHighConf.gross || 0;
        highConfNet = apiHighConf.net || 0;
        highConfCount = apiHighConf.deals_count || 0;
        log('[HIGH-CONF] <svg class="icon"><use href="#icon-check"/></svg> Usando valores FILTRADOS da API:', highConfCount, 'deals');
      } else {
        // Sem filtros: usa valores globais da carga inicial (DATA)
        const globalHighConf = safe(window.DATA, 'cloudAnalysis.pipeline_analysis.executive.high_confidence', {});
        highConfGross = globalHighConf.gross || 0;
        highConfNet = globalHighConf.net || 0;
        highConfCount = globalHighConf.deals_count || 0;
        log('[HIGH-CONF] <svg class="icon"><use href="#icon-check"/></svg> Usando valores GLOBAIS da API:', highConfCount, 'deals');
      }
      
      log('[HIGH-CONF] Resultado:', {
        'total': highConfCount,
        'gross': formatMoney(highConfGross),
        'net': formatMoney(highConfNet)
      });
      
      // Atualiza cards
      setTextSafe('exec-above50-value', formatMoney(highConfGross));
      setTextSafe('exec-above50-count', highConfCount + ' deals');
      setTextSafe('exec-above50-net', 'Net: ' + formatMoney(highConfNet));
    }
    
    // FunÃ§Ã£o para filtrar pipeline por perÃ­odo
    function filterPipeline(period) {
      showLoading('Aplicando filtros');
      
      log('[FILTER] ========== FILTRO DE PIPELINE ==========');
      log('[FILTER] PerÃ­odo selecionado:', period);
      
      // Armazena filtro atual para debug
      window.currentPeriodFilter = period;
      
      // <svg class="icon"><use href="#icon-check"/></svg> NOVA ARQUITETURA: Quando filtrar por quarter, CHAMA API
      if (period === 'q1' || period === 'q2' || period === 'q3' || period === 'q4') {
        log('[FILTER] <svg class="icon"><use href="#icon-check"/></svg> Chamando API com filtro de quarter:', period);
        
        const quarterNum = period.replace('q', ''); // "q2" -> "2"
        const currentYear = 2026; // FY26 = 2026
        
        // Chama API com filtros year + quarter
        fetch(`${API_BASE_URL}/api/metrics?year=${currentYear}&quarter=${quarterNum}`)
          .then(res => res.json())
          .then(metrics => {
            log('[FILTER API] MÃ©tricas filtradas recebidas:', metrics);
            
            // Armazena resposta filtrada globalmente
            window.lastApiFilteredResponse = { executive: metrics };
            
            // Atualiza Pipeline (PerÃ­odo Filtrado) com dados da API
            const pipelineFiltered = metrics.pipeline_filtered || {};
            setTextSafe('exec-pipeline-total', formatMoney(pipelineFiltered.gross || 0));
            setTextSafe('exec-pipeline-deals', (pipelineFiltered.deals_count || 0) + ' deals no perÃ­odo');
            setTextSafe('exec-pipeline-net', 'Net: ' + formatMoney(pipelineFiltered.net || 0));
            
            // Atualiza PrevisÃ£o Ponderada IA com avg_confidence DA API
            const avgConf = pipelineFiltered.avg_confidence || 0;
            const forecastGross = (pipelineFiltered.gross || 0) * (avgConf / 100);
            const forecastNet = (pipelineFiltered.net || 0) * (avgConf / 100);
            
            setTextSafe('exec-forecast-weighted', formatMoney(forecastGross));
            setTextSafe('exec-forecast-percent', Math.round(avgConf) + '% confianÃ§a mÃ©dia');
            setTextSafe('exec-forecast-net', 'Net: ' + formatMoney(forecastNet));
            
            log('[FILTER API] PrevisÃ£o Ponderada:', {
              avgConfidence: avgConf + '%',
              forecastGross: formatMoney(forecastGross),
              forecastNet: formatMoney(forecastNet)
            });
            
            // Atualiza Deals â‰¥50% ConfianÃ§a com dados DA API
            const highConf = metrics.high_confidence || {};
            setTextSafe('exec-above50-value', formatMoney(highConf.gross || 0));
            setTextSafe('exec-above50-count', (highConf.deals_count || 0) + ' deals');
            setTextSafe('exec-above50-net', 'Net: ' + formatMoney(highConf.net || 0));
            
            // Atualiza botÃµes de perÃ­odo
            document.querySelectorAll('.period-filter').forEach(btn => {
              btn.classList.remove('active');
              btn.style.border = '1px solid rgba(176,184,196,0.3)';
              btn.style.background = 'transparent';
            });
            
            const activeBtn = document.querySelector(`.period-filter[data-period="${period}"]`);
            if (activeBtn) {
              activeBtn.classList.add('active');
              activeBtn.style.border = '2px solid var(--primary-cyan)';
              activeBtn.style.background = 'rgba(0,190,255,0.08)';
            }
            
            // Atualiza Sales Specialist e Forecast Health com dados locais (menos crÃ­tico)
            updateConversionMetricsForPeriod(period);
            if (window.updateForecastHealth) window.updateForecastHealth(period);
            if (window.updateTop5Opps) window.updateTop5Opps(period);
            
            hideLoading();
          })
          .catch(err => {
            log('[FILTER API] <svg class="icon"><use href="#icon-x"/></svg> Erro ao chamar API:', err);
            // Fallback: usa filtro local
            filterPipelineLocal(period);
          });
        
        return; // Sai da funÃ§Ã£o, aguarda callback da API
      }
      
      // Para "all" ou "total", usa dados GLOBAIS da API (sem filtros)
      if (period === 'all' || period === 'total') {
        log('[FILTER] <svg class="icon"><use href="#icon-check"/></svg> Usando dados GLOBAIS da API (sem filtros)');
        
        // Pega mÃ©tricas globais da resposta inicial da API
        const globalMetrics = window.DATA?.cloudAnalysis?.pipeline_analysis?.executive || {};
        const pipelineAll = globalMetrics.pipeline_all || {};
        const highConfGlobal = globalMetrics.high_confidence || {};
        
        // Atualiza Pipeline (PerÃ­odo Filtrado) com dados globais
        setTextSafe('exec-pipeline-total', formatMoney(pipelineAll.gross || 0));
        setTextSafe('exec-pipeline-deals', (pipelineAll.deals_count || 0) + ' deals abertos');
        setTextSafe('exec-pipeline-net', 'Net: ' + formatMoney(pipelineAll.net || 0));
        
        // Calcula PrevisÃ£o Ponderada usando avg_confidence GLOBAL do BigQuery
        // Pega de pipeline_filtered (que tem avg_confidence calculado de todos os deals)
        const pipelineFiltered = globalMetrics.pipeline_filtered || {};
        const avgConfGlobal = pipelineFiltered.avg_confidence || 0;
        const forecastGross = (pipelineAll.gross || 0) * (avgConfGlobal / 100);
        const forecastNet = (pipelineAll.net || 0) * (avgConfGlobal / 100);
        
        setTextSafe('exec-forecast-weighted', formatMoney(forecastGross));
        setTextSafe('exec-forecast-percent', Math.round(avgConfGlobal) + '% confianÃ§a mÃ©dia');
        setTextSafe('exec-forecast-net', 'Net: ' + formatMoney(forecastNet));
        
        log('[FILTER] PrevisÃ£o Ponderada GLOBAL:', {
          avgConfidence: avgConfGlobal + '%',
          forecastGross: formatMoney(forecastGross),
          forecastNet: formatMoney(forecastNet)
        });
        
        // Atualiza Deals â‰¥50% com dados globais
        setTextSafe('exec-above50-value', formatMoney(highConfGlobal.gross || 0));
        setTextSafe('exec-above50-count', (highConfGlobal.deals_count || 0) + ' deals');
        setTextSafe('exec-above50-net', 'Net: ' + formatMoney(highConfGlobal.net || 0));
        
        // Atualiza botÃµes
        document.querySelectorAll('.period-filter').forEach(btn => {
          btn.classList.remove('active');
          btn.style.border = '1px solid rgba(176,184,196,0.3)';
          btn.style.background = 'transparent';
        });
        
        const activeBtn = document.querySelector(`.period-filter[data-period=\"${period}\"]`);
        if (activeBtn) {
          activeBtn.classList.add('active');
          activeBtn.style.border = '2px solid var(--primary-cyan)';
          activeBtn.style.background = 'rgba(0,190,255,0.08)';
        }
        
        // Atualiza Sales Specialist, Forecast Health e Top5 com dados locais
        updateConversionMetricsForPeriod(period);
        if (window.updateForecastHealth) window.updateForecastHealth(period);
        if (window.updateTop5Opps) window.updateTop5Opps(period);
        
        hideLoading();
        return;
      }
      
      // Para outros casos, usa filtro local (fallback)
      filterPipelineLocal(period);
    }
    
    // FunÃ§Ã£o auxiliar para filtro local (fallback)
    function filterPipelineLocal(period) {
      
      const data = getPipelineDataForPeriod(period);
      if (!data) {
        log('[FILTER] <svg class="icon"><use href="#icon-alert"/></svg> Dados do perÃ­odo nÃ£o encontrados:', period);
        hideLoading();
        return;
      }
      
      // ============================================================================
      // ARQUITETURA HÃBRIDA: FILTROS DINÃ‚MICOS
      // ============================================================================
      // Esta funÃ§Ã£o manipula APENAS dados DINÃ‚MICOS do payload JSON (window.pipelineData)
      // KPIs ESTÃTICOS (Pipeline Total, Vendedores Ativos) vÃªm da aba e NÃƒO sÃ£o recalculados aqui
      // 
      // REGRAS:
      // - "Pipeline Total Ano" (exec-pipeline-year-*) â†’ ESTÃTICO (da aba)
      // - "Pipeline (PerÃ­odo Filtrado)" (exec-pipeline-*) â†’ DINÃ‚MICO (recalculado aqui)
      // - "Top 5 Oportunidades" â†’ DINÃ‚MICO (filtrado por quarter)
      // - "SaÃºde do Forecast" â†’ DINÃ‚MICO (recalculado por perÃ­odo)
      // ============================================================================
      
      log('[FILTER] Aplicando filtro:', {
        'perÃ­odo': period,
        'gross': formatMoney(data.gross),
        'net': formatMoney(data.net),
        'deals': data.count
      });
      
      // ATUALIZA APENAS O CARD "Pipeline (PerÃ­odo Filtrado)"
      // O card "Pipeline Total Ano" (exec-pipeline-year-*) Ã© ESTÃTICO e NÃƒO Ã© alterado
      setTextSafe('exec-pipeline-total', formatMoney(data.gross));
      setTextSafe('exec-pipeline-deals', data.count + ' deals no perÃ­odo');
      setTextSafe('exec-pipeline-net', 'Net: ' + formatMoney(data.net));
      
      // RECALCULA PREVISÃƒO PONDERADA IA ADAPTATIVA AO FILTRO
      // CRÃTICO: Se hÃ¡ filtros ativos, usar confianÃ§a mÃ©dia da API
      const hasActiveFilters = window.currentFilters && (window.currentFilters.year || window.currentFilters.quarter || window.currentFilters.month || window.currentFilters.seller);
      if (hasActiveFilters && window.DATA && window.DATA.cloudAnalysis && window.DATA.cloudAnalysis.pipeline_analysis) {
        const apiMetrics = window.DATA.cloudAnalysis.pipeline_analysis.executive || {};
        log('[FORECAST] Usando confianÃ§a da API filtrada');
        
        // Atualizar PrevisÃ£o Ponderada IA com dados da API
        if (apiMetrics.pipeline_filtered) {
          const avgConf = apiMetrics.pipeline_filtered.avg_confidence || 0;
          const pipelineGross = apiMetrics.pipeline_filtered.gross || 0;
          const forecastWeighted = pipelineGross * (avgConf / 100);
          
          setTextSafe('exec-forecast-pipeline', formatMoney(pipelineGross));
          setTextSafe('exec-forecast-confidence', (avgConf).toFixed(1) + '% confianÃ§a mÃ©dia');
          setTextSafe('exec-forecast-value', 'Net: ' + formatMoney(forecastWeighted));
          
          log('[FORECAST] PrevisÃ£o da API:', {
            pipeline: formatMoney(pipelineGross),
            confianÃ§a: avgConf.toFixed(1) + '%',
            previsÃ£o: formatMoney(forecastWeighted)
          });
        }
        
        // Atualizar Deals â‰¥50% com dados da API
        if (apiMetrics.high_confidence) {
          const highConfGross = apiMetrics.high_confidence.gross || 0;
          const highConfNet = apiMetrics.high_confidence.net || 0;
          const highConfCount = apiMetrics.high_confidence.deals_count || 0;
          
          setTextSafe('exec-above50-value', formatMoney(highConfGross));
          setTextSafe('exec-above50-count', highConfCount + ' deals');
          setTextSafe('exec-above50-net', 'Net: ' + formatMoney(highConfNet));
          
          log('[HIGH-CONF] Deals â‰¥50% da API:', {
            total: highConfCount,
            gross: formatMoney(highConfGross),
            net: formatMoney(highConfNet)
          });
        }
      } else {
        // Fallback: Recalcular localmente
        updateForecastPrediction(period, data);
        updateHighConfidenceDeals(period);
      }
      
      // MÃ©tricas de Idle Days agora vÃªm do endpoint /api/metrics
      // A chamada updateExecutiveMetricsFromAPI jÃ¡ foi feita em loadData
      
      // Atualiza mÃ©tricas de conversÃ£o (Ganhas/Perdidas com Gross/Net)
      updateConversionMetricsForPeriod(period);
      
      // Atualiza Sales Specialist por quarter (Closed Date)
      if (window.salesSpecData) {
        const salesAll = window.salesSpecData.all || { gross: 0, net: 0, count: 0 };
        const byFiscalQ = window.salesSpecData.byFiscalQ || {};
        const fy = window.currentFY || 'FY26';

        if (period === 'q1' || period === 'q2' || period === 'q3' || period === 'q4') {
          const fiscalLabel = `${fy}-${period.toUpperCase()}`;
          const spec = byFiscalQ[fiscalLabel] || { gross: 0, net: 0, count: 0 };
          setTextSafe('exec-pipeline-specialist-total', formatMoney(spec.gross));
          setTextSafe('exec-pipeline-specialist-deals', spec.count + ' deals curados');
          setTextSafe('exec-pipeline-specialist-net', 'Net: ' + formatMoney(spec.net));
        } else {
          setTextSafe('exec-pipeline-specialist-total', formatMoney(salesAll.gross));
          setTextSafe('exec-pipeline-specialist-deals', salesAll.count + ' deals curados');
          setTextSafe('exec-pipeline-specialist-net', 'Net: ' + formatMoney(salesAll.net));
        }
      }
      
      // Recalcula SaÃºde do Forecast para o perÃ­odo
      if (window.updateForecastHealth) {
        log('[FILTER] Atualizando saÃºde do forecast...');
        window.updateForecastHealth(period);
      }
      
      // Atualiza Top 5 Oportunidades por perÃ­odo
      if (window.updateTop5Opps) {
        log('[FILTER] Atualizando Top 5 Oportunidades...');
        window.updateTop5Opps(period);
      }
      
      // Atualiza botÃµes
      document.querySelectorAll('.period-filter').forEach(btn => {
        btn.classList.remove('active');
        btn.style.border = '1px solid rgba(176,184,196,0.3)';
        btn.style.background = 'transparent';
        btn.style.color = 'var(--text-gray)';
        btn.style.fontWeight = '500';
        btn.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
      });
      
      const activeBtn = document.querySelector(`.period-filter[data-period="${period}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.style.border = '1px solid var(--primary-cyan)';
        activeBtn.style.background = 'rgba(0,190,255,0.15)';
        activeBtn.style.color = 'var(--primary-cyan)';
        activeBtn.style.fontWeight = '600';
        activeBtn.style.boxShadow = '0 2px 4px rgba(0,190,255,0.2)';
      }
      
      log('[FILTER] ========== FILTRO APLICADO COM SUCESSO ==========');
      hideLoading();
    }

    function getPipelineDataForPeriod(period) {
      const fy = window.currentFY || 'FY26';
      const repFilter = window.currentRepFilter && window.currentRepFilter !== 'all'
        ? window.currentRepFilter
        : null;

      const byQuarter = window.pipelineAggByQuarter || [];
      const bySellerQuarter = window.pipelineAggBySellerQuarter || [];
      const netRatio = window.pipelineNetRatio || 0;

      // Se period Ã© 'all', retorna o total do pipelineData
      if (period === 'all' && window.pipelineData && window.pipelineData.all) {
        return {
          gross: window.pipelineData.all.gross || 0,
          net: window.pipelineData.all.net || 0,
          count: window.pipelineData.all.count || 0
        };
      }

      const matchQuarter = (quarter) => {
        if (period === 'all') return true;
        if (!quarter) return false;
        if (period === 'total') return quarter.startsWith(fy + '-');
        if (['q1', 'q2', 'q3', 'q4'].includes(period)) {
          return quarter === fy + '-' + period.toUpperCase();
        }
        return false;
      };

      if (repFilter) {
        let gross = 0;
        let count = 0;
        bySellerQuarter.forEach(item => {
          if (item.seller === repFilter && matchQuarter(item.quarter)) {
            gross += item.total_gross || 0;
            count += item.count || 0;
          }
        });

        return {
          gross: gross,
          net: gross * netRatio,
          count: count
        };
      }

      let gross = 0;
      let net = 0;
      let count = 0;
      
      // CORREÃ‡ÃƒO: Se byQuarter estiver vazio, usar window.pipelineData como fallback
      if (byQuarter.length === 0 && window.pipelineData) {
        log('[FILTER] <svg class="icon"><use href="#icon-alert"/></svg> byQuarter vazio, usando window.pipelineData');
        const data = window.pipelineData[period] || window.pipelineData.all;
        return {
          gross: data.gross || 0,
          net: data.net || 0,
          count: data.count || 0
        };
      }
      
      byQuarter.forEach(item => {
        if (matchQuarter(item.quarter)) {
          gross += item.total_gross || 0;
          net += item.total_net || 0;
          count += item.count || 0;
        }
      });

      return {
        gross: gross,
        net: net,
        count: count
      };
    }

    function populateYearFilter() {
      const select = document.getElementById('year-filter');
      if (!select) return;

      const byQuarter = safe(DATA, 'cloudAnalysis.aggregations.by_quarter', []);
      const years = Array.from(new Set(byQuarter
        .map(item => (item.quarter || '').split('-')[0])
        .filter(Boolean)
      ));

      years.sort();
      if (years.length === 0) {
        years.push(window.currentFY || 'FY26');
      }

      select.innerHTML = '';
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        select.appendChild(option);
      });

      const defaultYear = years.includes(window.currentFY) ? window.currentFY : years[0];
      select.value = defaultYear;
      window.currentFY = defaultYear;
      updateYearLabels();
    }

    function updateYearLabels() {
      const currentFY = window.currentFY || 'FY26';
      setTextSafe('filter-total-label', 'Todo Pipeline (' + currentFY + ')');
      setTextSafe('filter-q1-label', currentFY + '-Q1');
      setTextSafe('filter-q2-label', currentFY + '-Q2');
      setTextSafe('filter-q3-label', currentFY + '-Q3');
      setTextSafe('filter-q4-label', currentFY + '-Q4');
    }

    function setYearFilter(year) {
      window.currentFY = year;
      updateYearLabels();
      const currentPeriod = window.currentPeriodFilter || 'all';
      filterPipeline(currentPeriod);
    }

    // FunÃ§Ã£o para popular dropdown de vendedores ativos
    function populateRepFilter() {
      if (!DATA.fsrScorecard) {
        log('[REP FILTER] fsrScorecard nÃ£o disponÃ­vel');
        return;
      }
      
      const activeReps = DATA.fsrScorecard.filter(r => r.isActive);
      const select = document.getElementById('rep-filter');
      
      if (!select) {
        log('[REP FILTER] <svg class="icon"><use href="#icon-alert"/></svg> Elemento select nÃ£o encontrado');
        return;
      }
      
      // Limpa options existentes (exceto "Todos")
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Adiciona vendedores ativos ordenados por nome
      activeReps
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(rep => {
          const option = document.createElement('option');
          option.value = rep.name;
          option.text = rep.name;
          select.add(option);
        });
      
      log('[REP FILTER] <svg class="icon"><use href="#icon-check"/></svg> Dropdown populado com', activeReps.length, 'vendedores ativos');
    }

    // FunÃ§Ã£o para filtrar por vendedor
    function filterByRep(repName) {
      log('[REP FILTER] ========== FILTRO POR VENDEDOR ==========');
      log('[REP FILTER] Vendedor selecionado:', repName);
      
      // Armazena filtro atual
      window.currentRepFilter = repName;
      
      if (repName === 'all') {
        log('[REP FILTER] Exibindo todos os vendedores');
        // Reaplica o filtro de perÃ­odo atual (sem filtro de vendedor)
        const currentPeriod = window.currentPeriodFilter || 'all';
        filterPipeline(currentPeriod);
        return;
      }
      
      // Filtra pelo vendedor selecionado
      if (!DATA.fsrScorecard) {
        log('[REP FILTER] <svg class="icon"><use href="#icon-alert"/></svg> fsrScorecard nÃ£o disponÃ­vel');
        return;
      }
      
      const rep = DATA.fsrScorecard.find(r => r.name === repName);
      if (!rep) {
        log('[REP FILTER] <svg class="icon"><use href="#icon-alert"/></svg> Vendedor nÃ£o encontrado:', repName);
        return;
      }
      
      log('[REP FILTER] Dados do vendedor:', {
        nome: rep.name,
        pipeline: formatMoney(rep.pipeline || 0),
        revenue: formatMoney(rep.revenue || 0),
        revenueGross: formatMoney(rep.revenueGross || 0),
        totalWonQuarter: rep.totalWonQuarter || 0,
        totalWon: rep.totalWon || 0,
        totalLost: rep.totalLost || 0
      });
      
      // Atualiza "Fechado no Quarter" com dados do vendedor (APENAS QUARTER ATUAL)
      const currentQuarter = window.currentQuarterLabel || safe(DATA, 'cloudAnalysis.closed_analysis.closed_quarter.quarter', 'FY26-Q1');
      const repWons = (window.wonAgg || []).filter(d => d.owner === rep.name && d.fiscalQ === currentQuarter);
      const repGross = repWons.reduce((sum, d) => sum + (d.gross || 0), 0);
      const repNet = repWons.reduce((sum, d) => sum + (d.net || 0), 0);
      setTextSafe('exec-closed-total', formatMoney(repGross));
      setTextSafe('exec-closed-net', 'Net: ' + formatMoney(repNet));
      setTextSafe('exec-closed-deals', repWons.length + ' deals ganhos');
      setTextSafe('exec-closed-deals', (rep.totalWonQuarter || 0) + ' deals ganhos');
      setTextSafe('exec-closed-net', 'Net: ' + formatMoney(rep.revenue || 0));
      
      // Atualiza "Taxa de ConversÃ£o" com dados do vendedor
      const totalDealsRep = (rep.totalWon || 0) + (rep.totalLost || 0);
      const conversionRep = totalDealsRep > 0 ? Math.round(((rep.totalWon || 0) / totalDealsRep) * 100) : 0;
      setTextSafe('exec-conversion-rate', conversionRep + '%');
      setTextSafe('exec-conversion-detail', (rep.totalWon || 0) + '/' + totalDealsRep + ' deals');
      
      // Filtra deals abertos do vendedor no weeklyAgenda
      let repDealsGross = 0;
      let repDealsNet = 0;
      let repDealsCount = 0;
      let repDealsAbove50Gross = 0;
      let repDealsAbove50Net = 0;
      let repDealsAbove50Count = 0;
      
      if (DATA.weeklyAgenda) {
        Object.values(DATA.weeklyAgenda).forEach(quarterDeals => {
          if (Array.isArray(quarterDeals)) {
            quarterDeals.forEach(d => {
              if (d.owner === repName) {
                repDealsGross += d.val || 0;
                repDealsNet += d.net || 0;
                repDealsCount++;
                
                const conf = (d.confidence || 0) > 1 ? (d.confidence / 100) : (d.confidence || 0);
                if (conf >= 0.50) {
                  repDealsAbove50Gross += d.val || 0;
                  repDealsAbove50Net += d.net || 0;
                  repDealsAbove50Count++;
                }
              }
            });
          }
        });
      }
      
      log('[REP FILTER] Pipeline do vendedor:', {
        gross: formatMoney(repDealsGross),
        net: formatMoney(repDealsNet),
        count: repDealsCount,
        above50Gross: formatMoney(repDealsAbove50Gross),
        above50Count: repDealsAbove50Count
      });
      
      // Atualiza "Pipeline (PerÃ­odo Filtrado)" - usa pipeline do vendedor
      setTextSafe('exec-pipeline-total', formatMoney(rep.pipeline || 0));
      setTextSafe('exec-pipeline-deals', repDealsCount + ' deals do vendedor');
      setTextSafe('exec-pipeline-net', 'Net: ' + formatMoney(repDealsNet));
      
      // Atualiza "Deals â‰¥50% ConfianÃ§a IA"
      setTextSafe('exec-above50-value', formatMoney(repDealsAbove50Gross));
      setTextSafe('exec-above50-count', repDealsAbove50Count + ' deals');
      setTextSafe('exec-above50-net', 'Net: ' + formatMoney(repDealsAbove50Net));
      
      log('[REP FILTER] ========== FILTRO APLICADO ==========');
    }

    // FunÃ§Ã£o para atualizar dashboard (limpa cache e recarrega)
    function refreshDashboard() {
      const btn = document.querySelector('.refresh-btn');
      btn.classList.add('loading');
      btn.innerHTML = 'â³';
      
      // Adiciona parÃ¢metro de timestamp para forÃ§ar bypass de cache
      const url = new URL(window.location.href);
      url.searchParams.set('nocache', Date.now());
      
      // Recarrega com novo URL
      window.location.href = url.toString();
    }

    // ============================================================================
    // FUNÃ‡Ã•ES ML INTELLIGENCE 
    // ============================================================================
    
    let ML_DATA = null;

    function formatPercentSmart(value) {
      if (value === null || value === undefined) return '0%';
      const num = Number(value) || 0;
      const normalized = num > 1.5 ? num : num * 100;
      return Math.round(normalized) + '%';
    }

    function formatPercentDetailed(value) {
      if (value === null || value === undefined) return '0.0%';
      const num = Number(value) || 0;
      const normalized = num > 1.5 ? num : num * 100;
      return (Math.round(normalized * 10) / 10).toFixed(1) + '%';
    }

    function formatPercentDelta(value) {
      const num = Number(value) || 0;
      const normalized = num > 1.5 ? num : num * 100;
      const sign = normalized > 0 ? '+' : normalized < 0 ? '-' : '';
      return sign + Math.round(Math.abs(normalized)) + '%';
    }

    function formatDateShort(value) {
      if (!value) return 'N/A';
      const dt = new Date(value);
      if (Number.isNaN(dt.getTime())) return String(value);
      return dt.toLocaleDateString('pt-BR');
    }

    function parseIdleDays(value) {
      const num = Number(value);
      return Number.isFinite(num) ? num : null;
    }

    function estimateLastActivity(idleDays) {
      if (idleDays === null || idleDays === undefined) return null;
      const days = Number(idleDays);
      if (!Number.isFinite(days)) return null;
      const ms = Date.now() - (days * 24 * 60 * 60 * 1000);
      return formatDateShort(new Date(ms));
    }

    function formatVelocityLabel(label) {
      if (label === 'RÃPIDO') return 'Rapido (<=30d)';
      if (label === 'NORMAL') return 'Normal (31-60d)';
      if (label === 'LENTO') return 'Lento (61-120d)';
      if (label === 'MUITO_LENTO') return 'Muito lento (121+d)';
      return label || 'N/A';
    }

    function formatLossCause(label) {
      if (!label) return 'N/A';
      const map = {
        MA_QUALIFICACAO: 'Ma qualificacao',
        CONCORRENCIA: 'Concorrente',
        PRECO: 'Preco',
        TIMING: 'Timing',
        BUDGET: 'Budget',
        FIT: 'Fit',
        ABANDONO: 'Abandono',
        CHAMPION_SAIU: 'Champion saiu',
        MUDANCA_ESCOPO: 'Mudanca de escopo',
        OUTROS: 'Outros'
      };
      return map[label] || label;
    }

    function buildMLFilters() {
      const filters = window.currentFilters || {};
      let year = filters.year || '';
      let quarter = filters.quarter || '';
      const seller = filters.seller || '';

      if (quarter) {
        if (quarter.includes('-')) {
          const parts = quarter.match(/FY(\d+)-Q(\d+)/i);
          if (parts) {
            year = year || ('20' + parts[1]);
            quarter = parts[2];
          }
        } else if (quarter.toUpperCase().startsWith('Q')) {
          quarter = quarter.replace(/[^0-9]/g, '');
        }
      }

      const payload = {};
      if (year) payload.year = year;
      if (quarter) payload.quarter = quarter;
      if (seller) payload.seller = seller;
      return payload;
    }

    function loadMLPredictions() {
      log('[ML] Carregando prediÃ§Ãµes...');
      document.getElementById('ml-content-area').innerHTML = '<div class="loading"><svg class="icon"><use href="#icon-robot"/></svg> Carregando prediÃ§Ãµes ML...</div>';

      const filters = buildMLFilters();
      fetch(`${ML_API_URL}/api/ml/predictions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: 'all', filters })
      })
        .then(async (response) => {
          if (!response.ok) {
            const text = await response.text();
            throw new Error(`ML HTTP ${response.status}: ${text}`);
          }
          return response.json();
        })
        .then((data) => {
          ML_DATA = data;
          log('[ML] <svg class="icon"><use href="#icon-check"/></svg> Dados ML carregados');
          switchMLTab('previsao-ciclo');
        })
        .catch((error) => {
          console.error('[ML] <svg class="icon"><use href="#icon-x"/></svg> Erro:', error);
          document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--danger);"><svg class="icon"><use href="#icon-x"/></svg> Erro ao carregar ML</h2></div>';
        });
    }

    function switchMLTab(tabName) {
      document.querySelectorAll('.ml-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.color = 'var(--text-gray)';
        tab.style.borderBottom = '3px solid transparent';
      });
      
      const activeTab = document.querySelector(`.ml-tab[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.color = 'var(--primary-cyan)';
        activeTab.style.borderBottom = '3px solid var(--primary-cyan)';
      }
      
      if (!ML_DATA) return;
      
      if (tabName === 'previsao-ciclo') renderPrevisaoCiclo();
      else if (tabName === 'previsibilidade') renderPrevisibilidade();
      else if (tabName === 'classificador-perda') renderClassificadorPerda();
      else if (tabName === 'risco-abandono') renderRiscoAbandono();
      else if (tabName === 'performance-vendedor') renderPerformanceVendedor();
      else if (tabName === 'prioridade-deals') renderPrioridadeDeals();
      else if (tabName === 'proxima-acao') renderProximaAcao();
      else if (tabName === 'recomendacao-produtos') renderRecomendacaoProdutos();
      else if (tabName === 'deteccao-anomalias') renderDeteccaoAnomalias();
    }

    // Render functions (simplified for space - complete versions inline)
    function renderPrevisaoCiclo() {
      const data = ML_DATA.previsao_ciclo;
      if (!data?.enabled) {
        document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--warning);"><svg class="icon"><use href="#icon-alert"/></svg> Modelo IndisponÃ­vel</h2></div>';
        return;
      }
      const s = data.summary;
      const deals = [...(data.deals || [])].sort((a,b) => (b.dias_previstos||0)-(a.dias_previstos||0)).slice(0,15);
      const topGrossSum = deals.reduce((sum, d) => sum + (d.Gross_Value || 0), 0);
      const topNetSum = deals.reduce((sum, d) => sum + (d.Net_Value || 0), 0);
      const hasNetData = deals.some(d => (d.Net_Value || 0) > 0);
      let html = `<div class="ai-card" style="margin-bottom: 16px; padding: 14px;">
        <div style="font-size: 12px; color: var(--text-gray); line-height: 1.6;">
          <strong>Como calcular:</strong> dias previstos ate o fechamento com base no historico (ganhos + perdidos) e sinais do pipeline.
          <br><strong>Faixas:</strong> Rapido (<=30d), Normal (31-60d), Lento (61-120d), Muito lento (121+d).
        </div>
      </div><div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">Deals</div><div class="kpi-value val-cyan">${data.total_deals}</div></div>
        <div class="kpi-card"><div class="kpi-title">Ciclo MÃ©dio</div><div class="kpi-value val-cyan">${Math.round(s.avg_dias_previstos||0)}d</div></div>
        <div class="kpi-card"><div class="kpi-title">Rapidos (<=30d)</div><div class="kpi-value val-green">${s.rapidos||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Lentos (>=61d)</div><div class="kpi-value val-warning">${(s.lentos||0)+(s.muito_lentos||0)}</div></div>
      </div>
      <div class="ai-card" style="margin: 16px 0; padding: 12px;">
        <div style="font-size: 12px; color: var(--text-gray);">Soma Top 15: <strong>${formatMoney(topGrossSum)}</strong> Gross${hasNetData ? ` | <strong>${formatMoney(topNetSum)}</strong> Net` : ' | Net indisponivel'}</div>
      </div>
      <h4>â±ï¸ Top 15 Deals Mais Lentos</h4>
      <table><thead><tr><th>Deal</th><th>Vendedor</th><th>Gross</th><th>Net</th><th>Dias previstos</th><th>Dias sem atividade</th><th>Ultima atividade</th><th>Velocidade</th><th>Justificativa</th></tr></thead><tbody>`;
      deals.forEach(d => {
        const idleDays = parseIdleDays(d.idle_days);
        const lastActivity = d.ultima_atualizacao ? formatDateShort(d.ultima_atualizacao) : estimateLastActivity(idleDays);
        const reasonParts = [];
        if (idleDays !== null) reasonParts.push(`Inativo ${Math.round(idleDays)}d`);
        if (d.confidence_num !== null && d.confidence_num !== undefined) reasonParts.push(`Conf ${Math.round(d.confidence_num||0)}%`);
        if (d.atividades !== null && d.atividades !== undefined) reasonParts.push(`Ativ ${Math.round(d.atividades||0)}`);
        const reason = reasonParts.length ? reasonParts.join(' â€¢ ') : 'Sem sinais adicionais';
        const netValue = (d.Net_Value || 0) > 0 ? formatMoney(d.Net_Value||0) : '-';
        html += `<tr><td style="font-weight:600;">${d.opportunity||'N/A'}</td><td>${d.Vendedor||'N/A'}</td><td style="font-weight:600;">${formatMoney(d.Gross_Value||0)}</td><td style="font-weight:600;">${netValue}</td><td class="${d.velocidade_prevista==='MUITO_LENTO'?'val-red':d.velocidade_prevista==='LENTO'?'val-warning':'val-cyan'}" style="font-weight:700;">${Math.round(d.dias_previstos||0)}d</td><td>${idleDays !== null ? Math.round(idleDays) + 'd' : 'N/A'}</td><td>${lastActivity || 'N/A'}</td><td><span class="badge badge-${d.velocidade_prevista==='RÃPIDO'?'success':d.velocidade_prevista==='NORMAL'?'warning':'danger'}">${formatVelocityLabel(d.velocidade_prevista)}</span></td><td style="font-size:12px;max-width:260px;">${reason}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('ml-content-area').innerHTML = html;
    }

    function renderPrevisibilidade() {
      const data = ML_DATA.previsibilidade;
      if (!data?.enabled) {
        document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--warning);"><svg class="icon"><use href="#icon-alert"/></svg> Modelo IndisponÃ­vel</h2></div>';
        return;
      }
      const s = data.summary || {};
      const backtest = s.backtest || {};
      const deals = [...(data.deals || [])].sort((a,b) => (b.expected_gross||0)-(a.expected_gross||0)).slice(0,15);
      const avgProb = formatPercentDetailed(s.avg_prob_win || 0);
      const totalClosed = backtest.total_closed || 0;
      const winRate = totalClosed > 0 ? Math.round(((backtest.won_count || 0) / totalClosed) * 100) : 0;
      const accuracy = formatPercentDetailed(backtest.accuracy || 0);
      const avgProbWon = formatPercentDetailed(backtest.avg_prob_win_won || 0);
      const avgProbLost = formatPercentDetailed(backtest.avg_prob_win_lost || 0);

      let html = `<div class="ai-card" style="margin-bottom: 16px; padding: 14px;">
        <div style="font-size: 12px; color: var(--text-gray); line-height: 1.6;">
          <strong>Como calcular:</strong> probabilidade de ganho vem do modelo treinado em historico (ganhos + perdidos).
          <br><strong>Provisionado:</strong> Gross/Net Ã— Prob Win. Isso representa previsao para pipeline aberto (nao fechado).
        </div>
      </div><div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">Provisionado (Gross)</div><div class="kpi-value val-cyan">${formatMoney(s.expected_gross||0)}</div></div>
        <div class="kpi-card"><div class="kpi-title">Provisionado (Net)</div><div class="kpi-value val-cyan">${formatMoney(s.expected_net||0)}</div></div>
        <div class="kpi-card"><div class="kpi-title">Prob Media</div><div class="kpi-value val-cyan">${avgProb}</div></div>
        <div class="kpi-card"><div class="kpi-title">Alta Previsibilidade</div><div class="kpi-value val-green">${s.alta||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Baixa Previsibilidade</div><div class="kpi-value val-warning">${s.baixa||0}</div></div>
      </div>`;

      if (totalClosed > 0) {
        html += `<div class="ai-card" style="margin: 16px 0; padding: 16px;">
          <h4 style="margin: 0 0 12px 0;"><svg class="icon"><use href="#icon-check"/></svg> Backtest em Fechados</h4>
          <div class="kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="kpi-card"><div class="kpi-title">Win Rate Real</div><div class="kpi-value val-green">${winRate}%</div><div class="kpi-subtitle">${backtest.won_count||0} ganhos / ${backtest.lost_count||0} perdidos</div></div>
            <div class="kpi-card"><div class="kpi-title">Prob Media (Won)</div><div class="kpi-value val-green">${avgProbWon}</div></div>
            <div class="kpi-card"><div class="kpi-title">Prob Media (Lost)</div><div class="kpi-value val-red">${avgProbLost}</div></div>
            <div class="kpi-card"><div class="kpi-title">Acuracia</div><div class="kpi-value val-cyan">${accuracy}</div></div>
          </div>
        </div>`;
      } else {
        html += `<div class="ai-card" style="margin: 16px 0; padding: 16px;">
          <h4 style="margin: 0 0 8px 0;"><svg class="icon"><use href="#icon-alert"/></svg> Backtest indisponivel</h4>
          <div style="font-size: 12px; color: var(--text-gray);">Sem fechados para o filtro atual ou modelo ainda nao foi atualizado.</div>
        </div>`;
      }

      html += `<h4><svg class="icon"><use href="#icon-target"/></svg> Top 15 por Provisionado (Gross)</h4>
        <table><thead><tr><th>Deal</th><th>Vendedor</th><th>Gross</th><th>Net</th><th>Prob</th><th>Gross Prov.</th><th>Net Prov.</th><th>Faixa</th></tr></thead><tbody>`;
      deals.forEach(d => html += `<tr><td style="font-weight:600;">${d.opportunity||'N/A'}</td><td>${d.Vendedor||'N/A'}</td><td style="font-weight:600;">${formatMoney(d.Gross_Value||0)}</td><td style="font-weight:600;">${formatMoney(d.Net_Value||0)}</td><td class="val-cyan" style="font-weight:700;">${formatPercentDetailed(d.prob_win||0)}</td><td style="font-weight:700;">${formatMoney(d.expected_gross||0)}</td><td style="font-weight:700;">${formatMoney(d.expected_net||0)}</td><td><span class="badge badge-${d.previsibilidade==='ALTA'?'success':d.previsibilidade==='MEDIA'?'warning':'danger'}">${d.previsibilidade||'N/A'}</span></td></tr>`);
      html += '</tbody></table>';
      document.getElementById('ml-content-area').innerHTML = html;
    }

    function renderClassificadorPerda() {
      const data = ML_DATA.classificador_perda;
      if (!data?.enabled) { document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--warning);"><svg class="icon"><use href="#icon-alert"/></svg> Modelo IndisponÃ­vel</h2></div>'; return; }
      const s = data.summary;
      const deals = [...(data.deals || [])].sort((a,b) => (b.confianca_predicao||0)-(a.confianca_predicao||0)).slice(0,15);
      const buildFactors = (d) => {
        const candidates = [
          { label: 'Preco', prob: d.prob_preco },
          { label: 'Timing', prob: d.prob_timing },
          { label: 'Concorrente', prob: d.prob_concorrente },
          { label: 'Budget', prob: d.prob_budget },
          { label: 'Fit', prob: d.prob_fit }
        ].filter(item => item.prob !== null && item.prob !== undefined);
        candidates.sort((a, b) => (b.prob || 0) - (a.prob || 0));
        return candidates.slice(0, 2).map(item => `${item.label} ${formatPercentDetailed(item.prob || 0)}`).join(' | ') || 'N/A';
      };
      let html = `<div class="ai-card" style="margin-bottom: 16px; padding: 14px;">
        <div style="font-size: 12px; color: var(--text-gray); line-height: 1.6;">
          <strong>Como calcular:</strong> causa prevista pelo modelo com base no historico de perdas.
          <br><strong>Confianca:</strong> probabilidade da causa ser a principal.
        </div>
      </div><div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">PREÃ‡O</div><div class="kpi-value val-red">${s.preco||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">TIMING</div><div class="kpi-value val-warning">${s.timing||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">CONCORRENTE</div><div class="kpi-value val-red">${s.concorrente||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">BUDGET</div><div class="kpi-value val-warning">${s.budget||0}</div></div>
      </div><h4><svg class="icon"><use href="#icon-x"/></svg> Top 15 em Risco de Perda</h4><table><thead><tr><th>Deal</th><th>Vendedor</th><th>Gross</th><th>Net</th><th>Causa</th><th>ConfianÃ§a</th><th>Fatores</th></tr></thead><tbody>`;
      deals.forEach(d => html += `<tr><td style="font-weight:600;">${d.opportunity||'N/A'}</td><td>${d.Vendedor||'N/A'}</td><td style="font-weight:600;">${formatMoney(d.Gross_Value||0)}</td><td style="font-weight:600;">${formatMoney(d.Net_Value||0)}</td><td><span class="badge badge-${d.causa_prevista==='PRECO'||d.causa_prevista==='CONCORRENTE'?'danger':'warning'}">${formatLossCause(d.causa_prevista)}</span></td><td class="val-cyan" style="font-weight:700;">${formatPercentDetailed(d.confianca_predicao||0)}</td><td style="font-size:12px;max-width:220px;">${buildFactors(d)}</td></tr>`);
      html += '</tbody></table>';
      document.getElementById('ml-content-area').innerHTML = html;
    }

    function renderRiscoAbandono() {
      const data = ML_DATA.risco_abandono;
      if (!data?.enabled) { document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--warning);"><svg class="icon"><use href="#icon-alert"/></svg> Modelo IndisponÃ­vel</h2></div>'; return; }
      const s = data.summary;
      const deals = [...(data.deals || [])].sort((a,b) => (b.prob_abandono||0)-(a.prob_abandono||0)).slice(0,15);
      let html = `<div class="ai-card" style="margin-bottom: 16px; padding: 14px;">
        <div style="font-size: 12px; color: var(--text-gray); line-height: 1.6;">
          <strong>Como calcular:</strong> o modelo estima probabilidade de abandono com base em inatividade, sinais de risco e historico.
          <br><strong>Faixas:</strong> Alto (>=60%), Medio (40-59%), Baixo (<40%).
        </div>
      </div><div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">ALTO Risco</div><div class="kpi-value val-red">${s.alto_risco||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">MÃ‰DIO Risco</div><div class="kpi-value val-warning">${s.medio_risco||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">BAIXO Risco</div><div class="kpi-value val-green">${s.baixo_risco||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Prob MÃ©dia</div><div class="kpi-value val-cyan">${formatPercentDetailed(s.avg_prob_abandono||0)}</div></div>
      </div><h4><svg class="icon" style="color:var(--error)"><use href="#icon-alert"/></svg> Top 15 em Risco de Abandono</h4><table><thead><tr><th>Deal</th><th>Vendedor</th><th>Valor</th><th>NÃ­vel</th><th>Prob.</th></tr></thead><tbody>`;
      deals.forEach(d => html += `<tr><td style="font-weight:600;">${d.opportunity||'N/A'}</td><td>${d.Vendedor||'N/A'}</td><td style="font-weight:600;">${formatMoney(d.Gross_Value||0)}</td><td><span class="badge badge-${d.nivel_risco==='ALTO'?'danger':d.nivel_risco==='MÃ‰DIO'?'warning':'success'}">${d.nivel_risco||'N/A'}</span></td><td class="val-red" style="font-weight:700;">${formatPercentDetailed(d.prob_abandono||0)}</td></tr>`);
      html += '</tbody></table>';
      document.getElementById('ml-content-area').innerHTML = html;
    }

    function renderPerformanceVendedor() {
      const data = ML_DATA.performance_vendedor;
      if (!data?.enabled) { document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--warning);"><svg class="icon"><use href="#icon-alert"/></svg> Modelo IndisponÃ­vel</h2></div>'; return; }
      const s = data.summary;
      const sellers = [...(data.sellers || [])].sort((a,b) => (a.ranking||999)-(b.ranking||999));
      let html = `<div class="ai-card" style="margin-bottom: 16px; padding: 14px;">
        <div style="font-size: 12px; color: var(--text-gray); line-height: 1.6;">
          <strong>Como calcular:</strong> win rate previsto vem do modelo treinado em historico (ganhos + perdidos).
          <br><strong>Delta:</strong> diferenca entre previsto e historico do vendedor.
        </div>
      </div><div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">Sobre-performando</div><div class="kpi-value val-green">${s.sobre_performando||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Na Meta</div><div class="kpi-value val-cyan">${s.na_meta||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Abaixo Meta</div><div class="kpi-value val-warning">${s.abaixo_meta||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Win Rate Medio</div><div class="kpi-value val-cyan">${formatPercentSmart(s.avg_win_rate||0)}</div></div>
      </div><h4><svg class="icon"><use href="#icon-user"/></svg> Ranking de Performance</h4><table><thead><tr><th>#</th><th>Vendedor</th><th>Win Rate</th><th>Delta</th><th>Valor</th><th>Classe</th></tr></thead><tbody>`;
      sellers.forEach(v => html += `<tr><td style="font-weight:700;color:var(--primary-cyan);">#${v.ranking||'N/A'}</td><td style="font-weight:600;">${v.Vendedor||'N/A'}</td><td class="val-cyan" style="font-weight:700;">${formatPercentSmart(v.win_rate_previsto||0)}</td><td class="${(v.delta_performance||0)>0?'val-green':(v.delta_performance||0)<0?'val-red':'val-cyan'}" style="font-weight:600;">${formatPercentDelta(v.delta_performance||0)}</td><td style="font-weight:600;">${formatMoney(v.valor_previsto_venda||0)}</td><td><span class="badge badge-${v.classificacao==='SOBRE_PERFORMANDO'||v.classificacao==='PERFORMANDO_BEM'?'success':v.classificacao==='NA_META'?'warning':'danger'}">${v.classificacao||'N/A'}</span></td></tr>`);
      html += '</tbody></table>';
      document.getElementById('ml-content-area').innerHTML = html;
    }

    function renderPrioridadeDeals() {
      const data = ML_DATA.prioridade_deals;
      if (!data?.enabled) { document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--warning);"><svg class="icon"><use href="#icon-alert"/></svg> Modelo IndisponÃ­vel</h2></div>'; return; }
      const s = data.summary;
      const deals = [...(data.deals || [])].sort((a,b) => (a.ranking_global||999)-(b.ranking_global||999)).slice(0,20);
      let html = `<div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">CRÃTICO</div><div class="kpi-value val-red">${s.critico||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">ALTO</div><div class="kpi-value val-warning">${s.alto||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">MÃ‰DIO</div><div class="kpi-value val-cyan">${s.medio||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Score MÃ©dio</div><div class="kpi-value val-cyan">${Math.round(s.avg_priority_score||0)}</div></div>
      </div><h4><svg class="icon"><use href="#icon-star"/></svg> Top 20 Prioridade MÃXIMA</h4><table><thead><tr><th>#</th><th>Deal</th><th>Vendedor</th><th>Valor</th><th>Score</th><th>NÃ­vel</th></tr></thead><tbody>`;
      deals.forEach(d => html += `<tr><td style="font-weight:700;color:var(--primary-cyan);">#${d.ranking_global||'N/A'}</td><td style="font-weight:600;">${d.opportunity||'N/A'}</td><td>${d.Vendedor||'N/A'}</td><td style="font-weight:600;">${formatMoney(d.Gross_Value||0)}</td><td class="val-cyan" style="font-weight:700;font-size:16px;">${Math.round(d.priority_score||0)}</td><td><span class="badge badge-${d.priority_level==='CRÃTICO'?'danger':d.priority_level==='ALTO'?'warning':'warning'}">${d.priority_level||'N/A'}</span></td></tr>`);
      html += '</tbody></table>';
      document.getElementById('ml-content-area').innerHTML = html;
    }

    function renderProximaAcao() {
      const data = ML_DATA.proxima_acao;
      if (!data?.enabled) { document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--warning);"><svg class="icon"><use href="#icon-alert"/></svg> Modelo IndisponÃ­vel</h2></div>'; return; }
      const s = data.summary;
      const urgOrder = {'ALTA': 1, 'MÃ‰DIA': 2, 'BAIXA': 3};
      const deals = [...(data.deals || [])].sort((a,b) => {
        const urgA = urgOrder[a.urgencia] || 9;
        const urgB = urgOrder[b.urgencia] || 9;
        return urgA !== urgB ? urgA - urgB : (b.Gross_Value||0) - (a.Gross_Value||0);
      }).slice(0,25);
      let html = `<div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">URGENTES</div><div class="kpi-value val-red">${s.urgentes||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">MÃ‰DIAS</div><div class="kpi-value val-warning">${s.medias||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">BAIXAS</div><div class="kpi-value val-cyan">${s.baixas||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Top Categoria</div><div class="kpi-value val-cyan" style="font-size:14px;">${Object.keys(s.top_categorias||{})[0]||'N/A'}</div></div>
      </div><h4><svg class="icon"><use href="#icon-idea"/></svg> Top 25 AÃ§Ãµes PrioritÃ¡rias</h4><table><thead><tr><th>Deal</th><th>Vendedor</th><th>Valor</th><th>UrgÃªncia</th><th>AÃ§Ã£o Recomendada</th></tr></thead><tbody>`;
      deals.forEach(d => html += `<tr><td style="font-weight:600;">${d.opportunity||'N/A'}</td><td>${d.Vendedor||'N/A'}</td><td style="font-weight:600;">${formatMoney(d.Gross_Value||0)}</td><td><span class="badge badge-${d.urgencia==='ALTA'?'danger':d.urgencia==='MÃ‰DIA'?'warning':'success'}">${d.urgencia||'N/A'}</span></td><td style="font-size:12px;max-width:300px;">${d.acao_recomendada||'N/A'}</td></tr>`);
      html += '</tbody></table>';
      document.getElementById('ml-content-area').innerHTML = html;
    }

    function renderRecomendacaoProdutos() {
      const data = ML_DATA.recomendacao_produtos;
      if (!data?.enabled) { document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--warning);"><svg class="icon"><use href="#icon-alert"/></svg> Modelo IndisponÃ­vel</h2></div>'; return; }
      const s = data.summary || {};
      const rows = [...(data.rows || [])].slice(0, 25);
      let html = `<div class="ai-card" style="margin-bottom: 16px; padding: 14px;">
        <div style="font-size: 12px; color: var(--text-gray); line-height: 1.6;">
          <strong>Como calcular:</strong> recomendacoes baseadas em ganhos historicos por vendedor e portfolio.
          <br><strong>Score:</strong> forca da recomendacao pelo modelo de fatores latentes.
        </div>
      </div><div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">Vendedores</div><div class="kpi-value val-cyan">${s.total_sellers||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">RecomendaÃ§Ãµes</div><div class="kpi-value val-cyan">${s.total_recomendacoes||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Score MÃ©dio</div><div class="kpi-value val-cyan">${(s.avg_score||0).toFixed(2)}</div></div>
      </div><h4><svg class="icon"><use href="#icon-idea"/></svg> Top RecomendaÃ§Ãµes</h4><table><thead><tr><th>Vendedor</th><th>Quarter</th><th>Produto</th><th>Score</th><th>Wins</th><th>Avg Net</th><th>Pipeline</th><th>AÃ§Ã£o</th></tr></thead><tbody>`;
      rows.forEach(r => {
        const avgNet = formatMoney(r.avg_net || 0);
        html += `<tr><td style="font-weight:600;">${r.Vendedor||'N/A'}</td><td>${r.Fiscal_Q||'N/A'}</td><td>${r.recomendacao_produto||'N/A'}</td><td class="val-cyan" style="font-weight:700;">${(r.score||0).toFixed(2)}</td><td>${r.wins_historico||0}</td><td style="font-weight:600;">${avgNet}</td><td>${r.pipeline_deals||0}</td><td style="font-size:12px;max-width:260px;">${r.recomendacao_acao||'N/A'}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('ml-content-area').innerHTML = html;
    }

    function renderDeteccaoAnomalias() {
      const data = ML_DATA.deteccao_anomalias;
      if (!data?.enabled) { document.getElementById('ml-content-area').innerHTML = '<div class="ai-card"><h2 style="color:var(--warning);"><svg class="icon"><use href="#icon-alert"/></svg> Modelo IndisponÃ­vel</h2></div>'; return; }
      const s = data.summary || {};
      const rows = [...(data.rows || [])].slice(0, 25);
      let html = `<div class="ai-card" style="margin-bottom: 16px; padding: 14px;">
        <div style="font-size: 12px; color: var(--text-gray); line-height: 1.6;">
          <strong>Como calcular:</strong> identifica deals fora do padrao de valor, ciclo e atividade.
          <br><strong>Severidade:</strong> score alto indica maior desvio do cluster.
        </div>
      </div><div class="kpi-grid">
        <div class="kpi-card"><div class="kpi-title">Anomalias</div><div class="kpi-value val-red">${s.total_anomalias||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Vendedores</div><div class="kpi-value val-cyan">${s.total_sellers||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Alta Severidade</div><div class="kpi-value val-red">${s.alta||0}</div></div>
        <div class="kpi-card"><div class="kpi-title">Score MÃ©dio</div><div class="kpi-value val-cyan">${(s.avg_score||0).toFixed(2)}</div></div>
      </div><h4><svg class="icon"><use href="#icon-alert"/></svg> Top Anomalias</h4><table><thead><tr><th>Deal</th><th>Vendedor</th><th>Gross</th><th>Net</th><th>Ciclo</th><th>Idle</th><th>Conf.</th><th>Score</th><th>Sev.</th><th>AÃ§Ã£o</th></tr></thead><tbody>`;
      rows.forEach(r => {
        const sev = r.severidade || 'N/A';
        const sevClass = sev === 'ALTA' ? 'danger' : sev === 'MEDIA' ? 'warning' : 'success';
        html += `<tr><td style="font-weight:600;">${r.opportunity||'N/A'}</td><td>${r.Vendedor||'N/A'}</td><td style="font-weight:600;">${formatMoney(r.Gross_Value||0)}</td><td style="font-weight:600;">${formatMoney(r.Net_Value||0)}</td><td>${r.ciclo_dias||0}d</td><td>${r.idle_days||0}d</td><td>${formatPercentDetailed(r.confianca||0)}</td><td class="val-cyan" style="font-weight:700;">${(r.anomaly_score||0).toFixed(2)}</td><td><span class="badge badge-${sevClass}">${sev}</span></td><td style="font-size:12px;max-width:240px;">${r.acao_recomendada||'N/A'}</td></tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('ml-content-area').innerHTML = html;
    }

    // ==================== PERFORMANCE FSR FUNCTIONS ====================
    
    // Build Performance API Query with Global Filters
    function buildPerformanceQuery() {
      const filters = window.currentFilters || {};
      const params = new URLSearchParams();
      
      // Extract year and quarter from filters
      let year = filters.year;
      let quarter = filters.quarter;
      
      // Processar quarter em diferentes formatos
      if (quarter) {
        // Formato: "FY26-Q1" -> extrair year e quarter
        if (quarter.includes('-')) {
          const parts = quarter.match(/FY(\d+)-Q(\d+)/);
          if (parts) {
            year = '20' + parts[1]; // FY26 -> 2026
            quarter = parts[2]; // Q1 -> 1
          }
        } 
        // Formato: "Q1", "Q2", etc -> extrair apenas nÃºmero
        else if (quarter.startsWith('Q')) {
          quarter = quarter.replace('Q', ''); // Q1 -> 1
        }
      }
      
      // Adicionar year e quarter se disponÃ­veis
      if (year) params.append('year', year);
      if (quarter) params.append('quarter', quarter);
      
      // Adicionar seller se filtrado
      if (filters.seller) {
        params.append('seller', filters.seller);
      }
      
      const queryString = params.toString();
      log('[PERFORMANCE FSR] Filtros aplicados:', { year, quarter, seller: filters.seller });
      log('[PERFORMANCE FSR] Query string:', queryString);
      
      return queryString ? '?' + queryString : '';
    }
    
    // Load Performance Data from API with Filters
    async function loadPerformanceData() {
      showLoading('Carregando Performance FSR');
      
      try {
        const queryString = buildPerformanceQuery();
        const url = `${API_BASE_URL}/api/performance${queryString}`;
        
        log('[PERFORMANCE FSR] Buscando:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error('API returned error');
        }
        
        log('[PERFORMANCE FSR] Data loaded:', data);
        
        // Render IPV Ranking
        renderRankingIPV(data.ranking);
        
        // Render Scorecard
        renderScorecard(data.scorecard);
        
        // Render Comportamento
        renderComportamento(data.comportamento);
        
        hideLoading();
        
      } catch (error) {
        console.error('[PERFORMANCE FSR] Error:', error);
        hideLoading();
        alert(`Erro ao carregar dados de performance: ${error.message}`);
      }
    }
    
    // Apply Filters to Performance FSR (chamado quando filtros mudam)
    function applyFiltersToPerformance() {
      // Verifica se a seÃ§Ã£o FSR estÃ¡ ativa
      const fsrSection = document.getElementById('fsr');
      if (fsrSection && fsrSection.classList.contains('active')) {
        log('[PERFORMANCE FSR] <svg class="icon"><use href="#icon-refresh"/></svg> Recarregando com novos filtros...');
        loadPerformanceData();
      }
    }
    
    // Render IPV Ranking Table
    function renderRankingIPV(ranking) {
      const tbody = document.getElementById('fsr-ipv-table');
      tbody.innerHTML = '';
      
      if (!ranking || ranking.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-gray)">Sem dados disponÃ­veis</td></tr>';
        return;
      }
      
      ranking.forEach(seller => {
        const ipv = seller.ipv || 0;
        let ipvClass = 'badge-warning';
        if (ipv >= 80) ipvClass = 'badge-success';
        else if (ipv < 50) ipvClass = 'badge-danger';
        
        const resultClass = seller.resultado >= 70 ? 'badge-success' : 
                            seller.resultado >= 50 ? 'badge-warning' : 'badge-danger';
        const effClass = seller.eficiencia >= 70 ? 'badge-success' : 
                         seller.eficiencia >= 50 ? 'badge-warning' : 'badge-danger';
        const behavClass = seller.comportamento >= 70 ? 'badge-success' : 
                           seller.comportamento >= 50 ? 'badge-warning' : 'badge-danger';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight:700;color:var(--primary-cyan);font-size:1.2em;">#${seller.rank}</td>
          <td style="font-weight:600;color:#fff;">${seller.vendedor}</td>
          <td><span class="badge ${ipvClass}" style="font-size:1.1em;padding:8px 12px;">${ipv}</span></td>
          <td><span class="badge ${resultClass}">${seller.resultado}</span></td>
          <td><span class="badge ${effClass}">${seller.eficiencia}</span></td>
          <td><span class="badge ${behavClass}">${seller.comportamento}</span></td>
          <td>${seller.winRate}%</td>
          <td style="font-weight:600;color:var(--primary-cyan);">${formatMoney(seller.netGerado)}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Render Scorecard Table
    function renderScorecard(scorecard) {
      const tbody = document.getElementById('fsr-performance-active-body');
      tbody.innerHTML = '';
      
      if (!scorecard || scorecard.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-gray)">Sem dados disponÃ­veis</td></tr>';
        return;
      }
      
      scorecard.forEach(seller => {
        const wr = seller.winRate || 0;
        let winRateClass = 'badge-warning';
        if (wr >= 80) winRateClass = 'badge-success';
        else if (wr < 40) winRateClass = 'badge-danger';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight:600;color:#fff;">${seller.vendedor}</td>
          <td><span class="badge ${winRateClass}">${wr}%</span></td>
          <td>${seller.totalGanhos}</td>
          <td>${seller.totalPerdas}</td>
          <td style="color:var(--success);">${seller.cicloMedioWin}d</td>
          <td style="color:var(--danger);">${seller.cicloMedioLoss}d</td>
          <td>${formatMoney(seller.ticketMedio)}</td>
          <td style="font-weight:600;color:var(--success);">${formatMoney(seller.grossGerado)}</td>
          <td style="font-weight:600;color:var(--primary-cyan);">${formatMoney(seller.netGerado)}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Render Comportamento Table
    function renderComportamento(comportamento) {
      const tbody = document.getElementById('fsr-behavior-active-body');
      tbody.innerHTML = '';
      
      if (!comportamento || comportamento.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-gray)">Sem dados disponÃ­veis</td></tr>';
        return;
      }
      
      comportamento.forEach(seller => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight:600;color:#fff;">${seller.vendedor}</td>
          <td style="color:var(--success);">${seller.ativMediaWin}</td>
          <td style="color:var(--danger);">${seller.ativMediaLoss}</td>
          <td style="font-size:12px;color:var(--text-gray);">${seller.principalCausaPerda}</td>
          <td style="font-size:12px;color:var(--text-gray);">${seller.principalFatorSucesso}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ==================== XERTICA LOADING OVERLAY ====================
    function showLoading(message = 'Sincronizando dados') {
      const overlay = document.getElementById('xertica-loading-overlay');
      const textElement = document.getElementById('xertica-loading-text');
      if (textElement) textElement.innerHTML = message + '<span class="xertica-loading-dots"><span>.</span><span>.</span><span>.</span></span>';
      if (overlay) overlay.classList.add('active');
      log('[LOADING] <svg class="icon"><use href="#icon-refresh"/></svg>', message);
    }

    function hideLoading() {
      const overlay = document.getElementById('xertica-loading-overlay');
      if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.classList.remove('active');
          overlay.style.opacity = '';
        }, 300);
      }
      log('[LOADING] <svg class="icon"><use href="#icon-check"/></svg> ConcluÃ­do');
    }
  </script>

  <!-- Weekly Agenda Enhanced Script (cache-bust) -->
  <script src="weekly-agenda-new.js?v=20260212-0015"></script>

  <!-- Xertica Loading Overlay -->
  <div id="xertica-loading-overlay" class="xertica-loading-overlay">
    <div class="xertica-loading-container loader-card">
      <div class="loader-brand">
        <img class="loader-logo" src="https://storage.googleapis.com/etp-bucket/Logos%20Xertica.ai%20(.png)/X%20-%20simbolo/Copy%20of%20X_symbol_variation3_Blue_white.png" alt="Xertica.ai" />
        <div class="loader-wordmark">Xertica</div>
      </div>
      <div id="xertica-loading-text" class="xertica-loading-text">
        Sincronizando dados<span class="xertica-loading-dots"><span>.</span><span>.</span><span>.</span></span>
      </div>
      <div class="loader-progress">
        <div class="loader-progress-bar"></div>
      </div>
    </div>
  </div>

</body>
</html>
