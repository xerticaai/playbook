<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Net Revenue — Xertica.ai</title>
  <link rel="icon" type="image/png" href="https://storage.googleapis.com/etp-bucket/Logos%20Xertica.ai%20(.png)/X%20-%20simbolo/Copy%20of%20X_symbol_variation3_Blue_white.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --cyan:        #00BEFF;
      --cyan-dim:    rgba(0,190,255,0.12);
      --cyan-border: rgba(0,190,255,0.22);
      --success:     #C0FF7D;
      --warning:     #FFA500;
      --danger:      #E14849;
      --bg-deep:     #050a10;
      --bg-card:     #111827;
      --surface:     rgba(18,28,41,0.72);
      --text-main:   #e2e8f0;
      --text-muted:  #8899aa;
      --text-white:  #ffffff;
      --pago-color:  #C0FF7D;
      --pend-color:  #FFA500;
      --anul-color:  #E14849;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-deep);
      background-image:
        linear-gradient(rgba(0,190,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,190,255,0.03) 1px, transparent 1px),
        radial-gradient(circle at 50% 0%, rgba(0,190,255,0.13) 0%, transparent 60%);
      background-size: 40px 40px, 40px 40px, 100% 100%;
      color: var(--text-main);
      min-height: 100vh;
    }

    /* ── Header ── */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 22px 32px 16px;
      border-bottom: 1px solid var(--cyan-border);
      background: rgba(5,10,16,0.82);
      backdrop-filter: blur(12px);
      position: sticky; top: 0; z-index: 100;
      gap: 16px; flex-wrap: wrap;
    }
    .page-title {
      font-family: 'Poppins', sans-serif;
      font-size: 20px; font-weight: 700;
      color: var(--text-white);
      display: flex; align-items: center; gap: 10px;
    }
    .page-title span.badge {
      font-size: 11px; font-weight: 600;
      background: var(--cyan-dim);
      border: 1px solid var(--cyan-border);
      color: var(--cyan); padding: 2px 8px; border-radius: 20px;
      letter-spacing: 0.5px;
    }
    .back-link {
      font-size: 13px; color: var(--text-muted);
      text-decoration: none; display: flex; align-items: center; gap: 5px;
      transition: color .2s;
    }
    .back-link:hover { color: var(--cyan); }

    /* ── Filter bar ── */
    .filter-bar {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 32px;
      background: rgba(10,16,26,0.6);
      border-bottom: 1px solid rgba(0,190,255,0.08);
      flex-wrap: wrap;
    }
    .filter-bar label {
      font-size: 12px; color: var(--text-muted); white-space: nowrap;
    }
    .filter-bar select, .filter-bar button {
      background: rgba(18,28,41,0.9);
      border: 1px solid rgba(0,190,255,0.2);
      color: var(--text-main);
      border-radius: 6px; padding: 6px 12px;
      font-size: 13px; cursor: pointer;
    }
    .filter-bar select:focus { outline: none; border-color: var(--cyan); }
    .filter-bar button.btn-apply {
      background: var(--cyan); color: #000;
      font-weight: 600; border: none;
      transition: opacity .2s;
    }
    .filter-bar button.btn-apply:hover { opacity: .85; }
    .filter-bar button.btn-clear {
      background: transparent; color: var(--text-muted);
    }
    .filter-bar button.btn-clear:hover { color: var(--text-main); }
    .active-context {
      margin-left: auto; font-size: 12px; color: var(--cyan);
      background: var(--cyan-dim); border: 1px solid var(--cyan-border);
      padding: 4px 12px; border-radius: 20px; white-space: nowrap;
    }

    /* ── Main layout ── */
    .main { padding: 28px 32px; max-width: 1440px; margin: 0 auto; }

    /* ── Section title ── */
    .section-title {
      font-family: 'Poppins', sans-serif;
      font-size: 13px; font-weight: 600;
      color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase;
      margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
    }
    .section-title::after {
      content: ''; flex: 1; height: 1px;
      background: rgba(0,190,255,0.12);
    }

    /* ── Cards ── */
    .cards-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px; margin-bottom: 28px;
    }
    @media(max-width: 900px) { .cards-row { grid-template-columns: repeat(2,1fr); } }
    @media(max-width: 560px) { .cards-row { grid-template-columns: 1fr; } }

    .card {
      background: var(--surface);
      border: 1px solid var(--cyan-border);
      border-radius: 12px; padding: 20px 22px;
      backdrop-filter: blur(10px);
      display: flex; flex-direction: column; gap: 6px;
      transition: border-color .2s;
    }
    .card:hover { border-color: rgba(0,190,255,0.4); }
    .card-label {
      font-size: 11px; font-weight: 600;
      letter-spacing: .8px; text-transform: uppercase;
      color: var(--text-muted);
    }
    .card-value {
      font-family: 'Poppins', sans-serif;
      font-size: 26px; font-weight: 700;
      color: var(--text-white); line-height: 1.1;
    }
    .card-sub {
      font-size: 12px; color: var(--text-muted); margin-top: 2px;
    }
    .card-badge {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 11px; font-weight: 600;
      padding: 3px 8px; border-radius: 20px; margin-top: 4px;
      width: fit-content;
    }
    .badge-success { background: rgba(192,255,125,0.12); color: var(--success); }
    .badge-warning { background: rgba(255,165,0,0.12);   color: var(--warning); }
    .badge-danger  { background: rgba(225,72,73,0.12);   color: var(--danger); }
    .badge-info    { background: var(--cyan-dim);        color: var(--cyan); }

    /* attainment gauge-bar */
    .att-bar-wrap {
      margin-top: 8px;
      background: rgba(255,255,255,0.06);
      border-radius: 4px; height: 5px; overflow: hidden;
    }
    .att-bar-fill {
      height: 100%; border-radius: 4px;
      background: linear-gradient(90deg, var(--cyan), #7af0ff);
      transition: width .6s ease;
    }

    /* ── Charts row ── */
    .charts-row {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 20px; margin-bottom: 28px;
    }
    @media(max-width: 860px) { .charts-row { grid-template-columns: 1fr; } }
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--cyan-border);
      border-radius: 12px; padding: 22px;
      backdrop-filter: blur(10px);
    }
    .chart-card h3 {
      font-family: 'Poppins', sans-serif;
      font-size: 14px; font-weight: 600;
      color: var(--text-main); margin-bottom: 18px;
      display: flex; align-items: center; gap: 8px;
    }
    .chart-wrap { position: relative; height: 240px; }

    /* ── Tables row ── */
    .tables-row {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media(max-width: 860px) { .tables-row { grid-template-columns: 1fr; } }
    .table-card {
      background: var(--surface);
      border: 1px solid var(--cyan-border);
      border-radius: 12px; overflow: hidden;
      backdrop-filter: blur(10px);
    }
    .table-card h3 {
      font-family: 'Poppins', sans-serif;
      font-size: 14px; font-weight: 600;
      color: var(--text-main);
      padding: 16px 20px 12px;
      border-bottom: 1px solid rgba(0,190,255,0.1);
      display: flex; align-items: center; gap: 8px;
    }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      font-size: 11px; font-weight: 600; letter-spacing: .6px;
      text-transform: uppercase; color: var(--text-muted);
      padding: 10px 16px; text-align: left;
      border-bottom: 1px solid rgba(0,190,255,0.08);
    }
    thead th:last-child { text-align: right; }
    tbody tr { transition: background .15s; }
    tbody tr:hover { background: rgba(0,190,255,0.04); }
    tbody td {
      font-size: 13px; padding: 9px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      color: var(--text-main);
    }
    tbody td:last-child { text-align: right; font-weight: 600; }
    .pct-bar {
      display: flex; align-items: center; gap: 8px;
    }
    .pct-bar-bg {
      flex: 1; background: rgba(255,255,255,0.06);
      border-radius: 3px; height: 4px; overflow: hidden;
    }
    .pct-bar-fill {
      height: 100%; border-radius: 3px;
      background: linear-gradient(90deg, var(--cyan), #7af0ff);
    }

    /* ── Loading / error / empty states ── */
    .state-overlay {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 10px; border-radius: 12px;
      background: rgba(5,10,16,0.65);
    }
    .spinner {
      width: 28px; height: 28px;
      border: 3px solid rgba(0,190,255,0.2);
      border-top-color: var(--cyan);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .state-msg { font-size: 13px; color: var(--text-muted); }
    .state-err  { font-size: 13px; color: var(--danger); }
  </style>
</head>
<body>

<!-- ── Header ── -->
<header class="page-header">
  <div class="page-title">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
    </svg>
    Net Revenue
    <span class="badge">ERP · mart_l10</span>
  </div>
  <a class="back-link" href="../index.html">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
    Voltar ao Dashboard
  </a>
</header>

<!-- ── Filter bar ── -->
<div class="filter-bar">
  <label>Quarter fiscal</label>
  <select id="flt-quarter">
    <option value="">Todos</option>
    <option value="FY26-Q1" selected>FY26-Q1</option>
    <option value="FY26-Q2">FY26-Q2</option>
    <option value="FY26-Q3">FY26-Q3</option>
    <option value="FY26-Q4">FY26-Q4</option>
  </select>

  <label>Squad</label>
  <select id="flt-squad">
    <option value="">Todos</option>
    <option value="Contas Nomeadas">Contas Nomeadas</option>
    <option value="Sales Outras GTM">Sales Outras GTM</option>
    <option value="CS">CS</option>
    <option value="SS">SS</option>
    <option value="NAO_GTM">NAO_GTM</option>
  </select>

  <label>Portfolio</label>
  <select id="flt-portfolio">
    <option value="">Todos</option>
    <option value="Workspace">Workspace</option>
    <option value="GCP">GCP</option>
    <option value="MSP">MSP</option>
  </select>

  <button class="btn-apply" onclick="loadData()">Aplicar</button>
  <button class="btn-clear" onclick="clearFilters()">Limpar</button>

  <div class="active-context" id="active-context">FY26-Q1</div>
</div>

<!-- ── Main ── -->
<main class="main">

  <!-- Cards -->
  <div class="section-title">KPIs de Revenue</div>
  <div class="cards-row">

    <div class="card">
      <div class="card-label">Net Revenue Realizado</div>
      <div class="card-value" id="card-net-total">—</div>
      <div class="card-sub">Líquido após custo Google</div>
      <div class="card-badge badge-info" id="card-net-linhas">— faturas</div>
    </div>

    <div class="card">
      <div class="card-label">Net Pago</div>
      <div class="card-value" id="card-net-pago">—</div>
      <div class="card-sub">Pagada + Intercompañia</div>
      <div class="card-badge badge-success" id="card-net-pago-pct">—%</div>
    </div>

    <div class="card">
      <div class="card-label">Net Pendente</div>
      <div class="card-value" id="card-net-pend">—</div>
      <div class="card-sub">Pendiente + Não informado</div>
      <div class="card-badge badge-warning" id="card-net-pend-pct">—%</div>
    </div>

    <div class="card">
      <div class="card-label">Attainment Net vs Meta</div>
      <div class="card-value" id="card-att-pct">—</div>
      <div class="card-sub" id="card-att-sub">Meta: — | Realizado: —</div>
      <div class="att-bar-wrap">
        <div class="att-bar-fill" id="att-bar" style="width:0%"></div>
      </div>
    </div>

  </div>

  <!-- Charts -->
  <div class="section-title">Evolução Temporal</div>
  <div class="charts-row">

    <div class="chart-card">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        Net Revenue Semanal
      </h3>
      <div class="chart-wrap">
        <canvas id="chart-semanal"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/>
        </svg>
        Pago × Pendente por Mês
      </h3>
      <div class="chart-wrap">
        <canvas id="chart-mensal"></canvas>
      </div>
    </div>

  </div>

  <!-- Breakdown tables -->
  <div class="section-title">Breakdown</div>
  <div class="tables-row">

    <div class="table-card">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        </svg>
        Por Portfolio
      </h3>
      <table>
        <thead>
          <tr><th>Portfolio</th><th>Gross</th><th>Net</th><th style="text-align:center">% Net</th></tr>
        </thead>
        <tbody id="tbody-portfolio">
          <tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:24px">Carregando...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="table-card">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        Por Squad
      </h3>
      <table>
        <thead>
          <tr><th>Squad</th><th>Gross</th><th>Net</th><th style="text-align:center">% Net</th></tr>
        </thead>
        <tbody id="tbody-squad">
          <tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:24px">Carregando...</td></tr>
        </tbody>
      </table>
    </div>

  </div>

</main>

<script>
// ── Config ──
const API_BASE = window.location.origin;
const CHART_DEFAULTS = {
  responsive: true, maintainAspectRatio: false,
  plugins: { legend: { display: true, labels: { color: '#8899aa', boxWidth: 12, font: { size: 11 } } } },
  scales: {
    x: { ticks: { color: '#8899aa', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
    y: { ticks: { color: '#8899aa', font: { size: 10 }, callback: v => '$' + fmtK(v) }, grid: { color: 'rgba(255,255,255,0.06)' } }
  }
};
let chartSemanal = null, chartMensal = null;

// ── Formatters ──
function fmtMoney(v) {
  if (v == null || isNaN(v)) return '—';
  if (v >= 1_000_000) return '$' + (v/1_000_000).toFixed(2) + 'M';
  if (v >= 1_000)     return '$' + (v/1_000).toFixed(1) + 'K';
  return '$' + v.toFixed(0);
}
function fmtK(v) {
  if (v >= 1_000_000) return (v/1_000_000).toFixed(1) + 'M';
  if (v >= 1_000)     return (v/1_000).toFixed(0) + 'K';
  return v;
}
function fmtPct(v) {
  if (v == null) return '—%';
  return v.toFixed(1) + '%';
}
function pct(a, b) { return b > 0 ? (a/b*100) : 0; }

// ── Load data ──
async function loadData() {
  const fiscal_q  = document.getElementById('flt-quarter').value;
  const squad     = document.getElementById('flt-squad').value;
  const portfolio = document.getElementById('flt-portfolio').value;

  // update context badge
  const ctx = [fiscal_q, squad, portfolio].filter(Boolean).join(' · ') || 'Todos os períodos';
  document.getElementById('active-context').textContent = ctx;

  const params = new URLSearchParams();
  if (fiscal_q)  params.set('fiscal_q', fiscal_q);
  if (squad)     params.set('squad', squad);
  if (portfolio) params.set('portfolio', portfolio);

  try {
    const [revRes, attRes] = await Promise.all([
      fetch(`${API_BASE}/api/revenue/weekly?${params}`).then(r => r.json()),
      fetch(`${API_BASE}/api/attainment?${fiscal_q ? '&fiscal_q='+encodeURIComponent(fiscal_q) : ''}`).then(r => r.json()),
    ]);

    renderCards(revRes, attRes);
    renderChartSemanal(revRes.por_semana || []);
    renderChartMensal(revRes.por_mes || []);
    renderTablePortfolio(revRes.por_portfolio || []);
    renderTableSquad(revRes.por_squad || []);
  } catch(err) {
    console.error('Revenue load error:', err);
  }
}

// ── Cards ──
function renderCards(rev, att) {
  const t = rev.totais || {};
  const a = att.resumo  || {};

  const net   = t.net_revenue  || 0;
  const pago  = t.net_pago     || 0;
  const pend  = t.net_pendente || 0;
  const linhas= t.linhas       || 0;

  document.getElementById('card-net-total').textContent  = fmtMoney(net);
  document.getElementById('card-net-linhas').textContent = linhas + ' faturas';
  document.getElementById('card-net-pago').textContent   = fmtMoney(pago);
  document.getElementById('card-net-pend').textContent   = fmtMoney(pend);

  const pagoPct = pct(pago, net);
  const pendPct = pct(pend, net);
  const el_pp   = document.getElementById('card-net-pago-pct');
  const el_pendp= document.getElementById('card-net-pend-pct');
  el_pp.textContent   = fmtPct(pagoPct) + ' do total';
  el_pendp.textContent= fmtPct(pendPct) + ' do total';

  // attainment card (usa /api/attainment)
  const attPct  = a.attainment_net_pct;
  const metaNet = a.meta_net   || 0;
  const realNet = a.net_realizado || 0;
  document.getElementById('card-att-pct').textContent = attPct != null ? fmtPct(attPct) : '—';
  document.getElementById('card-att-sub').textContent = `Meta: ${fmtMoney(metaNet)} · Real: ${fmtMoney(realNet)}`;

  const barW = Math.min(attPct || 0, 100);
  const bar  = document.getElementById('att-bar');
  bar.style.width = barW + '%';
  bar.style.background = (attPct >= 100) ? 'linear-gradient(90deg,#C0FF7D,#7af0ff)'
                       : (attPct >= 70)  ? 'linear-gradient(90deg,#FFA500,#ffd57a)'
                       : 'linear-gradient(90deg,#E14849,#ff8a8a)';

  // badge cor attainment
  const cardAtt = document.getElementById('card-att-pct').closest('.card');
  const badge   = cardAtt && cardAtt.querySelector('.card-badge');
  // no badge here — just the value and bar
}

// ── Chart A: semanal ──
function renderChartSemanal(rows) {
  const labels = rows.map(r => {
    const d = r.semana_inicio; // "2026-01-05"
    const dt = new Date(d + 'T00:00:00');
    return dt.toLocaleDateString('pt-BR', { day:'2-digit', month:'short' });
  });
  const netData     = rows.map(r => r.net_revenue   || 0);
  const pagoData    = rows.map(r => r.net_pago       || 0);
  const pendData    = rows.map(r => r.net_pendente   || 0);

  if (chartSemanal) chartSemanal.destroy();
  const ctx = document.getElementById('chart-semanal').getContext('2d');
  chartSemanal = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Net Revenue',
          data: netData,
          borderColor: '#00BEFF',
          backgroundColor: 'rgba(0,190,255,0.08)',
          tension: 0.35, fill: true, pointRadius: 3, borderWidth: 2,
        },
        {
          label: 'Pago',
          data: pagoData,
          borderColor: '#C0FF7D',
          backgroundColor: 'transparent',
          tension: 0.35, fill: false, pointRadius: 3, borderWidth: 1.5,
          borderDash: [4,2],
        },
        {
          label: 'Pendente',
          data: pendData,
          borderColor: '#FFA500',
          backgroundColor: 'transparent',
          tension: 0.35, fill: false, pointRadius: 3, borderWidth: 1.5,
          borderDash: [4,2],
        },
      ]
    },
    options: {
      ...CHART_DEFAULTS,
      interaction: { mode: 'index', intersect: false },
    }
  });
}

// ── Chart B: mensal empilhado ──
function renderChartMensal(rows) {
  const labels = rows.map(r => {
    const d = r.mes_inicio;
    const dt = new Date(d + 'T00:00:00');
    return dt.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
  });
  const pagoData = rows.map(r => r.net_pago     || 0);
  const pendData = rows.map(r => r.net_pendente || 0);

  if (chartMensal) chartMensal.destroy();
  const ctx = document.getElementById('chart-mensal').getContext('2d');
  chartMensal = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Pago',
          data: pagoData,
          backgroundColor: 'rgba(192,255,125,0.65)',
          borderRadius: 3,
        },
        {
          label: 'Pendente',
          data: pendData,
          backgroundColor: 'rgba(255,165,0,0.55)',
          borderRadius: 3,
        },
      ]
    },
    options: {
      ...CHART_DEFAULTS,
      scales: {
        ...CHART_DEFAULTS.scales,
        x: { ...CHART_DEFAULTS.scales.x, stacked: true },
        y: { ...CHART_DEFAULTS.scales.y, stacked: true },
      }
    }
  });
}

// ── Table: portfolio ──
function renderTablePortfolio(rows) {
  const tbody = document.getElementById('tbody-portfolio');
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:24px">Sem dados</td></tr>';
    return;
  }
  const totalNet = rows.reduce((s, r) => s + (r.net_revenue || 0), 0);
  tbody.innerHTML = rows.map(r => {
    const p = pct(r.net_revenue || 0, totalNet);
    return `<tr>
      <td>${r.portfolio || '—'}</td>
      <td>${fmtMoney(r.gross_revenue)}</td>
      <td>${fmtMoney(r.net_revenue)}</td>
      <td>
        <div class="pct-bar">
          <div class="pct-bar-bg"><div class="pct-bar-fill" style="width:${p.toFixed(0)}%"></div></div>
          <span style="font-size:11px;color:var(--text-muted);min-width:34px;text-align:right">${p.toFixed(0)}%</span>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// ── Table: squad ──
function renderTableSquad(rows) {
  const tbody = document.getElementById('tbody-squad');
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:24px">Sem dados</td></tr>';
    return;
  }
  const totalNet = rows.reduce((s, r) => s + (r.net_revenue || 0), 0);
  tbody.innerHTML = rows.map(r => {
    const p = pct(r.net_revenue || 0, totalNet);
    return `<tr>
      <td>${r.squad || '—'}</td>
      <td>${fmtMoney(r.gross_revenue)}</td>
      <td>${fmtMoney(r.net_revenue)}</td>
      <td>
        <div class="pct-bar">
          <div class="pct-bar-bg"><div class="pct-bar-fill" style="width:${p.toFixed(0)}%"></div></div>
          <span style="font-size:11px;color:var(--text-muted);min-width:34px;text-align:right">${p.toFixed(0)}%</span>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// ── Clear filters ──
function clearFilters() {
  document.getElementById('flt-quarter').value  = '';
  document.getElementById('flt-squad').value    = '';
  document.getElementById('flt-portfolio').value= '';
  loadData();
}

// ── Inicialização ──
document.addEventListener('DOMContentLoaded', () => loadData());
</script>
</body>
</html>
